<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>linux åœ¨ python2.x åŸºç¡€ä¸Šå®‰è£… python3.x</title>
      <link href="/2024/11/23/linux-zai-python2-x-ji-chu-shang-an-zhuang-python3-x/"/>
      <url>/2024/11/23/linux-zai-python2-x-ji-chu-shang-an-zhuang-python3-x/</url>
      
        <content type="html"><![CDATA[<p>è¿™ç§æ–‡å…¶å®å¯ä»¥ä¸å†™ï¼Œæµè§ˆå™¨ä¸­ä¸€å¤§æŠŠï¼Œä½†ä¹Ÿç¡®å®å¾ˆå¤šéƒ½ä¸å¤ªå¯¹ã€‚è¿™é‡Œè¯´çš„å®‰è£… python3.x ä½¿ç”¨ pyenv è¿›è¡Œç®¡ç†ï¼Œè¿™æ ·å¯ä»¥å¾ˆå¥½çš„ç®¡ç†æ‰€éœ€çš„ python 3.x å„ç§ç‰ˆæœ¬ã€‚</p><p>æˆ‘ç»å†äº†æ¯”è¾ƒå¤šçš„é—®é¢˜ï¼Œæˆ‘ä¼šæ¯æ­¥éƒ½è®°å½•ï¼Œå¦‚æœä½ è¿™ç§é—®é¢˜å°±è·³è¿‡ã€‚</p><h3 id="yum-ä¿®æ”¹é˜¿é‡Œä»“åº“æº"><a href="#yum-ä¿®æ”¹é˜¿é‡Œä»“åº“æº" class="headerlink" title="yum ä¿®æ”¹é˜¿é‡Œä»“åº“æº"></a>yum ä¿®æ”¹é˜¿é‡Œä»“åº“æº</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># å¤‡ä»½å½“å‰çš„ yum é…ç½®</span><span class="token function">sudo</span> <span class="token function">cp</span> <span class="token parameter variable">-ar</span> /etc/yum.repos.d /etc/yum.repos.d.bak<span class="token comment"># åˆ é™¤åŸæœ‰çš„ repos æ–‡ä»¶</span><span class="token function">sudo</span> <span class="token function">rm</span> <span class="token parameter variable">-f</span> /etc/yum.repos.d/*.repo<span class="token comment"># ä¸‹è½½é˜¿é‡Œäº‘çš„ CentOS YUM æºé…ç½®</span><span class="token comment"># æ ¹æ®ä½ çš„ CentOS ç‰ˆæœ¬é€‰æ‹©ä¸‹é¢çš„å‘½ä»¤æ‰§è¡Œ</span><span class="token comment"># CentOS 7</span><span class="token function">sudo</span> <span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo<span class="token comment"># CentOS 8</span><span class="token function">sudo</span> <span class="token function">wget</span> <span class="token parameter variable">-O</span> /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-8.repo<span class="token comment"># æ¸…é™¤ç¼“å­˜å¹¶ç”Ÿæˆæ–°çš„ç¼“å­˜</span><span class="token function">sudo</span> yum clean all<span class="token function">sudo</span> yum makecache<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®‰è£…-pyenv"><a href="#å®‰è£…-pyenv" class="headerlink" title="å®‰è£… pyenv"></a>å®‰è£… pyenv</h3><p>pyenv éœ€è¦åŸºäº github ä¸Šçš„ä»“åº“ï¼Œæ‰€ä»¥å‰æœŸéœ€è¦å®‰è£… git å¹¶è®¾ç½® token è®¿é—®ã€‚å®‰è£… git ç›´æ¥ yum å®‰è£…å°±è¡Œã€‚è¿™é‡Œä¼šå•ç‹¬è¯´æ˜è®¾ç½® token è®¿é—®ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">git</span> config <span class="token parameter variable">--global</span> credential.helper store<span class="token function">git</span> clone https://<span class="token variable">${token}</span>@<span class="token variable">${repo_url}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å°±æ˜¯ä¿å­˜ token éªŒè¯ä¿¡æ¯åï¼Œå†å®‰è£… pyenvã€‚é€šè¿‡å‘½ä»¤ <code>curl https://pyenv.run | bash</code>ã€‚å¹¶åœ¨ <code>~/.bashrc</code> å¢åŠ é…ç½®</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">export</span> <span class="token assign-left variable">PYENV_ROOT</span><span class="token operator">=</span><span class="token string">"<span class="token environment constant">$HOME</span>/.pyenv"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$PYENV_ROOT</span>/bin:<span class="token environment constant">$PATH</span>"</span><span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token string">"<span class="token variable">$PYENV_ROOT</span>/shims:<span class="token environment constant">$PATH</span>"</span><span class="token builtin class-name">eval</span> <span class="token string">"<span class="token variable"><span class="token variable">$(</span>pyenv init -<span class="token variable">)</span></span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å®‰è£…-python3-x"><a href="#å®‰è£…-python3-x" class="headerlink" title="å®‰è£… python3.x"></a>å®‰è£… python3.x</h3><p>ä½¿ç”¨å‘½ä»¤ <code>pyenv install 3.11.10</code> ç»“æœå¡ä½åœ¨åŒ…ä¸‹è½½ä¸Šï¼Œåªèƒ½æ‰‹åŠ¨ä¸‹è½½ python å®‰è£…åŒ…ï¼Œæ”¾åˆ° <code>~/.pip/cache</code> ä¹‹åå†æ‰§è¡Œ <code>pyenv install 3.11.10</code> å‘½ä»¤ã€‚</p><p>å®‰è£…åä¼šå‡ºç° <code>ERROR: The Python ssl extension was not compiled. Missing the OpenSSL lib</code> çš„é—®é¢˜ï¼Œè¿™é‡Œè€—è´¹çš„æ—¶é—´æœ€é•¿ï¼Œç™¾åº¦çš„éƒ½ä¸å¯¹ã€‚<strong>æœ€ç»ˆè¿˜æ˜¯å¾—çœ‹å®˜ç½‘è¯´æ˜çš„è§£å†³æ–¹æ¡ˆã€‚</strong></p><h4 id="openssl-å®‰è£…"><a href="#openssl-å®‰è£…" class="headerlink" title="openssl å®‰è£…"></a>openssl å®‰è£…</h4><p>ç¡®å®šåœ¨ 1.0.2 ç‰ˆæœ¬ä»¥ä¸Šï¼Œæˆ‘è¿™é‡Œé€‰çš„æ˜¯ 1.1.1 ç‰ˆæœ¬ã€‚å…ˆä¸‹è½½ openssl çš„æºç  <a href="https://openssl-library.org/source/old/1.1.1/index.html">1.1.1 | Library</a>ï¼Œå®Œæˆæ‰‹åŠ¨å®‰è£…</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">./config <span class="token parameter variable">--prefix</span><span class="token operator">=</span>/usr/local/openssl_1_1 no-zlib<span class="token function">make</span> <span class="token operator">&amp;</span> <span class="token function">make</span> <span class="token function">install</span><span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/openssl_1_1/include/openssl /usr/include/openssl<span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/openssl_1_1/lib/libssl.so.1.1 /usr/local/lib64/libssl.so<span class="token function">ln</span> <span class="token parameter variable">-s</span> /usr/local/openssl_1_1/bin/openssl /usr/bin/openssl<span class="token builtin class-name">echo</span> <span class="token string">"/usr/local/openssl_1_1/lib"</span> <span class="token operator">&gt;&gt;</span> /etc/ld.so.confldconfig <span class="token parameter variable">-v</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä½¿ç”¨ <code>openssl version -d</code> å‘½ä»¤ç¡®å®šå®‰è£…è·¯å¾„ï¼Œä½¿ç”¨ä¸€ä¸‹å‘½ä»¤å®‰è£… å®‰è£… python3.xï¼Œå‘½ä»¤æ˜¯ç»“åˆ linux ç‰ˆæœ¬å’Œè¦å®‰è£…åçš„ python ç‰ˆæœ¬ä»¥åŠå°è¯•åçš„ç»“æœã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">LDFLAGS</span><span class="token operator">=</span><span class="token string">"-L/usr/lib64/openssl"</span> <span class="token punctuation">\</span><span class="token assign-left variable">CPPFLAGS</span><span class="token operator">=</span><span class="token string">"-I/usr/include/openssl"</span> <span class="token punctuation">\</span><span class="token assign-left variable">CONFIGURE_OPTS</span><span class="token operator">=</span><span class="token string">"--with-openssl=&lt;openssl install prefix&gt; --with-openssl-rpath=auto"</span> <span class="token punctuation">\</span>pyenv <span class="token function">install</span> <span class="token parameter variable">-v</span> <span class="token number">3.11</span>.10<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><h3 id="å‚è€ƒé™„ä»¶"><a href="#å‚è€ƒé™„ä»¶" class="headerlink" title="å‚è€ƒé™„ä»¶"></a>å‚è€ƒé™„ä»¶</h3><ul><li><p><a href="https://github.com/pyenv/pyenv/wiki/Common-build-problems#error-the-python-ssl-extension-was-not-compiled-missing-the-openssl-lib">error-the-python-ssl-extension-was-not-compiled-missing-the-openssl-lib</a></p></li><li><p><a href="https://blog.csdn.net/2301_76933862/article/details/143360338">ã€linuxã€‘centosç¼–è¯‘å®‰è£…openssl1.1.1_centoså®‰è£…openssl1.1.1-CSDNåšå®¢</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> python </category>
          
      </categories>
      
      
        <tags>
            
            <tag> python </tag>
            
            <tag> linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Apple M1 ç¼–è¯‘ electron sqlite3</title>
      <link href="/2024/11/15/apple-m1-bian-yi-electron-sqlite3/"/>
      <url>/2024/11/15/apple-m1-bian-yi-electron-sqlite3/</url>
      
        <content type="html"><![CDATA[<p>ä½¿ç”¨ cnpm å®‰è£…çš„ sqlite3 ä¼šå‡ºç°å†…æ ¸ä¸åŒ¹é…é—®é¢˜ï¼ŒæŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š</p><pre class="line-numbers language-log" data-language="log"><code class="language-log">App threw an error during load<span class="token property">Error:</span> dlopen<span class="token operator">(</span><span class="token file-path string">/Users/liull/00_beluga/slient-printer-app/node_modules/.store/sqlite3@5.1.7/node_modules/sqlite3/build/Release/node_sqlite3.node</span><span class="token punctuation">,</span> <span class="token number">0x0001</span><span class="token operator">)</span><span class="token operator">:</span> <span class="token property">tried:</span> <span class="token string">'/Users/liull/00_beluga/slient-printer-app/node_modules/.store/sqlite3@5.1.7/node_modules/sqlite3/build/Release/node_sqlite3.node'</span> <span class="token operator">(</span>mach<span class="token operator">-</span>o file<span class="token punctuation">,</span> but is an incompatible architecture <span class="token operator">(</span>have <span class="token string">'x86_64'</span><span class="token punctuation">,</span> need <span class="token string">'arm64'</span><span class="token operator">)</span><span class="token operator">)</span><span class="token punctuation">,</span>  <span class="token string">'/System/Volumes/Preboot/Cryptexes/OS/Users/liull/00_beluga/slient-printer-app/node_modules/.store/sqlite3@5.1.7/node_modules/sqlite3/build/Release/node_sqlite3.node'</span> <span class="token operator">(</span>no such file<span class="token operator">)</span><span class="token punctuation">,</span>   <span class="token string">'/Users/liull/00_beluga/slient-printer-app/node_modules/.store/sqlite3@5.1.7/node_modules/sqlite3/build/Release/node_sqlite3.node'</span> <span class="token operator">(</span>mach<span class="token operator">-</span>o file<span class="token punctuation">,</span> but is an incompatible architecture <span class="token operator">(</span>have <span class="token string">'x86_64'</span><span class="token punctuation">,</span> need <span class="token string">'arm64'</span><span class="token operator">)</span><span class="token operator">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ ¸å¿ƒå°±æ˜¯ä¸‹è½½çš„ sqlite3 å†…æ ¸æ˜¯ x86_64 è€Œ apple M1 çš„å†…æ ¸æ˜¯ arm64ã€‚ä¸€ç§åŠæ³•æ˜¯ä»<a href="https://registry.npmmirror.com/binary.html?path=sqlite3/v5.1.7/">ä»“åº“</a> æ‰¾å‡†ä¸‹è½½æ›¿æ¢æœ¬åœ°å¯¹åº” <code>node_modules/sqlite3/build/Release/node_sqlite3.node</code> è·¯å¾„æ–‡ä»¶ã€‚ä¸€ç§åŠæ³•æ˜¯ä¾æ®æºç è¿›è¡Œç¼–è¯‘ã€‚</p><ol><li><p>éœ€è¦å…¨å±€å®‰è£… electron <code>cnpm install electron -g</code></p></li><li><p>éœ€è¦å…¨å±€å®‰è£… node-gyp <code>cnpm install node-gyp -g</code></p></li><li><p>ä¸‹è½½ sqlite3 æºç  <code>cnpm install sqlite3 --ignore-scripts</code>ï¼Œå…¶ä¸­ <code>--ignore-script</code> æ˜¯ä¸ºäº†é˜²æ­¢ sqlite3 è‡ªåŠ¨æ‰§è¡Œç¼–è¯‘</p></li><li><p>æ‰‹åŠ¨æ‰§è¡Œè„šæœ¬è¿›è¡Œç¼–è¯‘</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token builtin class-name">cd</span> node_modules/sqlite3node-gyp rebuild <span class="token parameter variable">--target</span><span class="token operator">=</span>electronç‰ˆæœ¬ <span class="token parameter variable">--arch</span><span class="token operator">=</span>arm64 --dist-url<span class="token operator">=</span>https://electronjs.org/headers --module-name<span class="token operator">=</span>node_sqlite3 <span class="token parameter variable">--module_path</span><span class="token operator">=</span><span class="token punctuation">..</span>/lib/binding/napi-v3-darwin-arm64<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre></li><li><p>åœ¨é¡¹ç›®ä¸­è¿è¡Œ <code>cnpm run dev</code> è¿è¡Œé¡¹ç›®åï¼Œæ­£å¸¸å¯åŠ¨</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> electron </tag>
            
            <tag> sqlite3 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mac å¦‚ä½•æ·»åŠ  CA è¯ä¹¦</title>
      <link href="/2024/11/15/mac-ru-he-tian-jia-ca-zheng-shu/"/>
      <url>/2024/11/15/mac-ru-he-tian-jia-ca-zheng-shu/</url>
      
        <content type="html"><![CDATA[<p>chrome æµè§ˆå™¨è®¿é—® https éƒ½ä¼šéœ€è¦éªŒè¯è¯ä¹¦ï¼Œå¯ä»¥æ‰‹åŠ¨æ·»åŠ  CA è¯ä¹¦ã€‚Mac æ‰‹åŠ¨æ·»åŠ  CA è¯ä¹¦æ˜¯åœ¨ <code>å®ç”¨å·¥å…· =&gt; é’¥åŒ™ä¸²è®¿é—®.app</code> ä¸­æ“ä½œã€‚è€Œåœ¨ app ä¸­ï¼Œåˆ†ä¸º<strong>é»˜è®¤é’¥åŒ™ä¸² =&gt; ç™»å½•</strong>ã€<strong>é»˜è®¤é’¥åŒ™ä¸² =&gt; æœ¬åœ°é¡¹ç›®</strong>ã€<strong>ç³»ç»Ÿé’¥åŒ™ä¸² =&gt; ç³»ç»Ÿ</strong>ã€<strong>ç³»ç»Ÿé’¥åŒ™ä¸² =&gt; ç³»ç»Ÿæ ¹è¯ä¹¦</strong>ã€‚</p><p><img src="/images/2024/mac-add-ca/1.png" alt="keys.jpg"></p><p>è‡ªç­¾çš„ CA è¯ä¹¦ï¼Œæœ‰ä¸”åªèƒ½åœ¨ <strong>é»˜è®¤é’¥åŒ™ä¸² =&gt; ç™»å½•</strong> æˆ–<strong>ç³»ç»Ÿé’¥åŒ™ä¸² =&gt; ç³»ç»Ÿ</strong> ä¸¤ä¸ªåˆ†ç»„ä¸Šåš <strong>æ–‡ä»¶èœå• =&gt; å¯¼å…¥é¡¹ç›®</strong> è¿›è¡Œå¯¼å…¥ã€‚å¯¼å…¥æˆåŠŸååœ¨è¯ä¹¦é¡µç­¾ä¸‹æŸ¥çœ‹æ–°å¢çš„è¯ä¹¦ï¼Œå¹¶å³é”®é€‰æ‹© <strong>æ˜¾ç¤ºç®€ä»‹</strong> åä¿¡ä»»å¤„é€‰æ‹© <strong>å§‹ç»ˆä¿¡ä»»</strong>ã€‚</p><p><img src="/images/2024/mac-add-ca/2.png" alt="final.jpg"></p>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> æ‚é¡¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JDK å¯¼å…¥ (CA) SSL è®¤è¯-çº¯å‡€ç‰ˆ</title>
      <link href="/2024/11/15/jdk-dao-ru-ca-ssl-ren-zheng-chun-jing-ban/"/>
      <url>/2024/11/15/jdk-dao-ru-ca-ssl-ren-zheng-chun-jing-ban/</url>
      
        <content type="html"><![CDATA[<p>JDK æä¾› keytool æ˜¯å¯†é’¥å’Œè¯ä¹¦ç®¡ç†å·¥å…·ï¼Œå¯ä»¥ç”Ÿæˆè¯ä¹¦ã€å¯¼å…¥è¯ä¹¦ã€ç”Ÿæˆå¯†é’¥ã€‚å¯ä»¥ç»™é€šè¿‡ java è¿è¡Œç¨‹åº https å®‰å…¨è®¤è¯ï¼Œå½“ç„¶ä¸åŒ…å«tomcatã€jetty å®¹å™¨ï¼Œä»–ä»¬æœ‰è‡ªå·±è¯ä¹¦é…ç½®ã€‚é»˜è®¤ keytool å¯†ç åº“æ˜¯ <code>$JAVA_HOME/jre/lib/security/cacerts</code>ï¼Œå¦‚æœè‡ªèº«æœ‰éœ€è¦å¯ä»¥é€šè¿‡ <code>keytool -keystore filepath</code> å…¶ä¸­ filepath å¯ä»¥æ˜¯ç»å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ä»…æ˜¯æ–‡ä»¶åï¼ŒåŒºåˆ«åœ¨äºæ˜¯åœ¨æœ¬æ–‡ä»¶å¤¹ä¸‹çš„å¯†ç åº“è¿˜æ˜¯æŒ‡å®šæ–‡ä»¶å¤¹çš„å¯†ç åº“ï¼Œ<strong>è¿™ç‚¹å¾ˆé‡è¦</strong>ã€‚</p><p>æˆ‘æ˜¯åœ¨ sonar-maven-plugin ä½¿ç”¨æ—¶ï¼Œå›  sonar æ˜¯ https æ³¨æ„åˆ° JDK SSL è®¤è¯ã€‚æœŸé—´ç¢°åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œé—®é¢˜éƒ½æ˜¯è¸©è¿‡çš„å‘ã€‚</p><ul><li><p><code> sun.security.provider.certpath.SunCertPathBuilderException: unable to find valid certification path to requested target</code></p><ul><li><font color="blue">æ²¡æœ‰æŒ‡å®šå¯†é’¥åº“æˆ–å¯†é’¥åº“ä¸­æ²¡æœ‰æœ‰æ•ˆçš„å¯†é’¥</font></li></ul></li><li><p><code>java.security.UnrecoverableKeyException: Password verification failed</code></p><ul><li><font color="blue">æŒ‡å®šçš„å¯†é’¥åº“å¯¹åº”çš„å¯†ç ä¸æ­£ç¡®ï¼Œå½“ç„¶å¯¹åº”çš„è·¯å¾„ä¸‹å¯èƒ½ä¸å­˜åœ¨å¯†é’¥åº“</font></li></ul></li><li><p><code>java.security.InvalidAlgorithmParameterException: the trustAnchors parameter must be non-empty</code></p><ul><li><font color="blue">å¯¹åº”çš„å¯†ç åº“è·¯å¾„ä¸æ­£ç¡®</font></li></ul></li></ul><h3 id="JDK-å¯¼å…¥-CA-è®¤è¯"><a href="#JDK-å¯¼å…¥-CA-è®¤è¯" class="headerlink" title="JDK å¯¼å…¥ CA è®¤è¯"></a>JDK å¯¼å…¥ CA è®¤è¯</h3><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">keytool <span class="token parameter variable">-importcert</span> <span class="token parameter variable">-keystore</span> <span class="token operator">&lt;</span>keystore-file-path<span class="token operator">&gt;</span> <span class="token parameter variable">-alias</span> <span class="token operator">&lt;</span>caAlias<span class="token operator">&gt;</span> <span class="token parameter variable">-file</span> <span class="token operator">&lt;</span>ca-file-path<span class="token operator">&gt;</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><ul><li><p>keystoreï¼ŒæŒ‡å®šå¯†é’¥åº“è·¯å¾„ã€‚å¦‚æœä»…æ–‡ä»¶åï¼Œåˆ™é»˜è®¤åœ¨è¿è¡Œå‘½ä»¤çš„ç›®å½•åˆ›å»ºå¯†é’¥åº“ã€‚</p></li><li><p>aliasï¼Œåªæ˜¯ç”¨æ¥æ–¹ä¾¿æ ‡è®°è®¤è¯åˆ«åã€‚</p></li><li><p>fileï¼ŒæŒ‡å‘ ca è¯ä¹¦</p></li></ul><p>è¿è¡Œå‘½ä»¤æ—¶ï¼Œéœ€è¦è®¾ç½®å¯†ç åº“çš„ä½¿ç”¨å¯†ç ï¼Œ<strong>è¿™ä¸ªåƒä¸‡ä¸èƒ½å¿˜è®°</strong>ã€‚è¿è¡Œå‘½ä»¤åï¼Œä¼šåœ¨ <code>keystore-file-path</code> ç”Ÿæˆç›¸åº”çš„å¯†ç åº“æ–‡ä»¶ã€‚å¯ä»¥ä½¿ç”¨ <code>keytool -list -v -keystore &lt;keystore-file-path&gt;</code> æŸ¥çœ‹å¯¼å…¥è¯ä¹¦æ˜ç»†ã€‚</p><h3 id="mvn-sonar-è¿è¡Œå˜é‡æŒ‡å®š"><a href="#mvn-sonar-è¿è¡Œå˜é‡æŒ‡å®š" class="headerlink" title="mvn sonar è¿è¡Œå˜é‡æŒ‡å®š"></a>mvn sonar è¿è¡Œå˜é‡æŒ‡å®š</h3><p><code>mvn clean compile sonar:sonar -Djavax.net.ssl.trustStore=&lt;keystore-file-path&gt; -Djavax.net.ssl.trustStorePassword=&lt;keystore-password&gt;</code></p><ul><li><p><code>javax.net.ssl.trustStore</code>ï¼ŒæŒ‡å‘å¯†ç åº“çš„ç»å¯¹è·¯å¾„</p></li><li><p><code>javax.net.ssl.trustStorePassword</code>ï¼ŒæŒ‡å‘å¯†ç åº“çš„ä½¿ç”¨å¯†ç </p></li></ul>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> æ‚é¡¹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä½¿ç”¨ç¯¡æ”¹çŒ´å’Œ python æ±‚ï¼ˆpaï¼‰æ¢¯å­å¤–æ–‡æ¡£å’Œè§†é¢‘</title>
      <link href="/2024/10/25/shi-yong-cuan-gai-hou-he-python-qiu-pa-ti-zi-wai-wen-dang-he-shi-pin/"/>
      <url>/2024/10/25/shi-yong-cuan-gai-hou-he-python-qiu-pa-ti-zi-wai-wen-dang-he-shi-pin/</url>
      
        <content type="html"><![CDATA[<p>åŠå¹´å‰ï¼Œæˆ‘å—æœ‹å‹å§”æ‰˜è¯·æ±‚å¸®å¿™ pa å›½å¤–ç½‘ç«™å­¦ä¹ èµ„æºã€‚æ—¶é—´æœ‰ç‚¹ä¹…ï¼Œæœ€è¿‘æœ‰ç©ºé—²æ—¶é—´å°±æ¥çœ‹çœ‹èƒ½ä¸èƒ½æã€‚pa è¿™å¥—èµ„æºï¼Œåˆ†æåæœ‰å‡ ä¸ªæƒ…å†µ</p><ol><li><p>è¯¥ç½‘ç«™æ˜¯æœ‰ 2FA è®¤è¯</p></li><li><p>PDF æ˜¯ä½¿ç”¨ chrome å†…ç½®ç¨‹åºå±•ç¤ºï¼Œå¥½åœ¨é¡µé¢ä¸Šæä¾›äº†ä¸‹è½½å›¾æ ‡å’Œé“¾æ¥</p></li><li><p>è§†é¢‘æ˜¯ä½¿ç”¨ video æ ‡ç­¾å±•ç¤ºå¹¶æ”¯æŒæ’­æ”¾ï¼Œè§†é¢‘æ˜¯ mp4ï¼Œè¢«åˆ†ç‰‡ä¸º ts ç”± m3u8 è®°å½•åˆ†ç‰‡åˆ—è¡¨</p></li></ol><p>å…¶ä¸­ï¼Œæ–‡æ¡£èµ„æºçš„ä¸‹è½½é“¾æ¥éœ€è¦é€šè¿‡ç½‘ç«™ç™»å½•éªŒè¯ï¼Œæ‰€ä»¥è¿™ç±»èµ„æºæœ€å¥½æ˜¯é€šè¿‡æµè§ˆå™¨ä¸‹è½½ã€‚å› ä¸ºä¸€èˆ¬çš„ç»•ä¸è¿‡ 2FA è®¤è¯ã€‚è§†é¢‘èµ„æºçš„ä¸‹è½½é“¾æ¥ä¸éœ€è¦é€šè¿‡ç½‘ç«™ç™»å½•éªŒè¯ï¼Œä¸‹è½½æµé‡æ˜¯ç›´æ¥æ‰“åˆ°ç½‘ç«™æä¾›çš„å­˜å‚¨ï¼Œè¿™å¯¹çˆ¬è™«æ¥è¯´æ˜¯ä¸ªç¦éŸ³ã€‚éšåç¡®å®šæ–‡æ¡£ç±»èµ„æºä½¿ç”¨ç¯¡æ”¹çŒ´ä¸‹è½½ï¼Œè§†é¢‘ç±»èµ„æºä½¿ç”¨ python ä¸‹è½½ã€‚</p><h3 id="æ–‡æ¡£ç±»èµ„æºä¸‹-pa-è½½-chong"><a href="#æ–‡æ¡£ç±»èµ„æºä¸‹-pa-è½½-chong" class="headerlink" title="æ–‡æ¡£ç±»èµ„æºä¸‹ (pa) è½½ (chong)"></a>æ–‡æ¡£ç±»èµ„æºä¸‹ (pa) è½½ (chong)</h3><p><a href="https://www.tampermonkey.net/index.php?src=a&amp;locale=zh_CN#google_vignette">ç¯¡æ”¹çŒ´ tampermonkey</a>ï¼Œå®ƒå…è®¸ç”¨æˆ·è‡ªå®šä¹‰å¹¶<strong>å¢å¼ºæ‚¨æœ€å–œçˆ±çš„ç½‘é¡µçš„åŠŸèƒ½</strong>ã€‚ç”¨æˆ·è„šæœ¬æ˜¯å°å‹ JavaScript ç¨‹åºï¼Œå¯ç”¨äºå‘ç½‘é¡µæ·»åŠ æ–°åŠŸèƒ½æˆ–ä¿®æ”¹ç°æœ‰åŠŸèƒ½ã€‚ä½¿ç”¨ ç¯¡æ”¹çŒ´ï¼Œæ‚¨å¯ä»¥è½»æ¾åœ¨ä»»ä½•ç½‘ç«™ä¸Šåˆ›å»ºã€ç®¡ç†å’Œè¿è¡Œè¿™äº›ç”¨æˆ·è„šæœ¬ã€‚å¯ä»¥ä½¿ç”¨ blob å°†è§†é¢‘ç±»èµ„æºä¸‹è½½åœ°å€ä¿å­˜åˆ°æœ¬åœ°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">const</span> videoUrls <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">const</span> videoBlob <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Blob</span><span class="token punctuation">(</span><span class="token punctuation">[</span>videoUrls<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">const</span> videoLink <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>videoLink<span class="token punctuation">.</span>href <span class="token operator">=</span> window<span class="token punctuation">.</span><span class="token constant">URL</span><span class="token punctuation">.</span><span class="token function">createObjectURL</span><span class="token punctuation">(</span>videoBlob<span class="token punctuation">)</span><span class="token punctuation">;</span>videoLink<span class="token punctuation">.</span>download<span class="token operator">=</span>course <span class="token operator">+</span><span class="token string">'_'</span><span class="token operator">+</span>item<span class="token operator">+</span><span class="token string">'_video.txt'</span><span class="token punctuation">;</span>videoLink<span class="token punctuation">.</span><span class="token function">click</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…³äºæ–‡æ¡£ä¸‹è½½ javascript ç›´æ¥ä½¿ç”¨ <code>window.open(downloadUrl, '_blank')</code> å®Œæˆä¸‹è½½ã€‚éœ€è¦åœ¨æµè§ˆå™¨è®¾ç½®è®¿é—® PDF æ—¶æ˜¯ç›´æ¥ä¸‹è½½ï¼Œä¸æ˜¯åœ¨ chrome ä¸­æ‰“å¼€ PDF æ–‡ä»¶ï¼Œè®¿é—® <code>chrome://settings/content/pdfDocuments</code> å¯ä¿®æ”¹ï¼Œè®°å¾—é‡å¯æµè§ˆå™¨ã€‚</p><h4 id="chrome-ä¸‹è½½å†å²è®°å½•åœ¨å“ªé‡Œ"><a href="#chrome-ä¸‹è½½å†å²è®°å½•åœ¨å“ªé‡Œ" class="headerlink" title="chrome ä¸‹è½½å†å²è®°å½•åœ¨å“ªé‡Œ"></a>chrome ä¸‹è½½å†å²è®°å½•åœ¨å“ªé‡Œ</h4><p>æˆ‘æœ¬æ¬¡çš„ pa è™«ï¼Œéœ€è¦æŒ‰ç…§é¡µé¢è¿›è¡Œæ–‡æ¡£åˆ†ç±»ï¼Œæ‰€ä»¥éœ€è¦æŒ‰ç…§ä¸‹è½½åœ°å€æ˜ å°„ä¸‹è½½çš„æ–‡ä»¶ï¼Œè¿™éœ€è¦ chrome ä¸‹è½½å†å²è®°å½•ã€‚è€Œ chrome ä¸‹è½½å†å²è®°å½•ï¼Œåœ¨ <code>${chrome_data_home}/History</code> æ–‡ä»¶ä¸­ï¼Œ<code>${chrome_data_home}</code> æ¥è‡ªäº <code>chrome://version/</code> çš„<strong>ä¸ªäººèµ„æ–™è·¯å¾„</strong>ã€‚History æ–‡ä»¶æ˜¯ sqlite æ•°æ®åº“æ–‡ä»¶ã€‚å‰©ä¸‹çš„ä½ æ‡‚çš„ã€‚</p><h3 id="è§†é¢‘ç±»èµ„æºä¸‹-pa-è½½-chong"><a href="#è§†é¢‘ç±»èµ„æºä¸‹-pa-è½½-chong" class="headerlink" title="è§†é¢‘ç±»èµ„æºä¸‹ (pa) è½½ (chong)"></a>è§†é¢‘ç±»èµ„æºä¸‹ (pa) è½½ (chong)</h3><p>python è§†é¢‘ä¸‹è½½ä»£ç æ¯”è¾ƒå¤šï¼Œè€Œ ts å’Œ m3u8 æ–‡ä»¶ä¸‹è½½å®Œä¹‹åï¼Œéœ€è¦ä½¿ç”¨ ffmpeg å®Œæˆè§†é¢‘çš„åˆå¹¶ã€‚ffmpeg éœ€è¦ä¸‹è½½ï¼Œç¼–è¯‘åçš„ ffmpeg <a href="https://www.osxexperts.net/">ä¸‹è½½åœ°å€</a>ï¼Œè‡ªå·±ç¼–è¯‘<a href="https://ffmpeg.org/download.html">è®¿é—®åœ°å€</a>ã€‚æ•´ä¸ªçš„ä¸‹è½½ä»£ç å¦‚ä¸‹</p><pre class="line-numbers language-python" data-language="python"><code class="language-python"><span class="token keyword">import</span> os<span class="token punctuation">.</span>path<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>parse<span class="token keyword">import</span> requests<span class="token keyword">import</span> shutil<span class="token keyword">import</span> subprocess<span class="token keyword">import</span> concurrent<span class="token punctuation">.</span>futures<span class="token keyword">def</span> <span class="token function">download_mp4_part_file</span><span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> video_url<span class="token punctuation">)</span><span class="token punctuation">:</span>    download_part_sfile<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> video_url<span class="token punctuation">)</span>    video_file_name <span class="token operator">=</span> video_url<span class="token punctuation">[</span>video_url<span class="token punctuation">.</span>rindex<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    video_file_prefix <span class="token operator">=</span> video_url<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span> video_url<span class="token punctuation">.</span>rindex<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    video_file_path <span class="token operator">=</span> dir_path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> video_file_name    <span class="token keyword">if</span> video_file_name<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'m3u8'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>video_file_path<span class="token punctuation">,</span> <span class="token string">"r"</span><span class="token punctuation">)</span> <span class="token keyword">as</span> f<span class="token punctuation">:</span>            lines <span class="token operator">=</span> f<span class="token punctuation">.</span>readlines<span class="token punctuation">(</span><span class="token punctuation">)</span>        ts_list <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> line <span class="token keyword">in</span> lines<span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token keyword">not</span> line<span class="token punctuation">.</span>startswith<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token keyword">if</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'m3u8'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>                    download_mp4_part_file<span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> video_file_prefix <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token keyword">elif</span> line<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'.ts'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>                    ts_list<span class="token punctuation">.</span>append<span class="token punctuation">(</span>video_file_prefix<span class="token operator">+</span><span class="token string">'/'</span><span class="token operator">+</span>line<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>ts_list<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>            <span class="token keyword">with</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>ThreadPoolExecutor<span class="token punctuation">(</span>max_workers<span class="token operator">=</span><span class="token number">8</span><span class="token punctuation">)</span> <span class="token keyword">as</span> executor<span class="token punctuation">:</span>                futures <span class="token operator">=</span> <span class="token punctuation">[</span>executor<span class="token punctuation">.</span>submit<span class="token punctuation">(</span>download_part_sfile<span class="token punctuation">,</span> dir_path<span class="token punctuation">,</span> ts_url<span class="token punctuation">)</span> <span class="token keyword">for</span> ts_url <span class="token keyword">in</span> ts_list<span class="token punctuation">]</span>                <span class="token keyword">for</span> future <span class="token keyword">in</span> concurrent<span class="token punctuation">.</span>futures<span class="token punctuation">.</span>as_completed<span class="token punctuation">(</span>futures<span class="token punctuation">)</span><span class="token punctuation">:</span>                    result <span class="token operator">=</span> future<span class="token punctuation">.</span>result<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">download_part_sfile</span><span class="token punctuation">(</span>dir_path<span class="token punctuation">,</span> video_url<span class="token punctuation">)</span><span class="token punctuation">:</span>    video_file_name <span class="token operator">=</span> video_url<span class="token punctuation">[</span>video_url<span class="token punctuation">.</span>rindex<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    video_file_path <span class="token operator">=</span> dir_path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> video_file_name    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>video_file_path<span class="token punctuation">)</span><span class="token punctuation">:</span>        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>video_url<span class="token punctuation">)</span>        <span class="token keyword">with</span> <span class="token builtin">open</span><span class="token punctuation">(</span>video_file_path<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span> <span class="token keyword">as</span> <span class="token builtin">file</span><span class="token punctuation">:</span>            <span class="token builtin">file</span><span class="token punctuation">.</span>write<span class="token punctuation">(</span>response<span class="token punctuation">.</span>content<span class="token punctuation">)</span>    <span class="token keyword">return</span> <span class="token boolean">True</span><span class="token keyword">def</span> <span class="token function">download_file</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> module_video<span class="token punctuation">,</span> video_url<span class="token punctuation">)</span><span class="token punctuation">:</span>    video_name <span class="token operator">=</span> module_video<span class="token punctuation">[</span>module_video<span class="token punctuation">.</span>rindex<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>    video_name <span class="token operator">=</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>video_name<span class="token punctuation">)</span>    video_part_name <span class="token operator">=</span> video_name<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span> video_name<span class="token punctuation">.</span>rindex<span class="token punctuation">(</span><span class="token string">'.'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>    video_dir_path <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> module_name <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> video_part_name    <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>video_dir_path<span class="token operator">+</span><span class="token string">'.mp4'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token keyword">return</span>    <span class="token keyword">if</span> <span class="token keyword">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>video_dir_path<span class="token punctuation">)</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>video_dir_path<span class="token punctuation">,</span> <span class="token number">0o777</span><span class="token punctuation">)</span>    download_mp4_part_file<span class="token punctuation">(</span>video_dir_path<span class="token punctuation">,</span> video_url<span class="token punctuation">)</span>    <span class="token keyword">try</span><span class="token punctuation">:</span>        video_file_name <span class="token operator">=</span> video_url<span class="token punctuation">[</span>video_url<span class="token punctuation">.</span>rindex<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token operator">+</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>        subprocess<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'ffmpeg'</span><span class="token punctuation">,</span> <span class="token string">'-i'</span><span class="token punctuation">,</span> video_dir_path<span class="token operator">+</span><span class="token string">'/'</span> <span class="token operator">+</span> video_file_name<span class="token punctuation">,</span> <span class="token string">'-c'</span><span class="token punctuation">,</span> <span class="token string">'copy'</span><span class="token punctuation">,</span> video_dir_path<span class="token operator">+</span><span class="token string">'.mp4'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>    <span class="token keyword">except</span> BaseException <span class="token keyword">as</span> exc<span class="token punctuation">:</span>        <span class="token keyword">print</span><span class="token punctuation">(</span>module_video <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> video_url <span class="token operator">+</span> <span class="token string">"åˆå¹¶è§†é¢‘å¤±è´¥"</span> <span class="token operator">+</span> exc<span class="token punctuation">)</span>    <span class="token keyword">finally</span><span class="token punctuation">:</span>        shutil<span class="token punctuation">.</span>rmtree<span class="token punctuation">(</span>video_dir_path<span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">download</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> module_map<span class="token punctuation">,</span> videos<span class="token punctuation">,</span> video_map<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token keyword">for</span> module_key<span class="token punctuation">,</span> module_videos <span class="token keyword">in</span> videos<span class="token punctuation">.</span>items<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        module_name <span class="token operator">=</span> module_map<span class="token punctuation">[</span>module_key<span class="token punctuation">]</span>        bilibili_videos <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token keyword">for</span> module_video <span class="token keyword">in</span> module_videos<span class="token punctuation">:</span>            <span class="token keyword">if</span> module_video<span class="token punctuation">.</span>find<span class="token punctuation">(</span><span class="token string">'bilibili'</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span>                bilibili_videos<span class="token punctuation">.</span>append<span class="token punctuation">(</span>module_video<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                video_url <span class="token operator">=</span> video_map<span class="token punctuation">[</span>module_video<span class="token punctuation">]</span>                download_file<span class="token punctuation">(</span>path<span class="token punctuation">,</span> module_name<span class="token punctuation">,</span> module_video<span class="token punctuation">,</span> video_url<span class="token punctuation">)</span>        other_video_path <span class="token operator">=</span> path <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> module_name <span class="token operator">+</span> <span class="token string">"/other_video_url.txt"</span>        other_video_file <span class="token operator">=</span> <span class="token builtin">open</span><span class="token punctuation">(</span>other_video_path<span class="token punctuation">,</span> <span class="token string">"w"</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> bilibili_video <span class="token keyword">in</span> bilibili_videos<span class="token punctuation">:</span>            other_video_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span>bilibili_video<span class="token punctuation">)</span>            other_video_file<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">)</span>        other_video_file<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="é™„å½•"><a href="#é™„å½•" class="headerlink" title="é™„å½•"></a>é™„å½•</h3><ul><li><a href="https://www.foxtonforensics.com/browser-history-examiner/chrome-history-location">chrome ç”¨æˆ·ç›®å½•æ–‡ä»¶è§£æ</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> code </tag>
            
            <tag> python </tag>
            
            <tag> tampermonkey </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PDF åˆå¹¶å¤§æ–‡ä»¶çš„ battle</title>
      <link href="/2024/10/10/pdf-he-bing-da-wen-jian-de-battle/"/>
      <url>/2024/10/10/pdf-he-bing-da-wen-jian-de-battle/</url>
      
        <content type="html"><![CDATA[<p>ç›®å‰åœ¨å¸‚é¢ä¸Šæµé€šçš„ java PDF æ“ä½œç»„ä»¶æœ‰ <a href="https://pdfbox.apache.org/">PDFbox</a> å’Œ <a href="https://itextpdf.com/">itextPDF</a>ï¼Œå½“ç„¶å•†ç”¨çš„ä¸åœ¨æˆ‘ä»¬è®¨è®ºçš„èŒƒå›´å†…ã€‚å…¶å®ï¼Œ itextPDF ä¹Ÿæ˜¯æœ‰å•†ç”¨ç‰ˆæœ¬ï¼Œä½†å¥½åƒå…è´¹ç‰ˆæœ¬ä¹Ÿé€‚åˆå¤§å¤šåœºæ™¯ä½¿ç”¨ï¼Œå…¶æ¬¡ä¹Ÿæ²¡åˆ«çš„ä»€ä¹ˆå…è´¹ç»„ä»¶å…±é€‰æ‹©ä¸æ¯”å¯¹ã€‚</p><h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><h4 id="itextPDF"><a href="#itextPDF" class="headerlink" title="itextPDF"></a>itextPDF</h4><p>itextPDF å±äºåŠå…è´¹åŠå•†ä¸šçš„é€‰æ‹©ã€‚åœ¨å®˜ç½‘ä¸Šä¹Ÿæ˜ç¡®å‘ŠçŸ¥ä»€ä¹ˆç»„ä»¶æ˜¯å…è´¹å¼€æºçš„ä»€ä¹ˆç»„ä»¶æ˜¯é—­æºï¼Œä¾›ä½ æŒ‰éœ€æ–¹ä¾¿çš„é€‰æ‹©ã€‚åœ¨ itext 8 äº§å“ç»„ä¸‹ï¼Œ</p><ul><li><a href="https://itextpdf.com/en/products/itext-7/itext-7-core">iText&nbsp;Core</a>&nbsp;(å¼€æº)&nbsp;</li><li><a href="https://itextpdf.com/en/products/itext-7/pdfcalligraph">pdfCalligraph</a>&nbsp;(é—­æº)&nbsp;</li><li><a href="https://itextpdf.com/en/products/itext-7/pdfhtml">pdfHTML</a>*****&nbsp;(å¼€æº)&nbsp;</li><li><a href="https://itextpdf.com/en/products/itext-7/pdfocr" title="pdfOCR">pdfOCR</a>&nbsp;(å¼€æº)</li><li><a href="https://itextpdf.com/en/products/itext-7/pdfsweep">pdfSweep</a>&nbsp;(å¼€æº)&nbsp;</li><li><a href="https://itextpdf.com/en/products/itext-7/pdfxfa">pdfXFA</a>*****&nbsp;(é—­æº)&nbsp;</li><li><a href="https://itextpdf.com/en/products/itext-7/compress-pdf-pdfoptimizer">pdfOptimizer</a>&nbsp;(é—­æº)</li></ul><h4 id="PDFBox"><a href="#PDFBox" class="headerlink" title="PDFBox"></a>PDFBox</h4><p>PDFBox æ˜¯ apache å¼€æºé¡¹ç›®ï¼ŒPDF å¯æ“ä½œçš„åŸºæœ¬ä¸Šéƒ½æ”¯æŒï¼Œä¹Ÿæ˜¯å¸‚é¢ä¸Šè¢«è¿½æ§çš„é¡¹ç›®ï¼Œé¡¹ç›®æ¯”è¾ƒæ´»è·ƒã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å£°æ˜ï¼Œä»…ç«™åœ¨å¤§æ–‡ä»¶åˆå¹¶è¿‡ç¨‹çš„åœºæ™¯ä¸Šåˆ†äº«é€‰æ‹©è¿‡ç¨‹ï¼Œä¸ä½¿ç”¨å°å¿ƒå¾—ã€‚</p></blockquote><h3 id="åˆå¹¶ä»£ç ã€è€—æ—¶åŠæ€§èƒ½æƒ…å†µ"><a href="#åˆå¹¶ä»£ç ã€è€—æ—¶åŠæ€§èƒ½æƒ…å†µ" class="headerlink" title="åˆå¹¶ä»£ç ã€è€—æ—¶åŠæ€§èƒ½æƒ…å†µ"></a>åˆå¹¶ä»£ç ã€è€—æ—¶åŠæ€§èƒ½æƒ…å†µ</h3><h4 id="itextPDF-8-0-5"><a href="#itextPDF-8-0-5" class="headerlink" title="itextPDF 8.0.5"></a>itextPDF 8.0.5</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> mergedFilePath <span class="token operator">=</span> <span class="token string">"/Users/liull/Downloads/merge/itext8_"</span> <span class="token operator">+</span> index <span class="token operator">+</span> <span class="token string">".pdf"</span><span class="token punctuation">;</span><span class="token class-name">String</span> mergeSourcePdfDir <span class="token operator">=</span> <span class="token string">"/Users/liull/Downloads/PDFæ–‡ä»¶"</span><span class="token punctuation">;</span><span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mergeSourcePdfDir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> pdfFiles <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>file <span class="token operator">-&gt;</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"pdf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> failedFileCount <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">OutputStream</span> fileOut <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>mergedFilePath<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">PdfDocument</span> pdfWriterDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PdfDocument</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PdfWriter</span><span class="token punctuation">(</span>fileOut<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">File</span> file<span class="token operator">:</span> pdfFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span><span class="token punctuation">(</span><span class="token class-name">InputStream</span> in <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FileInputStream</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">PdfDocument</span> pdfReaderDoc <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PdfDocument</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PdfReader</span><span class="token punctuation">(</span>in<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">int</span> count <span class="token operator">=</span> pdfReaderDoc<span class="token punctuation">.</span><span class="token function">getNumberOfPages</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                pdfReaderDoc<span class="token punctuation">.</span><span class="token function">copyPagesTo</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> count<span class="token punctuation">,</span> pdfWriterDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>                pdfWriterDoc<span class="token punctuation">.</span><span class="token function">flushCopiedObjects</span><span class="token punctuation">(</span>pdfReaderDoc<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                failedFileCount<span class="token operator">++</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>file<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span><span class="token function">getMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                pdfReaderDoc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    pdfWriterDoc<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"merge cost "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms, files:"</span> <span class="token operator">+</span> pdfFiles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">", failed:"</span> <span class="token operator">+</span> failedFileCount<span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœºå™¨èµ„æºï¼Œå†…å­˜ 4GB CPU 8æ ¸ï¼ˆmacï¼‰</p><table><thead><tr><th>ææ–™é‡</th><th>å¹¶å‘é‡</th><th>è€—æ—¶æƒ…å†µ</th><th>æ˜¯å¦ OOM</th></tr></thead><tbody><tr><td>323 ä¸ªææ–™<br>986.3 MB</td><td>1</td><td>12,139ms</td><td>å¦</td></tr><tr><td>323 ä¸ªææ–™<br>986.3 MB</td><td>5</td><td>24,482ms</td><td>å¦</td></tr><tr><td>323 ä¸ªææ–™<br>986.3 MB</td><td>10</td><td>52,162ms</td><td>å¦</td></tr><tr><td>323 ä¸ªææ–™<br>986.3 MB</td><td>15</td><td>æ— </td><td>æ˜¯</td></tr></tbody></table><p>ä»¥ä¸‹æ˜¯å•çº¿ç¨‹çš„ JVM æƒ…å†µ</p><p><img src="/images/2024/PDFMerge/PDFMerge_itext8_1.png"></p><p>ä»¥ä¸‹æ˜¯ 10 å¹¶å‘çš„ JVM æƒ…å†µ</p><p><img src="/images/2024/PDFMerge/PDFMerge_itext8_10.png"></p><p>æ¯ä¸ªææ–™åœ¨ copy å®Œæˆå, é€šè¿‡ <code>pdfWriterDoc.flushCopiedObjects(pdfReaderDoc);</code> åˆ·åˆ°ç¡¬ç›˜ä¸Šã€‚</p><h4 id="PDFBox-3-0-3"><a href="#PDFBox-3-0-3" class="headerlink" title="PDFBox 3.0.3"></a>PDFBox 3.0.3</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> mergeSourcePdfDir <span class="token operator">=</span> <span class="token string">"/Users/liull/Downloads/PDFæ–‡ä»¶"</span><span class="token punctuation">;</span><span class="token class-name">File</span><span class="token punctuation">[</span><span class="token punctuation">]</span> files <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>mergeSourcePdfDir<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listFiles</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">File</span><span class="token punctuation">&gt;</span></span> pdfFiles <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>files<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>file <span class="token operator">-&gt;</span> file<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">"pdf"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PDFMergerUtility</span> pdfMergerUtility  <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PDFMergerUtility</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pdfMergerUtility<span class="token punctuation">.</span><span class="token function">setAcroFormMergeMode</span><span class="token punctuation">(</span><span class="token class-name">PDFMergerUtility<span class="token punctuation">.</span>AcroFormMergeMode</span><span class="token punctuation">.</span><span class="token constant">PDFBOX_LEGACY_MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pdfMergerUtility<span class="token punctuation">.</span><span class="token function">setDocumentMergeMode</span><span class="token punctuation">(</span><span class="token class-name">PDFMergerUtility<span class="token punctuation">.</span>DocumentMergeMode</span><span class="token punctuation">.</span><span class="token constant">OPTIMIZE_RESOURCES_MODE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pdfMergerUtility<span class="token punctuation">.</span><span class="token function">setIgnoreAcroFormErrors</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>pdfMergerUtility<span class="token punctuation">.</span><span class="token function">setDestinationFileName</span><span class="token punctuation">(</span><span class="token string">"/Users/liull/Downloads/merge/PDFBox_"</span> <span class="token operator">+</span> index <span class="token operator">+</span> <span class="token string">".pdf"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">File</span> file <span class="token operator">:</span> pdfFiles<span class="token punctuation">)</span> <span class="token punctuation">{</span>    pdfMergerUtility<span class="token punctuation">.</span><span class="token function">addSource</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">RandomAccessReadBufferedFile</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token class-name">MemoryUsageSetting</span> memoryUsageSetting <span class="token operator">=</span> <span class="token class-name">MemoryUsageSetting</span><span class="token punctuation">.</span><span class="token function">setupMixed</span><span class="token punctuation">(</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">1024</span><span class="token operator">*</span><span class="token number">256</span><span class="token punctuation">)</span><span class="token punctuation">;</span>memoryUsageSetting<span class="token punctuation">.</span><span class="token function">setTempDir</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span><span class="token string">"/Users/liull/Downloads/merge/temp"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//                    MemoryUsageSetting memoryUsageSetting = MemoryUsageSetting.setupTempFileOnly();</span>pdfMergerUtility<span class="token punctuation">.</span><span class="token function">mergeDocuments</span><span class="token punctuation">(</span>memoryUsageSetting<span class="token punctuation">.</span>streamCache<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">long</span> end <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"merge cost "</span> <span class="token operator">+</span> <span class="token punctuation">(</span>end<span class="token operator">-</span>start<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"ms"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœºå™¨èµ„æºï¼Œå†…å­˜ 4GB CPU 8æ ¸ï¼ˆmacï¼‰</p><table><thead><tr><th>ææ–™é‡</th><th>å¹¶å‘é‡</th><th>è€—æ—¶æƒ…å†µ</th><th>æ˜¯å¦ OOM</th></tr></thead><tbody><tr><td>323 ä¸ªææ–™<br>986.3 MB</td><td>1</td><td>30,899ms</td><td>å¦</td></tr><tr><td>323 ä¸ªææ–™<br>986.3 MB</td><td>5</td><td>æ— </td><td>æ˜¯</td></tr></tbody></table><p>ä»¥ä¸‹æ˜¯å•çº¿ç¨‹çš„ JVM æƒ…å†µ</p><p><img src="/images/2024/PDFMerge/PDFMerge_pdfbox.png"></p><p><strong>å°±æ€§èƒ½æ¯”è¾ƒç»“æœè€Œè¨€ï¼Œitext8 ä¼˜ç§€äº PDFBox çš„è¡¨ç°ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> PDF </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¥½ç”¨çš„ nodejs å¤šç‰ˆæœ¬ç®¡ç†å·¥å…· nvm</title>
      <link href="/2024/09/28/hao-yong-de-nodejs-duo-ban-ben-guan-li-gong-ju-nvm/"/>
      <url>/2024/09/28/hao-yong-de-nodejs-duo-ban-ben-guan-li-gong-ju-nvm/</url>
      
        <content type="html"><![CDATA[<p><a href="https://github.com/nvm-sh/nvm">nvm</a> æ˜¯ä¸€æ¬¾èƒ½å¤Ÿåœ¨ä¸€å°ä¸»æœºä¸Šé€šè¿‡å‘½ä»¤åˆ‡æ¢ node ç‰ˆæœ¬ï¼Œé€‚åˆäºéœ€è¦æ”¯æŒå¤šä¸ªé¡¹ç›®ä¸”é¡¹ç›®ä¹‹é—´éœ€è¦ä¸åŒç‰ˆæœ¬çš„ nodejsã€‚å®‰è£… nvm åå¯ä»¥æŒ‡å®šä¸‹è½½ä¸åŒ node ç‰ˆæœ¬ï¼Œåˆ‡æ¢ node ç‰ˆæœ¬ä¹Ÿæ˜¯ä¸€æ¡å‘½ä»¤çš„äº‹æƒ…ï¼Œç®€å•å¥½æ“ä½œã€‚</p><h3 id="å®‰è£…å‘½ä»¤"><a href="#å®‰è£…å‘½ä»¤" class="headerlink" title="å®‰è£…å‘½ä»¤"></a>å®‰è£…å‘½ä»¤</h3><p>ä½¿ç”¨ curl å‘½ä»¤ æˆ– wget å‘½ä»¤å®‰è£…ï¼Œéœ€è¦æ‰§è¡Œ <code>install.sh</code> ã€‚</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">curl</span> -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh <span class="token operator">|</span> <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">wget</span> -qO- https://raw.githubusercontent.com/nvm-sh/nvm/v0.40.1/install.sh <span class="token operator">|</span> <span class="token function">bash</span><span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre><p>è„šæœ¬è¿è¡Œçš„ç›®çš„æ˜¯å°† nvm èµ„æºè·¯å¾„è®¾ç½®ä¸º <code>~/.nvm</code> å¹¶ä¸”å®‰è£…è·¯å¾„è®¾ç½®ä¸ºç¯å¢ƒå˜é‡ã€‚</p><h3 id="å¸¸ç”¨å‘½ä»¤"><a href="#å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å¸¸ç”¨å‘½ä»¤"></a>å¸¸ç”¨å‘½ä»¤</h3><h4 id="å®‰è£…-nodejs"><a href="#å®‰è£…-nodejs" class="headerlink" title="å®‰è£… nodejs"></a>å®‰è£… nodejs</h4><p>å®‰è£…æŒ‡å®šç‰ˆæœ¬çš„ nodejsï¼Œå¦‚æœåªæ˜¯è¾“å…¥å¤§ç‰ˆæœ¬å·åˆ™å®‰è£…å¤§ç‰ˆæœ¬å·ä¸‹çš„æœ€æ–°å°ç‰ˆæœ¬çš„ nodejs.</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ç›´æ¥å®‰è£…æŒ‡å®šç‰ˆæœ¬å·çš„ nodejs</span>nvm <span class="token function">install</span> <span class="token number">12.22</span>.6<span class="token comment"># ç›´æ¥å®‰è£…æŒ‡å®šå¤§ç‰ˆæœ¬å·ä¸‹æœ€æ–°ç‰ˆæœ¬çš„ nodejs</span>nvm <span class="token function">install</span> <span class="token number">12</span><span class="token comment"># ç›´æ¥å®‰è£… nodejs å‘å¸ƒçš„æœ€æ–°ç‰ˆæœ¬åŒ…</span>nvm <span class="token function">install</span> <span class="token function">node</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ç›¸åº”çš„å¸è½½å°±æ˜¯ install æ¢æˆ uninstall.</p><h4 id="åˆ‡æ¢ä½¿ç”¨-nodejs"><a href="#åˆ‡æ¢ä½¿ç”¨-nodejs" class="headerlink" title="åˆ‡æ¢ä½¿ç”¨ nodejs"></a>åˆ‡æ¢ä½¿ç”¨ nodejs</h4><p>åˆ‡æ¢ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬çš„ nodejs</p><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># ä»£è¡¨ä½¿ç”¨æœ¬åœ°å®‰è£…çš„12å¤§ç‰ˆæœ¬ä¸‹æœ€å¤§ç‰ˆæœ¬çš„ nodejs</span>nvm use <span class="token number">12</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><h4 id="å…¶ä»–å¸¸ç”¨å‘½ä»¤"><a href="#å…¶ä»–å¸¸ç”¨å‘½ä»¤" class="headerlink" title="å…¶ä»–å¸¸ç”¨å‘½ä»¤"></a>å…¶ä»–å¸¸ç”¨å‘½ä»¤</h4><pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token comment"># åˆ—å‡ºæœ¬åœ°å¯ç”¨çš„ nodejs ç‰ˆæœ¬å·</span>nvm <span class="token function">ls</span><span class="token comment"># æŸ¥çœ‹ nodejs ç‰ˆæœ¬çš„å®‰è£…è·¯å¾„</span>nvm <span class="token function">which</span> v20.13.1<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre><p>å‰©ä½™å…¶ä»–åŒ…å«æŒ‡å®šé•œåƒä»“åº“ç­‰ç›´æ¥åœ¨ <code>github</code> ä¸Šæ‰¾ã€‚ÃÃ</p>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è™šæ‹Ÿåˆ—è¡¨åŸºæœ¬å®ç°</title>
      <link href="/2024/07/22/xu-ni-lie-biao-ji-ben-shi-xian/"/>
      <url>/2024/07/22/xu-ni-lie-biao-ji-ben-shi-xian/</url>
      
        <content type="html"><![CDATA[<h2 id="è™šæ‹Ÿåˆ—è¡¨åŸºæœ¬å®ç°"><a href="#è™šæ‹Ÿåˆ—è¡¨åŸºæœ¬å®ç°" class="headerlink" title="è™šæ‹Ÿåˆ—è¡¨åŸºæœ¬å®ç°"></a>è™šæ‹Ÿåˆ—è¡¨åŸºæœ¬å®ç°</h2><p>è™šæ‹Ÿåˆ—è¡¨çš„å®ç°ï¼Œé‡ç‚¹æ˜¯å®ç°â€œå‡è£…â€æ»šåŠ¨æ¡ç”¨ä»¥è®¡ç®—æ»šåŠ¨åˆ°çš„ä½ç½®å¯¹åº”åˆ—è¡¨åŒ¹é…çš„é«˜åº¦ï¼Œè£…è½½å¯¹åº”é«˜åº¦çš„å•é¡µå…ƒç´ åˆ—è¡¨ã€‚ç®€å•æ¥è¯´ï¼Œæ»‘åŠ¨æ»šåŠ¨æ¡åˆ‡æ¢å…ƒç´ åˆ—è¡¨ã€‚</p><p>åˆ—è¡¨å…ƒç´ æ€»é«˜åº¦(topHeight) = (å•å…ƒç´ é«˜åº¦ * åˆ—è¡¨æ•°é‡)ï¼Œæ»šåŠ¨æ¡æœ¬èº«é«˜åº¦ = (divé«˜åº¦)^2/topHeightã€‚ç›‘å¬ä¸¤ç±»äº‹ä»¶ï¼Œä¸€ç±»äº‹ä»¶æ˜¯é¼ æ ‡æ»šåŠ¨äº‹ä»¶ï¼ˆé€‚åˆå±€éƒ¨çŸ­æ»šåŠ¨ï¼‰ï¼Œä¸€ç±»äº‹ä»¶æ˜¯é¼ æ ‡æŒ‰ä¸‹å’Œé‡Šæ”¾äº‹ä»¶ï¼ˆé€‚åˆå¤§æ®µé•¿æ»šåŠ¨ï¼‰ã€‚æ»šåŠ¨å start å…ƒç´ çš„é«˜åº¦ = æ»šåŠ¨åçš„top * topHeight / div é«˜åº¦ï¼Œstartå…ƒç´ ç´¢å¼•ä½ä¸º (startå…ƒç´ é«˜åº¦/å•å…ƒç´ é«˜åº¦ -1) å‘ä¸‹å–æ•´ã€‚æ»šåŠ¨å end å…ƒç´ çš„é«˜åº¦ = ((start å…ƒç´ ç´¢å¼•ä½ + 1) * å•å…ƒç´ é«˜åº¦ + div é«˜åº¦ï¼‰ï¼Œend å…ƒç´ ç´¢å¼•ä½ä¸ºï¼ˆendå…ƒç´ é«˜åº¦/å•å…ƒç´ é«˜åº¦ - 1) å‘ä¸‹å–æ•´ã€‚å½“ç„¶ï¼Œå¦‚æœ topHeight &lt; divHeight é‚£å°±æ²¡æœ‰å¿…è¦å‡ºç°æ»šåŠ¨æ¡ã€‚è¿˜æœ‰å°±æ˜¯è°ƒæ•´çª—å£å¤§å°å…¶å®ä¹Ÿéœ€è¦é‡ç»˜æ»šåŠ¨æ¡æœ¬èº«é«˜åº¦åŠå•é¡µå…ƒç´ åˆ—è¡¨ã€‚</p><h3 id="åˆçº§å®ç°æ­¥éª¤"><a href="#åˆçº§å®ç°æ­¥éª¤" class="headerlink" title="åˆçº§å®ç°æ­¥éª¤"></a>åˆçº§å®ç°æ­¥éª¤</h3><h4 id="æ»šåŠ¨æ¡éƒ¨åˆ†"><a href="#æ»šåŠ¨æ¡éƒ¨åˆ†" class="headerlink" title="æ»šåŠ¨æ¡éƒ¨åˆ†"></a>æ»šåŠ¨æ¡éƒ¨åˆ†</h4><h5 id="vue-æ¨¡æ¿ä»£ç "><a href="#vue-æ¨¡æ¿ä»£ç " class="headerlink" title="vue æ¨¡æ¿ä»£ç "></a>vue æ¨¡æ¿ä»£ç </h5><p>pageHeightï¼Œå½“å‰ div é«˜åº¦ã€‚ topHeightï¼Œéœ€è¦å°†æ»šåŠ¨æ¡å—è¿›è¡Œç§»åŠ¨çš„é«˜åº¦è·ç¦»ã€‚barHeightï¼Œæ»šåŠ¨æ¡å—è‡ªèº«çš„é«˜åº¦ã€‚</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scroll<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scroll<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d-flex scroller border<span class="token punctuation">"</span></span> <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{'height': pageHeight + 'px'}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bar<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>bar<span class="token punctuation">"</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scroller bar<span class="token punctuation">"</span></span>         <span class="token attr-name">:style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{'height': barHeight +'px', 'transform': 'translateY(' + topHeight + 'px)'}<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="css-ä»£ç "><a href="#css-ä»£ç " class="headerlink" title="css ä»£ç "></a>css ä»£ç </h5><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.scroller</span> <span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> 12px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.bar</span> <span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> 8px<span class="token punctuation">;</span>  <span class="token property">margin</span><span class="token punctuation">:</span> 0 1px<span class="token punctuation">;</span>  <span class="token property">position</span><span class="token punctuation">:</span> absolute<span class="token punctuation">;</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>141<span class="token punctuation">,</span> 152<span class="token punctuation">,</span> 164<span class="token punctuation">,</span> 0.75<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token property">border-radius</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.bar:hover</span> <span class="token punctuation">{</span>  <span class="token property">background-color</span><span class="token punctuation">:</span> <span class="token function">rgba</span><span class="token punctuation">(</span>141<span class="token punctuation">,</span> 152<span class="token punctuation">,</span> 164<span class="token punctuation">,</span> 1.25<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="javascript-ä»£ç "><a href="#javascript-ä»£ç " class="headerlink" title="javascript ä»£ç "></a>javascript ä»£ç </h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token literal-property property">totalHeight</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">1000</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token literal-property property">pageHeight</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">1000</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      <span class="token literal-property property">topHeight</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token literal-property property">barHeight</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token literal-property property">isDragging</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>      <span class="token literal-property property">startY</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token literal-property property">startTop</span><span class="token operator">:</span> <span class="token number">0</span>    <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calcBarHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>scroll<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'wheel'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">wheelScroll</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>scroll<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> clientY <span class="token operator">=</span> event<span class="token punctuation">.</span>clientY<span class="token punctuation">;</span>        <span class="token keyword">const</span> top <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>top <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>        <span class="token keyword">let</span> topHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>clientY <span class="token operator">&gt;</span> top<span class="token punctuation">)</span> <span class="token punctuation">{</span>          topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>clientY <span class="token operator">&lt;</span> top<span class="token punctuation">)</span> <span class="token punctuation">{</span>          topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token operator">/</span><span class="token number">10</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>topHeight <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>topHeight <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> topHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noticeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousedown'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>isDragging <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>         console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">startY:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startY<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">down:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>event<span class="token punctuation">.</span>clientY<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>startY <span class="token operator">=</span> event<span class="token punctuation">.</span>clientY<span class="token punctuation">;</span>         <span class="token keyword">this</span><span class="token punctuation">.</span>startTop <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight<span class="token punctuation">;</span>         event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mousemove'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>isDragging<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">const</span> distinctY <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startTop <span class="token operator">-</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>startY <span class="token operator">-</span> event<span class="token punctuation">.</span>clientY<span class="token punctuation">)</span><span class="token punctuation">;</span>        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>index<span class="token operator">++</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">)offset:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>bar<span class="token punctuation">.</span>offsetTop<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">move:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>distinctY<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>        <span class="token keyword">const</span> topHeight <span class="token operator">=</span> distinctY<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>topHeight <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>topHeight <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> topHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noticeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseup'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isDragging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>bar<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'mouseleave'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>isDragging <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token function-variable function">calcBarHeight</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalHeight<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">noticeScroll</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> itemStartHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalHeight<span class="token punctuation">;</span>      <span class="token keyword">const</span> itemEndHeight <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalHeight<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> itemStartHeight<span class="token punctuation">,</span> itemEndHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">refreshScroll</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>totalHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">calcBarHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noticeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">wheelScroll</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      event<span class="token punctuation">.</span><span class="token function">preventDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight<span class="token punctuation">;</span>      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>event<span class="token punctuation">.</span>deltaY<span class="token operator">/</span><span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> latestTopHeight <span class="token operator">=</span> topHeight <span class="token operator">-</span> event<span class="token punctuation">.</span>deltaY<span class="token operator">/</span><span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>latestTopHeight <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>latestTopHeight <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> latestTopHeight<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noticeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">nextOrAbovePage</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">startHeight<span class="token punctuation">,</span> endHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>startHeight <span class="token operator">&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>totalHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>barHeight<span class="token punctuation">;</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noticeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>endHeight <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>topHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>          <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">noticeScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="åˆ—è¡¨éƒ¨åˆ†"><a href="#åˆ—è¡¨éƒ¨åˆ†" class="headerlink" title="åˆ—è¡¨éƒ¨åˆ†"></a>åˆ—è¡¨éƒ¨åˆ†</h4><h5 id="vue-æ¨¡æ¿ä»£ç -1"><a href="#vue-æ¨¡æ¿ä»£ç -1" class="headerlink" title="vue æ¨¡æ¿ä»£ç "></a>vue æ¨¡æ¿ä»£ç </h5><p>itemsï¼Œæ˜¯å½“å‰é¡µéœ€è¦å±•ç¤ºçš„å…ƒç´ é›†åˆã€‚activeItemIdï¼Œæ˜¯å½“å‰è¢«é€‰æ‹©çš„å…ƒç´ ã€‚totalHeightï¼Œæ˜¯æ‰€æœ‰å…ƒç´ å®Œå…¨å±•å¼€é«˜åº¦ã€‚pageHeightï¼Œæ˜¯div#content é«˜åº¦ã€‚scrollItem()ï¼Œæ˜¯ä¾æ®æ»šåŠ¨çš„ startIndex å’Œ endIndex å˜åŒ– items é›†åˆã€‚</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d-flex overflow-y-hidden w-100 h-100<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>list-group h-100 w-280<span class="token punctuation">"</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>content<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>a</span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>#<span class="token punctuation">"</span></span> <span class="token attr-name">:class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>{'list-group-item': true, 'list-group-item-action': true, 'active': item.id == activeItemId}<span class="token punctuation">"</span></span>       <span class="token attr-name">v-for</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item in items<span class="token punctuation">"</span></span> <span class="token attr-name">@key</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>item.id<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>d-flex w-auto justify-content-between<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>mb-1 truncate<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>{{item.filename}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>a</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>scroller</span> <span class="token attr-name">ref</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>cScroller<span class="token punctuation">"</span></span> <span class="token attr-name">:total-height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>totalHeight<span class="token punctuation">"</span></span> <span class="token attr-name">:page-height</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>pageHeight<span class="token punctuation">"</span></span> <span class="token attr-name">@scroll</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>scrollItem<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>scroller</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="css-ä»£ç -1"><a href="#css-ä»£ç -1" class="headerlink" title="css ä»£ç "></a>css ä»£ç </h5><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.truncate</span> <span class="token punctuation">{</span>  <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span>  <span class="token property">text-overflow</span><span class="token punctuation">:</span> ellipsis<span class="token punctuation">;</span>  <span class="token property">white-space</span><span class="token punctuation">:</span> nowrap<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.w-280</span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> 280px <span class="token important">!important</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.list-group</span> <span class="token punctuation">{</span>  <span class="token property">border-radius</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>  <span class="token property">--bs-list-group-active-bg</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--ev-c-purple-soft<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token property">--bs-list-group-active-border-color</span><span class="token punctuation">:</span> <span class="token function">var</span><span class="token punctuation">(</span>--ev-c-purple-soft<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="javascript-ä»£ç -1"><a href="#javascript-ä»£ç -1" class="headerlink" title="javascript ä»£ç "></a>javascript ä»£ç </h5><p>å¦‚æœå…¶ä¸­ fileList ä¼šå˜åŒ–ï¼Œé‚£å°±åœ¨ methods é‡Œé¢ handleResize æ–¹æ³•å˜ç›¸å®Œæˆåˆ·æ–°ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">import</span> scroller <span class="token keyword">from</span> <span class="token string">'../scroller/index.vue'</span><span class="token punctuation">;</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token literal-property property">components</span><span class="token operator">:</span> <span class="token punctuation">{</span>    scroller  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token literal-property property">props</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token literal-property property">itemHeight</span><span class="token operator">:</span> <span class="token punctuation">{</span>      <span class="token literal-property property">type</span><span class="token operator">:</span> Number<span class="token punctuation">,</span>      <span class="token keyword">default</span><span class="token operator">:</span> <span class="token number">50</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      <span class="token literal-property property">activeItemId</span><span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>      <span class="token literal-property property">totalHeight</span><span class="token operator">:</span> <span class="token keyword">null</span><span class="token punctuation">,</span>      <span class="token literal-property property">pageHeight</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>      <span class="token literal-property property">items</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token function">created</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleResize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>content<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'wheel'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>cScroller<span class="token punctuation">.</span><span class="token function">wheelScroll</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'resize'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleResize<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token literal-property property">methods</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token function-variable function">refreshItems</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">items <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>totalHeight <span class="token operator">=</span> items<span class="token punctuation">.</span>length <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>content<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span><span class="token function">commit</span><span class="token punctuation">(</span><span class="token string">'updateFiles'</span><span class="token punctuation">,</span> items<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>cScroller<span class="token punctuation">.</span><span class="token function">refreshScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">handleResize</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>pageHeight <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>content<span class="token punctuation">.</span>offsetHeight<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>cScroller<span class="token punctuation">.</span><span class="token function">refreshScroll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">fileClick</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">item</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>activeItemId <span class="token operator">=</span> item<span class="token punctuation">.</span>id<span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'fileClick'</span><span class="token punctuation">,</span> item<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">partFiles</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">startIndex<span class="token punctuation">,</span> endIndex</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> fileList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>$store<span class="token punctuation">.</span>getters<span class="token punctuation">.</span>getFiles<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>startIndex <span class="token operator">&gt;</span> fileList<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>endIndex <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      startIndex <span class="token operator">=</span> startIndex <span class="token operator">&lt;</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token number">0</span> <span class="token operator">:</span> startIndex<span class="token punctuation">;</span>      endIndex <span class="token operator">=</span> endIndex <span class="token operator">&gt;</span> fileList<span class="token punctuation">.</span>length <span class="token operator">?</span> fileList<span class="token punctuation">.</span>length <span class="token operator">:</span> endIndex<span class="token punctuation">;</span>      <span class="token keyword">return</span> fileList<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">scrollItem</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">startHeight<span class="token punctuation">,</span> endHeight</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>startHeight <span class="token operator">==</span> endHeight<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">const</span> startIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>startHeight <span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> endIndex <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">ceil</span><span class="token punctuation">(</span>endHeight<span class="token operator">/</span> <span class="token keyword">this</span><span class="token punctuation">.</span>itemHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">const</span> items <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">partFiles</span><span class="token punctuation">(</span>startIndex<span class="token punctuation">,</span> endIndex<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>$refs<span class="token punctuation">.</span>cScroller<span class="token punctuation">.</span><span class="token function">nextOrAbovePage</span><span class="token punctuation">(</span>startHeight<span class="token punctuation">,</span> endHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>items<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>items<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="ä½¿ç”¨-vue-state-è¿›è¡Œæ•°æ®å…±äº«"><a href="#ä½¿ç”¨-vue-state-è¿›è¡Œæ•°æ®å…±äº«" class="headerlink" title="ä½¿ç”¨ vue-state è¿›è¡Œæ•°æ®å…±äº«"></a>ä½¿ç”¨ vue-state è¿›è¡Œæ•°æ®å…±äº«</h5><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// store/index.js</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>  <span class="token function-variable function">state</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>    <span class="token keyword">return</span> <span class="token punctuation">{</span>      <span class="token literal-property property">fileList</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token literal-property property">mutations</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token function-variable function">updateFiles</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state<span class="token punctuation">,</span>fileList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">const</span> files <span class="token operator">=</span> state<span class="token punctuation">.</span>fileList<span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span>files<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        files<span class="token punctuation">.</span><span class="token function">splice</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> files<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      files<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>fileList<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span>  <span class="token literal-property property">getters</span><span class="token operator">:</span> <span class="token punctuation">{</span>    <span class="token function-variable function">getFiles</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">state</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> state<span class="token punctuation">.</span>fileList<span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// store/index.js</span><span class="token keyword">import</span> <span class="token punctuation">{</span>createStore<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token keyword">import</span> fileStore <span class="token keyword">from</span> <span class="token string">'./fileStore'</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createStore</span><span class="token punctuation">(</span><span class="token punctuation">{</span>  <span class="token literal-property property">modules</span><span class="token operator">:</span> <span class="token punctuation">{</span>    fileStore  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‰ç«¯æ ·å¼å¸ƒå±€è‡ªé€‚åº”å°ç»“</title>
      <link href="/2024/05/22/qian-duan-yang-shi-bu-ju-zi-gua-ying-xiao-jie/"/>
      <url>/2024/05/22/qian-duan-yang-shi-bu-ju-zi-gua-ying-xiao-jie/</url>
      
        <content type="html"><![CDATA[<p>ä¸€èˆ¬ç”¨æ¥æ­å»ºå¸ƒå±€ä½¿ç”¨çš„å—å…ƒç´ æ˜¯ <code>div</code> ï¼Œä½†ä½ å¯ä»¥ä½¿ç”¨å†…è”å…ƒç´ ï¼ˆä¾‹å¦‚ï¼Œ<code>span</code> ç­‰ï¼‰é€šè¿‡è®¾ç½® <code>display: inline-block</code> å°†å…¶æ”¹ä¸ºå†…è”-å—å…ƒç´ ç”¨æ¥æ­å»ºå¸ƒå±€ã€‚åŒæ ·å—å…ƒç´ ä¹Ÿèƒ½ä¿®æ”¹ä¸ºå†…è”-å—å…ƒç´ ç”¨äºåšå¸ƒå±€ã€‚å—å…ƒç´ ä¸€èˆ¬æ˜¯ä¸€ä¸ªå…ƒç´ å æ®ä¸€è¡Œï¼Œä¸è®ºæ˜¯å¦è®¾ç½® width éƒ½æ˜¯å æ®ä¸€è¡Œã€‚å†…è”å…ƒç´ åˆ™æ˜¯æŒ‰ç…§å†…å®¹å†³å®šå®½åº¦ã€‚å†…è”-å—å…ƒç´ åˆ™å¯ä»¥æŒ‰ç…§è®¾ç½®çš„ width è°ƒæ•´å…ƒç´ åœ¨å•è¡Œå å®½æƒ…å†µã€‚ä¹Ÿå°±æ˜¯ä¸€è¡Œå¯ä»¥æ”¾å¤šä¸ªå†…è”-å—å…ƒç´ ã€å†…è”å…ƒç´ ï¼Œä¸€è¡Œå¯ä»¥æ”¾ä¸€ä¸ªå—å…ƒç´ ã€‚</p><h3 id="ä¸¤ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰"><a href="#ä¸¤ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰" class="headerlink" title="ä¸¤ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰"></a>ä¸¤ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰</h3><pre class="line-numbers language-less" data-language="less"><code class="language-less">    <span class="token selector">.parent</span> <span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.parent2</span><span class="token punctuation">{</span><span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">span</span> <span class="token punctuation">{</span>  <span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token operator">-</span>block<span class="token punctuation">;</span>    <span class="token property">margin-top</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token property">margin-right</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.span_fixed</span> <span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> 37px<span class="token punctuation">;</span><span class="token property">vertical-align</span><span class="token punctuation">:</span> middle<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.span_flex2</span><span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> <span class="token function">calc</span><span class="token punctuation">(</span>100% <span class="token operator">-</span> 60px<span class="token punctuation">)</span><span class="token punctuation">;</span>         <span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span><span class="token property">text-overflow</span><span class="token punctuation">:</span> ellipsis<span class="token punctuation">;</span><span class="token property">white-space</span><span class="token punctuation">:</span> nowrap<span class="token punctuation">;</span><span class="token property">vertical-align</span><span class="token punctuation">:</span> middle<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.span_flex</span> <span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span> inline<span class="token operator">-</span>block<span class="token punctuation">;</span><span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">,</span><span class="token property">--webkit-box-flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span><span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span><span class="token property">text-overflow</span><span class="token punctuation">:</span> ellipsis<span class="token punctuation">;</span><span class="token property">white-space</span><span class="token punctuation">:</span> nowrap<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_fixed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>fixed<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_flex<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>span_flexspan_flexspan_flexspan_flex<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_fixed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>fixed<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_flex2<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>span_flexspan_flexspan_flexspan_flexspan_flexspan_flexspan_flexspan_flexspan_flex<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="ä¸‰ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ å®½åº¦ä¸å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰"><a href="#ä¸‰ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ å®½åº¦ä¸å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰" class="headerlink" title="ä¸‰ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ å®½åº¦ä¸å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰"></a>ä¸‰ä¸ªå…ƒç´ ï¼ˆä¸€ä¸ªå…ƒç´ å®½åº¦å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ å®½åº¦ä¸å›ºå®šï¼Œä¸€ä¸ªå…ƒç´ è‡ªé€‚åº”ï¼‰</h3><pre class="line-numbers language-css" data-language="css"><code class="language-css"><span class="token selector">.parent</span> <span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span><span class="token property">width</span><span class="token punctuation">:</span> 400px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">span</span> <span class="token punctuation">{</span>  <span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span>    <span class="token property">margin-top</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token property">margin-bottom</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token property">margin-right</span><span class="token punctuation">:</span> 5px<span class="token punctuation">;</span><span class="token property">border</span><span class="token punctuation">:</span> 1px solid<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.span_fixed</span> <span class="token punctuation">{</span>  <span class="token property">width</span><span class="token punctuation">:</span> 37px<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token selector">.span_flex</span> <span class="token punctuation">{</span><span class="token property">display</span><span class="token punctuation">:</span> inline-block<span class="token punctuation">;</span><span class="token property">flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">,</span><span class="token property">--webkit-box-flex</span><span class="token punctuation">:</span> 1<span class="token punctuation">;</span><span class="token property">overflow</span><span class="token punctuation">:</span> hidden<span class="token punctuation">;</span><span class="token property">text-overflow</span><span class="token punctuation">:</span> ellipsis<span class="token punctuation">;</span><span class="token property">white-space</span><span class="token punctuation">:</span> nowrap<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>parent<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_fixed<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>fixed<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_active<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>span_activespan_active<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>span</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>span_flex<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>span_flexspan_flexspan_flexspan_flex<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>span</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
            <tag> css </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>PDFæ–‡ä»¶WEBç«¯åŠ é€Ÿè£…è½½</title>
      <link href="/2024/05/22/pdf-wen-jian-web-duan-jia-su-zhuang-zai/"/>
      <url>/2024/05/22/pdf-wen-jian-web-duan-jia-su-zhuang-zai/</url>
      
        <content type="html"><![CDATA[<p>å½“å‡ºç°å¤§æ–‡ä»¶ pdf è£…è½½æ—¶ï¼Œpdf.js ä½¿ç”¨åˆ†æ®µä¸‹è½½å’ŒæœŸæœ› pdf æ˜¯çº¿æ€§åŒ– pdf æ¥è¾¾åˆ°å°½å¯èƒ½å¿«çš„åŠ è½½ pdf é¦–é¡µã€‚å¯¹äºå°æ–‡ä»¶ pdf.js åˆ™æ˜¯ç­‰å¾… pdf å®Œæ•´ä¸‹è½½åå†åˆ†æåŠ è½½ pdf é¦–é¡µã€‚</p><p>ä½†æ˜¯ï¼Œåœ¨é¡¹ç›®è¿è¡Œè¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰çœ‹åˆ° pdf.js åˆ†æ®µä¸‹è½½ï¼Œä¸è®º pdf æ–‡ä»¶å¤§å°éƒ½éœ€è¦ç­‰åˆ°ä¸‹è½½å®Œæ¯•å pdf.js æ‰å¼€å§‹æ¸²æŸ“ã€‚<font color="red">è¿™ä¸­é—´ä¸€å®šæœ‰ä»€ä¹ˆè¯¯ä¼šã€‚</font></p><p>å› ä¸ºå¯¹ pdf.js å¹¶ä¸ç†Ÿæ‚‰ï¼Œåªèƒ½ä» pdf æ–‡ä»¶ä¸‹è½½åå‘æ‰¾é€»è¾‘ï¼Œæœ€ç»ˆæ‰¾å‡ºäº†é—®é¢˜æ‰€åœ¨ï¼Œå¹¶ç›˜ä¸€ä¸‹ pdf.js åˆ†æ®µä¸‹è½½å®ç°é€»è¾‘ã€‚</p><h3 id="çº¿æ€§åŒ–-PDF-åŸºç¡€çŸ¥è¯†"><a href="#çº¿æ€§åŒ–-PDF-åŸºç¡€çŸ¥è¯†" class="headerlink" title="çº¿æ€§åŒ– PDF åŸºç¡€çŸ¥è¯†"></a>çº¿æ€§åŒ– PDF åŸºç¡€çŸ¥è¯†</h3><p>çº¿æ€§åŒ– PDF ä¸»è¦èšç„¦äºä¼˜åŒ–åªè¯» PDF æ–‡æ¡£çš„æŸ¥çœ‹ï¼Œçº¿æ€§åŒ– PDF æœ€å¥½æ˜¯ç”Ÿæˆä¸€æ¬¡è¯»å–å¤šæ¬¡çš„åœºæ™¯ã€‚å¦‚æœå‡ºç° PDF å†…å®¹å˜æ›´ï¼Œåˆ™éœ€è¦é‡æ–°æ„å»ºçº¿æ€§åŒ– PDFã€‚è€Œçº¿æ€§åŒ– PDF è¦æ±‚å°†ç¬¬ä¸€é¡µä¿¡æ¯æ”¾åœ¨ PDF å‰éƒ¨ä½ç½®ï¼Œä¸ºäº†èƒ½è®© WEB ç«¯èƒ½å¿«é€ŸåŠ è½½ç¬¬ä¸€é¡µã€‚å…¶ä¸­ï¼Œçº¿æ€§åŒ– PDF æ–‡æ¡£ç»“æ„å¦‚ä¸‹</p><pre class="line-numbers language-none"><code class="language-none">&lt;&lt; /Linearized 1 /L 136764335 /H [ 632 76194 ] /O 27610 /E 776091 /N 5500 /T 136598419 &gt;&gt;&lt;&lt; /Type /XRef /Filter /FlateDecode /Length 69 /W [ 1 3 1 ] /Index [ 27606 16 ]   /ID [&lt;6C3B266F4EDFA286BC2F2B6DF32B4233&gt;&lt;41432D38312D46432D35412D39342D46&gt;]    /Info 27603 0 R         /Root 27608 0 R         /Size 27622 /Prev 136598420   &gt;&gt;stream// PDF å…¶ä»–æ–‡æ¡£ç»“æ„å†…å®¹....<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><p>çº¿æ€§åŒ– header</p><ul><li><p><code>/Linearized</code>ï¼Œæ ‡è®°çº¿æ€§åŒ– PDF</p></li><li><p><code>/L</code>ï¼ŒPDF æ–‡ä»¶å¤§å°</p></li><li><p><code>/H</code>ï¼ŒPrimary hint stream çš„èµ·å§‹ä½ç½®åŠé•¿åº¦</p></li><li><p><code>/O</code>ï¼Œç¬¬ä¸€é¡µçš„å†…å®¹å¯¹è±¡èŠ‚ç‚¹</p></li><li><p><code>/E</code>ï¼Œç¬¬ä¸€é¡µç»“æŸçš„ offset</p></li><li><p><code>/N</code>ï¼ŒPDF æ€»é¡µæ•°</p></li></ul></li><li><p>XRef Tableï¼Œåˆå§‹çš„ XRef è¡¨ï¼Œåˆ—å‡ºæ–‡ä»¶çš„å¼€å§‹å¯¹è±¡ï¼ŒåŒ…æ‹¬æ–‡æ¡£ç›®å½•ï¼ˆTOCï¼‰ã€é¡µå¯¹è±¡å’Œå…¶ä»–å…³é”®å¯¹è±¡ã€‚</p></li><li><p>è·Ÿéš XRefTable ä¹‹åï¼ŒåŒ…æ‹¬ç¬¬ä¸€é¡µçš„æ•°æ®å’Œæ‰€æœ‰ä¸ç¬¬ä¸€é¡µç›¸å…³è”çš„å¯¹è±¡ï¼Œå¦‚å›¾åƒã€å­—ä½“å’Œå…ƒæ•°æ®ã€‚è¿™äº›å¯¹è±¡æŒ‰é¡ºåºç¼–å·ï¼Œä»¥ä¾¿å¿«é€ŸåŠ è½½ç¬¬ä¸€é¡µã€‚</p></li></ul><h3 id="åˆ†æ®µä¸‹è½½é€»è¾‘æ€è·¯"><a href="#åˆ†æ®µä¸‹è½½é€»è¾‘æ€è·¯" class="headerlink" title="åˆ†æ®µä¸‹è½½é€»è¾‘æ€è·¯"></a>åˆ†æ®µä¸‹è½½é€»è¾‘æ€è·¯</h3><p>åˆ†æ®µä¸‹è½½æ˜¯éœ€è¦å’Œåç«¯äº¤äº’ n+1 æ¬¡ï¼Œå…¶ä¸­ n ä¸º <code>ææ–™å¤§å°/åˆ†ç‰‡å¤§å°</code> å€¼ã€‚å¤§è‡´åˆ†æ®µä¸‹è½½æµè½¬å¦‚å›¾</p><p><img src="/./images/2024/pdf_web_view/pdf_1.png" alt="download_2.jpg"></p><p>ç¬¬ 1 æ¬¡ï¼Œè¦æ±‚åç«¯å“åº”å“åº”çŠ¶æ€ï¼ˆ<code>HttpStatus:200</code>ï¼‰ï¼Œæä¾› <code>response-headers</code> åŒ…å« <code>Accept-Ranges:bytes</code>ã€<code>Content-Encoding:identity</code>ã€<code>Content-Length:xxxxxx</code>ï¼ˆæ–‡ä»¶å¤§å°ï¼‰ï¼Œä½†ä¹Ÿè¦æä¾›æ–‡ä»¶å­—èŠ‚æµå†™å…¥ <code>Response Stream</code> ä¸­ï¼Œå¦åˆ™ä¼šå¯¼è‡´è¯·æ±‚å¡åœåœ¨åç«¯å¤„ç†ã€‚</p><p>ç¬¬ 2 åˆ° n æ¬¡ï¼Œéœ€è¦æä¾›è¯·æ±‚ header åŒ…å« <code>Range:bytes=startIndex-endIndex</code>ï¼Œå“åº” header åŒ…å« <code>Content-Range:bytes startIndex-endIndex/æ–‡ä»¶é•¿åº¦</code>ã€<code>Content-Length: å½“å‰åˆ†æ®µéœ€è¦çš„å†…å®¹é•¿åº¦</code> å’Œå¯¹åº”å½“å‰åˆ†æ®µçš„æ–‡ä»¶å­—èŠ‚æµã€‚</p><p>ä½†æ˜¯ï¼Œç¬¬ 1 æ¬¡å“åº”å·²ç»å†™å…¥å­—èŠ‚æµï¼Œä¹Ÿå°±æ˜¯æ–‡ä»¶å†…å®¹ã€‚ä¹Ÿè¦æ±‚åœ¨åˆ†æ®µä¸‹è½½æ—¶ï¼Œå¦‚æœå‡ºç°åˆ†æ®µä¸‹è½½éœ€æ±‚æ—¶ï¼Œ<strong>éœ€è¦å°†ç¬¬ 1 æ¬¡è¯·æ±‚ç»ˆæ­¢ä¸å†æ¥æ”¶åç»­å­—èŠ‚</strong> ï¼Œè½¬è€Œå‘èµ· 2+ æ¬¡ range è¯·æ±‚ã€‚</p><h3 id="pdf-js-åˆ†æ®µä¸‹è½½ä»£ç "><a href="#pdf-js-åˆ†æ®µä¸‹è½½ä»£ç " class="headerlink" title="pdf.js åˆ†æ®µä¸‹è½½ä»£ç "></a>pdf.js åˆ†æ®µä¸‹è½½ä»£ç </h3><p>ç¬¬ 1 æ¬¡è¯·æ±‚å‘èµ·ä»£ç ä½ç½®äº <code>pdf.worker.js</code> çš„ <code>PDFNetworkStreamFullRequestReader</code> å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">PDFNetworkStreamFullRequestReader</span><span class="token punctuation">(</span><span class="token parameter">manager<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_manager <span class="token operator">=</span> manager<span class="token punctuation">;</span>  <span class="token keyword">var</span> source <span class="token operator">=</span> options<span class="token punctuation">.</span>source<span class="token punctuation">;</span>  <span class="token keyword">var</span> args <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token literal-property property">onHeadersReceived</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_onHeadersReceived</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">onProgressiveData</span><span class="token operator">:</span> source<span class="token punctuation">.</span>disableStream <span class="token operator">?</span> <span class="token keyword">null</span> <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_onProgressiveData</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">onDone</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_onDone</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">onError</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_onError</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span>    <span class="token literal-property property">onProgress</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_onProgress</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_url <span class="token operator">=</span> source<span class="token punctuation">.</span>url<span class="token punctuation">;</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>_fullRequestId <span class="token operator">=</span> manager<span class="token punctuation">.</span><span class="token function">requestFull</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//....</span><span class="token punctuation">}</span><span class="token class-name">PDFNetworkStreamFullRequestReader</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function-variable function">_validateRangeRequestCapabilities</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">PDFNetworkStreamFullRequestReader_validateRangeRequestCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_disableRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> networkManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_manager<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>networkManager<span class="token punctuation">.</span>isHttp<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> fullRequestXhrId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_fullRequestId<span class="token punctuation">;</span>    <span class="token keyword">var</span> fullRequestXhr <span class="token operator">=</span> networkManager<span class="token punctuation">.</span><span class="token function">getRequestXhr</span><span class="token punctuation">(</span>fullRequestXhrId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fullRequestXhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> contentEncoding <span class="token operator">=</span> fullRequestXhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'identity'</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentEncoding <span class="token operator">!==</span> <span class="token string">'identity'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> length <span class="token operator">=</span> fullRequestXhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    length <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInt</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_contentLength <span class="token operator">=</span> length<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rangeChunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token function-variable function">_onHeadersReceived</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">PDFNetworkStreamFullRequestReader_onHeadersReceived</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_validateRangeRequestCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_isRangeSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> networkManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_manager<span class="token punctuation">;</span>    <span class="token keyword">var</span> fullRequestXhrId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_fullRequestId<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>networkManager<span class="token punctuation">.</span><span class="token function">isStreamingRequest</span><span class="token punctuation">(</span>fullRequestXhrId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>_isStreamingSupported <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_isRangeSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>      networkManager<span class="token punctuation">.</span><span class="token function">abortRequest</span><span class="token punctuation">(</span>fullRequestXhrId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_headersReceivedCapability<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åˆ†æ®µè¯·æ±‚å‘èµ·ä»£ç ä½ç½® <code>pdf.worker.js</code> çš„ <code>loadDocument</code> å‡½æ•°</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">function</span> <span class="token function">loadDocument</span><span class="token punctuation">(</span><span class="token parameter">recoveryMode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> loadDocumentCapability <span class="token operator">=</span> <span class="token function">createPromiseCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> <span class="token function-variable function">parseSuccess</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">parseSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> numPagesPromise <span class="token operator">=</span> pdfManager<span class="token punctuation">.</span><span class="token function">ensureDoc</span><span class="token punctuation">(</span><span class="token string">'numPages'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> fingerprintPromise <span class="token operator">=</span> pdfManager<span class="token punctuation">.</span><span class="token function">ensureDoc</span><span class="token punctuation">(</span><span class="token string">'fingerprint'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> encryptedPromise <span class="token operator">=</span> pdfManager<span class="token punctuation">.</span><span class="token function">ensureXRef</span><span class="token punctuation">(</span><span class="token string">'encrypt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span><span class="token punctuation">[</span>numPagesPromise<span class="token punctuation">,</span> fingerprintPromise<span class="token punctuation">,</span> encryptedPromise<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token function">onDocReady</span><span class="token punctuation">(</span><span class="token parameter">results</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">var</span> doc <span class="token operator">=</span> <span class="token punctuation">{</span>            <span class="token literal-property property">numPages</span><span class="token operator">:</span> results<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">fingerprint</span><span class="token operator">:</span> results<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">encrypted</span><span class="token operator">:</span> <span class="token operator">!</span><span class="token operator">!</span>results<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">,</span>            <span class="token literal-property property">info</span><span class="token operator">:</span> pdfManager<span class="token punctuation">.</span>_info          <span class="token punctuation">}</span><span class="token punctuation">;</span>          loadDocumentCapability<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>doc<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> parseFailure<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> <span class="token function-variable function">parseFailure</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">parseFailure</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        loadDocumentCapability<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">;</span>      pdfManager<span class="token punctuation">.</span><span class="token function">ensureDoc</span><span class="token punctuation">(</span><span class="token string">'checkHeader'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        pdfManager<span class="token punctuation">.</span><span class="token function">ensureDoc</span><span class="token punctuation">(</span><span class="token string">'parseStartXRef'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          pdfManager<span class="token punctuation">.</span><span class="token function">ensureDoc</span><span class="token punctuation">(</span><span class="token string">'parse'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span>recoveryMode<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>parseSuccess<span class="token punctuation">,</span> parseFailure<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> parseFailure<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">,</span> parseFailure<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> loadDocumentCapability<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>    <span class="token punctuation">}</span>Util<span class="token punctuation">.</span><span class="token function">inherit</span><span class="token punctuation">(</span>NetworkPdfManager<span class="token punctuation">,</span> BasePdfManager<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token function-variable function">ensure</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">NetworkPdfManager_ensure</span><span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> prop<span class="token punctuation">,</span> args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> pdfManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">function</span> <span class="token function">ensureHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">var</span> result<span class="token punctuation">;</span>            <span class="token keyword">var</span> value <span class="token operator">=</span> obj<span class="token punctuation">[</span>prop<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> value <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              result <span class="token operator">=</span> <span class="token function">value</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>              result <span class="token operator">=</span> value<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>e <span class="token keyword">instanceof</span> <span class="token class-name">MissingDataException</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            pdfManager<span class="token punctuation">.</span>streamManager<span class="token punctuation">.</span><span class="token function">requestRange</span><span class="token punctuation">(</span>e<span class="token punctuation">.</span>begin<span class="token punctuation">,</span> e<span class="token punctuation">.</span>end<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>ensureHelper<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token function">ensureHelper</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">ChunkedStreamManager</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span>     <span class="token function-variable function">sendRequest</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">ChunkedStreamManager_sendRequest</span><span class="token punctuation">(</span><span class="token parameter">begin<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> rangeReader <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pdfNetworkStream<span class="token punctuation">.</span><span class="token function">getRangeReader</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rangeReader<span class="token punctuation">.</span>isStreamingSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>        rangeReader<span class="token punctuation">.</span>onProgress <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">var</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>          loaded <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> manager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> <span class="token function-variable function">readChunk</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunk<span class="token punctuation">.</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token keyword">var</span> data <span class="token operator">=</span> chunk<span class="token punctuation">.</span>value<span class="token punctuation">;</span>              chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>              loaded <span class="token operator">+=</span> <span class="token function">arrayByteLength</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">if</span> <span class="token punctuation">(</span>rangeReader<span class="token punctuation">.</span>isStreamingSupported<span class="token punctuation">)</span> <span class="token punctuation">{</span>                manager<span class="token punctuation">.</span><span class="token function">onProgress</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">loaded</span><span class="token operator">:</span> loaded <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token punctuation">}</span>              rangeReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>readChunk<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>              <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">var</span> chunkData <span class="token operator">=</span> <span class="token function">arraysToBytes</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>            chunks <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token function">resolve</span><span class="token punctuation">(</span>chunkData<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>          <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>        rangeReader<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>readChunk<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>aborted<span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">onReceiveData</span><span class="token punctuation">(</span><span class="token punctuation">{</span>          <span class="token literal-property property">chunk</span><span class="token operator">:</span> data<span class="token punctuation">,</span>          <span class="token literal-property property">begin</span><span class="token operator">:</span> begin        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token function-variable function">_requestChunks</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">ChunkedStreamManager_requestChunks</span><span class="token punctuation">(</span><span class="token parameter">chunks</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> requestId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>currRequestId<span class="token operator">++</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> i<span class="token punctuation">,</span> ii<span class="token punctuation">;</span>      <span class="token keyword">var</span> chunksNeeded <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">create</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>chunksNeededByRequest<span class="token punctuation">[</span>requestId<span class="token punctuation">]</span> <span class="token operator">=</span> chunksNeeded<span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> ii <span class="token operator">=</span> chunks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ii<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>stream<span class="token punctuation">.</span><span class="token function">hasChunk</span><span class="token punctuation">(</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          chunksNeeded<span class="token punctuation">[</span>chunks<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isEmptyObj</span><span class="token punctuation">(</span>chunksNeeded<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">var</span> capability <span class="token operator">=</span> <span class="token function">createPromiseCapability</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>promisesByRequest<span class="token punctuation">[</span>requestId<span class="token punctuation">]</span> <span class="token operator">=</span> capability<span class="token punctuation">;</span>      <span class="token keyword">var</span> chunksToRequest <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> chunk <span class="token keyword">in</span> chunksNeeded<span class="token punctuation">)</span> <span class="token punctuation">{</span>        chunk <span class="token operator">=</span> chunk <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>chunk <span class="token keyword">in</span> <span class="token keyword">this</span><span class="token punctuation">.</span>requestsByChunk<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>          <span class="token keyword">this</span><span class="token punctuation">.</span>requestsByChunk<span class="token punctuation">[</span>chunk<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>          chunksToRequest<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>requestsByChunk<span class="token punctuation">[</span>chunk<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>requestId<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>chunksToRequest<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> capability<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">var</span> groupedChunksToRequest <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">groupChunks</span><span class="token punctuation">(</span>chunksToRequest<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span>i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> groupedChunksToRequest<span class="token punctuation">.</span>length<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> groupedChunk <span class="token operator">=</span> groupedChunksToRequest<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">var</span> begin <span class="token operator">=</span> groupedChunk<span class="token punctuation">.</span>beginChunk <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">;</span>        <span class="token keyword">var</span> end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>groupedChunk<span class="token punctuation">.</span>endChunk <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>chunkSize<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendRequest</span><span class="token punctuation">(</span>begin<span class="token punctuation">,</span> end<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> capability<span class="token punctuation">.</span>promise<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token function-variable function">requestRange</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">ChunkedStreamManager_requestRange</span><span class="token punctuation">(</span><span class="token parameter">begin<span class="token punctuation">,</span> end</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      end <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>end<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> beginChunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getBeginChunk</span><span class="token punctuation">(</span>begin<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> endChunk <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getEndChunk</span><span class="token punctuation">(</span>end<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token keyword">var</span> chunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> chunk <span class="token operator">=</span> beginChunk<span class="token punctuation">;</span> chunk <span class="token operator">&lt;</span> endChunk<span class="token punctuation">;</span> <span class="token operator">++</span>chunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>        chunks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token punctuation">}</span>      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_requestChunks</span><span class="token punctuation">(</span>chunks<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>pdf.js åœ¨åˆ†æè¿‡ç¨‹ä¸­å¯ä»¥ä¾æ®åˆ†æè¿‡ç¨‹æŒ‰éœ€è¯·æ±‚åˆ†æ®µï¼Œæ¯”å¦‚éœ€è¦ç¬¬ 100 æ®µï¼Œåˆ™å¯ä»¥åœ¨ç¬¬äºŒä¸ªè¯·æ±‚é‡Œç›´æ¥æŒ‡å®šè¦ç¬¬ 100 æ®µçš„å­—èŠ‚æµã€‚è¿™æ ·é€‚ç”¨äºé¦–é¡µè£…è½½ã€‚</p><h3 id="åç«¯å®ç°åˆ†æ®µä¸‹è½½é—®é¢˜ä»£ç "><a href="#åç«¯å®ç°åˆ†æ®µä¸‹è½½é—®é¢˜ä»£ç " class="headerlink" title="åç«¯å®ç°åˆ†æ®µä¸‹è½½é—®é¢˜ä»£ç "></a>åç«¯å®ç°åˆ†æ®µä¸‹è½½é—®é¢˜ä»£ç </h3><p>åç«¯ä»£ç ä¸»è¦é—®é¢˜æ˜¯æœªåœ¨ç¬¬ä¸€æ¬¡è¯·æ±‚å“åº”ä¸­æä¾› <code>Content-Length</code> header å¯¼è‡´æ²¡æœ‰è§¦å‘åˆ†æ®µä¸‹è½½ã€‚å‰ç«¯åˆ¤æ–­ä»£ç </p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">PDFNetworkStreamFullRequestReader</span><span class="token punctuation">.</span>prototype <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token function-variable function">_validateRangeRequestCapabilities</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">PDFNetworkStreamFullRequestReader_validateRangeRequestCapabilities</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_disableRange<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> networkManager <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_manager<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>networkManager<span class="token punctuation">.</span>isHttp<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> fullRequestXhrId <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_fullRequestId<span class="token punctuation">;</span>    <span class="token keyword">var</span> fullRequestXhr <span class="token operator">=</span> networkManager<span class="token punctuation">.</span><span class="token function">getRequestXhr</span><span class="token punctuation">(</span>fullRequestXhrId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>fullRequestXhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Accept-Ranges'</span><span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'bytes'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> contentEncoding <span class="token operator">=</span> fullRequestXhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Encoding'</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token string">'identity'</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>contentEncoding <span class="token operator">!==</span> <span class="token string">'identity'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">var</span> length <span class="token operator">=</span> fullRequestXhr<span class="token punctuation">.</span><span class="token function">getResponseHeader</span><span class="token punctuation">(</span><span class="token string">'Content-Length'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    length <span class="token operator">=</span> <span class="token function">parseInt</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isInt</span><span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>_contentLength <span class="token operator">=</span> length<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>length <span class="token operator">&lt;=</span> <span class="token number">2</span> <span class="token operator">*</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_rangeChunkSize<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>range ä¿®æ”¹åä»£ç </p><pre class="line-numbers language-java" data-language="java"><code class="language-java">response<span class="token punctuation">.</span><span class="token function">setCharacterEncoding</span><span class="token punctuation">(</span><span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">setBufferSize</span><span class="token punctuation">(</span><span class="token constant">DEFAULT_BUFFER_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">ACCESS_CONTROL_ALLOW_ORIGIN</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">ACCESS_CONTROL_ALLOW_CREDENTIALS</span><span class="token punctuation">,</span> <span class="token string">"true"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">ACCESS_CONTROL_REQUEST_METHOD</span><span class="token punctuation">,</span> <span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">ACCESS_CONTROL_EXPOSE_HEADERS</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">ACCEPT_RANGES</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_RANGE</span><span class="token punctuation">,</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_DISPOSITION</span><span class="token punctuation">,</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_LENGTH</span><span class="token punctuation">,</span>                    <span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">TRANSFER_ENCODING</span><span class="token punctuation">,</span> <span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_ENCODING</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token char">','</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è®¾ç½® Content-Type</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setResponseContentType</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> fileStoreName<span class="token punctuation">,</span> fileName<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å†…å®¹è£…è½½æ–¹å¼ï¼Œæ˜¯inline æˆ–æ˜¯ç›´æ¥ä¸‹è½½</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setResponseAttachment</span><span class="token punctuation">(</span>response<span class="token punctuation">,</span> request<span class="token punctuation">,</span> <span class="token class-name">StringKit</span><span class="token punctuation">.</span><span class="token function">defaultIfBlank</span><span class="token punctuation">(</span>fileName<span class="token punctuation">,</span> fileStoreName<span class="token punctuation">)</span><span class="token punctuation">,</span>                    responseContentDisposition<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// </span><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringKit</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>range<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name">HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">ACCEPT_RANGES</span><span class="token punctuation">,</span> <span class="token string">"bytes"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  response<span class="token punctuation">.</span><span class="token function">setContentLengthLong</span><span class="token punctuation">(</span>æ–‡ä»¶é•¿åº¦<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">InputStream</span> in <span class="token operator">=</span> storageService<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span>protocol<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">IOUtils</span><span class="token punctuation">.</span><span class="token function">copyLarge</span><span class="token punctuation">(</span>in<span class="token punctuation">,</span> response<span class="token punctuation">.</span><span class="token function">getOutputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">flushBuffer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>  <span class="token keyword">return</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token comment">// æŒ‰rangeæ‹·è´å­—èŠ‚ï¼Œéœ€è¦è®¾ç½®header</span><span class="token comment">// å•ä¸ª range header</span>response<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token class-name"><span class="token namespace">org<span class="token punctuation">.</span>springframework<span class="token punctuation">.</span>http<span class="token punctuation">.</span></span>HttpHeaders</span><span class="token punctuation">.</span><span class="token constant">CONTENT_RANGE</span><span class="token punctuation">,</span>                    <span class="token string">"bytes "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>start <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>end <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span>            response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_PARTIAL_CONTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¤šä¸ª range headerï¼Œå“åº”ä½“ä¸­æŒ‰range åŒºåˆ†èµ·å§‹ä¸ç»“æŸæ ‡è¯†</span>response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"multipart/byteranges; boundary=MULTIPART_BYTERANGES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpServletResponse</span><span class="token punctuation">.</span><span class="token constant">SC_PARTIAL_CONTENT</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--MULTIPART_BYTERANGES"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"Content-Range: bytes "</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>start <span class="token operator">+</span> <span class="token string">"-"</span> <span class="token operator">+</span> r<span class="token punctuation">.</span>end <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> total<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¡«å…… range å¯¹åº”å­—èŠ‚ä¿¡æ¯</span><span class="token comment">// End with multipart boundary.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"--MULTIPART_BYTERANGES--"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‰ç«¯ </tag>
            
            <tag> PDF </tag>
            
            <tag> pdf.js </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>vue 5w ä¸ªèŠ‚ç‚¹æ ‘æ€§èƒ½ä¼˜åŒ–</title>
      <link href="/2024/04/06/vue-5w-ge-jie-dian-shu-xing-neng-you-hua/"/>
      <url>/2024/04/06/vue-5w-ge-jie-dian-shu-xing-neng-you-hua/</url>
      
        <content type="html"><![CDATA[<p>è¿‘æœŸå·¥ä½œä¸­é’ˆå¯¹æ¡£æ¡ˆæ–‡ä»¶å‹æ ‘å±•ç¤ºå®Œæˆä¼˜åŒ–ã€‚ä¼˜åŒ–ç›®æ ‡ä¸ºåœ¨<strong>ç§’çº§</strong>è£…è½½é¡µé¢ï¼Œå¹¶ä¸”æ“ä½œä¸å…è®¸å¡é¡¿ã€‚è€ŒåŸºæœ¬è¦æ±‚æ”¯æ’‘<strong>ä¸‡çº§</strong>æ–‡ä»¶çš„å±•ç¤ºä¸æ“ä½œã€‚</p><p>åœ¨ä¼˜åŒ–ä¹‹å‰ï¼Œé¡µé¢è£…è½½ 5w ææ–™é‡å…¨éƒ¨è£…è½½å®Œæ¯•å¤§çº¦åœ¨ 1-2 min ï¼Œæ—¶é—´åŒ…å«åç«¯æä¾›æ•°æ®æ—¶é—´ 20-30 sã€‚é¡µé¢æ»šåŠ¨æˆ–åŸºæœ¬æ“ä½œåˆ™æ— é™å¡é¡¿ï¼Œç”šè‡³æµè§ˆå™¨ä¼šå¡æ­»å´©æºƒã€‚</p><p>è®©æˆ‘è®°å½•çš„åˆè¡·æ˜¯è·Œå®•èµ·ä¼çš„ä¼˜åŒ–è¿‡ç¨‹ï¼Œè¿™æ¬¡çš„ä¼˜åŒ–è®©æˆ‘æŒºä½©æœå…¬å¸å‰ç«¯éƒ¨åˆ†å·¥ç¨‹å¸ˆèƒ½åŠ›ã€‚</p><h3 id="mosquito-é—®é¢˜åˆ†æ"><a href="#mosquito-é—®é¢˜åˆ†æ" class="headerlink" title=":mosquito: é—®é¢˜åˆ†æ"></a><span class="github-emoji"><span>ğŸ¦Ÿ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f99f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜åˆ†æ</h3><ol><li>åç«¯æä¾› 5w æ•°æ®é‡è€—æ—¶ 20-30 s</li><li>å‰ç«¯å…¨éƒ¨è£…è½½è€—æ—¶ 60-90 s</li><li>å‰ç«¯å…¨éƒ¨ html èŠ‚ç‚¹ &gt; 5w å¯¼è‡´æ»šåŠ¨åè®¡ç®—ä¼šå‡ºç°æ¸²æŸ“æ…¢æ“ä½œæ…¢ç­‰é—®é¢˜</li></ol><h3 id="microscope-é€ä¸ªå‡»ç ´"><a href="#microscope-é€ä¸ªå‡»ç ´" class="headerlink" title=":microscope: é€ä¸ªå‡»ç ´"></a><span class="github-emoji"><span>ğŸ”¬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f52c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é€ä¸ªå‡»ç ´</h3><h4 id="åç«¯æä¾›-5w-æ•°é‡è€—æ—¶-20-30-s"><a href="#åç«¯æä¾›-5w-æ•°é‡è€—æ—¶-20-30-s" class="headerlink" title="åç«¯æä¾› 5w æ•°é‡è€—æ—¶ 20-30 s"></a>åç«¯æä¾› 5w æ•°é‡è€—æ—¶ 20-30 s</h4><p>åç«¯å®ç°æ˜¯ï¼Œä¾æ®æ¡ä»¶ä»æ•°æ®åº“ä¸­è£…è½½ 5w ææ–™ pojo å¯¹è±¡ï¼Œç„¶åéå†å°† 5w pojo å¯¹è±¡è½¬æ¢ä¸º VO å¯¹è±¡ã€‚åœ¨éå†æœŸé—´è½¬æ¢ VO å¯¹è±¡æ—¶éœ€è¦å› ä¸šåŠ¡éœ€è¦ç»„è£…å„ç§æ•°æ®ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// æ•°æ®æŸ¥è¯¢ä½ç½®</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SusongJuan</span><span class="token punctuation">&gt;</span></span> juans <span class="token operator">=</span> susongJuanMapper<span class="token punctuation">.</span><span class="token function">getJuans</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SusongCailiao</span><span class="token punctuation">&gt;</span></span> susongCailiaos <span class="token operator">=</span> ssdaMaterialMapper<span class="token punctuation">.</span><span class="token function">selectByJuanbhAndFyId</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getDabh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> juanbhs<span class="token punctuation">,</span> param<span class="token punctuation">.</span><span class="token function">getDassfy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SusongMulu</span><span class="token punctuation">&gt;</span></span> mulus <span class="token operator">=</span> susongMuluMapper<span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span><span class="token class-name">SusongMulu</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">dabh</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getDabh</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">fy</span><span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getDassfy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// æ•°æ®ç»„è£…éƒ¨åˆ†</span>ssdaMaterialTreeService<span class="token punctuation">.</span><span class="token function">buildSsdaCailiaoNode</span><span class="token punctuation">(</span>susongCailiaos<span class="token punctuation">,</span> mulus<span class="token punctuation">,</span> juans<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// ssdaMaterialTreeService.buildSsdaCailiaoNode æ•°æ®ç»„è£…é€»è¾‘</span><span class="token keyword">return</span> susongCailiaos<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>cailiao <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>    <span class="token class-name">CailiaoVO</span> cailiaoVO <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CailiaoVO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment">// å±æ€§å¤åˆ¶åŠå®šåˆ¶å±æ€§é…ç½®</span>    <span class="token keyword">return</span> cailiaoVO<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>çœ‹ç€ä»£ç æ­¥éª¤æ˜¯æ¯”è¾ƒç®€æ´ã€‚å…ˆè¯•ç”¨ <a href="https://arthas.gitee.io/doc/trace.html#%E5%8F%82%E6%95%B0%E8%AF%B4%E6%98%8E">arthas trace</a> åˆ†æå„è¡Œä»£ç æ‰§è¡Œæƒ…å†µï¼Œç»“æœå‘ç°æ•°æ®æŸ¥è¯¢åœ¨ 3-4 sï¼Œå¾ªç¯éå†è€—æ—¶ 25-27sã€‚æ‰€ä»¥åˆ†ä¸ºä¸¤æ­¥éª¤ä¼˜åŒ–</p><p>é¦–å…ˆæ•°æ®æŸ¥è¯¢éƒ¨åˆ†ä¼˜åŒ– SQLï¼Œå»æ‰ <code>juanbhs</code> çš„ <code>in</code> æŸ¥è¯¢ã€‚å¹¶å°† mybatis å¯¹è±¡ç±»ä» <code>SusongCailiao</code> æ”¹ä¸º <code>CailiaoVO</code>ï¼Œé¿å…äº†åœ¨å¾ªç¯éå†ä¸­çš„æ–°å¯¹è±¡èµ„æºç”³è¯·è€—æ—¶ï¼Œå’ŒåŒå±æ€§æ‹·è´è€—æ—¶ã€‚æœ€ç»ˆæ•°æ®æŸ¥è¯¢éƒ¨åˆ†ä¼˜åŒ–å 1-1.5sã€‚</p><p>å¾ªç¯éå†è€—æ—¶ 25-27sï¼Œç›¸å½“äºå•å¯¹è±¡è½¬æ¢è€—æ—¶ 500 msï¼Œé™¤äº† CailiaoVO åŒå±æ€§æ‹·è´å¤–ï¼Œæœ‰ä¸¤ç±»å±æ€§è®¾ç½®ï¼Œç¬¬ä¸€ç»„è£…å­—ç¬¦ä¸²ã€ç¬¬äºŒè°ƒç”¨æ¥å£æ˜ç¡®ææ–™æŸ¥é˜… urlã€‚ä¼˜åŒ–æ€è·¯ï¼Œçº¿æ€§æ”¹ä¸ºå¹¶å‘ï¼Œå°† <code>stream()</code> æ”¹ä¸º <code>parallelStream()</code>ï¼Œè€Œè‡³äºæ’åºé—®é¢˜åœ¨å¤„ç†å®Œè½¬æ¢ä¹‹åå†åšä¸šåŠ¡æ’åºã€‚è°ƒç”¨æ¥å£æ˜ç¡®ææ–™æŸ¥é˜… urlï¼ˆurl å¯èƒ½æ˜¯ç›´æ¥è¯·æ±‚æ‰“åˆ°å­˜å‚¨æœåŠ¡å™¨ä¸Šï¼‰æ”¹ä¸ºç›´æ¥æ‹¼æ¥åç«¯æœåŠ¡å™¨è®¿é—®ææ–™è¯·æ±‚åœ°å€ä¸²ï¼Œè‡³äºå…¶ä»–æ–‡ä»¶æ˜¯å¦å­˜åœ¨ç­‰åˆ¤æ–­ä¸åœ¨æ­¤å¤„åšåˆ¤æ–­ã€‚æœ€ç»ˆå¾ªç¯éå†è€—æ—¶ 1-1.5sã€‚</p><p>æœ€ç»ˆè€—æ—¶ä» 60- 90s é™ä½åˆ° 2-3sï¼Œé€Ÿåº¦æå‡ 20 å€ã€‚</p><h4 id="å‰ç«¯å…¨éƒ¨è£…è½½è€—æ—¶-60-90s-ä¸”-å‰ç«¯å…¨éƒ¨-html-èŠ‚ç‚¹-gt-5w-ï¼ˆå·¨å¤šï¼‰"><a href="#å‰ç«¯å…¨éƒ¨è£…è½½è€—æ—¶-60-90s-ä¸”-å‰ç«¯å…¨éƒ¨-html-èŠ‚ç‚¹-gt-5w-ï¼ˆå·¨å¤šï¼‰" class="headerlink" title="å‰ç«¯å…¨éƒ¨è£…è½½è€—æ—¶ 60-90s ä¸” å‰ç«¯å…¨éƒ¨ html èŠ‚ç‚¹ > 5w ï¼ˆå·¨å¤šï¼‰"></a>å‰ç«¯å…¨éƒ¨è£…è½½è€—æ—¶ 60-90s ä¸” å‰ç«¯å…¨éƒ¨ html èŠ‚ç‚¹ &gt; 5w ï¼ˆå·¨å¤šï¼‰</h4><p>å‰ç«¯ç»˜åˆ¶ 5w ä¸ª html å…ƒç´ ï¼Œä¸€å®šæ˜¯è€—æ—¶é•¿ä¸”å¡çš„ã€‚å‰ç«¯åŒå­¦æ‰¾åˆ°äº†ä¸€ç§å«<a href="https://cloud.tencent.com/developer/article/2271375">è™šæ‹Ÿåˆ—è¡¨</a>ï¼Œç›¸å½“äºé€šè¿‡è®¡ç®—æ•´é¢—æ ‘çš„é«˜åº¦ï¼Œæ­é…å›ºå®šæ•°é‡çš„ li å…ƒç´ ï¼Œæ¥ç»˜åˆ¶æ–‡ä»¶æ ‘ã€‚è‡³æ­¤ï¼Œæœ¬ä»¥ä¸ºä¼˜åŒ–ç»“æŸã€‚ç»“æœè€—æ—¶è¿˜æ˜¯éœ€è¦ 60s ç”šè‡³æ›´ä¹…ã€‚</p><p>å‰ç«¯ææ–™é¡µç è®¡ç®—è€—æ—¶ç‰¹åˆ«é•¿ï¼Œæœ€ç»ˆåœ¨ 5w æ–‡ä»¶èŠ‚ç‚¹è¿”å›ç»™å‰ç«¯æ—¶ï¼Œåœ¨éå†æ ‘æ‰€æœ‰èŠ‚ç‚¹æ—¶ï¼ŒåŒ…å«ç›®å½•å’Œææ–™ã€‚è®¡ç®—ææ–™é¡µç åä¼šå‘ä¸Šè®¡ç®—å„å±‚çº§ç›®å½•çš„é¡µç ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * æ€»ä½“è¯´æ˜ï¼Œè®¡ç®—é¡µç é€‚åˆäºæ ‘æ·±åº¦éå†.&lt;br&gt; * éå¶å­èŠ‚ç‚¹æœ‰å¦‚ä¸‹ç‰¹å¾ï¼Œnode.children &gt; 0.&lt;br&gt; * å¶å­èŠ‚ç‚¹æœ‰å¦‚ä¸‹ç‰¹å¾ï¼Œ node.children = 0.&lt;br&gt; * æ·±åº¦éå†æ—¶ï¼Œéå¶å­èŠ‚ç‚¹éœ€è¦åŠ å…¥ calcPageNodes ç¼“å­˜å¯¹è±¡ä¸­ï¼Œç›¸å½“äºç­‰å¾…å„ä¸ªèŠ‚ç‚¹è®¡ç®—å®Œæ¯•é¡µç æ‰è®¡ç®—æœ¬èŠ‚ç‚¹é¡µç çš„ä¸´æ—¶åœç•™ä½ç½®.&lt;br&gt; * å½“éå†ä¸ºå¶å­ç»“ç‚¹æ—¶ï¼Œæ¯ä¸ªå¶å­ç»“ç‚¹ç»„è£…é¡µç æ•°æ®ä¹‹åå‘çˆ¶èŠ‚ç‚¹é€šå‘Šæœ¬èŠ‚ç‚¹ç»„è£…ç»“æœï¼Œä¾›çˆ¶èŠ‚ç‚¹æ›´æ–°é¡µç . */</span><span class="token comment">/** * æ„é€ æ–¹æ³•ï¼ŒæŒ‰çˆ¶è®¡ç®—é¡µç èŠ‚ç‚¹å’Œæœ¬æ ‘èŠ‚ç‚¹å…±åŒç»„æˆå±æ€§. * 1. çˆ¶è®¡ç®—é¡µç èŠ‚ç‚¹ * 2. æœ¬èŠ‚ç‚¹èµ·å§‹é¡µç  * 3. æœ¬èŠ‚ç‚¹ç»“æŸé¡µç  * 4. æœ¬èŠ‚ç‚¹é¡µç  * 5. å·¦ä¾§æ ‘èŠ‚ç‚¹æ•°æ® * 6. æ˜¯å¦è®¡å…¥æ¡£æ¡ˆé¡µç  * @param selfTreeNode æ ‘èŠ‚ç‚¹æœ¬ç‚¹ * @param pCalcPageNode çˆ¶è®¡ç®—é¡µç èŠ‚ç‚¹ */</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">CalcPageNode</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">selfTreeNode<span class="token punctuation">,</span> calcPageNodes</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode <span class="token operator">=</span> calcPageNodes<span class="token punctuation">.</span><span class="token function">getNode</span><span class="token punctuation">(</span>selfTreeNode<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenPageMap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenLength <span class="token operator">=</span> selfTreeNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">;</span>        selfTreeNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">subTreeNode</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>childrenPageMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>subTreeNode<span class="token punctuation">.</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode <span class="token operator">=</span> selfTreeNode<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>calcDangPage <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token comment">// this.calcDangPage = selfTreeNode.details.calcDangPage || false;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>calcDangPage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">.</span>calcDangPage<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>selfTreeNode<span class="token punctuation">.</span>type <span class="token operator">!==</span> <span class="token string">'CAILIAO'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>calcDangPage <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>calcDangPage <span class="token operator">&amp;&amp;</span> selfTreeNode<span class="token punctuation">.</span>details<span class="token punctuation">.</span>calcDangPage<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>selfTreeNode<span class="token punctuation">.</span>details<span class="token punctuation">.</span>muluType <span class="token operator">===</span> <span class="token string">'FEN_CE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">.</span>page <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">.</span>endPageNo <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">.</span>endPageNo <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenPageMap<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenPageMap <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenLength <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>calcDangPage <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     *  æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹åˆ¤æ–­ï¼Œåªç”¨ä¾æ® children æ˜¯ä¸æ˜¯ç©ºåˆ¤æ–­.     * @returns {boolean}     * @private     */</span>    <span class="token function">_isLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>childrenLength <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * è®¡ç®—å•å¶å­èŠ‚ç‚¹çš„é¡µç ï¼Œå½“è®©æ˜¯æ¡£æ¡ˆè®¤ä¸ºéœ€è¦è®¡ç®—çš„é¡µç .     */</span>    <span class="token function">calcPage</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>calcDangPage<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token comment">// console.info('å½“å‰èŠ‚ç‚¹éå¶å­èŠ‚ç‚¹ï¼Œç­‰å¾…å­èŠ‚ç‚¹å›è°ƒ');</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'MULU'</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'JUAN'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'CAILIAO'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>details<span class="token punctuation">.</span>pages <span class="token operator">||</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_buildPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">.</span><span class="token function">_pageNodeNotice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">ä¸æ”¯æŒçš„æ ‘èŠ‚ç‚¹ç±»å‹ã€</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ã€‘èŠ‚ç‚¹ç¼–å·ã€</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">ã€‘</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * å¡«å……æ ‘èŠ‚ç‚¹ page ä¿¡æ¯.     * @private     */</span>    <span class="token function">_buildPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_isLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'CAILIAO'</span> <span class="token operator">||</span> <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'MULU'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">===</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>pageInfo <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                        <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>pageInfo <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">let</span> page <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenPageMap<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>            page <span class="token operator">+=</span> value<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">=</span> page<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo <span class="token operator">+</span> <span class="token keyword">this</span><span class="token punctuation">.</span>page <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'MULU'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>pageInfo <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>startPageNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> - </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>endPageNo<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'JUAN'</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>page<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>pageInfo <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token keyword">this</span><span class="token punctuation">.</span>page<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> é¡µ</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token function">_pageNodeNotice</span><span class="token punctuation">(</span><span class="token parameter">childPageNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>childrenPageMap<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>childPageNode<span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>id<span class="token punctuation">,</span> childPageNode<span class="token punctuation">.</span>page<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_buildPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>pPageNode<span class="token punctuation">.</span><span class="token function">_pageNodeNotice</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">class</span> <span class="token class-name">PageNodes</span> <span class="token punctuation">{</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pageNodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">addNode</span><span class="token punctuation">(</span><span class="token parameter">calcPageNode</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pageNodes<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>calcPageNode<span class="token punctuation">.</span>treeNode<span class="token punctuation">.</span>id<span class="token punctuation">,</span> calcPageNode<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">getNode</span><span class="token punctuation">(</span><span class="token parameter">id</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>pageNodes<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">clearAll</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pageNodes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">pageNode</span> <span class="token operator">=&gt;</span> pageNode<span class="token punctuation">.</span><span class="token function">destory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pageNodes<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>pageNodes <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä¼˜åŒ–å®Œä¹‹åï¼Œé¡µç è®¡ç®—è€—æ—¶å¤§çº¦åœ¨ 2- 3s å·¦å³ã€‚ä¹Ÿå°±æ˜¯å‰ç«¯ + åç«¯æ€»å…±è€—æ—¶åœ¨ 5-6s å·¦å³ã€‚å–äº†ä¼šå„¿èŒ¶ä¹‹åï¼Œå‘ç°é¡µé¢å´©æºƒäº†ã€‚æˆ‘è‰¹ï¼Œæ€ä¹ˆå´©æºƒäº†ï¼Œå•¥æ“ä½œéƒ½æ²¡æœ‰ã€‚ç»“æœå‘ç°ï¼Œåˆ·æ–°é¡µé¢ 5-6s è£…è½½å®Œæˆä¹‹åï¼Œchrome å‰ç«¯å†…å­˜å ç”¨ä¸º 2.5 GBï¼Œè¿™æœ‰ç‚¹è¯¡å¼‚äº†ï¼Œæœ€å¤§çš„ææ–™èŠ‚ç‚¹è¯·æ±‚å“åº”å¤§çº¦æ˜¯ 4.6 MBï¼Œå•é¡µé¢ vue å¤§çº¦å†…å­˜åœ¨ 100 MB å·¦å³ã€‚æ‰€ä»¥å°±è¿™äº›æ•°æ®æ€ä¹ˆå°± 2.5 GB å‘¢ï¼Ÿå› ä¸ºå†…å­˜å ç”¨å¤ªå¤§ï¼Œæˆ‘å»æ‰äº†é¡µé¢åŸºæœ¬æ‰€æœ‰å†…å®¹ï¼Œåªå‰©ä¸‹ææ–™è¯·æ±‚å’Œç»“æœå“åº”éƒ¨åˆ†ã€‚ç»“æœå‘ç°ï¼Œæ¯ä¸ªææ–™èŠ‚ç‚¹è¢«å›æ”¶çš„è¯ï¼Œææ–™æ•°æ®è‡ªèº«è¢«å›æ”¶å¤§çº¦èƒ½åˆ° 14KB å·¦å³ï¼Œå¤§å° 14KB x 53576 = 732 MBã€‚</p><p><img src="/images/2024/vue_5w_tree/vue2_1.png" alt="vue2-1.png"></p><p>åŸºæœ¬ä¸Šé—®é¢˜å°±åœ¨è¿™é‡Œäº†ï¼ŒåŸºæœ¬èƒ½ç¡®å®šçš„æ˜¯ï¼Œåœ¨ vue2 data ä¸­å®šä¹‰çš„ç»“æ„åœ¨èµ‹å€¼ä¹‹åï¼Œä¼šéœ€è¦æ¯”åŸæœ¬å¯¹è±¡æ›´å¤šçš„å†…å­˜å»ç®¡ç†å±æ€§ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// æ”¹é€ å‰å†…å®¹</span><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>    <span class="token function">data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token punctuation">{</span>            <span class="token comment">// ææ–™æ•°æ®</span>            <span class="token literal-property property">materialData</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        <span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æ”¹é€ åï¼Œæ˜¯å°† 5w çš„ææ–™ä»¥ç¼“å­˜çš„å½¢å¼ï¼Œæ”¾åœ¨ windows å¯¹è±¡ä¸­ï¼Œæ“ä½œä»€ä¹ˆçš„éƒ½ç”¨ç¼“å­˜æä¾›çš„æ•°æ®å®Œæˆè£…è½½ã€æ“ä½œåŠåˆ·æ–°ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">/** * ææ–™æ ‘ç¼“å­˜. ä¸ window.fd é…åˆä½¿ç”¨ï¼Œta çš„åˆå§‹åŒ–åœ¨æ ‘è§¦å‘ ready æ–¹æ³•åæ–¹å¯åšæœ¬ææ–™æ ‘ç¼“å­˜. * å®Œæ•´çš„å±æ€§ç»“æ„ï¼Œç¼©ç•¥å›¾å’Œæ ‘éƒ½ç”¨åŒä¸€ä»½æ ‘å‹æ•°æ®. * ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼Œä¸€éƒ¨åˆ†æ˜¯ç›®å½•æ ‘ï¼Œä¸€éƒ¨åˆ†æ˜¯ææ–™åˆ—è¡¨ï¼Œæœ€ç»ˆç»„è£…æˆæ¡£æ¡ˆæ ‘. */</span><span class="token keyword">class</span> <span class="token class-name">MaterialTreeData</span> <span class="token punctuation">{</span>    <span class="token comment">/**     * treeData: æ¡£æ¡ˆæ ‘&lt;br&gt;     * initLoadMulu: æ˜¯å¦åˆå§‹åŒ–äº†ç›®å½•ï¼Œç»“åˆ initLoadCailiaos ä¸€èµ·åšæ¡£æ¡ˆæ ‘åˆå§‹åŒ–åˆ¤æ–­ &lt;br&gt;     * initLoadCailiaos: æ˜¯å¦åˆå§‹åŒ–äº†ææ–™ï¼Œç»“åˆ initLoadMulu ä¸€èµ·åšæ¡£æ¡ˆæ ‘åˆå§‹åŒ–åˆ¤æ–­ &lt;br&gt;     */</span>    <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">daTree</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>treeData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>thumbLastMuluData <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>initLoadMulu <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>initLoadCailiaos <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>daTree <span class="token operator">=</span> daTree<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * è£…è½½ç›®å½•æ ‘.     * @param muluTreeData æ•°ç»„ç»“æ„ï¼Œå› ä¸ºä¸€ä¸ªå·ä¸€ä¸ªæ ‘æ ¹èŠ‚ç‚¹.     * @param refreshDaTree æ˜¯å¦ç›´æ¥åˆ·æ–°æ¡£æ¡ˆæ ‘     */</span>    <span class="token function">initMulus</span><span class="token punctuation">(</span><span class="token parameter">muluTreeData<span class="token punctuation">,</span> refreshDaTree <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>muluTreeData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>initLoadMulu <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>refreshDaTree<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>daTree<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * æ³¨æ„ï¼Œææ–™çš„åˆå§‹åŒ–å¾—åœ¨ç›®å½•ä¹‹åï¼Œä¸æƒ³åšè¿‡å¤šæ—¶é—´å‰åçš„å…¼å®¹ï¼Œæ‰€ä»¥è¯·åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œå…ˆè¯·æ±‚ç›®å½•å†è¯·æ±‚ææ–™.     * è£…è½½ææ–™åˆ—è¡¨.å°†ææ–™åˆ—è¡¨è£…è½½è¿›æ ‘é‡Œ.     *     * @param cailiaoData ææ–™åˆ—è¡¨æ•°æ®     * @param refreshDaTree æ˜¯å¦ç›´æ¥åˆ·æ–°æ¡£æ¡ˆæ ‘     */</span>    <span class="token function">initCailiaos</span><span class="token punctuation">(</span><span class="token parameter">cailiaoData<span class="token punctuation">,</span> refreshDaTree <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>initLoadMulu<span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'ææ–™åˆ—è¡¨åˆå§‹åŒ–åˆ°æ¡£æ¡ˆæ ‘å¾—åœ¨ç›®å½•ä¹‹åï¼Œä¸æƒ³åšè¿‡å¤šæ—¶é—´å‰åçš„å…¼å®¹ï¼Œæ‰€ä»¥è¯·åœ¨è°ƒç”¨çš„æ—¶å€™ï¼Œå…ˆè¯·æ±‚ç›®å½•å†è¯·æ±‚ææ–™'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>cailiaoData <span class="token operator">||</span> <span class="token operator">!</span>cailiaoData<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">'ææ–™åˆ—è¡¨ä¸ºç©ºï¼Œç›´æ¥ç»“æŸ'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>initLoadCailiaos <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_composeCailiao2DaTree</span><span class="token punctuation">(</span>cailiaoData<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>thumbCailiaoData<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>initLoadCailiaos <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>refreshDaTree<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>daTree<span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span>daTree<span class="token punctuation">.</span><span class="token function">gUpdateCurrentDataList</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_getFirstLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * åªæä¾›éœ€è¦çš„åŸºç¡€å±æ€§çš„æ ‘èŠ‚ç‚¹.     */</span>    <span class="token function">getSimpleJuanTreeNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> juans <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">juan</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> simpleJuan <span class="token operator">=</span> <span class="token punctuation">{</span>                <span class="token literal-property property">details</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>details<span class="token punctuation">,</span>                <span class="token literal-property property">id</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>id<span class="token punctuation">,</span>                <span class="token literal-property property">name</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>name<span class="token punctuation">,</span>                <span class="token literal-property property">order</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>order<span class="token punctuation">,</span>                <span class="token literal-property property">pageInfo</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>pageInfo<span class="token punctuation">,</span>                <span class="token literal-property property">pid</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>pid<span class="token punctuation">,</span>                <span class="token literal-property property">type</span><span class="token operator">:</span> juan<span class="token punctuation">.</span>type            <span class="token punctuation">}</span><span class="token punctuation">;</span>            juans<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>simpleJuan<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> juans<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">getThumbLastMuluData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>thumbLastMuluData<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">getTreeData</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token function">_getFirstLeaf</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeData <span class="token operator">||</span> <span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">let</span> treeNode <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>treeData<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">while</span> <span class="token punctuation">(</span>treeNode<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>treeNode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token operator">!</span>treeNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            treeNode <span class="token operator">=</span> treeNode<span class="token punctuation">.</span>children<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> treeNode<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * ç»„åˆæ¡£æ¡ˆæ ‘å’Œææ–™åˆ—è¡¨ï¼Œå…¶ä¸­æ¡£æ¡ˆæ ‘å¾—ç°æœ‰ç›®å½•æ•°æ®ï¼Œå‰é¢ initCailiaos å·²ç»æœ‰å‰ç½®ä½åˆ¤æ–­.     * @param cailiaoData ææ–™åˆ—è¡¨æ•°æ®     * @param muluTreeData ç›®å½•æ ‘     * @private     */</span>    <span class="token function">_composeCailiao2DaTree</span><span class="token punctuation">(</span><span class="token parameter">cailiaoData<span class="token punctuation">,</span> muluTreeData<span class="token punctuation">,</span> thumbCailiaoData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cailiaoData <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>cailiaoData<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">const</span> cailiaoByPidGroup <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_group</span><span class="token punctuation">(</span>cailiaoData<span class="token punctuation">,</span> <span class="token parameter">cailiao</span> <span class="token operator">=&gt;</span> cailiao<span class="token punctuation">.</span>pid<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_composeCailiao2Mulus</span><span class="token punctuation">(</span>muluTreeData<span class="token punctuation">,</span> cailiaoByPidGroup<span class="token punctuation">,</span> thumbCailiaoData<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * éå†æ ‘èŠ‚ç‚¹ï¼Œå¾€ç›®å½•èŠ‚ç‚¹åŒçº§æˆ–ä¸‹çº§æ·»åŠ ææ–™èŠ‚ç‚¹.     *     * @param muluTreeNodes ç›®å½•é›†åˆ     * @param cailiaoByPidGroup åˆ†ç»„     * @private     */</span>    <span class="token function">_composeCailiao2Mulus</span><span class="token punctuation">(</span><span class="token parameter">muluTreeNodes<span class="token punctuation">,</span> cailiaoByPidGroup<span class="token punctuation">,</span> thumbCailiaoData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> muluTreeNodes<span class="token punctuation">.</span>length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> muluTreeNode <span class="token operator">=</span> muluTreeNodes<span class="token punctuation">[</span>index<span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>muluTreeNode<span class="token punctuation">.</span>children <span class="token operator">&amp;&amp;</span> muluTreeNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_composeCailiao2Mulus</span><span class="token punctuation">(</span>muluTreeNode<span class="token punctuation">.</span>children<span class="token punctuation">,</span> cailiaoByPidGroup<span class="token punctuation">,</span> thumbCailiaoData<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_composeCailiao2Mulu</span><span class="token punctuation">(</span>muluTreeNode<span class="token punctuation">,</span> cailiaoByPidGroup<span class="token punctuation">,</span> thumbCailiaoData<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">_composeCailiao2Mulu</span><span class="token punctuation">(</span>muluTreeNode<span class="token punctuation">,</span> cailiaoByPidGroup<span class="token punctuation">,</span> thumbCailiaoData<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * å°†å½’å±æœ¬ç›®å½•çš„ææ–™æ·»åŠ åˆ° children ä¸­.     * @param muluTreeNode ç›®å½•èŠ‚ç‚¹     * @param cailiaoByPidGroup åˆ†ç»„     * @private     */</span>    <span class="token function">_composeCailiao2Mulu</span><span class="token punctuation">(</span><span class="token parameter">muluTreeNode<span class="token punctuation">,</span> cailiaoByPidGroup<span class="token punctuation">,</span> thumbCailiaoData</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">const</span> cailiaos <span class="token operator">=</span> cailiaoByPidGroup<span class="token punctuation">[</span>muluTreeNode<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>cailiaos<span class="token punctuation">.</span>length <span class="token operator">&amp;&amp;</span> muluTreeNode<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'MULU'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">delete</span> cailiaoByPidGroup<span class="token punctuation">[</span>muluTreeNode<span class="token punctuation">.</span>id<span class="token punctuation">]</span><span class="token punctuation">;</span>            muluTreeNode<span class="token punctuation">.</span>children <span class="token operator">=</span> muluTreeNode<span class="token punctuation">.</span>children <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            muluTreeNode<span class="token punctuation">.</span>children<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>cailiaos<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å› ä¸ºç›®å½•ä¸‹èŠ‚ç‚¹æœ‰ææ–™å’Œå­ç›®å½•ï¼Œæ‰€ä»¥ç”¨è¿™ä¸ªå‚æ•°è£…è½½åªæ˜¯ææ–™èŠ‚ç‚¹.</span>            muluTreeNode<span class="token punctuation">.</span>cailiaoChildren <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            muluTreeNode<span class="token punctuation">.</span>cailiaoChildren<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token operator">...</span>cailiaos<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>thumbLastMuluData<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>muluTreeNode<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * åˆ†ç»„ï¼Œæ•°ç»„å…ƒç´ æŒ‰ç…§å…ƒç´ æŸä¸ªå±æ€§å€¼åšåˆ†ç»„ï¼Œè¿”å›ç»“æ„ä¸º Map&lt;Property, List&lt;Item&gt;&gt;     * @param array æ•°ç»„     * @param keyFunc å±æ€§è·å–å‡½æ•°     * @returns {*} Map&lt;Property, List&lt;Item&gt;&gt;     * @private     */</span>    <span class="token function">_group</span><span class="token punctuation">(</span><span class="token parameter">array<span class="token punctuation">,</span> keyFunc</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> array<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">groups<span class="token punctuation">,</span> item</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">const</span> key <span class="token operator">=</span> <span class="token function">keyFunc</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>groups<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                groups<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            groups<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>item<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> groups<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">export</span> <span class="token keyword">const</span> materialTreeCache <span class="token operator">=</span> <span class="token punctuation">{</span>    <span class="token function-variable function">createMaterialTreeCache</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">daTree<span class="token punctuation">,</span> dabh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>daTree <span class="token operator">||</span> <span class="token operator">!</span>dabh<span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'åˆ›å»ºææ–™æ ‘ç¼“å­˜æ—¶ï¼Œæ¡£æ¡ˆæ ‘å’Œæ¡£æ¡ˆç¼–å·éƒ½ä¸å¯ä¸ºç©º'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>globalTreeCacheObject<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            window<span class="token punctuation">.</span>globalTreeCacheObject <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// åˆ›å»ºç¼“å­˜å¯¹è±¡</span>        window<span class="token punctuation">.</span>globalTreeCacheObject<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">materialTreeCache_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dabh<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MaterialTreeData</span><span class="token punctuation">(</span>daTree<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">getMaterialTreeCache</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">dabh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dabh<span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'è·å–ææ–™æ ‘ç¼“å­˜æ—¶ï¼Œæ¡£æ¡ˆç¼–å·ä¸å¯ä¸ºç©º'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>globalTreeCacheObject<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'è·å–ææ–™æ ‘ç¼“å­˜æ—¶ï¼Œå…¨å±€æ ‘ç¼“å­˜å¯¹è±¡ä¸å¯ä¸ºç©º'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> window<span class="token punctuation">.</span>globalTreeCacheObject<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">materialTreeCache_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dabh<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span>    <span class="token function-variable function">destoryMaterialTreeCache</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">dabh</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>dabh<span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'é”€æ¯ææ–™æ ‘ç¼“å­˜æ—¶ï¼Œæ¡£æ¡ˆç¼–å·ä¸å¯ä¸ºç©º'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">type</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>globalTreeCacheObject<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            console<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">'é”€æ¯ææ–™æ ‘ç¼“å­˜æ—¶ï¼Œå…¨å±€æ ‘ç¼“å­˜å¯¹è±¡ä¸å¯ä¸ºç©º'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">delete</span> window<span class="token punctuation">.</span>globalTreeCacheObject<span class="token punctuation">[</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">materialTreeCache_</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dabh<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é‡æ„åï¼Œå‰ç«¯å†…å­˜å ç”¨ç¨³å®šåœ¨ 200-300 MBã€‚</p><h3 id="fuelpump-æ€»ç»“"><a href="#fuelpump-æ€»ç»“" class="headerlink" title=":fuelpump: æ€»ç»“"></a><span class="github-emoji"><span>â›½</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/26fd.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ€»ç»“</h3><ol><li><p>æ•°æ®é‡å¤§æ—¶ï¼Œå°½å¯èƒ½å‡å°‘è®¡ç®—å·¥ä½œåŠæ¥å£è°ƒç”¨ã€‚</p></li><li><p>å–„ç”¨ç®—æ³•ï¼Œä¸è¦æ­»æ¿çš„å®Œæˆè®¡ç®—ã€‚åˆ©ç”¨æ ‘çš„æ·±åº¦éå†ï¼Œè®¡ç®—å„ä¸ªç›®å½•å’Œææ–™é¡µç èŒƒå›´ã€‚</p></li><li><p>å­¦ä¹ åˆ°è™šæ‹Ÿåˆ—è¡¨ï¼Œå¯¹æ•°æ®èŠ‚ç‚¹å¤šçš„å‰ç«¯è£…è½½ä¼˜åŒ–ã€‚</p></li><li><p>æ•°æ®é‡å¤§æ—¶ï¼Œä¸è¦ç”¨ vue2 çš„ data å±æ€§ç®¡ç†æ•°æ®ã€‚</p></li></ol>]]></content>
      
      
      <categories>
          
          <category> ä¼˜åŒ– </category>
          
      </categories>
      
      
        <tags>
            
            <tag> code </tag>
            
            <tag> å‰ç«¯ </tag>
            
            <tag> vue </tag>
            
            <tag> è™šæ‹Ÿåˆ—è¡¨ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ç®—æ³•å°ç™½-Bæ ‘ã€B+æ ‘å’ŒB*æ ‘</title>
      <link href="/2024/04/01/suan-fa-xiao-bai-b-shu-b-shu-he-b-shu/"/>
      <url>/2024/04/01/suan-fa-xiao-bai-b-shu-b-shu-he-b-shu/</url>
      
        <content type="html"><![CDATA[<h2 id="ç®—æ³•ç¯‡-â€”-B-æ ‘-ã€-B-æ ‘-å’Œ-B-æ ‘"><a href="#ç®—æ³•ç¯‡-â€”-B-æ ‘-ã€-B-æ ‘-å’Œ-B-æ ‘" class="headerlink" title="ç®—æ³•ç¯‡ â€” B æ ‘ ã€ B+ æ ‘ å’Œ B* æ ‘"></a>ç®—æ³•ç¯‡ â€” B æ ‘ ã€ B+ æ ‘ å’Œ B* æ ‘</h2><h3 id="åŸºç¡€æ¦‚å¿µ"><a href="#åŸºç¡€æ¦‚å¿µ" class="headerlink" title="åŸºç¡€æ¦‚å¿µ"></a>åŸºç¡€æ¦‚å¿µ</h3><p><strong>äºŒå‰æ ‘</strong>ï¼Œåªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ¯ä¸ªæ ‘èŠ‚ç‚¹æœ€å¤šæœ‰ä¸¤ä¸ªå­èŠ‚ç‚¹ï¼Œå…è®¸æœ‰å¤šå±‚çº§èŠ‚ç‚¹ã€‚äºŒå‰æ ‘æŸ¥æ‰¾å¹³å‡æ—¶é—´å¤æ‚åº¦ <code>O(logn)</code>ï¼Œä½†æœ€åæŸ¥æ‰¾æ¬¡æ•°ä¾èµ–äºäºŒå‰æ ‘çš„æ·±åº¦ï¼Œæœ€åæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ <code>O(n)</code> å³æ‰€æœ‰èŠ‚ç‚¹åå‘å·¦æˆ–å³ã€‚</p><p><strong>å®Œå…¨äºŒå‰æ ‘</strong>ï¼Œæ‰€æœ‰å¶å­ç»“ç‚¹éƒ½å‡ºç°åœ¨ K æˆ– K-1 å±‚ï¼Œè€Œä¸”ä» 1 åˆ° k-1 å±‚æ¯å±‚éƒ½æ˜¯æ»¡èŠ‚ç‚¹æ•°ã€‚æœ€å¤šåªæœ‰ K å±‚ä¸æ˜¯æ»¡èŠ‚ç‚¹æ•°ï¼Œä¸”éæ»¡èŠ‚ç‚¹çš„ K å±‚é›†ä¸­åœ¨å·¦è¾¹ã€‚æŸ¥æ‰¾å¹³å‡æ—¶é—´å¤æ‚åº¦ <code>O(logn)</code> ã€æœ€åæŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦ <code>O(logn)</code>ã€‚</p><p><strong>å¹³è¡¡äºŒå‰æ ‘</strong>ï¼Œä¿è¯å·¦å³å­æ ‘çš„é«˜åº¦ä¹‹å·®ä¸å¤§äº 1ï¼Œå¹¶ä¸”å­æ ‘ä¹Ÿå¿…é¡»æ˜¯ä¸€é¢—å¹³è¡¡äºŒå‰æ ‘ã€‚å½“æ·»åŠ æˆ–åˆ é™¤èŠ‚ç‚¹æ—¶éœ€è¦é€šè¿‡æ—‹è½¬ä¿æŒæ•´ä¸ªæ•°çš„å¹³è¡¡ã€‚æœ€ç»ˆï¼Œæ’å…¥ã€æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦ <code>O(logn)</code>ã€‚</p><h3 id="B-æ ‘"><a href="#B-æ ‘" class="headerlink" title="B æ ‘"></a>B æ ‘</h3><p>æ˜¯ä¸€ä¸ªå¹³è¡¡çš„å¤šè·¯æŸ¥æ‰¾æ ‘ï¼Œå¹³è¡¡äºŒå‰æ ‘çš„å˜ç§ã€‚ä¸€ä¸ª m é˜¶çš„ B æ ‘éœ€è¦æ»¡è¶³ï¼Œ(1) æ ‘ä¸­æ¯ä¸ªèŠ‚ç‚¹è‡³å¤šæœ‰ m ä¸ªå­æ ‘ (m&gt;2)ã€‚ï¼ˆ2ï¼‰æ¯ä¸ªéå¶å­èŠ‚ç‚¹ï¼ˆé™¤æ ¹èŠ‚ç‚¹ï¼‰æœ€å°‘æœ‰âŒˆm/2âŒ‰ ä¸ªå­èŠ‚ç‚¹ï¼ŒâŒˆm/2âŒ‰ è¡¨ç¤ºå‘ä¸Šå–æ•´ã€‚ï¼ˆ3ï¼‰å¦‚æœæ ¹èŠ‚ç‚¹ä¸æ˜¯å¶å­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå®ƒè‡³å°‘æœ‰ 2 ä¸ªå­èŠ‚ç‚¹ã€‚ï¼ˆ4ï¼‰æœ‰ K ä¸ªå­ç»“ç‚¹çš„éå¶å­èŠ‚ç‚¹æ‹¥æœ‰ K-1 ä¸ªé”®ã€‚ï¼ˆ5ï¼‰æ‰€æœ‰å¶å­ç»“ç‚¹éƒ½åœ¨åŒä¸€å±‚ã€‚ï¼ˆ5ï¼‰æ ‘èŠ‚ç‚¹ä¸ŠåŒ…å«æ•°æ®éƒ¨åˆ†å’Œå­ç»“ç‚¹åœ°å€é“¾æ¥éƒ¨åˆ†ã€‚</p><p>å› ä¸ºæ ‘èŠ‚ç‚¹ä¸ŠåŒ…å«äº†å…³é”®å­—åŠæ•°æ®ï¼Œä¹Ÿå°±æŸ¥è¯¢æ—¶é—´å¹³å‡å’Œæœ€åè€—æ—¶ <code>O(logn)</code> ã€‚ä½†å¹¶ä¸ç¨³å®šï¼Œå› ä¸ºä¾æ®æŸ¥è¯¢æ•°æ®å¯èƒ½ä¼šä½¿ç”¨æ›´å°‘æ¬¡æ•°å°±èƒ½æŸ¥è¯¢åˆ°ã€‚è¿™å’‹å¬ä¹‹ä¸‹æ˜¯å¥½äº‹ï¼Œä½†å› ä¸ºèŠ‚ç‚¹ä¸æ­¢åŒ…å«å…³é”®å­—è¿˜åŒ…å«äº†æ•°æ®ï¼Œä¹Ÿå°±æ˜¯ä¸€æ¬¡ç£ç›˜ IO è¯»å–å¯èƒ½åªå´å‡ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œä½†èŠ‚ç‚¹ä¸Šå¯ä»¥åŒ…å«çš„å…³é”®å­—æ•°ä¼šæœ‰é™åˆ¶ä¸”è¾ƒå°‘ï¼Œä¹Ÿå°±æ˜¯ç£ç›˜ IO è¯»å–æ¬¡æ•°ä¼šå¤šã€‚</p><h3 id="B-æ ‘-1"><a href="#B-æ ‘-1" class="headerlink" title="B+ æ ‘"></a>B+ æ ‘</h3><p>B+ æ ‘æ˜¯ B æ ‘çš„å˜ç§ï¼ŒB+ æ ‘ä¸Šéå¶å­èŠ‚ç‚¹ä¸ä¿å­˜æ•°æ®ï¼Œåªç”¨æ¥ä¿å­˜ç´¢å¼•å­—æ®µå€¼ã€‚è¿™æ ·ç¡®ä¿ä¸€ä¸ªèŠ‚ç‚¹ä¸Šèƒ½ä¿å­˜æ›´å¤šçš„ç´¢å¼•å­—æ®µå€¼ï¼Œè®©æ•´é¢—æ ‘çš„é«˜åº¦ç›¸å¯¹äº B æ ‘æ›´ä½ã€‚å› ä¸ºå¶å­èŠ‚ç‚¹ä¸Šæ˜¯æ•°æ®èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„æœç´¢éƒ½ä¼šè½åˆ°å¶å­èŠ‚ç‚¹ä¸Šï¼Œæ‰€ä»¥æœç´¢è€—æ—¶ä¿æŒ <code>O(logn)</code> ã€‚è€Œå¯¹äºå…¨æ•°æ®éå†æ—¶ï¼Œå› ä¸º B+ æ ‘å¶å­èŠ‚ç‚¹æœ‰ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŠŠæ‰€æœ‰å¶å­èŠ‚ç‚¹ä¸²åœ¨ä¸€èµ·ã€‚B+ æ ‘åªéœ€è¦éå†å¶å­ç»“ç‚¹é“¾è¡¨ï¼ŒB æ ‘éœ€è¦å¤æ‚çš„ä¸­åºéå†ã€‚</p><h3 id="B-æ ‘-2"><a href="#B-æ ‘-2" class="headerlink" title="B * æ ‘"></a>B * æ ‘</h3><p>B* æ ‘æ˜¯ B+ æ ‘çš„å˜ç§ã€‚åœ¨ B+ æ ‘çš„åŸºç¡€ä¸Šåœ¨éæ ¹å’Œéå¶å­èŠ‚ç‚¹å†å¢åŠ æŒ‡å‘å…„å¼Ÿçš„æŒ‡é’ˆã€‚å› ä¸ºè®¾ç½®äº†å…„å¼Ÿçš„æŒ‡é’ˆï¼Œæ‰€ä»¥åœ¨å¢åŠ æ•°æ®èŠ‚ç‚¹æœ¬æ ‘èŠ‚ç‚¹æ»¡æ—¶ï¼ŒB* æ ‘ä¼šçœ‹å…„å¼ŸèŠ‚ç‚¹æ˜¯å¦æœ‰ç©ºä½ï¼Œæœ‰çš„è¯å°±ä¼šæŠŠæ•°æ®èŠ‚ç‚¹åŠ åœ¨å…„å¼ŸèŠ‚ç‚¹ä¸Šã€‚å…„å¼ŸèŠ‚ç‚¹ä¹Ÿæ²¡æœ‰ç©ºé—´çš„è¯ï¼Œåˆ™åœ¨åŸèŠ‚ç‚¹ä¸å…„å¼ŸèŠ‚ç‚¹ä¹‹é—´å¢åŠ æ–°èŠ‚ç‚¹ï¼Œå¹¶å„å¤åˆ¶1/3çš„æ•°æ®åˆ°æ–°èŠ‚ç‚¹ï¼Œæœ€ååœ¨çˆ¶èŠ‚ç‚¹å¢åŠ æ–°èŠ‚ç‚¹çš„æŒ‡é’ˆã€‚è€Œ B+ æ ‘å½“ä¸€ä¸ªèŠ‚ç‚¹æ»¡æ—¶ï¼Œåˆ†é…ä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œå¹¶å°†åŸèŠ‚ç‚¹ä¸­1/2çš„æ•°æ®å¤åˆ¶åˆ°æ–°èŠ‚ç‚¹ï¼Œæœ€ååœ¨çˆ¶èŠ‚ç‚¹ä¸­å¢åŠ æ–°ç»“ç‚¹çš„æŒ‡é’ˆï¼›B+æ ‘çš„åˆ†è£‚åªå½±å“åŸèŠ‚ç‚¹å’Œçˆ¶èŠ‚ç‚¹ï¼Œè€Œä¸ä¼šå½±å“å…„å¼ŸèŠ‚ç‚¹ã€‚B* æ ‘åˆ†é…æ–°æ¥ç‚¹çš„æ¦‚ç‡æ¯” B+ æ ‘è¦ä½ï¼Œç©ºé—´ä½¿ç”¨ç‡æ›´é«˜ã€‚</p><blockquote><p>ç´¢å¼•çš„ç¦»æ•£å‹ <code>count(distinct column_name):count(*)</code> æ¯”å€¼è¶Šé«˜ï¼Œå·®åˆ«å€¼å æ¯”è¶Šé«˜ï¼Œç´¢å¼•æ•ˆç‡è¶Šé«˜ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> ç®—æ³• </category>
          
      </categories>
      
      
        <tags>
            
            <tag> ç®—æ³• </tag>
            
            <tag> æŸ¥æ‰¾ </tag>
            
            <tag> æ ‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JVM çš„åƒåœ¾å›æ”¶å™¨ä»¬</title>
      <link href="/2024/03/22/jvm-de-la-ji-hui-shou-qi-men/"/>
      <url>/2024/03/22/jvm-de-la-ji-hui-shou-qi-men/</url>
      
        <content type="html"><![CDATA[<h3 id="å †å†…å­˜åˆ†é…"><a href="#å †å†…å­˜åˆ†é…" class="headerlink" title="å †å†…å­˜åˆ†é…"></a>å †å†…å­˜åˆ†é…</h3><p>JVM å°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£ã€è€å¹´ä»£å’Œ metadata ç©ºé—´ã€‚æ–°ç”Ÿä»£è¢«åˆ†ä¸º eden ç©ºé—´ã€Survivor From ç©ºé—´ã€Survivor To ç©ºé—´ã€‚åƒåœ¾å›æ”¶åŸºæœ¬æ˜¯å¯¹ eden ç©ºé—´ã€Survivor From ç©ºé—´å’Œè€å¹´ä»£çš„å†…å­˜å›æ”¶ã€‚ä½†æ˜¯ï¼Œä¸æ˜¯æ¯æ¬¡åƒåœ¾å›æ”¶éƒ½ä¼šè§¦å‘è€å¹´ä»£çš„å†…å­˜å›æ”¶ï¼Œè¿™ä¸ªåœ¨ <a href="#%E5%9E%83%E5%9C%BE%E5%9B%9E%E6%94%B6%E5%99%A8%E4%BB%AC">åƒåœ¾å›æ”¶å™¨ä»¬</a> ä¼šå†æ¬¡æ€»ç»“ã€‚</p><p><img src="/images/2024/jvm/JVM_1.png" alt="JVM_heap.png"></p><h3 id="å›æ”¶å¯¹è±¡"><a href="#å›æ”¶å¯¹è±¡" class="headerlink" title="å›æ”¶å¯¹è±¡"></a>å›æ”¶å¯¹è±¡</h3><p>å½“å¯¹è±¡ä¸å†è¢«å¼•ç”¨æ—¶ï¼Œæ­¤æ—¶å¯¹è±¡è¢«è®¤ä¸ºæ˜¯<strong>åƒåœ¾å¯¹è±¡</strong>ï¼Œä¼šåœ¨åƒåœ¾å›æ”¶å™¨è¿è¡Œæ—¶è¢«å›æ”¶ã€‚åœ¨ JVM æœ‰å¼ºå¼•ç”¨ã€å¼±å¼•ç”¨ã€è½¯å¼•ç”¨å’Œè™šå¼•ç”¨å››ç§å¯¹è±¡å¼•ç”¨ç±»å‹ã€‚å…¶ä¸­ï¼Œ<strong>å¼ºå¼•ç”¨</strong>ï¼Œä¸ºæœ€å¸¸è§çš„å¼•ç”¨ç±»å‹ï¼Œé€šè¿‡å…³é”®å­— new åˆ›å»ºçš„å¯¹è±¡é»˜è®¤æ˜¯å¼ºå¼•ç”¨ã€‚åªè¦å¼ºå¼•ç”¨æŒ‡å‘ä¸€ä¸ªå¯¹è±¡å°±è¡¨ç¤ºå¯¹è±¡ä¾æ—§æ´»ç€ã€‚<strong>å¼±å¼•ç”¨</strong>ï¼Œå°†å¯¹è±¡å¼•ç”¨ä¿å­˜åœ¨å¼±å¼•ç”¨å¯¹è±¡ä¸­ï¼Œå¦‚æœåƒåœ¾å›æ”¶å™¨è¿è¡Œæ—¶ï¼Œè¿™ä¸ªå¼±å¼•ç”¨å¯¹è±¡å¯¹åƒåœ¾å›æ”¶å™¨è€Œè¨€ä¾æ—§ä¼šè¢«å›æ”¶ã€‚è€Œå¼±å¼•ç”¨ä½¿ç”¨åœºæ™¯ï¼Œåœ¨æ²¡æœ‰å¼ºå¼•ç”¨æŒ‡å‘çš„å¯¹è±¡æ—¶ï¼Œåœ¨è¢« GC å‰è¿˜èƒ½é€šè¿‡å¼±å¼•ç”¨æ¥è·å–å¯¹è±¡ï¼Œä½¿ç”¨è¯¥å¯¹è±¡å¹¶èƒ½å†æ¬¡ç”¨ä¸€ä¸ªå¼ºå¼•ç”¨æŒ‡å‘å®ƒï¼Œä¸ç”¨é‡æ–°è¿è¡Œé€»è¾‘è£…è½½å¯¹è±¡ã€‚<strong>è½¯å¼•ç”¨</strong>ï¼Œå¯¹è±¡åº”ç”¨ä¿å­˜åœ¨è½¯å¼•ç”¨å¯¹è±¡ä¸­ï¼Œåƒåœ¾å›æ”¶å™¨è¿è¡Œæ—¶ä¼šåˆ¤æ–­å †å†…å­˜æ˜¯å¦å……è¶³ã€‚å¦‚æœå……è¶³ï¼Œåƒåœ¾å›æ”¶å™¨ä¸ä¼šåœ¨å½“ä¸‹å›æ”¶è¢«è½¯å¼•ç”¨å¯¹è±¡æŒ‡å‘çš„å¯¹è±¡ã€‚å¦‚æœä¸å……è¶³ï¼Œåƒåœ¾å›æ”¶å™¨ä¼šç«‹å³å›æ”¶è¢«è½¯å¼•ç”¨å¯¹è±¡æŒ‡å‘çš„å¯¹è±¡ã€‚<strong>è™šå¼•ç”¨</strong>ï¼Œå°†å¯¹è±¡å¼•ç”¨ä¿å­˜åœ¨è™šå¼•ç”¨å¯¹è±¡ä¸­ï¼Œé€šè¿‡è™šå¼•ç”¨å¯¹è±¡æ— æ³•è·å–æŒ‡å‘çš„å¯¹è±¡ï¼Œé™¤éå¯¹è±¡å¼ºå¼•ç”¨æœªæ–­è¿ã€‚å¦‚æœåƒåœ¾å›æ”¶å™¨è¿è¡Œæ—¶ï¼Œè™šå¼•ç”¨å¯¹è±¡æŒ‡å‘å¯¹è±¡å›æ”¶åï¼Œåƒåœ¾å›æ”¶å™¨ä¼šæŠŠè¿™ä¸ªè™šå¼•ç”¨åŠ å…¥åˆ°ä¸ä¹‹å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ã€‚ç¨‹åºå¯ä»¥é€šè¿‡åˆ¤æ–­å¼•ç”¨é˜Ÿåˆ—ä¸­æ˜¯å¦å·²ç»åŠ å…¥äº†è™šå¼•ç”¨ï¼Œæ¥äº†è§£è¢«å¼•ç”¨çš„å¯¹è±¡æ˜¯å¦å°†è¦è¢«åƒåœ¾å›æ”¶ï¼Œå®Œæˆå¯¹è±¡å›æ”¶åçš„èµ„æºé‡Šæ”¾ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">String</span> test <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">(</span><span class="token string">"test123"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// å¼±å¼•ç”¨</span><span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> testWeakReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WeakReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>testWeakReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è½¯å¼•ç”¨</span><span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> testSoftReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SoftReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>test<span class="token punctuation">)</span><span class="token punctuation">;</span>testSoftReference<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è™šå¼•ç”¨</span><span class="token class-name">ReferenceQueue</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> referenceQueue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ReferenceQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">PhantomReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> testPhantomReference <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PhantomReference</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>test<span class="token punctuation">,</span> referenceQueue<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// è™šå¼•ç”¨é€šè¿‡é˜Ÿåˆ— poll åˆ¤æ–­ test è¢«å›æ”¶.</span>referenceQueue<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="åƒåœ¾å›æ”¶å™¨ç®—æ³•"><a href="#åƒåœ¾å›æ”¶å™¨ç®—æ³•" class="headerlink" title="åƒåœ¾å›æ”¶å™¨ç®—æ³•"></a>åƒåœ¾å›æ”¶å™¨ç®—æ³•</h3><h4 id="æ ‡è®°-æ¸…ç†ï¼ˆMark-Sweep"><a href="#æ ‡è®°-æ¸…ç†ï¼ˆMark-Sweep" class="headerlink" title="æ ‡è®°-æ¸…ç†ï¼ˆMark-Sweep)"></a>æ ‡è®°-æ¸…ç†ï¼ˆMark-Sweep)</h4><p>é¦–å…ˆï¼Œæ‰«ææ•´ä¸ªç©ºé—´é€šè¿‡å¯¹è±¡å¯è¾¾æ€§åˆ¤æ–­æ‰¾åˆ°æ²¡æœ‰è¢«å¼•ç”¨çš„å¯¹è±¡ï¼Œæ ‡è®°è¿™ç±»å¯¹è±¡éœ€è¦æ¸…ç†ã€‚å…¶æ¬¡ï¼Œæ‰«ææ•´ä¸ªç©ºé—´æ¸…ç†è¢«æ ‡è®°çš„å¯¹è±¡ã€‚ç¼ºç‚¹ï¼Œç›´æ¥æ¸…ç†æ ‡è®°å¯¹è±¡ï¼Œå¯èƒ½ä¼šç…§æˆå†…å­˜ç©ºé—´ç¢ç‰‡åŒ–ã€‚éœ€è¦æ•´ä¸ªç©ºé—´æ‰«æä¸¤æ¬¡ã€‚</p><p><img src="/images/2024/jvm/JVM_2.jpeg" alt="mark-sweep.jpg"></p><h4 id="å¤åˆ¶ï¼ˆCopyingï¼‰"><a href="#å¤åˆ¶ï¼ˆCopyingï¼‰" class="headerlink" title="å¤åˆ¶ï¼ˆCopyingï¼‰"></a>å¤åˆ¶ï¼ˆCopyingï¼‰</h4><p>å°†å†…å­˜åˆ’åˆ†ä¸ºä¸¤ä¸ªå¤§å°ç›¸ç­‰çš„ç©ºé—´ï¼Œä¿è¯æ¯æ¬¡ä»…æœ‰ä¸€ä¸ªç©ºé—´è¢«ä½¿ç”¨ã€‚å½“è¢«ä½¿ç”¨çš„ç©ºé—´å¿«ç”¨å®Œè§¦å‘å›æ”¶æ—¶ï¼Œéœ€è¦åœ¨å½“å‰ç©ºé—´æ‰«æå‡ºæ´»è·ƒå¯¹è±¡ï¼Œå°†æ´»è·ƒå¯¹è±¡æ‹·è´åˆ°å¦ä¸€ä¸ªæœªä½¿ç”¨ç©ºé—´ï¼Œæ¸…ç†ä½¿ç”¨ç©ºé—´ï¼ˆè¿™æ—¶ä½¿ç”¨ç©ºé—´å°±ä¼šå˜æˆæœªè¢«ä½¿ç”¨ç©ºé—´ï¼‰ã€‚ç¼ºç‚¹ï¼Œå†…å­˜è¿è¡Œæ—¶è¢«ä½¿ç”¨ç©ºé—´ä¸º 1/2ã€‚</p><p><img src="/images/2024/jvm/JVM_3.jpeg" alt="copying.jpg"></p><p>åœ¨ JVM è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¤§éƒ¨åˆ†å¯¹è±¡æ˜¯ â€œæœç”Ÿå¤•æ­»â€ çº¦å  98%ã€‚ä¹Ÿå°±æ˜¯è¯´çœŸæ­£éœ€è¦é•¿æœŸæ´»ç€çš„å¯¹è±¡å ç”¨å°‘ã€‚ä¹Ÿå°±è¯´æ˜è¿™æ ·çš„å¯¹åŠç©ºé—´ï¼Œä¸ç®—æµªè´¹å¾ˆå¤šã€‚å…¶ä¸­ï¼Œ98% å¯¹è±¡åœ¨ eden åŒºåŸŸåœ¨å†…å­˜åˆ’åˆ†ä¸­å å¤§å¤´é»˜è®¤æ¯”ä¾‹ä¸º 80%ã€‚å¤åˆ¶ç®—æ³•ä½œç”¨äº Survivor From ç©ºé—´  å’Œ Survivor To ç©ºé—´ï¼Œé»˜è®¤å ç”¨ 10%ã€‚</p><h4 id="æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰"><a href="#æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰" class="headerlink" title="æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰"></a>æ ‡è®°-æ•´ç†ï¼ˆMark-Compactï¼‰</h4><p>æ ‡è®°ä¾æ—§æ˜¯æ ‡è®°éœ€è¦æ¸…ç†çš„å¯¹è±¡ã€‚æ•´ç†æ˜¯å°†å­˜è´§çš„å¯¹è±¡å‘ä¸€ç«¯ç§»åŠ¨ï¼Œç„¶åå°†è¾¹ç•Œå¤–çš„å¯¹è±¡æ¸…ç†æ‰ã€‚è¿™æ ·æ²¡æœ‰å†…å­˜ç¢ç‰‡ã€‚ä¸æ¸…ç†ç›¸æ¯”ï¼Œæ•´ç†åæ²¡æœ‰å†…å­˜ç¢ç‰‡ã€‚ä¸æ‹·è´ç›¸æ¯”ï¼Œæ•´ç†å¹¶æ²¡æœ‰åˆ’åˆ†å‡ºä¸€åŠç©ºé—²ç©ºé—´ã€‚</p><p><img src="/images/2024/jvm/JVM_4.jpeg" alt="mark-compact.jpg"></p><h3 id="GC-æœ¯è¯­"><a href="#GC-æœ¯è¯­" class="headerlink" title="GC æœ¯è¯­"></a>GC æœ¯è¯­</h3><p>éƒ¨åˆ†æ”¶é›†ï¼ˆPartial GCï¼‰ï¼Œç›®æ ‡ä¸æ˜¯å®Œæ•´æ”¶é›†æ•´ä¸ª Java å †çš„åƒåœ¾æ”¶é›†ã€‚å…¶ä¸­ï¼Œæ–°ç”Ÿä»£æ”¶é›†ï¼ˆMinor GC/Young GCï¼‰ï¼Œç›®æ ‡åªæ˜¯æ–°ç”Ÿä»£çš„åƒåœ¾æ”¶é›†ã€‚è€å¹´ä»£æ”¶é›†ï¼ˆMajor GC/Old GCï¼‰ï¼Œåªæ˜¯è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œç›®å‰åªæœ‰ CMS ä¼šæœ‰å•ç‹¬æ”¶é›†è€å¹´ä»£çš„è¡Œä¸ºï¼Œå¦å¤–è¯·æ³¨æ„ Major GC è¿™ä¸ªè¯´æ³•ç°åœ¨æœ‰ç‚¹æ··æ·†ï¼Œåœ¨ä¸åŒèµ„æ–™ä¸Šå¸¸æœ‰ä¸åŒæ‰€æŒ‡ï¼Œè¯»è€…éœ€æŒ‰ä¸Šä¸‹æ–‡åŒºåˆ†åˆ°åº•æ˜¯æŒ‡è€å¹´ä»£çš„æ”¶é›†è¿˜æ˜¯æ•´å †æ”¶é›†ã€‚æ··åˆæ”¶é›†ï¼ˆMixed GCï¼‰ï¼Œç›®æ ‡æ˜¯æ”¶é›†æ•´ä¸ªæ–°ç”Ÿä»£ä»¥åŠéƒ¨åˆ†è€å¹´ä»£çš„åƒåœ¾æ”¶é›†ï¼Œç›®å‰åªæœ‰ G1 så›æ”¶å™¨ä¼šæœ‰è¿™ç§è¡Œä¸ºã€‚æ•´å †æ”¶é›†ï¼ˆFull GCï¼‰ï¼Œæ”¶é›†æ•´ä¸ª Java å †çš„åƒåœ¾æ”¶é›†ã€‚</p><p>å¯ä»¥ä½œä¸º GC Root å¯¹è±¡çš„æœ‰ï¼Œè™šæ‹Ÿæœºæ ˆï¼ˆæ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨ï¼‰ä¸­å¼•ç”¨çš„å¯¹è±¡ã€æ–¹æ³•åŒºä¸­ç±»é™æ€å±æ€§å¼•ç”¨çš„å¯¹è±¡ã€æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡ã€æœ¬åœ°æ–¹æ³•æ ˆä¸­ JNI å¼•ç”¨çš„å¯¹è±¡ã€‚</p><h3 id="åƒåœ¾å›æ”¶å™¨ä»¬"><a href="#åƒåœ¾å›æ”¶å™¨ä»¬" class="headerlink" title="åƒåœ¾å›æ”¶å™¨ä»¬"></a>åƒåœ¾å›æ”¶å™¨ä»¬</h3><p>ä»¥ç®—æ³•æ¥è¯´ï¼Œåˆ†ä»£å›æ”¶æ˜¯æŒ‰ç…§ä¸åŒåŒºåŸŸçš„ç‰¹ç‚¹ï¼Œé€‰ç”¨é€‚åˆçš„åƒåœ¾å›æ”¶ç®—æ³•å’Œåƒåœ¾å›æ”¶å™¨ï¼Œå¹´è½»ä»£åƒåœ¾å›æ”¶é¢‘ç¹è¿½æ±‚å“åº”æ—¶é—´çŸ­å’Œç¨‹åºç»ˆæ­¢æ—¶é—´çŸ­ã€‚åˆ†ä¸ºå¹´è½»ä»£å›æ”¶å™¨ï¼ŒSerialã€ParNewã€Parallel Scavengeã€G1ã€ZGCã€‚è€å¹´ä»£å›æ”¶å™¨ï¼ŒSerialOld ã€Parallel Oldã€CMSã€G1ã€‚</p><h4 id="Serial"><a href="#Serial" class="headerlink" title="Serial"></a>Serial</h4><p>ä¸²è¡Œå›æ”¶å™¨ï¼Œæœ€å¤è€ã€æœ€ç®€å•çš„åƒåœ¾å›æ”¶å™¨ã€‚è¿›è¡Œåƒåœ¾æ”¶é›†æ—¶åªä½¿ç”¨ä¸€ä¸ªçº¿ç¨‹ã€‚ä½¿ç”¨çš„æ˜¯æ ‡è®°å¤åˆ¶ç®—æ³•ã€‚åœ¨æ ‡è®°å’Œå¤åˆ¶ä¸¤ä¸ªç¯èŠ‚ä¸Šï¼Œæš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ï¼ˆ<code>stop-the-word</code>ï¼‰ã€‚</p><h4 id="Serial-Old"><a href="#Serial-Old" class="headerlink" title="Serial Old"></a>Serial Old</h4><p>å•çº¿ç¨‹ä¸²è¡Œè€å¹´ä»£æ ‡è®°æ•´ç†ç®—æ³•çš„åƒåœ¾å›æ”¶ã€‚ä¸ Serial åŒ¹é…çš„è€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚å¦‚æœè€å¹´ä»£å†…å­˜å¤§ï¼Œæ„å‘³ç€åƒåœ¾å›æ”¶è€—æ—¶å¾ˆé•¿ã€‚</p><h4 id="Parallel-Scavenge"><a href="#Parallel-Scavenge" class="headerlink" title="Parallel Scavenge"></a>Parallel Scavenge</h4><p>ä½¿ç”¨æ ‡è®°å¤åˆ¶ç®—æ³•åŠå¤šçº¿ç¨‹è¿›è¡Œå¹´è½»ä»£åƒåœ¾å›æ”¶ã€‚ä½†ä¸ ParNew ç›¸æ¯”ï¼Œå®ƒèƒ½è¾¾åˆ°ä¸€ä¸ªå¯æ§çš„ååé‡ã€‚ååé‡ =  CPU è¿è¡Œç”¨æˆ·çº¿ç¨‹æ—¶é—´ / CPU æ€»æ—¶é—´ã€‚ä½¿ç”¨ <code>-XX:MaxGCPauseMillis</code> æœ€å¤§åƒåœ¾æ”¶é›†åœé¡¿æ—¶é—´ï¼Œ<code>-XX:GCTimeRatio</code> åƒåœ¾å›æ”¶æ—¶é—´å æ€»æ—¶é—´æ¯”ä¾‹ã€‚å¦‚æœè®¾ç½®æ—¶é—´å˜çŸ­ï¼Œè¿™æ„å‘³ç€å›æ”¶æ›´åŠ é¢‘ç¹ï¼Œå¯¼è‡´ååé‡é™ä½ã€‚</p><h4 id="Parallel-Old"><a href="#Parallel-Old" class="headerlink" title="Parallel Old"></a>Parallel Old</h4><p>å¤šçº¿ç¨‹å¹¶è¡Œè€å¹´ä»£æ ‡è®°æ•´ç†ç®—æ³•çš„åƒåœ¾å›æ”¶ï¼Œååé‡ä¼˜å…ˆçš„åƒåœ¾å›æ”¶å™¨ã€‚ä¸ Parallel Scavenge åŒ¹é…çš„è€å¹´ä»£åƒåœ¾å›æ”¶å™¨ã€‚ä½¿ç”¨ <code>-XX:UseParallelOldGC</code> å¼€å¯æ­¤åƒåœ¾å›æ”¶å™¨ã€‚</p><h4 id="ParNew"><a href="#ParNew" class="headerlink" title="ParNew"></a>ParNew</h4><p>ä½¿ç”¨æ ‡è®°å¤åˆ¶ç®—æ³•åŠå¤šçº¿ç¨‹è¿›è¡Œå¹´è½»ä»£åƒåœ¾å›æ”¶ã€‚åƒåœ¾å›æ”¶è¿‡ç¨‹ä¸­ï¼Œä¼šæš‚åœæ‰€æœ‰åº”ç”¨çº¿ç¨‹ã€‚<code>-XX:ParallelGCThreads</code> è®¾ç½®åƒåœ¾å›æ”¶å™¨å¹¶è¡Œæ‰§è¡Œçº¿ç¨‹æ•°ï¼Œé»˜è®¤å¼€å¯å’Œ CPU æ•°æ®ç›¸åŒçš„çº¿ç¨‹æ•°ã€‚</p><h4 id="CMS"><a href="#CMS" class="headerlink" title="CMS"></a>CMS</h4><p>CMS é‡‡ç”¨æ ‡è®°æ¸…é™¤ç®—æ³•ï¼Œåªä¼šå›æ”¶è€å¹´ä»£ç©ºé—´ã€‚CMS æ˜¯ä¸€ç§é¢„å¤„ç†åƒåœ¾å›æ”¶å™¨ï¼Œéœ€è¦åœ¨è€å¹´ä»£å†…å­˜è€—å°½å‰å®Œæˆåƒåœ¾å›æ”¶ï¼Œå¦åˆ™ä¼šå¯¼è‡´å¹¶å‘å›æ”¶å¤±è´¥ï¼Œå¤±è´¥ä¼šé€€åŒ–ä¸º SerialOld åƒåœ¾å›æ”¶å™¨ã€‚å› æ­¤ CMS å¯è®¾ç½® <code>-XX:CMSInitiatingOccupancyFraction</code> ç¡®å®šå¼€å§‹åƒåœ¾å›æ”¶å¯åŠ¨é˜ˆå€¼ã€‚<code>-XX:+UseConcMarkSweepGC</code> å¯åŠ¨ CMS è€å¹´ä»£åƒåœ¾å›æ”¶ã€‚</p><p><strong>CMS åˆå§‹æ ‡è®°ï¼ˆSTWï¼‰</strong>ï¼Œæ ‡è®°è€å¹´ä»£ GC Roots ç›´æ¥å¼•ç”¨å¯¹è±¡ï¼Œ<code>-XX:+CMSParallelInitalMarkEnabled</code> å¼€å¯æ ‡è®°å¹¶è¡ŒåŒ–ï¼Œ<code>-XX:ParallelGCThreads</code> çº¿ç¨‹æ•°ä¸è¦è¶…è¿‡ CPU æ ¸æ•°ã€‚</p><p><strong>CMS å¹¶å‘æ ‡è®°</strong>ï¼Œæ²¿ç€åˆå§‹æ ‡è®°çš„å¯¹è±¡å¯»æ‰¾å­˜æ´»å¯¹è±¡ï¼Œè¯¥é˜¶æ®µä¸åº”ç”¨ç¨‹åºå¹¶å‘è¿è¡Œã€‚éœ€è¦å¯¹å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­ï¼Œå¯¹è€å¹´ä»£å¯¹è±¡å¼•ç”¨å…³ç³»å‘ç”Ÿå˜æ›´ï¼Œéœ€è¦é‡æ–°æ ‡è®°ï¼ˆä¼šæ ‡è®°ä¸º Dirtyï¼‰ã€‚å¹¶å‘æ ‡è®°æ—¶ï¼Œç”¨ä¸åŒé¢œè‰²æ ‡è®°ï¼ˆä¸‰è‰²æ ‡è®°æ³•ï¼‰è€å¹´ä»£å¯¹è±¡ï¼Œé»‘è‰²è¡¨ç¤ºå¯¹è±¡å·²ç»è¢«æ‰«æè¿‡ä¸”å­˜æ´»ã€ç°è‰²è¡¨ç¤ºå¯¹è±¡è‡³å°‘å­˜åœ¨ä¸€ä¸ªå¼•ç”¨è¿˜æ²¡æœ‰è¢«æ‰«æè¿‡ã€ç™½è‰²è¡¨ç¤ºå¯¹è±¡æ²¡æœ‰è¢«æ‰«æè¿‡ã€‚</p><p><strong>å¹¶å‘é¢„å¤„ç†</strong>ï¼Œå¹¶å‘é¢„æ¸…ç†ä¸»è¦æ˜¯å¤„ç†å¹¶å‘é˜¶æ®µå› å¼•ç”¨å…³ç³»å‘ç”Ÿå˜æ›´è€Œæœªæ ‡è®°åˆ°çš„å­˜æ´»å¯¹è±¡ï¼ˆå³ï¼šæ‰«ææ‰€æœ‰æ ‡è®°ä¸ºDirty çš„ Card&nbsp;ï¼‰ã€‚</p><p><strong>å¯ç»ˆæ­¢é¢„å¤„ç†</strong>ï¼Œå¯ç»ˆæ­¢é¢„å¤„ç†é˜¶æ®µä¸å¹¶å‘é¢„å¤„ç†èŠ‚ç‚¹ä¸€æ ·ï¼Œä¸»è¦æ˜¯å¤„ç†å¹¶å‘é˜¶æ®µå› å¼•ç”¨å…³ç³»å‘ç”Ÿå˜æ›´è€Œæœªæ ‡è®°åˆ°çš„å­˜æ´»å¯¹è±¡ï¼ˆå³ï¼šæ‰«ææ‰€æœ‰æ ‡è®°ä¸º Dirty çš„ Card&nbsp;ï¼‰ã€‚ä½†æ˜¯å¯ç»ˆæ­¢é¢„å¤„ç†æ˜¯æœ‰æ¡ä»¶è§¦å‘çš„ï¼Œè§¦å‘æ¡ä»¶ç”±CMSçš„ä¸¤ä¸ªå‚æ•°æ§åˆ¶ <code>-CMSScheduleRemarkEdenSizeThreshold</code> é»˜è®¤å€¼ 2M å’Œ <code>-CMSScheduleRemarkEdenPenetration</code> é»˜è®¤å€¼ 50%ï¼Œå½“ Eden ç©ºé—´ä½¿ç”¨è¶…è¿‡ 2M æ—¶ï¼Œå¯åŠ¨å¯ç»ˆæ­¢é¢„å¤„ç†ï¼Œå½“ Eden ç©ºé—´ä½¿ç”¨ç‡åˆ°è¾¾ 50% æ—¶ä¸­æ–­ï¼Œè¿›å…¥é‡æ–°æ ‡è®°é˜¶æ®µã€‚</p><p><strong>é‡æ–°æ ‡è®°ï¼ˆSTWï¼‰</strong>ï¼Œä¸»è¦æ˜¯æ ‡è®°æ•´ä¸ªè€å¹´ä»£çš„æ‰€æœ‰çš„å­˜æ´»å¯¹è±¡ï¼Œè¯¥é˜¶æ®µä¼šæ‰«ææ•´ä¸ªå †å†…å­˜ã€‚æ‰«ææ–°ç”Ÿä»£çš„åŸå› æ˜¯å› ä¸ºè€å¹´ä»£ä¸­çš„å¯¹è±¡ï¼Œå¦‚æœè¢«æ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡å¼•ç”¨ï¼Œä¼šè¢«è§†ä¸ºå­˜æ´»å¯¹è±¡ï¼Œå³ä½¿æ–°ç”Ÿä»£çš„å¯¹è±¡å·²ç»ä¸å¯è¾¾ï¼Œä¹Ÿä¼šä½¿ç”¨è¿™äº›ä¸å¯è¾¾çš„å¯¹è±¡å½“GC Root æ¥æ‰«æè€å¹´ä»£ã€‚é‡æ–°æ ‡è®°é˜¶æ®µè€—æ—¶è¾ƒé•¿ï¼Œå¯ä»¥é€šè¿‡è®¾ç½®å‚æ•°<code>-XX:+CMSScavengeBeforeRemark</code> åœ¨é‡æ–°æ ‡è®°å‰å…ˆæ‰§è¡Œä¸€æ¬¡ Minor GCï¼Œå›æ”¶æ‰æ–°ç”Ÿä»£ä¸­ä¸å¯è¾¾å¯¹è±¡ï¼Œå¹¶å°†å‰©ä½™å¯¹è±¡è½¬å…¥å¹¸å­˜è€…åŒºæˆ–æ™‹å‡åˆ°è€å¹´ä»£ï¼Œè¿™æ ·åœ¨æ‰«ææ–°ç”Ÿä»£æ—¶ï¼Œåªéœ€è¦æ‰«æå¹¸å­˜è€…åŒºå¯¹è±¡å³å¯ï¼Œå°†å¤§å¤§å‡å°‘æ‰«æå¯¹è±¡æ‰€éœ€æ—¶é•¿ã€‚</p><p>åŒæ—¶ï¼Œå¯é€šè¿‡è®¾ç½® <code>-CMSParallelRemarkEnabled</code> å¼€å¯å¹¶è¡Œé‡æ–°æ ‡è®°ï¼Œæé«˜æ ‡è®°æ•ˆç‡ï¼Œå‡å°‘é‡æ–°æ ‡è®°å¤„ç†æ—¶é•¿ã€‚</p><p><strong>å¹¶å‘æ¸…é™¤</strong>ï¼Œä¸»è¦æ˜¯æ¸…é™¤é‚£äº›æ²¡æœ‰è¢«æ ‡è®°çš„å¯¹è±¡ï¼Œå›æ”¶å†…å­˜ç©ºé—´ã€‚ä½†è¿‡ç¨‹ä¸­äº§ç”Ÿçš„åƒåœ¾åªèƒ½åœ¨ä¸‹æ¬¡ GC ä¸­å¤„ç†ã€‚å› ä¸ºæ˜¯æ¸…ç†æ–¹æ³•äº§ç”Ÿçš„ç¢ç‰‡ï¼Œå› å˜é‡ <code>-XX:UseCMSCompactAtFullCollection</code> å‹ç¼©å¼€å…³ï¼Œ <code>-XX:CMSFullGCsBeforeCompaction</code> å†³å®šç»è¿‡å¤šå°‘æ¬¡ FullGC ä¹‹åè¿›è¡Œç©ºé—´å‹ç¼©ã€‚</p><p><strong>å¹¶å‘é‡ç½®</strong>ï¼Œä¸»è¦æ˜¯é‡ç½® CMS æ•°æ®ç»“æ„ï¼Œå‡†å¤‡åœ¨ä¸‹ä¸€ä¸ªCMSç”Ÿå‘½å‘¨æœŸä¸­ä½¿ç”¨ã€‚</p><h4 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h4><p>G1 å°† java å †åˆ’åˆ†ä¸ºå¤šä¸ªå¤§å°ç›¸ç­‰çš„ç‹¬ç«‹åŒºåŸŸï¼ŒJVM å»ºè®®å°†å…¶åˆ†ä¸º 2048 ä¸ª Regionï¼Œè€Œ Region å¤§å°ä¸º å †å¤§å°/2048ã€‚G1 ä¿ç•™äº†å¹´è½»ä»£å’Œè€å¹´ä»£æ¦‚å¿µï¼Œä¸å†ç‰©ç†éš”ç¦»ï¼Œéƒ½æ˜¯å¯ä»¥ä¸è¿ç»­ Region é›†åˆã€‚å¯ä»¥é€šè¿‡ <code>-XX:G1NewSizePercent</code> è®¾ç½®æ–°ç”Ÿä»£åˆå§‹å æ¯”ï¼Œé€šè¿‡ <code>-XX:G1MaxNewSizePercent</code> è®¾ç½®æ–°ç”Ÿä»£æœ€å¤§å æ¯”ã€‚ä¸€ä¸ª Region å¯èƒ½ä¹‹å‰æ˜¯å¹´è½»ä»£ï¼Œå¦‚æœ Region è¿›è¡Œäº†åƒåœ¾å›æ”¶ï¼Œä¹‹åå¯èƒ½åˆä¼šå˜æˆè€å¹´ä»£ï¼Œä¹Ÿå°±æ˜¯è¯´Regionçš„åŒºåŸŸåŠŸèƒ½å¯èƒ½ä¼šåŠ¨æ€å˜åŒ–ã€‚G1 æœ‰ä¸“é—¨åˆ†é…å¤§å¯¹è±¡çš„ Region å« <strong>Humongous åŒº</strong>ï¼ˆä¸“é—¨å­˜æ”¾çŸ­æœŸå·¨å‹å¯¹è±¡ä¸ç”¨ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œå¯ä»¥èŠ‚çº¦è€å¹´ä»£çš„ç©ºé—´ï¼Œé¿å…å› ä¸ºè€å¹´ä»£ç©ºé—´ä¸å¤Ÿçš„GCå¼€é”€ï¼‰ï¼Œå¤§å¯¹è±¡å¤§å°è¶…è¿‡ 150% Region å°±ä¼šè¢«æ”¾å…¥ Humongous åŒºï¼Œå¦‚æœä¸€ä¸ªå¯¹è±¡å¤ªå¤§ä¼šç”³è¯·å¤šä¸ª Regionï¼Œå¦‚æœå‰©ä½™ Region ä¸å¤Ÿå¯¹è±¡ç©ºé—´ï¼Œä¼šè§¦å‘ä¸€æ¬¡ Full GCã€‚Full GC ä¼šæ”¶é›†å¹´è½»ä»£ã€è€å¹´ä»£å’Œ Humongous åŒºã€‚</p><p>G1 ä¸ºæ¯ä¸ªåˆ†åŒºå„è‡ªåˆ†é…ä¸€ä¸ª RSetï¼ˆRemembered Setï¼‰å®ƒå†…éƒ¨ç±»ä¼¼äºä¸€ä¸ªåå‘æŒ‡é’ˆï¼Œè®°å½•äº†å…¶å®ƒ&nbsp;Region å¯¹å½“å‰&nbsp;Region çš„å¼•ç”¨æƒ…å†µã€‚ä½†å› ä¸ºå¦‚æœå¼•ç”¨æºæ˜¯æœ¬åˆ†åŒºçš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±ä¸éœ€è¦è®°å½•åœ¨ RSet ä¸­ã€ä¸”åŒæ—¶ G1 æ¯æ¬¡ GC æ—¶ï¼Œæ‰€æœ‰çš„æ–°ç”Ÿä»£éƒ½ä¼šè¢«æ‰«æï¼Œå› æ­¤å¼•ç”¨æºæ˜¯å¹´è½»ä»£çš„å¯¹è±¡ï¼Œä¹Ÿä¸éœ€è¦åœ¨ RSet ä¸­è®°å½•ï¼Œæ‰€ä»¥æœ€ç»ˆåªéœ€è¦è®°å½•è€å¹´ä»£åˆ°æ–°ç”Ÿä»£ä¹‹é—´çš„å¼•ç”¨å³å¯ã€‚</p><p>Cardï¼Œæ¯ä¸ª Region å†…éƒ¨åˆè¢«åˆ†æˆäº†è‹¥å¹²ä¸ªå¤§å°ä¸º512 Byteçš„ Cardï¼Œæ ‡è¯†å †å†…å­˜æœ€å°å¯ç”¨ç²’åº¦ã€‚åˆ†é…çš„å¯¹è±¡ä¼šå ç”¨ç‰©ç†ä¸Šè¿ç»­çš„è‹¥å¹²ä¸ªå¡ç‰‡ã€‚å½“æŸ¥æ‰¾å¯¹åˆ†åŒºRegion å†…å¯¹è±¡çš„å¼•ç”¨æ—¶ä¾¿å¯é€šè¿‡è®°å½•å¡ç‰‡æ¥æŸ¥æ‰¾è¯¥å¼•ç”¨å¯¹è±¡ã€‚æ¯ä¸ªRegionå°±æœ‰ä¸€ä¸ªå¡è¡¨æ¥æ˜ å°„vRegion ä¸­çš„å¡é¡µï¼Œæ•´å †æœ‰ä¸ªå…¨å±€å¡ç‰‡è¡¨(<code>Global Card Table</code>) å­˜å‚¨æ‰€æœ‰Regionçš„å¡è¡¨æƒ…å†µã€‚æ¯ä¸€ä¸ªRegionçš„Cardï¼Œéƒ½ç”¨ä¸€ä¸ª Byte æ¥è®°å½•æ˜¯å¦ä¿®æ”¹è¿‡ã€‚å¡è¡¨å³è¿™äº›byteçš„é›†åˆã€‚å®é™…ä¸Šï¼Œå¦‚æœæŠŠRSç†è§£æˆä¸€ä¸ªæ¦‚å¿µæ¨¡å‹ï¼Œé‚£ä¹ˆ Card Table å°±å¯ä»¥è¯´æ˜¯ RSet çš„ä¸€ç§å®ç°æ–¹å¼ã€‚</p><p><img src="/images/2024/jvm/JVM_6.png" alt="G1.png"></p><p>åƒåœ¾å›æ”¶è¿‡ç¨‹ï¼Œ</p><ol><li>åˆå§‹æ ‡è®°ï¼šæ ‡è®° GC ROOT èƒ½å…³è”åˆ°çš„å¯¹è±¡ï¼Œéœ€è¦STW</li><li>å¹¶å‘æ ‡è®°ï¼šä» GCRoots çš„ç›´æ¥å…³è”å¯¹è±¡å¼€å§‹éå†æ•´ä¸ªå¯¹è±¡å›¾çš„è¿‡ç¨‹ï¼Œæ‰«æå®Œæˆåè¿˜ä¼šé‡æ–°å¤„ç†å¹¶å‘æ ‡è®°è¿‡ç¨‹ä¸­äº§ç”Ÿå˜åŠ¨çš„å¯¹è±¡ã€‚ä½¿ç”¨ä¸‰è‰²æ ‡è®°æ³•æ ‡è®°å¯¹è±¡ã€‚</li><li>æœ€ç»ˆæ ‡è®°ï¼šçŸ­æš‚æš‚åœç”¨æˆ·çº¿ç¨‹ï¼Œå†å¤„ç†ä¸€æ¬¡ï¼Œéœ€è¦STW</li><li>å¤åˆ¶å›æ”¶ï¼šæ›´æ–° Regio nçš„ç»Ÿè®¡æ•°æ®ï¼Œå¯¹æ¯ä¸ªRegionçš„å›æ”¶ä»·å€¼å’Œæˆæœ¬æ’åºï¼Œæ ¹æ®ç”¨æˆ·è®¾ç½®çš„åœé¡¿æ—¶é—´åˆ¶å®šå›æ”¶è®¡åˆ’ã€‚å†æŠŠéœ€è¦å›æ”¶çš„ Region ä¸­å­˜æ´»å¯¹è±¡å¤åˆ¶åˆ°ç©ºçš„Regionï¼ŒåŒæ—¶æ¸…ç†æ—§çš„Regionã€‚éœ€è¦STWã€‚</li></ol><p><strong>YongGC</strong> ï¼Œè¦ä¹ˆ eden åŒºæ”¾æ»¡ï¼Œè¦ä¹ˆ G1 è®¡ç®—å›æ”¶æ—¶é—´æ¥è¿‘ <code>-XX:MaxGCPauseMills</code> è®¾ç½®å€¼ä¼šè§¦å‘ã€‚G1ä¼šæ”¶é›†æ¯ä¸ª Region å›æ”¶ä¹‹åçš„ç©ºé—´å¤§å°ã€å›æ”¶éœ€è¦çš„æ—¶é—´ã€‚æ ¹æ®è¯„ä¼°å¾—åˆ°çš„ä»·å€¼ï¼Œåœ¨åå°ç»´æŠ¤ä¸€ä¸ªä¼˜å…ˆçº§åˆ—è¡¨ï¼Œç„¶ååŸºäºæˆ‘ä»¬è®¾ç½®çš„åœé¡¿æ—¶é—´ä¼˜å…ˆå›æ”¶<strong>ä»·å€¼æ”¶ç›Šæœ€å¤§</strong>çš„ Regionã€‚ä½† YongGC çš„æ ‡è®°-å¤åˆ¶æ˜¯å…¨è¿‡ç¨‹ STWã€‚</p><p><strong>MixedGC</strong>ï¼Œè€å¹´ä»£å¯¹å æœ‰ç‡è¾¾åˆ° <code>-XX:InitiatingHeapOccupancyPercent</code> å€¼è§¦å‘ï¼Œå›æ”¶ Yong å’Œ éƒ¨åˆ†Oldï¼ˆG1 ä¼˜å…ˆé˜Ÿåˆ—çš„ä¼˜å…ˆé¡ºåºï¼‰ä»¥åŠå¤§å¯¹è±¡åŒºã€‚ä¸»è¦ä½¿ç”¨å¤åˆ¶ç®—æ³•ï¼Œæ‹·è´è¿‡ç¨‹ä¸­å‘ç°æ²¡æœ‰è¶³å¤Ÿçš„ç©º region æ‰¿è½½æ‹·è´å¯¹è±¡æ—¶è§¦å‘ Full GCã€‚</p><p><strong>FullGC</strong>ï¼ŒSTW é‡‡ç”¨å•çº¿ç¨‹è¿›è¡Œæ ‡è®°ã€æ¸…ç†å’Œå‹ç¼©æ•´ç†ã€‚</p><p>G1 æ˜¯ jdk9+ çš„é»˜è®¤åƒåœ¾å›æ”¶å™¨ã€‚</p><h4 id="ZGC"><a href="#ZGC" class="headerlink" title="ZGC"></a>ZGC</h4><p>ZGC æ˜¯ jdk11 å¼•å…¥æä½å»¶è¿Ÿçš„åƒåœ¾å›æ”¶å™¨ï¼Œå·ç§°èƒ½å¤„ç† TB çº§å†…å­˜ä¸”åœé¡¿æ—¶é—´ï¼ˆSTWï¼‰ä¸è¶…è¿‡ 10msï¼Œåœé¡¿æ—¶é—´ä¸ä¼šéšç€å †å¤§å°æˆ–è€…æ´»è·ƒå¯¹è±¡çš„å¤§å°è€Œå¢åŠ ã€‚ZGC ç›®å‰è€Œè¨€ä¸åˆ†ä»£ã€‚ZGC Region åˆ†ä¸ºä¸‰ç§å®¹é‡ï¼Œå°å‹ Region ä¸º 2MB ç”¨äºæ”¾ç½®å°äº 256 KB çš„å°å¯¹è±¡ï¼Œä¸­å‹ Region ä¸º 32MB æ”¾ç½®å¤§äºç­‰äº 256KB ä½†å°äº 4MB å¯¹è±¡ï¼Œå¤§å‹ Region å®¹é‡ä¸å›ºå®šå¿…é¡»ä¸º 2MB çš„æ•´æ•°å€æ”¾ç½® 4MB æˆ–ä»¥ä¸Šçš„å¤§å¯¹è±¡ä¸”æ¯ä¸ªå¤§å‹ Region ä¸­åªä¼šå­˜æ”¾ä¸€ä¸ªå¤§å¯¹è±¡ã€‚</p><p>ZGC åœ¨æ ‡è®°ã€è½¬ç§»å’Œé‡å®šä½é˜¶æ®µå‡ ä¹éƒ½æ˜¯å¹¶å‘çš„ï¼Œè¿™æ˜¯ ZGC å®ç°åœé¡¿æ—¶é—´å°äº 10 ms ç›®æ ‡çš„æœ€å…³é”®åŸå› ã€‚ZGC åˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œåˆå§‹æ ‡è®°ã€å¹¶å‘æ ‡è®°ã€å†æ ‡è®°ã€å¹¶å‘è½¬ç§»å‡†å¤‡ã€åˆå§‹è½¬ç§»ã€å¹¶å‘è½¬ç§»ã€‚å¯è§åªæœ‰ åˆå§‹æ ‡è®°ã€å†æ ‡è®° å’Œåˆå§‹è½¬ç§» ä¼š STWã€‚</p><p><img src="/images/2024/jvm/JVM_5.png" alt="ZGC.png"></p><p>ZGC å®ç°å¤šä¸ªå¹¶å‘è¿‡ç¨‹ï¼Œæ˜¯ä¾æ®<strong>ç€è‰²æŒ‡é’ˆ</strong> å®ç°ï¼Œè€Œä¸”ä»…åœ¨ 64 ä½æ“ä½œç³»ç»Ÿä¸Šå¯ç”¨ï¼Œå°† 64 ä½è™šæ‹Ÿåœ°å€ç©ºé—´åˆ’åˆ†ä¸º [0~4TB) å¯¹åº”Javaå †ï¼Œ[4TB ~ 8TB) ç§°ä¸ºM0åœ°å€ç©ºé—´ï¼Œ[8TB ~ 12TB) ç§°ä¸ºM1åœ°å€ç©ºé—´ï¼Œ[12TB ~ 16TB) é¢„ç•™æœªä½¿ç”¨ï¼Œ[16TB ~ 20TB) ç§°ä¸ºRemappedç©ºé—´ã€‚ZGCä½¿ç”¨äº†å†…å­˜å¤šé‡æ˜ å°„ï¼ˆMulti-Mappingï¼‰å°†å¤šä¸ªä¸åŒçš„è™šæ‹Ÿå†…å­˜åœ°å€æ˜ å°„åˆ°åŒä¸€ä¸ªç‰©ç†å†…å­˜åœ°å€ä¸Šï¼Œè¿™æ˜¯ä¸€ç§å¤šå¯¹ä¸€æ˜ å°„ã€‚</p><p><img src="/images/2024/jvm/jvm_7.png" alt="JVM_64bit.png"></p><p>åˆå§‹æ ‡è®°å’Œåˆå§‹è½¬ç§»åˆ†åˆ«éƒ½åªéœ€è¦æ‰«ææ‰€æœ‰GC Rootsï¼Œå…¶å¤„ç†æ—¶é—´å’ŒGC Rootsçš„æ•°é‡æˆæ­£æ¯”ï¼Œä¸€èˆ¬æƒ…å†µè€—æ—¶éå¸¸çŸ­ã€‚å†æ ‡è®°é˜¶æ®µ STW æ—¶é—´å¾ˆçŸ­ï¼Œæœ€å¤š1msï¼Œè¶…è¿‡1msåˆ™å†æ¬¡è¿›å…¥å¹¶å‘æ ‡è®°é˜¶æ®µã€‚å³ï¼ŒZGC å‡ ä¹æ‰€æœ‰æš‚åœéƒ½åªä¾èµ–äº GC Roots é›†åˆå¤§å°ï¼Œåœé¡¿æ—¶é—´ä¸ä¼šéšç€å †çš„å¤§å°æˆ–è€…æ´»è·ƒå¯¹è±¡çš„å¤§å°è€Œå¢åŠ ã€‚ä¸ZGCå¯¹æ¯”ï¼ŒG1çš„è½¬ç§»é˜¶æ®µå®Œå…¨ STWï¼Œä¸”åœé¡¿æ—¶é—´éšå­˜æ´»å¯¹è±¡çš„å¤§å°å¢åŠ è€Œå¢åŠ ã€‚</p><p>ä»å †ä¸­è¯»å–å¯¹è±¡ï¼Œä¸”å¯¹è±¡ä¸­å±æ€§æŒ‡å‘çš„å¯¹è±¡ï¼Œä¼šåŠ å…¥è¯»å±éšœã€‚å¦‚æœè¿™æ—¶å€™å¯¹è±¡åœ¨ GC æ—¶è¢«ç§»åŠ¨äº†ï¼Œæ¥ä¸‹æ¥ JVM å°±ä¼šåŠ ä¸Šä¸€ä¸ªè¯»å±éšœï¼Œè¿™ä¸ªå±éšœä¼šæŠŠè¯»å‡ºçš„æŒ‡é’ˆæ›´æ–°åˆ°å¯¹è±¡çš„æ–°åœ°å€ä¸Šï¼Œå¹¶ä¸”æŠŠå †é‡Œçš„è¿™ä¸ªæŒ‡é’ˆâ€œä¿®æ­£â€åˆ°åŸæœ¬çš„å­—æ®µé‡Œã€‚è¿™æ ·å°±ç®— GC æŠŠå¯¹è±¡ç§»åŠ¨äº†ï¼Œè¯»å±éšœä¹Ÿä¼šå‘ç°å¹¶ä¿®æ­£æŒ‡é’ˆï¼Œäºæ˜¯åº”ç”¨ä»£ç å°±æ°¸è¿œéƒ½ä¼šæŒæœ‰æ›´æ–°åçš„æœ‰æ•ˆæŒ‡é’ˆï¼Œè€Œä¸”ä¸éœ€è¦ STWã€‚</p><p>åƒåœ¾å›æ”¶è¿‡ç¨‹ï¼š</p><ol><li><p><strong>åˆå§‹åŒ–</strong>ï¼šZGC åˆå§‹åŒ–ä¹‹åï¼Œæ•´ä¸ªå†…å­˜ç©ºé—´çš„åœ°å€è§†å›¾è¢«è®¾ç½®ä¸º Remappedï¼Œæ ‡è®°æ˜¯åœ¨æŸ“è‰²æŒ‡é’ˆä¸Šã€‚ç¨‹åºæ­£å¸¸è¿è¡Œï¼Œåœ¨å†…å­˜ä¸­åˆ†é…å¯¹è±¡ï¼Œæ»¡è¶³ä¸€å®šæ¡ä»¶ååƒåœ¾å›æ”¶å¯åŠ¨ï¼Œæ­¤æ—¶è¿›å…¥æ ‡è®°é˜¶æ®µã€‚</p></li><li><p><strong>å¹¶å‘æ ‡è®°é˜¶æ®µ</strong>ï¼šç¬¬ä¸€æ¬¡è¿›å…¥æ ‡è®°é˜¶æ®µæ—¶è§†å›¾ä¸º M0ï¼Œå¦‚æœå¯¹è±¡è¢«GCæ ‡è®°çº¿ç¨‹æˆ–è€…åº”ç”¨çº¿ç¨‹è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°±å°†å¯¹è±¡çš„åœ°å€è§†å›¾ä» Remapped è°ƒæ•´ä¸º M0ã€‚æ‰€ä»¥ï¼Œåœ¨æ ‡è®°é˜¶æ®µç»“æŸä¹‹åï¼Œå¯¹è±¡çš„åœ°å€è¦ä¹ˆæ˜¯ M0 è§†å›¾ï¼Œè¦ä¹ˆæ˜¯ Remappedã€‚å¦‚æœå¯¹è±¡çš„åœ°å€æ˜¯ M0 è§†å›¾ï¼Œé‚£ä¹ˆè¯´æ˜å¯¹è±¡æ˜¯æ´»è·ƒçš„ï¼›å¦‚æœå¯¹è±¡çš„åœ°å€æ˜¯Remapped è§†å›¾ï¼Œè¯´æ˜å¯¹è±¡æ˜¯ä¸æ´»è·ƒçš„ã€‚</p></li><li><p><strong>å¹¶å‘è½¬ç§»é˜¶æ®µ</strong>ï¼šæ ‡è®°ç»“æŸåå°±è¿›å…¥è½¬ç§»é˜¶æ®µï¼Œæ­¤æ—¶åœ°å€è§†å›¾å†æ¬¡è¢«è®¾ç½®ä¸ºRemappedã€‚å¦‚æœå¯¹è±¡è¢« GC è½¬ç§»çº¿ç¨‹æˆ–è€…åº”ç”¨çº¿ç¨‹è®¿é—®è¿‡ï¼Œé‚£ä¹ˆå°±å°†å¯¹è±¡çš„åœ°å€è§†å›¾ä» M0 è°ƒæ•´ä¸º Remappedã€‚</p></li></ol><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><ul><li><p><a href="https://xstarcd.github.io/wiki/Java/JVM_Heap_Non-heap.html">JVMå †å†…å­˜å’Œéå †å†…å­˜</a></p></li><li><p><a href="https://zhuanlan.zhihu.com/p/111016492">ä¸‡å­—è¯¦è§£ï¼Œä¸€æ–‡å¸¦ä½ æŒæ¡ JVM åƒåœ¾å›æ”¶ï¼</a></p></li><li><p><a href="https://mikechen.cc/16719.html">ZGC åƒåœ¾å›æ”¶åˆ†æ</a></p></li><li><p><a href="https://blog.csdn.net/u011107814/article/details/118420893">åƒåœ¾å›æ”¶å™¨G1&amp;ZGCè¯¦è§£</a></p></li><li><p><a href="https://juejin.cn/post/7209266987049844791">G1 åƒåœ¾æ”¶é›†å™¨è¯¦è§£ - æ˜é‡‘</a></p></li><li><p><a href="https://cloud.tencent.com/developer/article/1897189">CMS åƒåœ¾å›æ”¶</a></p></li><li><p><a href="https://tech.meituan.com/2020/08/06/new-zgc-practice-in-meituan.html">æ–°ä¸€ä»£åƒåœ¾å›æ”¶å™¨ZGCçš„æ¢ç´¢ä¸å®è·µ - ç¾å›¢æŠ€æœ¯å›¢é˜Ÿ</a></p></li><li><p><a href="https://www.selinux.tech/java/core/jvm-zgc-memory">JVM ZGC å†…å­˜ç®¡ç† | JustNote</a></p></li><li><p><a href="https://www.cnblogs.com/booksea/p/17665685.html">æ·±å…¥è§£æZGCåƒåœ¾å›æ”¶å™¨ - Booksea - åšå®¢å›­</a></p></li></ul>]]></content>
      
      
      <categories>
          
          <category> åŸºç¡€ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> JVM </tag>
            
            <tag> åƒåœ¾å›æ”¶ </tag>
            
            <tag> ZGC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>A4 å›¾çº¸ä¸Šç»˜ç”»&quot;å®šé«˜&quot;è¡¨æ ¼</title>
      <link href="/2024/03/04/a4-tu-zhi-shang-hui-hua-ding-gao-biao-ge/"/>
      <url>/2024/03/04/a4-tu-zhi-shang-hui-hua-ding-gao-biao-ge/</url>
      
        <content type="html"><![CDATA[<p>A4 å›¾çº¸ä¸Šç»˜ç”»å®šé«˜è¡¨æ ¼ã€‚é¦–å…ˆæ˜¯è¡¨æ ¼å†…å®¹æ•°æ®ç»„è£…å’Œè¡¨æ ¼å†…å®¹æ•°æ®æ›¿æ¢ã€‚è¡¨æ ¼å†…å®¹æ•°æ®æ›¿æ¢æœ‰å‡ ç§å®ç°æ–¹å¼ã€‚ä¸€ç§ï¼Œå€ŸåŠ© html ç»˜åˆ¶ table æ¨¡æ¿ï¼Œä½¿ç”¨ thymeleaf åšå…ƒç´ æ›¿æ¢ã€‚ä¸€ç§ï¼Œå€ŸåŠ© word å’Œ ä¹¦ç­¾ç»˜åˆ¶æ¨¡æ¿ï¼Œä½¿ç”¨ poi å®Œæˆä¹¦ç­¾æ›¿æ¢ã€‚ä¸€ç§ï¼Œä½¿ç”¨ word ç»˜åˆ¶ ftl æ¨¡æ¿ï¼Œä½¿ç”¨ freemarker å®Œæˆå…ƒç´ æ›¿æ¢ã€‚ä»¥ä¸Šå‡ ç§çš„è¡¨æ ¼å†…å®¹æ•°æ®æ›¿æ¢æ–¹æ¡ˆï¼Œç›¸å¯¹æ¥è¯´ html æ¨¡æ¿å’Œ ftl æ¨¡æ¿æ˜¯æœ‰æ¯”è¾ƒå¥½çš„å»¶å±•æ€§ã€‚</p><p>è‡³äºè¡¨æ ¼å†…å®¹æ•°æ®ç»„è£…ï¼ŒæŒ‰ç…§ä¸šåŠ¡ç»„è£…å³å¯ã€‚æœ€è¿‘æœ‰è¿™ç§â€œå®šé«˜â€è¡¨æ ¼éœ€æ±‚ï¼Œæ•…è€Œåœ¨æ­¤åˆ†äº«ã€‚æŒ‰ä¸¤åˆ†åˆ—å±•ç¤ºè¡¨æ ¼å†…å®¹ï¼Œæ¯ä¸ªåˆ†åˆ—å ç”¨ 3 åˆ—ï¼Œæ€»å…±ä¸€è¡Œ 6 åˆ—å±•ç¤ºä¸¤ä¸ªä¸šåŠ¡æ•°æ®ã€‚</p><p><img src="/images/2024/a4_table_dinggao/A41.jpg" alt="A1.jpg"></p><p><img src="/images/2024/a4_table_dinggao/4A2.jpg" alt="A2.jpg"></p><h3 id="éœ€æ±‚ç‚¹è¯†åˆ«"><a href="#éœ€æ±‚ç‚¹è¯†åˆ«" class="headerlink" title="éœ€æ±‚ç‚¹è¯†åˆ«"></a>éœ€æ±‚ç‚¹è¯†åˆ«</h3><ol><li><p>è¦æ±‚åœ¨å›ºå®šé«˜åº¦ä¸‹å°½å¯èƒ½å±•ç¤ºçš„è¡Œæ•°ã€‚</p></li><li><p>è¦æ±‚åºå·å’Œé¡µæ¬¡ä¸å¯æ¢è¡Œï¼Œä¸”è·¨é¡µå¯¹é½ã€‚</p></li><li><p>è¦æ±‚å•é¡µå†…å…ƒç´ ä¸å¤Ÿçš„ç”¨ç©ºè¡Œå æ®ã€‚</p></li><li><p>åºå·å•é¡µå†…å·¦ä¾§ä»n<del>mï¼Œåºå·å•é¡µå†…å³ä¾§ä» m+1</del>2mã€‚</p></li></ol><h3 id="è®¾è®¡åŠå®ç°"><a href="#è®¾è®¡åŠå®ç°" class="headerlink" title="è®¾è®¡åŠå®ç°"></a>è®¾è®¡åŠå®ç°</h3><h4 id="NO1ï¼Œè®¾è®¡ä½¿ç”¨-html-æ¨¡æ¿"><a href="#NO1ï¼Œè®¾è®¡ä½¿ç”¨-html-æ¨¡æ¿" class="headerlink" title="NO1ï¼Œè®¾è®¡ä½¿ç”¨ html æ¨¡æ¿"></a>NO1ï¼Œè®¾è®¡ä½¿ç”¨ html æ¨¡æ¿</h4><p>ä½¿ç”¨ html æ¨¡æ¿ + thymeleaf æ›¿æ¢ <code>th:</code> ç±»æ ‡ç­¾ã€‚ä½¿ç”¨ html  æ¨¡æ¿æ˜¯å› ä¸ºå¯ä»¥é€šè¿‡ css è°ƒæ•´æ ·å¼ï¼Œå¹¶ä¸”èƒ½å¤ŸæŒ‰å®šåˆ¶éœ€æ±‚å®Œæˆåˆ†é¡µã€‚</p><p>å…¶ä¸­ï¼Œ A4 å¯¹åº”åƒç´  <code>794px * 1123px</code> ï¼Œè¡¨æ ¼çš„å®½é«˜è®¾ç½®ä¸º A4 çš„ 85%ï¼Œå³ <code>675px * 955px</code> ã€‚è®¾ç½®è¡¨å¤´å†…å®¹æ— é¢œè‰²å±…ä¸­ã€‚</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">width</span><span class="token punctuation">:</span>794px<span class="token punctuation">;</span><span class="token property">height</span><span class="token punctuation">:</span>1123px</span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>table</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>table-bordered table<span class="token punctuation">"</span></span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>tr</span><span class="token punctuation">&gt;</span></span>            <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>td</span> <span class="token attr-name">colspan</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span>6<span class="token punctuation">"</span></span> <span class="token special-attr"><span class="token attr-name">style</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">"</span><span class="token value css language-css"><span class="token property">font-size</span><span class="token punctuation">:</span> 25px<span class="token punctuation">;</span> <span class="token property">border-style</span><span class="token punctuation">:</span> none<span class="token punctuation">;</span></span><span class="token punctuation">"</span></span></span><span class="token punctuation">&gt;</span></span>è¡¨å¤´æè¿°<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>td</span><span class="token punctuation">&gt;</span></span>        <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>tr</span><span class="token punctuation">&gt;</span></span>    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>table</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-css" data-language="css"><code class="language-css">    <span class="token selector">*</span> <span class="token punctuation">{</span>            <span class="token property">font-family</span><span class="token punctuation">:</span> SimHei<span class="token punctuation">;</span>            <span class="token property">font-size</span><span class="token punctuation">:</span> 18px<span class="token punctuation">;</span>            <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token selector">.table</span> <span class="token punctuation">{</span>            <span class="token property">width</span><span class="token punctuation">:</span> 85%<span class="token punctuation">;</span>            <span class="token property">border-collapse</span><span class="token punctuation">:</span> collapse <span class="token important">!important</span><span class="token punctuation">;</span>            <span class="token property">margin</span><span class="token punctuation">:</span> auto auto<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token selector">.table th,.table td</span> <span class="token punctuation">{</span>            <span class="token property">height</span><span class="token punctuation">:</span> 35px<span class="token punctuation">;</span>            <span class="token property">padding</span><span class="token punctuation">:</span> 0.35rem<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token selector">.table-bordered th, .table-bordered td</span> <span class="token punctuation">{</span>            <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #000000<span class="token punctuation">;</span>        <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NO2ï¼Œåºå·ã€å†…å®¹ã€é¡µæ¬¡ï¼Œè¡¨æ ¼ä¸­å•ä¸ªå…ƒç´ ç»„å„ä¸ªå•å…ƒæ ¼çš„å®½åº¦å’Œé«˜åº¦"><a href="#NO2ï¼Œåºå·ã€å†…å®¹ã€é¡µæ¬¡ï¼Œè¡¨æ ¼ä¸­å•ä¸ªå…ƒç´ ç»„å„ä¸ªå•å…ƒæ ¼çš„å®½åº¦å’Œé«˜åº¦" class="headerlink" title="NO2ï¼Œåºå·ã€å†…å®¹ã€é¡µæ¬¡ï¼Œè¡¨æ ¼ä¸­å•ä¸ªå…ƒç´ ç»„å„ä¸ªå•å…ƒæ ¼çš„å®½åº¦å’Œé«˜åº¦"></a>NO2ï¼Œåºå·ã€å†…å®¹ã€é¡µæ¬¡ï¼Œè¡¨æ ¼ä¸­å•ä¸ªå…ƒç´ ç»„å„ä¸ªå•å…ƒæ ¼çš„å®½åº¦å’Œé«˜åº¦</h4><p>åºå·å’Œé¡µæ¬¡é«˜åº¦åªæœ‰ä¸€è¡Œï¼Œåƒä¸‡ä¸è¦æ¢è¡Œã€‚å†…å®¹ä¼šå› ä¸ºå•å…ƒæ ¼å†…å®¹é•¿çŸ­å¯èƒ½å­˜åœ¨æ¢è¡Œã€‚å› ä¸ºè¡¨æ ¼å®½åº¦ä¸º 675pxï¼Œå†…å®¹å®½åº¦ = 675 - åºå·å®½åº¦ - é¡µæ¬¡å®½åº¦ã€‚è¿˜æœ‰ï¼ŒåŠè§’å­—ç¬¦å ç”¨ 10 pxï¼Œå…¨è§’å­—ç¬¦å ç”¨ 18pxã€‚å…¶ä¸­è‹±æ–‡ç›¸å…³å­—ç¬¦ä¸ºåŠè§’å­—ç¬¦ï¼Œä¸­æ–‡ç›¸å…³å­—ç¬¦ä¸ºå…¨è§’å­—ç¬¦ã€‚åºå·å’Œé¡µæ¬¡ä½¿ç”¨é˜¿æ‹‰ä¼¯æ•°å­—è¡¨ç¤ºï¼Œä¸ºåŠè§’å­—ç¬¦ã€‚æ‰€ä»¥ï¼Œåºå·å’Œé¡µæ¬¡å ç”¨å®½åº¦ä¸º é•¿åº¦ * 10pxã€‚åºå·çš„æœ€å¤§é•¿åº¦ä¸ºå…ƒç´ ç»„ size é•¿åº¦ï¼Œé¡µæ¬¡çš„æœ€å¤§é•¿åº¦ä¸ºå…ƒç´ ç»„æœ€åä¸€ä¸ªçš„é¡µæ¬¡é•¿åº¦ï¼Œåºå·å’Œé¡µæ¬¡çš„é«˜åº¦ä¸º <code>.table td</code> æ ·å¼é«˜åº¦ 35 pxã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluTreeNode</span><span class="token punctuation">&gt;</span></span> nonEmptyMulus <span class="token operator">=</span> muluJiegouParam<span class="token punctuation">.</span><span class="token function">getNonEmptyMulus</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> muluNum <span class="token operator">=</span> nonEmptyMulus<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åºå·å®½åº¦</span><span class="token keyword">int</span> xhWidth <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> <span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>muluNum<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// é¡µæ¬¡å®½åº¦</span><span class="token class-name">MuluTreeNode</span> lastMuluTreeNode <span class="token operator">=</span> nonEmptyMulus<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>muluNum <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> lastPageInfo <span class="token operator">=</span> lastMuluTreeNode<span class="token punctuation">.</span><span class="token function">getPageInfo</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> yeciWidth <span class="token operator">=</span> <span class="token number">10</span> <span class="token operator">*</span> lastPageInfo<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å†…å®¹é«˜åº¦ï¼Œåˆ™æ˜¯å¯¹å•å…ƒæ ¼å†…å®¹æ¯ä¸ªå­—ç¬¦ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ <code>[\x00-\xff]</code> åˆ¤æ–­æ˜¯å¦åŠè§’å­—ç¬¦ç´¯è®¡å®½åº¦ï¼Œå®½åº¦ä¸å¯å¤§äºå†…å®¹å®šå®½ï¼Œå¾ªç¯ç´¯è®¡å‡ æ¬¡åç¡®å®šè¡Œæ•° linesã€‚å¦‚æœ lines ä¸ºå•è¡Œåˆ™é«˜åº¦ä¸º 35 pxï¼Œå¦‚æœ lines ä¸º 2+ è¡Œåˆ™é«˜åº¦ä¸º <code>21px * lines</code>ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">int</span> tempContentWidthPx <span class="token operator">=</span> contentWidthPx<span class="token punctuation">;</span><span class="token class-name">String</span> content <span class="token operator">=</span> muluJiegouItem<span class="token punctuation">.</span><span class="token function">getContent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> length <span class="token operator">=</span> content<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"[\\x00-\\xff]"</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">int</span> line <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">String</span> contentIdx <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>content<span class="token punctuation">,</span> index<span class="token punctuation">,</span> <span class="token operator">++</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>contentIdx<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> itemWidthPx <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token constant">HALF_WIDTH_CHAR_PX</span> <span class="token operator">:</span> <span class="token constant">FULL_WIDTH_CHAR_PX</span><span class="token punctuation">;</span>    <span class="token keyword">int</span> nextContentWidthPx <span class="token operator">=</span> tempContentWidthPx <span class="token operator">-</span> itemWidthPx<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>nextContentWidthPx <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        tempContentWidthPx <span class="token operator">=</span> nextContentWidthPx<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        line<span class="token operator">++</span><span class="token punctuation">;</span>        tempContentWidthPx <span class="token operator">=</span> contentWidthPx <span class="token operator">-</span> itemWidthPx<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">++</span>line<span class="token punctuation">;</span><span class="token comment">// å…¶ä¸­ 35 ä¸ºå•è¡Œé«˜åº¦åƒç´ ï¼Œ21 * line ä¸ºå¤šè¡Œé«˜åº¦åƒç´ ï¼Œ14 ä¸º padding-top + padding-bottom</span><span class="token keyword">int</span> heightPx <span class="token operator">=</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token number">1</span> <span class="token operator">?</span> <span class="token number">35</span> <span class="token operator">:</span> <span class="token number">21</span> <span class="token operator">*</span> line<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">14</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NO3ï¼Œç¡®å®šå·¦ä¾§èƒ½è£…è½½å…ƒç´ é•¿åº¦ï¼Œç´¢å¼•ä½ï¼ˆ0-length-1ï¼‰"><a href="#NO3ï¼Œç¡®å®šå·¦ä¾§èƒ½è£…è½½å…ƒç´ é•¿åº¦ï¼Œç´¢å¼•ä½ï¼ˆ0-length-1ï¼‰" class="headerlink" title="NO3ï¼Œç¡®å®šå·¦ä¾§èƒ½è£…è½½å…ƒç´ é•¿åº¦ï¼Œç´¢å¼•ä½ï¼ˆ0~length-1ï¼‰"></a>NO3ï¼Œç¡®å®šå·¦ä¾§èƒ½è£…è½½å…ƒç´ é•¿åº¦ï¼Œç´¢å¼•ä½ï¼ˆ0~length-1ï¼‰</h4><p>ä»¥å•é¡µå®šé«˜ 820 px ä¸ºä¸Šé™ï¼ŒæŒ‰ç…§æ¯ä¸ªå…ƒç´ å†…å®¹é«˜åº¦çœ‹å•é¡µå·¦ä¾§æœ€å¤šèƒ½è£…ä¸‹å¤šå°‘å…ƒç´ ã€‚ä½†æ˜¯ï¼Œå…ƒç´ é›†åˆé«˜åº¦æ€»å’Œå°äº 820 pxæ—¶ï¼Œéœ€è¦ç”¨ç©ºè¡Œè¡¥å……ï¼Œè‡³äºå¤šå°‘ä¸ªåˆ™æ˜¯ç”¨ é«˜åº¦å·®å€¼px/49pxï¼Œå…¶ä¸­ 49px =  35px + 7px + 7pxã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">confirmPageLeftLength</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> muluJiegouItemHeights<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> height <span class="token operator">=</span> <span class="token constant">PAGE_CONTENT_HEIGHT</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> pageLength <span class="token operator">=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> length <span class="token operator">=</span> muluJiegouItemHeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> index <span class="token operator">&lt;</span> length<span class="token punctuation">;</span> index<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> tempHeight <span class="token operator">=</span> height <span class="token operator">-</span> muluJiegouItemHeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>tempHeight <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            pageLength <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            height <span class="token operator">=</span> tempHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pageLength <span class="token operator">==</span> length <span class="token operator">&amp;&amp;</span> height <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            pageLength <span class="token operator">+=</span> height<span class="token operator">/</span><span class="token number">49</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> pageLength<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NO4ï¼Œç¡®å®šå³ä¾§èƒ½è£…è½½å…ƒç´ èŒƒå›´"><a href="#NO4ï¼Œç¡®å®šå³ä¾§èƒ½è£…è½½å…ƒç´ èŒƒå›´" class="headerlink" title="NO4ï¼Œç¡®å®šå³ä¾§èƒ½è£…è½½å…ƒç´ èŒƒå›´"></a>NO4ï¼Œç¡®å®šå³ä¾§èƒ½è£…è½½å…ƒç´ èŒƒå›´</h4><p>æœ€å¤šèƒ½è£…è½½çš„å…ƒç´ ä¸º <strong>NO3</strong> å·¦ä¾§ lengthï¼Œç´¢å¼•ä¸º <code>length ~ 2*length-1</code> ã€‚ä½†å‰ææ˜¯å³ä¾§ç´¢å¼•èŒƒå›´å…ƒç´ é«˜åº¦ä¹‹å’Œå¿…é¡»<strong>å°äº</strong>å•é¡µå®šé«˜ã€‚å¯¹äº <code>2*length</code> å°äºå…ƒç´ é›†åˆé•¿åº¦ï¼Œéœ€è¦ç”¨ç©ºå•è¡Œå¡«å……å…ƒç´ é›†åˆï¼ˆå½“ç„¶å¾—å…ˆæ‹·è´é›†åˆï¼Œå¦åˆ™ä¼šå½±å“å…ƒç´ é›†åˆï¼‰ã€‚å¯¹äºå³ä¾§ç´¢å¼•èŒƒå›´å…ƒç´ é«˜åº¦ä¹‹å’Œå¤§äºå•é¡µå®šé«˜ï¼Œéœ€è¦å‡å°‘å³ä¾§å…ƒç´ çš„èµ·æ­¢ä½ç½® <code>length-1 ~ 2*length-3</code>ï¼Œä¹Ÿå°±æ˜¯å‘å‰æŒªåŠ¨ 2 ä¸ªå…ƒç´ ï¼ˆå³å•è¡Œå…ƒç´ ï¼‰ã€‚è€Œå³ä¾§ç´¢å¼•èŒƒå›´å…ƒç´ é«˜åº¦ï¼Œæ¯ä¸ªå…ƒç´ é«˜åº¦éœ€è¦å–å·¦å†…å®¹é«˜åº¦å’Œå³å†…å®¹é«˜åº¦æœ€å¤§å€¼ï¼ŒåŸå› å¾ˆç®€å•æ€»ä¸èƒ½å·¦ä¾§å’Œå³ä¾§ä¸ä¸€æ ·ï¼Œé‚£æ ·ä¼š â€œå¤§å°çœ¼â€ã€‚</p><p>æœ€ç»ˆï¼Œç¡®è®¤çš„å³ä¾§èƒ½å¡«å……çš„å…ƒç´ é•¿åº¦ final_lengthï¼Œé‚£å•é¡µçš„å…ƒç´ é•¿åº¦ä¸º <code>2*final_length</code> ç´¢å¼•ä½ <code>0 ~ 2*final_length - 1</code> ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">int</span> <span class="token function">confirmPageRightLength</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> muluJiegouItemHeights<span class="token punctuation">,</span> <span class="token keyword">int</span> leftPageLength<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> length <span class="token operator">=</span> muluJiegouItemHeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leftPageLength <span class="token operator">&gt;=</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> leftPageLength<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> pageLength <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> leftPageLength<span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> copyedHeights <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>muluJiegouItemHeights<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pageLength <span class="token operator">&gt;</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            copyedHeights<span class="token punctuation">.</span><span class="token function">addAll</span><span class="token punctuation">(</span><span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> pageLength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>num <span class="token operator">-&gt;</span> <span class="token constant">SINGLE_ROW_OFFSETHEIGHT_PX</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// è¿™æ®µè¦æ”¹</span>        <span class="token keyword">int</span> finalLeftPageLength <span class="token operator">=</span> leftPageLength<span class="token punctuation">;</span>        <span class="token keyword">int</span> height <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>leftPageLength<span class="token punctuation">,</span> pageLength<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>index <span class="token operator">-&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>copyedHeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> copyedHeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> finalLeftPageLength<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>height <span class="token operator">&gt;</span> <span class="token constant">PAGE_CONTENT_HEIGHT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            leftPageLength<span class="token operator">--</span><span class="token punctuation">;</span>            pageLength <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> leftPageLength<span class="token punctuation">;</span>            <span class="token keyword">int</span> finalLeftPageLength2 <span class="token operator">=</span> leftPageLength<span class="token punctuation">;</span>            height <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span>leftPageLength<span class="token punctuation">,</span> pageLength<span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>index <span class="token operator">-&gt;</span> <span class="token class-name">Integer</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span>copyedHeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span> copyedHeights<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index <span class="token operator">-</span> finalLeftPageLength2<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> leftPageLength<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NO5ï¼Œä¾æ®-NO4-æä¾›çš„-final-length-ç»„è£…å•é¡µè¡¨æ ¼å…ƒç´ "><a href="#NO5ï¼Œä¾æ®-NO4-æä¾›çš„-final-length-ç»„è£…å•é¡µè¡¨æ ¼å…ƒç´ " class="headerlink" title="NO5ï¼Œä¾æ® NO4 æä¾›çš„ final_length ç»„è£…å•é¡µè¡¨æ ¼å…ƒç´ "></a>NO5ï¼Œä¾æ® NO4 æä¾›çš„ final_length ç»„è£…å•é¡µè¡¨æ ¼å…ƒç´ </h4><p>åˆ°è¿™é‡Œå°±æ²¡ä»€ä¹ˆå¥½è¯´çš„å°±æ˜¯ç»„è£…å·¦å…ƒç´ å’Œå³å…ƒç´ ï¼Œåˆ°è¿™é‡Œå°±ç›¸å½“ç®€å•å•¦ï¼Œä½†æ˜¯è¦è®°å¾—åˆ é™¤å·²ç»å¤„ç†è¿‡çš„å…ƒç´ ï¼Œå¦åˆ™è®¡ç®—ä¸‹ä¸€é¡µçš„æ—¶å€™è¿˜è¦åšç´¢å¼•åç§»ã€‚å“ˆå“ˆï¼Œè¦è¯´å†è§äº†ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluJiegouLineItem</span><span class="token punctuation">&gt;</span></span> <span class="token function">buildMuluJiegouPage</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> muluJiegouItemHeights<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluJiegouItem</span><span class="token punctuation">&gt;</span></span> muluJiegouItemList<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> pageLength <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">confirmPageLength</span><span class="token punctuation">(</span>muluJiegouItemHeights<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> removePageLength <span class="token operator">=</span> pageLength<span class="token punctuation">;</span>        <span class="token keyword">int</span> length <span class="token operator">=</span> muluJiegouItemHeights<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>pageLength <span class="token operator">&gt;=</span> length<span class="token punctuation">)</span> <span class="token punctuation">{</span>            removePageLength <span class="token operator">=</span> length<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluJiegouLineItem</span><span class="token punctuation">&gt;</span></span> page <span class="token operator">=</span> <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> pageLength <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">boxed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>index <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">MuluJiegouItem</span> left <span class="token operator">=</span> <span class="token function">getItem</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> muluJiegouItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">MuluJiegouItem</span> right <span class="token operator">=</span> <span class="token function">getItem</span><span class="token punctuation">(</span>index <span class="token operator">+</span> pageLength<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> muluJiegouItemList<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">MuluJiegouLineItem</span><span class="token punctuation">.</span><span class="token function">builder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">left</span><span class="token punctuation">(</span>left<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">right</span><span class="token punctuation">(</span>right<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> muluJiegouItemHeightIter <span class="token operator">=</span> muluJiegouItemHeights<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluJiegouItem</span><span class="token punctuation">&gt;</span></span> muluJiegouItemIter <span class="token operator">=</span> muluJiegouItemList<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">IntStream</span><span class="token punctuation">.</span><span class="token function">range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> removePageLength<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>index <span class="token operator">-&gt;</span> index <span class="token operator">&lt;</span>length<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>index <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            muluJiegouItemIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            muluJiegouItemIter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            muluJiegouItemHeightIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            muluJiegouItemHeightIter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> page<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="NO6ï¼Œå€’åºæè¿°çš„æœ€å"><a href="#NO6ï¼Œå€’åºæè¿°çš„æœ€å" class="headerlink" title="NO6ï¼Œå€’åºæè¿°çš„æœ€å"></a>NO6ï¼Œå€’åºæè¿°çš„æœ€å</h4><p>å€’åºæè¿°çš„æœ€åæ˜¯æ–¹æ³•çš„å…¥å£ï¼Œæ‰€ä»¥è¦æµ‹è¯•çš„è¯ï¼Œé¡ºåºå¾—æ˜¯ <code>NO1 =&gt; NO2 =&gt; NO6 =&gt; NO5 =&gt; NO3 =&gt; NO4</code>ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">buildMuluJiegouPages</span><span class="token punctuation">(</span><span class="token class-name">MuluJiegouItems</span> muluJiegouItems<span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluTreeNode</span><span class="token punctuation">&gt;</span></span> nonEmptyMulus<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> widthPx <span class="token operator">=</span> muluJiegouItems<span class="token punctuation">.</span><span class="token function">getContentWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MuluJiegouItem</span><span class="token punctuation">&gt;</span></span> muluJiegouItemList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">convert</span><span class="token punctuation">(</span>nonEmptyMulus<span class="token punctuation">,</span> widthPx<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> muluJiegouItemHeights <span class="token operator">=</span> muluJiegouItemList<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">MuluJiegouItem</span><span class="token operator">::</span><span class="token function">getHeightPx</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MuluJiegouLineItem</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pages <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isNotEmpty</span><span class="token punctuation">(</span>muluJiegouItemHeights<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            pages<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token function">buildMuluJiegouPage</span><span class="token punctuation">(</span>muluJiegouItemHeights<span class="token punctuation">,</span> muluJiegouItemList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        muluJiegouItems<span class="token punctuation">.</span><span class="token function">setPages</span><span class="token punctuation">(</span>pages<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> A4 </tag>
            
            <tag> åˆ†é¡µ </tag>
            
            <tag> å®šé«˜ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>java é€šè¿‡ OpenCV æå–ç­”é¢˜å¡é€‰æ‹©é¢˜ç­”æ¡ˆ</title>
      <link href="/2024/02/24/java-tong-guo-opencv-ti-qu-da-ti-qia-xuan-ze-ti-da-an/"/>
      <url>/2024/02/24/java-tong-guo-opencv-ti-qu-da-ti-qia-xuan-ze-ti-da-an/</url>
      
        <content type="html"><![CDATA[<h3 id="ç­”é¢˜å¡è¯†åˆ«æŠ€æœ¯é€‰å‹"><a href="#ç­”é¢˜å¡è¯†åˆ«æŠ€æœ¯é€‰å‹" class="headerlink" title="ç­”é¢˜å¡è¯†åˆ«æŠ€æœ¯é€‰å‹"></a>ç­”é¢˜å¡è¯†åˆ«æŠ€æœ¯é€‰å‹</h3><p>OpenCVï¼ˆOpen Source Computer Vision Libraryï¼‰ æ˜¯ä¸€ç§å¼€æºè®¡ç®—æœºè§†è§‰åº“ï¼Œå®ƒæä¾›äº†ä¸€äº›ç”¨äºå¤„ç†å›¾åƒå’Œè§†é¢‘çš„å·¥å…·å’Œç®—æ³•ã€‚ç”¨äºå¤„ç†å›¾ç‰‡çš„çº åã€‚</p><p>tesseract-OCRï¼Œè¯†åˆ«å°åˆ·ä½“æ–‡å­—æ˜¯è½»é‡çš„ OCR å¼•æ“ã€‚ç”¨äºè¯†åˆ«é—®é¢˜å·ã€‚æµ‹è¯•è¿‡ tesseract çš„ java SDK <code>tess4j</code> è¯†åˆ«ç»“æœå’Œç›´æ¥ä½¿ç”¨ tesseract å‘½ä»¤è¯†åˆ«ç»“æœä¸ä¸€æ ·ã€‚æœ€ç»ˆæˆ‘é€‰äº†ç›´æ¥ä½¿ç”¨ tesseract å‘½ä»¤è¯†åˆ«ã€‚</p><h3 id="ç­”é¢˜å¡è¯†åˆ«å‰ç½®çº¦æŸ"><a href="#ç­”é¢˜å¡è¯†åˆ«å‰ç½®çº¦æŸ" class="headerlink" title="ç­”é¢˜å¡è¯†åˆ«å‰ç½®çº¦æŸ"></a>ç­”é¢˜å¡è¯†åˆ«å‰ç½®çº¦æŸ</h3><ol><li><p>éœ€è¦ä»¥å›ºå®šçš„æ ¼å¼è®¾ç½®é—®å·</p><ul><li><p>ç­”é¢˜åŒºçš„å®½åº¦å¤§äºé—®é¢˜çš„å®½åº¦</p><p><img src="/images/2024/opencv_tesseract_answerarea/openCV_1.jpg" alt="openCV_1.jpg"></p></li><li><p>éœ€è¦å›ºå®šéƒ¨åˆ†å®½åº¦çš„æ¯”ä¾‹</p><p><img src="/images/2024/opencv_tesseract_answerarea/openCV_2.png" alt="openCV_2.jpg"></p></li></ul></li><li><p>è¯†åˆ«ç»“æœçš„å¥½åéƒ½å’Œæ‰«æå›¾ç‰‡çš„è´¨é‡æœ‰å…³ï¼Œå»ºè®®æ˜¯ç°åº¦ 300dpi æ‰«æè®¾ç½®</p></li></ol><h3 id="ç­”é¢˜å¡è¯†åˆ«å…³é”®ä»£ç "><a href="#ç­”é¢˜å¡è¯†åˆ«å…³é”®ä»£ç " class="headerlink" title="ç­”é¢˜å¡è¯†åˆ«å…³é”®ä»£ç "></a>ç­”é¢˜å¡è¯†åˆ«å…³é”®ä»£ç </h3><h4 id="è·å–ç­”é¢˜åŒºé¢˜å·è¯†åˆ«"><a href="#è·å–ç­”é¢˜åŒºé¢˜å·è¯†åˆ«" class="headerlink" title="è·å–ç­”é¢˜åŒºé¢˜å·è¯†åˆ«"></a>è·å–ç­”é¢˜åŒºé¢˜å·è¯†åˆ«</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">getAnsTitles</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AnswerTitleException</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> outPath <span class="token operator">=</span> filePath<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> filePath<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">File</span> file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>outPath <span class="token operator">+</span> <span class="token string">".txt"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Runtime</span> runtime <span class="token operator">=</span> <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">String</span> command <span class="token operator">=</span> <span class="token string">"tesseract "</span> <span class="token operator">+</span>  filePath <span class="token operator">+</span> <span class="token string">" "</span> <span class="token operator">+</span> outPath <span class="token operator">+</span><span class="token string">" -l chi_sim "</span><span class="token punctuation">;</span>            <span class="token class-name">Process</span> ps <span class="token operator">=</span> runtime<span class="token punctuation">.</span><span class="token function">exec</span><span class="token punctuation">(</span>command<span class="token punctuation">)</span><span class="token punctuation">;</span>            ps<span class="token punctuation">.</span><span class="token function">waitFor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// è¯»å–æ–‡ä»¶</span>            <span class="token class-name">String</span> result <span class="token operator">=</span> <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">readLines</span><span class="token punctuation">(</span>file<span class="token punctuation">,</span> <span class="token class-name">StandardCharsets</span><span class="token punctuation">.</span><span class="token constant">UTF_8</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>line <span class="token operator">-&gt;</span> line<span class="token punctuation">.</span><span class="token function">replaceAll</span><span class="token punctuation">(</span><span class="token string">"\n"</span><span class="token punctuation">,</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token constant">EMPTY</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{} result: {}"</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"ç­”\\s*\\d+\\s*[-]*\\s*\\d*"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ansTitles <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">while</span><span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                ansTitles<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">group</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{} result pattern: {}"</span><span class="token punctuation">,</span> command<span class="token punctuation">,</span> ansTitles<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> ansTitles<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AnswerTitleException</span><span class="token punctuation">(</span><span class="token class-name">MessageFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"{0} answer-title-identify"</span><span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token class-name">FileUtils</span><span class="token punctuation">.</span><span class="token function">deleteQuietly</span><span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="é€šè¿‡-openCV-æˆªå–ç­”é¢˜å¡åŒºåŸŸ"><a href="#é€šè¿‡-openCV-æˆªå–ç­”é¢˜å¡åŒºåŸŸ" class="headerlink" title="é€šè¿‡ openCV æˆªå–ç­”é¢˜å¡åŒºåŸŸ"></a>é€šè¿‡ openCV æˆªå–ç­”é¢˜å¡åŒºåŸŸ</h4><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">static</span> <span class="token punctuation">{</span>  <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">loadLibrary</span><span class="token punctuation">(</span><span class="token class-name">Core</span><span class="token punctuation">.</span><span class="token constant">NATIVE_LIBRARY_NAME</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">recognize</span><span class="token punctuation">(</span><span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>         <span class="token comment">// è·å–è¯†åˆ«å†…å®¹ï¼Œç¡®å®šç­”é¢˜å·</span>            <span class="token class-name">Mat</span> srcImgMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token class-name">Mat</span> cvtMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token class-name">Mat</span> correctImgMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> ansTitles <span class="token operator">=</span> <span class="token function">getAnsTitles</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>                srcImgMat <span class="token operator">=</span> <span class="token class-name">Imgcodecs</span><span class="token punctuation">.</span><span class="token function">imread</span><span class="token punctuation">(</span>filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>                cvtMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// ç°åº¦</span>                <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">cvtColor</span><span class="token punctuation">(</span>srcImgMat<span class="token punctuation">,</span> cvtMat<span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">COLOR_BGR2GRAY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// çŸ«æ­£</span>                correctImgMat <span class="token operator">=</span> imgCorrector<span class="token punctuation">.</span><span class="token function">correct</span><span class="token punctuation">(</span>cvtMat<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token comment">// æˆªç­”é¢˜åŒº</span>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Mat</span><span class="token punctuation">&gt;</span></span> answerAreaMats <span class="token operator">=</span> answerCutter<span class="token punctuation">.</span><span class="token function">answerCut</span><span class="token punctuation">(</span>correctImgMat<span class="token punctuation">,</span> filePath<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>ansTitles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> answerAreaMats<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    answerAreaMats<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>ansAreaMat <span class="token operator">-&gt;</span> <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>ansAreaMat<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AnswerCutException</span><span class="token punctuation">(</span><span class="token string">"ç­”é¢˜æ•°å’Œç­”æ¡ˆåŒºæ•°é‡ä¸ä¸€è‡´ï¼Œè·³è¿‡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerArea</span><span class="token punctuation">&gt;</span></span> answerAreas <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>ansTitles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> ansTitles<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    answerAreas<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AnswerArea</span><span class="token punctuation">(</span>ansTitles<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">,</span> answerAreaMats<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">return</span> answerAreas<span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">CorrectException</span> <span class="token operator">|</span> <span class="token class-name">AnswerCutException</span> <span class="token operator">|</span> <span class="token class-name">AnswerTitleException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"file:{}"</span><span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>                <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>srcImgMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>cvtMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>correctImgMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token annotation punctuation">@Getter</span><span class="token annotation punctuation">@Setter</span><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AnswerArea</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> title<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">Mat</span> areaMat<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="å›¾ç‰‡çº å"><a href="#å›¾ç‰‡çº å" class="headerlink" title="å›¾ç‰‡çº å"></a>å›¾ç‰‡çº å</h5><p>å›¾ç‰‡çº åï¼Œçº æ­£è§’åº¦è¶…è¿‡ 10 åº¦çš„å›¾ç‰‡ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImgCorrector</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">Scalar</span> <span class="token constant">WHITE_PAGE</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scalar</span><span class="token punctuation">(</span><span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANNY_KERNEL_SIZE</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANNY_THRESHOLD</span> <span class="token operator">=</span> <span class="token number">40</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">CANNY_THRESHOLD_RATIO</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRAIGHT_PINGJIAO</span> <span class="token operator">=</span> <span class="token number">180</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRAIGHT_ZHIJIAO</span> <span class="token operator">=</span> <span class="token number">90</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THRESHOLD_300</span> <span class="token operator">=</span> <span class="token number">300</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THRESHOLD_200</span> <span class="token operator">=</span> <span class="token number">200</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THRESHOLD_100</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>    <span class="token comment">/**     * çŸ«æ­£å›¾ç‰‡ï¼Œå½“å€¾æ–œåº¦è¶…è¿‡ 10 åº¦éƒ½æ˜¯ä¸åˆç†çš„çŸ«æ­£.     * ä¿æŒåŸé•¿å®½ï¼Œä¸é€‚åˆå¤§è§’åº¦çº å.     * @param cvtMat ç°åº¦Mat     * @param filePath æ–‡ä»¶è·¯å¾„     * @return çŸ«æ­£åçš„Mat     */</span>    <span class="token keyword">public</span> <span class="token class-name">Mat</span> <span class="token function">correct</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> cvtMat<span class="token punctuation">,</span> <span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">CorrectException</span> <span class="token punctuation">{</span>        <span class="token class-name">Mat</span> mat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">double</span> degree <span class="token operator">=</span> <span class="token function">calcSlope</span><span class="token punctuation">(</span>cvtMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å½“å€¾æ–œåº¦è¶…è¿‡ 10 åº¦éƒ½æ˜¯ä¸åˆç†çš„çŸ«æ­£.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token number">0.0d</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">BigDecimal</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>degree<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>degree<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">10.0d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} correct, if degree({}) is zero or bigger than 10 then no correct."</span><span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> degree<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> cvtMat<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"{} correct, degree({})"</span><span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> degree<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Mat</span> correctImgMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> length <span class="token operator">=</span> cvtMat<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> cvtMat<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">?</span> cvtMat<span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> cvtMat<span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// ç¡®å®šç¿»è½¬åˆ‡å…¥ç‚¹</span>            <span class="token class-name">Point</span> point <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span>length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">,</span> length<span class="token operator">/</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            mat <span class="token operator">=</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">getRotationMatrix2D</span><span class="token punctuation">(</span>point<span class="token punctuation">,</span> degree<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">warpAffine</span><span class="token punctuation">(</span>cvtMat<span class="token punctuation">,</span> correctImgMat<span class="token punctuation">,</span> mat<span class="token punctuation">,</span>                    <span class="token keyword">new</span> <span class="token class-name">Size</span><span class="token punctuation">(</span>length<span class="token punctuation">,</span> length<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">INTER_LINEAR</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">WHITE_PAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">saveToTempFile</span><span class="token punctuation">(</span>correctImgMat<span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> <span class="token string">"correct"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> correctImgMat<span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">CorrectException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>mat<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * è®¡ç®—å›¾ç‰‡å€¾æ–œè§’åº¦.     * 1. Canny æå–å›¾åƒè¾¹ç¼˜æ£€æµ‹     * 2. HoughLines æå–ç›´çº¿     * @param cvtMat ç°åº¦å›¾ç‰‡mat     * @return å€¾æ–œè§’åº¦     */</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> <span class="token function">calcSlope</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> cvtMat<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Mat</span> cannyMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> blurMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> straightLineMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            blurMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// 3x3 å†…æ ¸é™å™ª</span>            <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">blur</span><span class="token punctuation">(</span>cvtMat<span class="token punctuation">,</span> blurMat<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// canny å°„çº¿</span>            cannyMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Imgproc<span class="token punctuation">.</span>Canny</span><span class="token punctuation">(</span>blurMat<span class="token punctuation">,</span> cannyMat<span class="token punctuation">,</span>                    <span class="token constant">CANNY_THRESHOLD</span><span class="token punctuation">,</span> <span class="token constant">CANNY_THRESHOLD</span> <span class="token operator">*</span> <span class="token constant">CANNY_THRESHOLD_RATIO</span><span class="token punctuation">,</span> <span class="token constant">CANNY_KERNEL_SIZE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// houghLines</span>            straightLineMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Imgproc<span class="token punctuation">.</span>HoughLines</span><span class="token punctuation">(</span>cannyMat<span class="token punctuation">,</span> straightLineMat<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token constant">PI</span><span class="token operator">/</span><span class="token constant">STRAIGHT_PINGJIAO</span><span class="token punctuation">,</span>  <span class="token constant">THRESHOLD_300</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//            if(straightLineMat.rows() == 0 || straightLineMat.cols() == 0) {</span><span class="token comment">//                Imgproc.HoughLines(cannyMat, straightLineMat, 1, Math.PI/STRAIGHT_PINGJIAO, THRESHOLD_300);</span><span class="token comment">//            }</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>straightLineMat<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> straightLineMat<span class="token punctuation">.</span><span class="token function">cols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Imgproc<span class="token punctuation">.</span>HoughLines</span><span class="token punctuation">(</span>cannyMat<span class="token punctuation">,</span> straightLineMat<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token constant">PI</span><span class="token operator">/</span><span class="token constant">STRAIGHT_PINGJIAO</span><span class="token punctuation">,</span> <span class="token constant">THRESHOLD_200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>straightLineMat<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> straightLineMat<span class="token punctuation">.</span><span class="token function">cols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">Imgproc<span class="token punctuation">.</span>HoughLines</span><span class="token punctuation">(</span>cannyMat<span class="token punctuation">,</span> straightLineMat<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token constant">PI</span><span class="token operator">/</span><span class="token constant">STRAIGHT_PINGJIAO</span><span class="token punctuation">,</span> <span class="token constant">THRESHOLD_100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>straightLineMat<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> straightLineMat<span class="token punctuation">.</span><span class="token function">cols</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">"æ²¡æ£€æµ‹åˆ°ç›´çº¿ï¼Œä¸çº å"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token number">0.0d</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">float</span> average <span class="token operator">=</span> <span class="token function">getLineSlopeAvg</span><span class="token punctuation">(</span>straightLineMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> average <span class="token operator">/</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token constant">PI</span> <span class="token operator">*</span> <span class="token constant">STRAIGHT_PINGJIAO</span> <span class="token operator">-</span> <span class="token constant">STRAIGHT_ZHIJIAO</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>blurMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>cannyMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>straightLineMat<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token number">0.0d</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">float</span> <span class="token function">getLineSlopeAvg</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> lines<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> xIsX <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>lines<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> x<span class="token operator">=</span><span class="token number">0</span><span class="token punctuation">;</span> x <span class="token operator">&lt;</span> lines<span class="token punctuation">.</span><span class="token function">rows</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> x<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vec <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">boolean</span> isX <span class="token operator">=</span> <span class="token function">isX</span><span class="token punctuation">(</span>vec<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> indexs <span class="token operator">=</span> xIsX<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>isX<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>xIsX<span class="token punctuation">.</span><span class="token function">containsKey</span><span class="token punctuation">(</span>isX<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                indexs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                xIsX<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>isX<span class="token punctuation">,</span> indexs<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            indexs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> xIndexs <span class="token operator">=</span> xIsX<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> yIndexs <span class="token operator">=</span> xIsX<span class="token punctuation">.</span><span class="token function">getOrDefault</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">emptyList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> countX <span class="token operator">=</span> xIndexs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> countY <span class="token operator">=</span> yIndexs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> indexs <span class="token operator">=</span> countX <span class="token operator">&gt;</span> countY <span class="token operator">?</span> xIndexs <span class="token operator">:</span> countX <span class="token operator">&lt;</span> countY <span class="token operator">?</span> yIndexs<span class="token operator">:</span> <span class="token class-name">ListUtils</span><span class="token punctuation">.</span><span class="token function">union</span><span class="token punctuation">(</span>xIndexs<span class="token punctuation">,</span> yIndexs<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">float</span> sum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token keyword">int</span> index<span class="token operator">:</span> indexs<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vec <span class="token operator">=</span> lines<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>index<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> theta <span class="token operator">=</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>            sum <span class="token operator">+=</span> theta<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> sum<span class="token operator">/</span>indexs<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">isX</span><span class="token punctuation">(</span><span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> vec<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">double</span> rho <span class="token operator">=</span> vec<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> theta <span class="token operator">=</span> vec<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> a <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">cos</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">,</span> b <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">sin</span><span class="token punctuation">(</span>theta<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> x0 <span class="token operator">=</span> a<span class="token operator">*</span>rho<span class="token punctuation">,</span> y0 <span class="token operator">=</span> b<span class="token operator">*</span>rho<span class="token punctuation">;</span>        <span class="token keyword">double</span> point1x <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>x0 <span class="token operator">+</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> point1y <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>y0 <span class="token operator">+</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> point2x <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>x0 <span class="token operator">-</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token punctuation">(</span><span class="token operator">-</span>b<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> point2y <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span>y0 <span class="token operator">-</span> <span class="token number">1000</span><span class="token operator">*</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>point1x<span class="token operator">-</span> point2x<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>point1y <span class="token operator">-</span> point2y<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseMat</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> imgMat<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>imgMat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            imgMat<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h5 id="æˆªå–ç­”é¢˜å¡åŒºåŸŸ"><a href="#æˆªå–ç­”é¢˜å¡åŒºåŸŸ" class="headerlink" title="æˆªå–ç­”é¢˜å¡åŒºåŸŸ"></a>æˆªå–ç­”é¢˜å¡åŒºåŸŸ</h5><p>ç­”é¢˜å¡åŒºåŸŸä¸é—®é¢˜åŒºåŸŸçš„åŒºåˆ«æ˜¯åœ¨è®¾ç½®çš„ç­”é¢˜å¡åŒºé•¿åº¦å¤§äºé—®é¢˜åŒºåŸŸã€‚è¿™æ ·å°±èƒ½ç®€å•çš„æˆªå–åˆ°ç­”é¢˜å¡åŒº</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ImgAnswerCutter</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">THRESHOLD_MAX</span> <span class="token operator">=</span> <span class="token number">255</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRUCTURE_WIDTH</span> <span class="token operator">=</span> <span class="token number">50</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> <span class="token constant">STRUCTURE_HEIGHT</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">POINT_HALF</span> <span class="token operator">=</span> <span class="token number">0.5</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">POINT_EIGHT</span> <span class="token operator">=</span> <span class="token number">0.8</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">POINT_NIGHTEIGHT</span> <span class="token operator">=</span> <span class="token number">0.98</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">FILTER_HEIGHT</span> <span class="token operator">=</span> <span class="token number">20</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">double</span> <span class="token constant">DOUBLE</span> <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>    <span class="token comment">/**     * ç­”é¢˜åŒºåˆ‡å‰².     * @param correctImgMat çŸ«æ­£åçš„å›¾ç‰‡Mat     * @param filePath æ–‡ä»¶è·¯å¾„     * @return ç­”é¢˜åŒºåˆ‡å‰²åçš„ Mat é›†åˆ     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Mat</span><span class="token punctuation">&gt;</span></span> <span class="token function">answerCut</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> correctImgMat<span class="token punctuation">,</span> <span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AnswerCutException</span> <span class="token punctuation">{</span>        <span class="token class-name">Mat</span> binaryMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> noiseMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> erodeMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> reverseMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> edgeMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            binaryMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// äºŒå€¼åŒ– Mat</span>            <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">threshold</span><span class="token punctuation">(</span>correctImgMat<span class="token punctuation">,</span> binaryMat<span class="token punctuation">,</span> <span class="token constant">THRESHOLD_MAX</span><span class="token punctuation">,</span> <span class="token constant">THRESHOLD_MAX</span><span class="token punctuation">,</span>                    <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">THRESH_OTSU</span> <span class="token operator">|</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">THRESH_BINARY</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å®šä¹‰è†¨åŒ– Mat</span>            noiseMat <span class="token operator">=</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">getStructuringElement</span><span class="token punctuation">(</span><span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">MORPH_RECT</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token constant">STRUCTURE_WIDTH</span><span class="token punctuation">,</span> <span class="token constant">STRUCTURE_HEIGHT</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            erodeMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">erode</span><span class="token punctuation">(</span>binaryMat<span class="token punctuation">,</span> erodeMat<span class="token punctuation">,</span> noiseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            reverseMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// åå€¼åŒ– Mat</span>            <span class="token class-name">Core</span><span class="token punctuation">.</span><span class="token function">bitwise_not</span><span class="token punctuation">(</span>erodeMat<span class="token punctuation">,</span> reverseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> matOfPoints <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            edgeMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å‘ç°çŸ©å½¢æ¡ä»¶</span>            <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">findContours</span><span class="token punctuation">(</span>reverseMat<span class="token punctuation">,</span> matOfPoints<span class="token punctuation">,</span> edgeMat<span class="token punctuation">,</span>                    <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">RETR_LIST</span><span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">CHAIN_APPROX_SIMPLE</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Point</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// åˆå¹¶å°çŸ©å½¢</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> rects <span class="token operator">=</span> <span class="token function">mergeInnerAndTransRect</span><span class="token punctuation">(</span>matOfPoints<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// è¿‡æ»¤æ‰ç¦»è°±çš„çŸ©å½¢</span>            <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token function">filterAnswerRect</span><span class="token punctuation">(</span>rects<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>rect <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>                        <span class="token class-name">Mat</span> ansAreaMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span>correctImgMat<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">int</span> num <span class="token operator">=</span> count<span class="token punctuation">.</span><span class="token function">getAndAdd</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">saveToTempFile</span><span class="token punctuation">(</span>ansAreaMat<span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> <span class="token string">"anscut-"</span> <span class="token operator">+</span> num<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">return</span> ansAreaMat<span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>           <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">AnswerCutException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>binaryMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>noiseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>erodeMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>reverseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token function">releaseMat</span><span class="token punctuation">(</span>edgeMat<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * åªç•™ä¸‹é•¿åº¦æœ€é•¿çš„ä¸¾è¯ï¼Œå…¼å®¹ 2% çš„å®½åº¦å·®.     * @param rects çŸ©é˜µé›†åˆ.     * @return æœ€é•¿çš„.     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> <span class="token function">filterAnswerRect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> rects<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">int</span> maxWidth <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span>  maxHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> secHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> minHeight <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        rects <span class="token operator">=</span> rects<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rect1<span class="token punctuation">,</span> rect2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>rect1<span class="token punctuation">.</span>height<span class="token punctuation">,</span> rect2<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Rect</span> rect<span class="token operator">:</span> rects<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxWidth <span class="token operator">&lt;</span> rect<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> maxHeight <span class="token operator">*</span> <span class="token constant">POINT_HALF</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                maxWidth <span class="token operator">=</span> rect<span class="token punctuation">.</span>width<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>maxHeight <span class="token operator">&lt;</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>                secHeight <span class="token operator">=</span> maxHeight<span class="token punctuation">;</span>                maxHeight <span class="token operator">=</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>minHeight <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> minHeight <span class="token operator">&gt;</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> rect<span class="token punctuation">.</span>height<span class="token operator">&gt;</span> <span class="token constant">FILTER_HEIGHT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                minHeight <span class="token operator">=</span> rect<span class="token punctuation">.</span>height<span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token comment">// å¤„ç†åŒä¸€é¡µæœ‰å¤šè¡Œç­”æ¡ˆå’Œå•è¡Œç­”æ¡ˆ,ä»…å¤„ç†åŒä¸€ä¹Ÿåªæœ‰ä¸€ä¸ªå¤šè¡Œå¤šä¸ªå•è¡Œçš„æƒ…å†µ</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>maxHeight <span class="token operator">&gt;</span> minHeight <span class="token operator">*</span> <span class="token constant">DOUBLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            maxHeight <span class="token operator">=</span> secHeight<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> height <span class="token operator">=</span> maxHeight<span class="token punctuation">;</span>        <span class="token keyword">final</span> <span class="token keyword">int</span> finalMaxWidth <span class="token operator">=</span> maxWidth<span class="token punctuation">;</span>        <span class="token keyword">return</span> rects<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>rect <span class="token operator">-&gt;</span> rect<span class="token punctuation">.</span>width <span class="token operator">&gt;</span> finalMaxWidth <span class="token operator">*</span> <span class="token constant">POINT_NIGHTEIGHT</span> <span class="token operator">&amp;&amp;</span>                        rect<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> height <span class="token operator">*</span> <span class="token constant">POINT_EIGHT</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rect1<span class="token punctuation">,</span> rect2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token class-name">NumberUtils</span><span class="token punctuation">.</span><span class="token function">compare</span><span class="token punctuation">(</span>rect1<span class="token punctuation">.</span>y<span class="token punctuation">,</span> rect2<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * è½¬å‹ä¸º MatOfPoint,åˆå¹¶innerçš„å°çŸ©å½¢.     * @param matOfPoints mat ç‚¹.     * @return çŸ©å½¢é›†åˆ.     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> <span class="token function">mergeInnerAndTransRect</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> matOfPoints<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> sortedRects <span class="token operator">=</span> matOfPoints<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Imgproc</span><span class="token operator">::</span><span class="token function">boundingRect</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">(</span>rec1<span class="token punctuation">,</span> rec2<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>rec1<span class="token punctuation">.</span>y <span class="token operator">&lt;</span> rec2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>rec1<span class="token punctuation">.</span>y <span class="token operator">==</span> rec2<span class="token punctuation">.</span>y<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>rec1<span class="token punctuation">.</span>width <span class="token operator">&lt;</span> rec2<span class="token punctuation">.</span>width<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span><span class="token punctuation">(</span>rec1<span class="token punctuation">.</span>height <span class="token operator">&lt;</span> rec2<span class="token punctuation">.</span>height<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> rects <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Rect</span> rect<span class="token operator">:</span> sortedRects<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">canMergeInner</span><span class="token punctuation">(</span>rects<span class="token punctuation">,</span> rect<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                rects<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>rect<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> rects<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * åˆ¤æ–­å½“å‰ rect çš„é•¿å®½é«˜æ˜¯å¦åœ¨èŒƒå›´å†…, x.yéƒ½åœ¨èŒƒå›´å†…ï¼Œä¸”x+widthå’Œ y+heightéƒ½åœ¨èŒƒå›´å†…åˆ™èƒ½åˆå¹¶.     * @param rects çŸ©å½¢é›†åˆ     * @param rect å¯¹æ¯”çŸ©å½¢     * @return æ˜¯å¦å¯merge     */</span>    <span class="token keyword">private</span> <span class="token keyword">boolean</span> <span class="token function">canMergeInner</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Rect</span><span class="token punctuation">&gt;</span></span> rects<span class="token punctuation">,</span> <span class="token class-name">Rect</span> rect<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> rects<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>rect1 <span class="token operator">-&gt;</span> rect1<span class="token punctuation">.</span>x <span class="token operator">&lt;=</span> rect<span class="token punctuation">.</span>x <span class="token operator">&amp;&amp;</span> rect1<span class="token punctuation">.</span>y <span class="token operator">&lt;=</span> rect<span class="token punctuation">.</span>y <span class="token operator">&amp;&amp;</span>                        rect1<span class="token punctuation">.</span>x<span class="token operator">+</span>rect1<span class="token punctuation">.</span>width <span class="token operator">&gt;=</span> rect<span class="token punctuation">.</span>x <span class="token operator">+</span> rect<span class="token punctuation">.</span>width <span class="token operator">&amp;&amp;</span> rect1<span class="token punctuation">.</span>y<span class="token operator">+</span>rect1<span class="token punctuation">.</span>height <span class="token operator">&gt;</span> rect<span class="token punctuation">.</span>y<span class="token operator">+</span>rect<span class="token punctuation">.</span>height<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">releaseMat</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> imgMat<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>imgMat <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            imgMat<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="å¾—åˆ°ç­”é¢˜åŒºçš„é€‰æ‹©é¡¹ç›®"><a href="#å¾—åˆ°ç­”é¢˜åŒºçš„é€‰æ‹©é¡¹ç›®" class="headerlink" title="å¾—åˆ°ç­”é¢˜åŒºçš„é€‰æ‹©é¡¹ç›®"></a>å¾—åˆ°ç­”é¢˜åŒºçš„é€‰æ‹©é¡¹ç›®</h4><p>é€šè¿‡ openCV å¯¹ç­”é¢˜åŒºçš„äºŒå€¼ã€è†¨èƒ€ã€canny ä¹‹åç¡®å®šå¡«å›¾åŒºåŸŸï¼Œå¹¶è®¡ç®—ä»–ä¸è¾¹çš„å·®å€¼å¤„äºé€‰é¡¹ä¹‹é—´çš„å·®å€¼ç¡®å®šæ˜¯å¡«æ¶‚çš„ç¬¬å‡ ä¸ªç­”æ¡ˆã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RecognizeShadow</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">MAINQ_PECENT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0.0197d</span><span class="token punctuation">,</span> <span class="token number">0.0388d</span><span class="token punctuation">,</span> <span class="token number">0.0116d</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">static</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">SUBQ_PECENT</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token number">0.0205d</span><span class="token punctuation">,</span> <span class="token number">0.0403d</span><span class="token punctuation">,</span> <span class="token number">0.0120d</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token comment">/**     * å°é—®é¢˜çš„é€‰é¡¹åŒºå ç­”é¢˜åŒºçš„ç™¾åˆ†å æ¯”.     */</span>    <span class="token keyword">private</span> <span class="token keyword">double</span> subPercent<span class="token punctuation">;</span>    <span class="token comment">/**     * å¤§é—®é¢˜çš„ä¸‰ä¸ªå æ¯”ï¼Œ     * num_0,ç¬¬ä¸€ä¸ªé€‰é¡¹åˆ°ç«–çº¿å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”     * num_1,é€‰é¡¹å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”     * num_2,é€‰é¡¹ä¹‹é—´å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”     */</span>    <span class="token keyword">private</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mainqPercent<span class="token punctuation">;</span>    <span class="token comment">/**     * å°é—®é¢˜çš„ä¸‰ä¸ªå æ¯”ï¼Œ     * num_0,ç¬¬ä¸€ä¸ªé€‰é¡¹åˆ°ç«–çº¿å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”     * num_1,é€‰é¡¹å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”     * num_2,é€‰é¡¹ä¹‹é—´å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”     */</span>    <span class="token keyword">private</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> subqPercent<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">RecognizeShadow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subPercent <span class="token operator">=</span> <span class="token number">0.88d</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mainqPercent <span class="token operator">=</span> <span class="token constant">MAINQ_PECENT</span><span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subqPercent <span class="token operator">=</span> <span class="token constant">SUBQ_PECENT</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">public</span> <span class="token class-name">RecognizeShadow</span><span class="token punctuation">(</span><span class="token keyword">double</span> subPercent<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> mainqPercent<span class="token punctuation">,</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> subqPercent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mainqPercent<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">3</span> <span class="token operator">||</span> subqPercent<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”å¿…é¡»æ˜¯3ä¸ªã€‚num_0ï¼Œç¬¬ä¸€ä¸ªé€‰é¡¹åˆ°ç«–çº¿å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”ã€‚"</span>                    <span class="token operator">+</span> <span class="token string">"num_1ï¼Œé€‰é¡¹å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”ã€‚num_2ï¼Œé€‰é¡¹ä¹‹é—´å é€‰é¡¹åŒºçš„ç™¾åˆ†æ¯”ã€‚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subPercent <span class="token operator">=</span> subPercent<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>mainqPercent <span class="token operator">=</span> mainqPercent<span class="token punctuation">;</span>        <span class="token keyword">this</span><span class="token punctuation">.</span>subqPercent <span class="token operator">=</span> subqPercent<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     *     * @param qPercent     * @return     */</span>    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">parseQPercent</span><span class="token punctuation">(</span><span class="token class-name">String</span> qPercent<span class="token punctuation">)</span> <span class="token punctuation">{</span>        qPercent <span class="token operator">=</span> qPercent<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"["</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token string">"]"</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> percents <span class="token operator">=</span> qPercent<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>percents<span class="token punctuation">.</span>length <span class="token operator">!=</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">",å­—ç¬¦é•¿åº¦ä¸ä¸º3ï¼Œ ä¸ç¬¦åˆè¦æ±‚"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">{</span><span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>percents<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>percents<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Double</span><span class="token punctuation">.</span><span class="token function">parseDouble</span><span class="token punctuation">(</span>percents<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * è¯†åˆ«é˜´å½±ï¼Œå¹¶å®šä½.     * @param answerAreas é˜´å½±     * @param filePath æ–‡ä»¶è·¯å¾„     * @return ç»“æœè¯†åˆ«     */</span>    <span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> <span class="token function">recognizeShadow</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AnswerArea</span><span class="token punctuation">&gt;</span></span> answerAreas<span class="token punctuation">,</span> <span class="token class-name">String</span> filePath<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> answerAreas<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>answerArea <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>                    <span class="token class-name">Mat</span> splitMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> noiseMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> erodeMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> dilateMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> edgeMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> contourMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> optionMat <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>                    <span class="token class-name">Mat</span> areaMat <span class="token operator">=</span> answerArea<span class="token punctuation">.</span><span class="token function">getAreaMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">try</span> <span class="token punctuation">{</span>                        splitMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// äºŒå€¼åŒ–</span>                        <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">threshold</span><span class="token punctuation">(</span>areaMat<span class="token punctuation">,</span> splitMat<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">THRESH_OTSU</span> <span class="token operator">|</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">THRESH_BINARY_INV</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// è·å–é€‰é¡¹åŒºåŸŸ</span>                        <span class="token class-name">Option</span> option <span class="token operator">=</span> <span class="token function">optionArea</span><span class="token punctuation">(</span>splitMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        noiseMat <span class="token operator">=</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">getStructuringElement</span><span class="token punctuation">(</span><span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">MORPH_RECT</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Size</span><span class="token punctuation">(</span><span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        erodeMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        optionMat <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getOptionMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">erode</span><span class="token punctuation">(</span>optionMat<span class="token punctuation">,</span> erodeMat<span class="token punctuation">,</span> noiseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        dilateMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// è†¨èƒ€</span>                        <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">dilate</span><span class="token punctuation">(</span>erodeMat<span class="token punctuation">,</span> dilateMat<span class="token punctuation">,</span> noiseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        edgeMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token comment">// canny</span>                        <span class="token class-name">Imgproc<span class="token punctuation">.</span>Canny</span><span class="token punctuation">(</span>dilateMat<span class="token punctuation">,</span> edgeMat<span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">,</span> <span class="token number">150</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> chapter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        contourMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">findContours</span><span class="token punctuation">(</span>edgeMat<span class="token punctuation">,</span> chapter<span class="token punctuation">,</span> contourMat<span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">RETR_EXTERNAL</span><span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">CHAIN_APPROX_SIMPLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                            <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">drawContours</span><span class="token punctuation">(</span>optionMat<span class="token punctuation">,</span> chapter<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                            <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">saveToTempFile</span><span class="token punctuation">(</span>option<span class="token punctuation">.</span><span class="token function">getOptionMat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> filePath<span class="token punctuation">,</span> <span class="token string">"shadow"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token punctuation">}</span>                        <span class="token keyword">return</span> <span class="token function">calcAnswer</span><span class="token punctuation">(</span>chapter<span class="token punctuation">,</span> option<span class="token punctuation">,</span> answerArea<span class="token punctuation">.</span><span class="token function">getTitle</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span><span class="token keyword">finally</span> <span class="token punctuation">{</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>optionMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>splitMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>noiseMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>erodeMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>dilateMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>edgeMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>contourMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                        <span class="token class-name">MatUtil</span><span class="token punctuation">.</span><span class="token function">releaseMat</span><span class="token punctuation">(</span>areaMat<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token punctuation">}</span>                <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token operator">::</span><span class="token function">isNotBlank</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * é€šè¿‡é€‰é¡¹çš„åç§»é‡è®¡ç®—ç­”æ¡ˆä½ç½®.     * @param chapter è¢«å¡«æ¶‚çš„MatOfPoint     * @param option é€‰é¡¹åŒºæƒ…å†µ     * @param answerTitle ç­”é¢˜ç›®     * @return ç­”é¢˜ç»“æœ     */</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">calcAnswer</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> chapter<span class="token punctuation">,</span> <span class="token class-name">Option</span> option<span class="token punctuation">,</span> <span class="token class-name">String</span> answerTitle<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">double</span><span class="token punctuation">[</span><span class="token punctuation">]</span> optionalPer <span class="token operator">=</span> option<span class="token punctuation">.</span>optionPercent <span class="token operator">&lt;</span> subPercent <span class="token operator">?</span> subqPercent<span class="token operator">:</span> mainqPercent<span class="token punctuation">;</span>        <span class="token keyword">double</span> optionAllWidth <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getOptionWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> optionAllHeight <span class="token operator">=</span> option<span class="token punctuation">.</span><span class="token function">getOptionHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> leftGrapWidth <span class="token operator">=</span> optionAllWidth <span class="token operator">*</span> optionalPer<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> ansWidth <span class="token operator">=</span> optionAllWidth <span class="token operator">*</span> optionalPer<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> ansGapWidth <span class="token operator">=</span> optionAllWidth <span class="token operator">*</span> optionalPer<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> preAnsWidth <span class="token operator">=</span> ansWidth <span class="token operator">+</span> ansGapWidth<span class="token punctuation">;</span>        <span class="token comment">// æœ€å°å¡«æ¶‚è¦†ç›–å®½åº¦.</span>        <span class="token keyword">double</span> minMatchWidth <span class="token operator">=</span> ansWidth <span class="token operator">*</span> <span class="token number">0.6</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SingleAnswerArea</span><span class="token punctuation">&gt;</span></span> ttAnsAreas <span class="token operator">=</span> <span class="token function">convert</span><span class="token punctuation">(</span>chapter<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> lineCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span> optionAllWidth <span class="token operator">-</span>leftGrapWidth<span class="token punctuation">)</span> <span class="token operator">/</span>preAnsWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> answer <span class="token operator">=</span> ttAnsAreas<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>ttAnsArea <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">double</span> yStart <span class="token operator">=</span> ttAnsArea<span class="token punctuation">.</span><span class="token function">getYStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> height <span class="token operator">=</span> ttAnsArea<span class="token punctuation">.</span><span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token comment">// å°äºæœ€å°çš„å¡«æ¶‚è¦†ç›–å®½åº¦åˆ™è®¤ä¸ºæ˜¯æ— æ•ˆçš„å¡«æ¶‚.</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ttAnsArea<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&lt;</span> minMatchWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} ttAnsArea:{}å®½åº¦{} å°äº{}ï¼Œæ— æ•ˆå¡«æ¶‚"</span><span class="token punctuation">,</span> answerTitle<span class="token punctuation">,</span> ttAnsArea<span class="token punctuation">,</span> ttAnsArea<span class="token punctuation">.</span><span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> minMatchWidth<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// ç®—å‡ºçš„è·³è¿‡é€‰é¡¹ï¼Œæ­¤å¤„ä½¿ç”¨ å››èˆäº”å…¥ åŸåˆ™.</span>            <span class="token keyword">int</span> skipXCount <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">int</span><span class="token punctuation">)</span><span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">round</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ttAnsArea<span class="token punctuation">.</span><span class="token function">getXStart</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span>leftGrapWidth<span class="token punctuation">)</span> <span class="token operator">/</span>preAnsWidth<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            skipXCount<span class="token operator">++</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>yStart <span class="token operator">&gt;</span> optionAllHeight <span class="token operator">*</span> <span class="token number">0.5</span> <span class="token operator">&amp;&amp;</span> height <span class="token operator">&lt;</span> optionAllHeight <span class="token operator">*</span> <span class="token number">0.25</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                skipXCount <span class="token operator">+=</span> lineCount<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>skipXCount <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> skipXCount<span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token comment">// è®¤ä¸ºå¤§äº 9 çš„æ˜¯ä»¥A-Zæ ‡è®°ï¼Œæ‰€ä»¥é€‰é¡¹ä¸è¶…è¿‡ 35 ä¸ªé€‰é¡¹.</span>            <span class="token keyword">return</span> skipXCount <span class="token operator">+</span> <span class="token number">55</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>num <span class="token operator">-&gt;</span> num <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">distinct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>num <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>num <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span>num<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">char</span><span class="token punctuation">)</span>num<span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">MessageFormat</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"é¢˜å·:{0}ï¼Œç­”æ¡ˆ:{1}"</span><span class="token punctuation">,</span>                <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replaceIgnoreCase</span><span class="token punctuation">(</span>answerTitle<span class="token punctuation">,</span> <span class="token string">" "</span><span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">,</span> answer<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * ä»MatOfPointå¤šä¸ªç‚¹ï¼Œè½¬æ¢ä¸º minX-&gt;maxX,minY-&gt;maxY.     * @param chapters chapters     * @return SingleAnswerAreaé›†åˆ.     */</span>    <span class="token keyword">private</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SingleAnswerArea</span><span class="token punctuation">&gt;</span></span> <span class="token function">convert</span><span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> chapters<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> chapters<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>chapter <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> points <span class="token operator">=</span> chapter<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> xStart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> xEnd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> yStart <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> yEnd <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Point</span> point<span class="token operator">:</span> points<span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">double</span> x <span class="token operator">=</span> point<span class="token punctuation">.</span>x<span class="token punctuation">;</span>                <span class="token keyword">double</span> y <span class="token operator">=</span> point<span class="token punctuation">.</span>y<span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>xStart <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    xStart <span class="token operator">=</span> x<span class="token punctuation">;</span>                    yStart <span class="token operator">=</span> y<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&gt;</span> xEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    xEnd <span class="token operator">=</span> x<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">&lt;</span> xStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    xStart <span class="token operator">=</span> x<span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&gt;</span> yEnd<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    yEnd <span class="token operator">=</span> y<span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>y <span class="token operator">&lt;</span> yStart<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    yStart <span class="token operator">=</span> y<span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">SingleAnswerArea</span><span class="token punctuation">(</span>xStart<span class="token punctuation">,</span> xEnd<span class="token punctuation">,</span> yStart<span class="token punctuation">,</span> yEnd<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span><span class="token class-name">SingleAnswerArea</span><span class="token operator">::</span><span class="token function">getYStart</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">thenComparing</span><span class="token punctuation">(</span><span class="token class-name">SingleAnswerArea</span><span class="token operator">::</span><span class="token function">getHeight</span><span class="token punctuation">)</span>                        <span class="token punctuation">.</span><span class="token function">thenComparing</span><span class="token punctuation">(</span><span class="token class-name">SingleAnswerArea</span><span class="token operator">::</span><span class="token function">getXStart</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Getter</span>    <span class="token annotation punctuation">@Setter</span>    <span class="token annotation punctuation">@AllArgsConstructor</span>    <span class="token annotation punctuation">@ToString</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">SingleAnswerArea</span> <span class="token punctuation">{</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> xStart<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> xEnd<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> yStart<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> yEnd<span class="token punctuation">;</span>        <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getWidth</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> xEnd <span class="token operator">-</span> xStart<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">public</span> <span class="token keyword">double</span> <span class="token function">getHeight</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> yEnd <span class="token operator">-</span> yStart<span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * ç¡®å®šç­”é¢˜åŒºä¸­é€‰é¡¹åŒºåŸŸä¸ç­”é¢˜åŒºçš„å®½åº¦å æ¯”ï¼Œç”¨ä»¥ç¡®å®šæ˜¯å¤§é¢˜è¿˜æ˜¯å°é¢˜ï¼Œä¸”åç»­çš„æ¯ä¸ªé€‰é¡¹çš„å æ¯”ä¹Ÿä¼šå› ä¸ºå¤§é¢˜ã€å°é¢˜è€Œä¸åŒ.     * @param srcMat ç­”é¢˜åŒºï¼ŒäºŒå€¼åŒ–åçš„Mat     * @return {@link Option}     */</span>    <span class="token keyword">private</span> <span class="token class-name">Option</span> <span class="token function">optionArea</span><span class="token punctuation">(</span><span class="token class-name">Mat</span> srcMat<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> chapter2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> contourMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">findContours</span><span class="token punctuation">(</span>srcMat<span class="token punctuation">,</span> chapter2<span class="token punctuation">,</span> contourMat<span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">RETR_LIST</span><span class="token punctuation">,</span> <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token constant">CHAIN_APPROX_SIMPLE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pointGroup <span class="token operator">=</span> chapter2<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">groupingBy</span><span class="token punctuation">(</span>matOfPoint <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> points <span class="token operator">=</span> matOfPoint<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>point <span class="token operator">-&gt;</span> point<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">double</span> minPoint <span class="token operator">=</span> points<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>            <span class="token keyword">double</span> maxPoint <span class="token operator">=</span> points<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>points<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">;</span>            <span class="token keyword">return</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">abs</span><span class="token punctuation">(</span>maxPoint <span class="token operator">-</span> minPoint<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> maxWidth <span class="token operator">=</span> <span class="token number">0.0d</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> optionWidth <span class="token operator">=</span> <span class="token number">0.0d</span><span class="token punctuation">;</span>        <span class="token class-name">MatOfPoint</span> maxMatPoint <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token class-name">MatOfPoint</span> optionMatPoint <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">for</span><span class="token punctuation">(</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Double</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> pointEntry<span class="token operator">:</span> pointGroup<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Double</span> width <span class="token operator">=</span> pointEntry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MatOfPoint</span><span class="token punctuation">&gt;</span></span> matOfPoints <span class="token operator">=</span> pointEntry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span><span class="token punctuation">(</span>maxWidth <span class="token operator">==</span> <span class="token number">0.0d</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                maxWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>                maxMatPoint <span class="token operator">=</span> matOfPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span><span class="token punctuation">(</span>maxWidth <span class="token operator">&lt;</span> width<span class="token punctuation">)</span> <span class="token punctuation">{</span>                optionWidth <span class="token operator">=</span> maxWidth<span class="token punctuation">;</span>                maxWidth <span class="token operator">=</span> width<span class="token punctuation">;</span>                optionMatPoint <span class="token operator">=</span> maxMatPoint<span class="token punctuation">;</span>                maxMatPoint <span class="token operator">=</span> matOfPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token class-name">Imgproc</span><span class="token punctuation">.</span><span class="token function">drawContours</span><span class="token punctuation">(</span>srcMat<span class="token punctuation">,</span> <span class="token class-name">Collections</span><span class="token punctuation">.</span><span class="token function">singletonList</span><span class="token punctuation">(</span>optionMatPoint<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Scalar</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">255</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> xPoints <span class="token operator">=</span> optionMatPoint<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>point <span class="token operator">-&gt;</span> point<span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Point</span><span class="token punctuation">&gt;</span></span> yPoints <span class="token operator">=</span> optionMatPoint<span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">sorted</span><span class="token punctuation">(</span><span class="token class-name">Comparator</span><span class="token punctuation">.</span><span class="token function">comparing</span><span class="token punctuation">(</span>point <span class="token operator">-&gt;</span> point<span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Range</span> colRange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Range</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span>xPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span>xPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>xPoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Range</span> rowRange <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Range</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span>yPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Double</span><span class="token punctuation">)</span>yPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>yPoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">intValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Mat</span> optionMat <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Mat</span><span class="token punctuation">(</span>srcMat<span class="token punctuation">,</span> rowRange<span class="token punctuation">,</span> colRange<span class="token punctuation">)</span><span class="token punctuation">;</span>        contourMat<span class="token punctuation">.</span><span class="token function">release</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">double</span> optionHeight <span class="token operator">=</span> yPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>yPoints<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y <span class="token operator">-</span> yPoints<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Option</span><span class="token punctuation">(</span>optionMat<span class="token punctuation">,</span> optionWidth<span class="token operator">/</span>maxWidth<span class="token punctuation">,</span> optionWidth<span class="token punctuation">,</span> optionHeight<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">/**     * é€‰é¡¹åŒºçš„ç»“æ„.     */</span>    <span class="token annotation punctuation">@Getter</span>    <span class="token annotation punctuation">@Setter</span>    <span class="token annotation punctuation">@AllArgsConstructor</span>    <span class="token keyword">private</span> <span class="token keyword">class</span> <span class="token class-name">Option</span> <span class="token punctuation">{</span>        <span class="token comment">/**         * é€‰é¡¹Mat.         */</span>        <span class="token keyword">private</span> <span class="token class-name">Mat</span> optionMat<span class="token punctuation">;</span>        <span class="token comment">/**         * é€‰é¡¹åŒº/ç­”é¢˜åŒºå æ¯”.         */</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> optionPercent<span class="token punctuation">;</span>        <span class="token comment">/**         * é€‰é¡¹åŒºå®½åº¦.         */</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> optionWidth<span class="token punctuation">;</span>        <span class="token keyword">private</span> <span class="token keyword">double</span> optionHeight<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> opencv </tag>
            
            <tag> tesseract </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡ºä¹æ„å¤–çš„ &quot;ç³»ç»Ÿå®•æœº&quot;</title>
      <link href="/2024/02/22/chu-hu-yi-wai-de-xi-tong-dang-ji/"/>
      <url>/2024/02/22/chu-hu-yi-wai-de-xi-tong-dang-ji/</url>
      
        <content type="html"><![CDATA[<p>å‡ºä¹æ„å¤–çš„ â€œç³»ç»Ÿå®•æœºâ€</p><p>æˆ‘å¾’å¼Ÿä¸€ä¸ªåˆšæ¯•ä¸šçš„ç²¾ç¥å°ä¼™ï¼Œè¿‘æœŸå¤„ç†ç°åœºæäº¤çš„å·¥å•é—®é¢˜ã€‚é©»åœ°å‘Šè¯‰ä»–ç³»ç»Ÿæ¯å¤©åœ¨ç”¨æˆ·ä¸‹ç­åä¼šå®•æœºï¼Œéœ€è¦ä»–æ¯å¤©ä¸Šç­å¯åŠ¨ç³»ç»Ÿã€‚å¾’å¼Ÿæ²¡ä»€ä¹ˆç»éªŒï¼Œå°±è®©çº¿ç¨‹è°ƒå¤§å†…å­˜å‚æ•° <code>-Xmx 16g -Xms 8g</code> è§‚å¯Ÿã€‚ç¬¬äºŒå¤©ï¼Œé©»åœ°è¿˜æ˜¯å‘Šè¯‰ä»–ä¾æ—§æ˜¯ç”¨æˆ·ä¸‹ç­åä¼šå®•æœºã€‚å¾’å¼Ÿä¹Ÿæ˜¯æ‘¸ä¸åˆ°å¤´è„‘æ‰¾åˆ°äº†æˆ‘ã€‚</p><p><img src="/images/2024/notinmind_systemexit/3641708614410_.pic.jpg"></p><h3 id="å‡ºä¹æ„å¤–ï¼Œæƒ…ç†ä¹‹ä¸­"><a href="#å‡ºä¹æ„å¤–ï¼Œæƒ…ç†ä¹‹ä¸­" class="headerlink" title="å‡ºä¹æ„å¤–ï¼Œæƒ…ç†ä¹‹ä¸­"></a>å‡ºä¹æ„å¤–ï¼Œæƒ…ç†ä¹‹ä¸­</h3><p>é¦–å…ˆï¼Œç¡®å®šæ˜¯å¦å†…å­˜ OOM å¯¼è‡´å®•æœºã€‚åœ¨å›¾ç‰‡ä¸­æ˜¯é€šè¿‡ <code>-XX:+HeapDumpOnOutOfMemoryError</code> å¯åŠ¨ OOM æ˜¯ç”Ÿæˆå † dump æ–‡ä»¶ï¼Œ OOM æ˜¯å † dump æ–‡ä»¶ <code>-XX:HeapDumpPath</code> é…ç½®æŒ‡å®šä½ç½®ã€‚ æ˜¯å¦å­˜åœ¨å † dump æ–‡ä»¶ã€‚<strong>é©»åœ°å›ç­”è¯´ç›®å½•ä¸‹æ²¡æœ‰ä»»ä½•æ–‡ä»¶ã€‚éš¾é“ OOM å¯åŠ¨é…ç½®æ˜¯ååŠ çš„ï¼Ÿ</strong></p><p><img src="/images/2024/notinmind_systemexit/cocall61708612842881.jpg"></p><p>å…¶æ¬¡ï¼Œè®©é©»åœ°é€šè¿‡ linux ç³»ç»Ÿæ—¥å¿—çœ‹èƒ½ä¸èƒ½æ‰¾åˆ° OOM çš„è››ä¸é©¬è¿¹ã€‚éšå³å‘å»æœç´¢å‘½ä»¤ <code>dmesg | grep -i -B10 'killed process'</code> å’Œ <code>grep -i 'killed process' /var/log/messages</code> ã€‚<strong>é©»åœ°å›ç­”è¯´æ²¡æœ‰ä»»ä½•å†…å®¹è¾“å‡ºã€‚</strong></p><p>å†æƒ³æƒ³é©»åœ°è¯´çš„è¯ï¼Œéƒ½æ˜¯ä¸‹ç­åå®•æœºï¼Œä¸‹ç­åç³»ç»Ÿä¸šåŠ¡å¹¶ä¸å¤šï¼Œæƒ³å†çœ‹çœ‹ç³»ç»Ÿæ—¥å¿—ï¼Œç¡®å®šä»€ä¹ˆæ—¶å€™å®•æœºçš„ã€‚ç»“æœå‘ç°ç›´åˆ° <code>23:59:59</code> éƒ½æœ‰æ•°æ®åº“é“¾æ¥çš„æµ‹è¯•æ—¥å¿—ã€‚é‚£æ˜¯å‡Œæ™¨å®•æœºï¼Ÿä½†æ˜¯æ—¥å¿—å·²ç»è¢«é©»åœ°æ‰‹åŠ¨å¯åŠ¨è¦†ç›–äº†ã€‚<span class="github-emoji"><span>ğŸŒŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f31f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <strong>æ‰‹åŠ¨å¯åŠ¨</strong> ï¼Œå›çœ‹å›¾ç‰‡é©»åœ°çš„å¯åŠ¨æ–¹å¼æ˜¯å‘½ä»¤è¡Œé‡Œè¾“å…¥ <code>java -jar xxx.jar &amp;</code> è¿™æ˜¯åŒæ­¥å¯åŠ¨éåå°å¯åŠ¨ï¼Œå¦‚æœå‡ºç°çª—å£å¤±æ•ˆæ–­å¼€è¿æ¥çš„è¯ï¼Œæ˜¯ä¼šè®©ç¨‹åºèµ°æ­£å¸¸ç³»ç»Ÿé€€å‡ºï¼Œé©»åœ°å‘å›æ¥çš„é€€å‡ºç³»ç»Ÿç…§ç‰‡èƒ½åŒ¹é…ä¸Šã€‚</p><p>æœ€ç»ˆï¼Œè®©ä»–ä¿®æ”¹æˆ <code>nohup java -jar xxx.jar &gt; /dev/null 2&gt;&amp;1 &amp;</code> å¯åŠ¨ï¼Œç¬¬äºŒå¤©ä¸å†å‡ºç°æ‰€è°“çš„ â€œç³»ç»Ÿå®•æœºâ€ã€‚</p><p><img src="/images/2024/notinmind_systemexit/12.png"></p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> code </tag>
            
            <tag> exception </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ€ä¹ˆå®ç° mybatis è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´</title>
      <link href="/2024/02/18/zen-me-shi-xian-mybatis-zi-dong-she-zhi-chuang-jian-shi-jian-geng-xin-shi-jian/"/>
      <url>/2024/02/18/zen-me-shi-xian-mybatis-zi-dong-she-zhi-chuang-jian-shi-jian-geng-xin-shi-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="æ€ä¹ˆå®ç°-mybatis-è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´"><a href="#æ€ä¹ˆå®ç°-mybatis-è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´" class="headerlink" title="æ€ä¹ˆå®ç° mybatis è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´"></a>æ€ä¹ˆå®ç° mybatis è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´</h2><h4 id="mag-ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯"><a href="#mag-ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯" class="headerlink" title=":mag: ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯"></a><span class="github-emoji"><span>ğŸ”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯</h4><p>mybatis æä¾› Interceptor æ¥å£ä»¥æ’ä»¶æ–¹å¼æä¾›æ‰©å±•èƒ½åŠ›ã€‚äº’è”ç½‘ä¸Šå¤§éƒ½æ˜¯å¯¹æ•°æ®è¡¨æ˜ å°„ç±»å¯¹è±¡ä¸­å…³äºæ—¶é—´å±æ€§è®¾ç½®å½“å‰æ—¶é—´çš„è§£å†³æ–¹æ¡ˆã€‚ä½†è¿™ç§æ–¹æ³•æ— æ³•è§£å†³ mapper.xml å†™æ›´æ–° SQL æˆ– @XXXProvider æ‹¼ SQL çš„æ–¹å¼æ’å…¥æˆ–æ›´æ–°æ•°æ®è¡¨ã€‚ä½†æ˜¯ä¾æ‰˜äºæ•°æ®è¡¨æ˜ å°„ç±»æœ¬èº«æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºéœ€è¦çŸ¥é“åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å¯¹åº”çš„æ•°æ®åº“å­—æ®µä¿¡æ¯ï¼Œè¿™æ˜¯å…‰æ‹¦æˆªåˆ° SQL è€Œæ— æ³•åˆ¤æ–­æ—¶é—´ç›¸å…³çš„å­—æ®µæ˜¯å¦å­˜åœ¨å¹¶èµ‹å€¼ã€‚</p><h4 id="mortar-board-æ›´å¥½çš„é€‰æ‹©"><a href="#mortar-board-æ›´å¥½çš„é€‰æ‹©" class="headerlink" title=":mortar_board: æ›´å¥½çš„é€‰æ‹©"></a><span class="github-emoji"><span>ğŸ“</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f393.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ›´å¥½çš„é€‰æ‹©</h4><p>å¦‚æœä½ é¡¹ç›®ä¸­ä½¿ç”¨äº† mybatis-plus ç»„ä»¶ï¼Œæ­å–œä½ åšè¿™ä¸ªå†³å®šä½ è¶³å¤Ÿæ˜æ™ºã€‚ mybatis-plus æä¾› MetaObjectHandler æŠ½è±¡ç±»å®ç°å…¬å…±å­—æ®µè‡ªåŠ¨å†™å…¥èƒ½åŠ›ã€‚å…¶å¤§ä½“æ€è·¯æ˜¯é’ˆå¯¹ @XXXProvider æ‹¼ SQL æ—¶å°†å®ä½“ä¸­æ ‡è®°éœ€è¦è‡ªåŠ¨å¡«å……çš„å­—æ®µæ‹¼å…¥ SQL ä¸­ï¼Œé€šè¿‡ metaObjectHandler å¯¹å®ä½“å±æ€§å­—æ®µå¡«å……ç›¸åº”å€¼ï¼Œæœ€åå¸¦æœ‰è‡ªåŠ¨å¡«å……å­—æ®µçš„ PrepareStatement SQL æ’å…¥/æ›´æ–°æ•°æ®è¡¨æ•°æ®ã€‚</p><p>ä½†ï¼Œé¡¹ç›®ä¸Šä½¿ç”¨è‡ªå†™ <code>BaseMapper&lt;E,ID&gt;</code> æ¥å£å’Œ @XXXProvider æ³¨è§£å®ç° BaseMapperSqlSourceBuilder ç±»å®Œæˆ SQL æ‹¼æ¥ã€‚ä½†æœªæä¾›å¯¹å…¬ç”¨å­—æ®µè‡ªåŠ¨å†™å…¥èƒ½åŠ›ã€‚</p><h4 id="mushroom-åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜"><a href="#mushroom-åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜" class="headerlink" title=":mushroom: åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜"></a><span class="github-emoji"><span>ğŸ„</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f344.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜</h4><p>Interceptor æ‹¦æˆªçš„ä½ç½®æ˜¯æ‰§è¡Œ SQL ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯ <code>@Signature(type = Executor.class, method="update", args={MappedStatement.class, Object.class})</code> ï¼Œåœ¨ SQL é‡Œæ‹¼æ¥æ—¶é—´çš„å­—æ®µå’Œå­—æ®µå€¼ã€‚å­—æ®µå€¼å¯ä»¥ç›´æ¥è®¾ç½®çš„ <code>now()</code> æ•°æ®åº“å‡½æ•°ï¼Œç¼ºç‚¹æ˜¯å¼ºä¾èµ–æ•°æ®åº“ã€‚è¿™ä¸ªç¼ºç‚¹éœ€è¦é€šè¿‡ driver ä¿¡æ¯æ‰¾ç¡®åˆ‡çš„æ•°æ®åº“ç±»å‹ï¼Œåˆ‡æ¢æ—¶é—´å‡½æ•°ã€‚æ—¶é—´å­—æ®µä¿¡æ¯åˆ™æ˜¯é€šè¿‡ <code>BaseMapper&lt;E,ID&gt;</code> è·å–æ³›å‹ E æŒ‡å‘çš„ Classï¼Œé€šè¿‡å±æ€§ååŒ¹é…ï¼ˆæ²¡åŠæ³•è€ä»£ç åªèƒ½åŒ¹é…å±æ€§åï¼‰æˆ–æ³¨è§£åŒ¹é…æ‰¾åˆ°æ—¶é—´å­—æ®µã€‚SQL é‡Œæ‹¼æ¥æ—¶é—´å­—æ®µæ˜¯é€šè¿‡åŒ…è£… SqlSource é€šè¿‡ <code>SqlSource#getBoundSql</code> æ›¿æ¢æœ€ç»ˆ SQL å’Œå½“å‰æ—¶é—´å‡½æ•°ã€‚</p><ul><li><code>mappedStatement#getId()</code>ï¼Œid çš„å€¼å¯¹åº”ç±»å…¨è·¯å¾„ï¼Œä»è¿™ä¸ªç±»å…¨è·¯å¾„è·å–ç±»ä¿¡æ¯å¹¶ç¡®å®š <code>BaseMapper&lt;E,ID&gt;</code> E æŒ‡å‘çš„æ³›å‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * è¡¨çš„åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´ä¼šéšç€è¡¨çš„æ›´æ–°æˆ–æ’å…¥è¡Œä¸ºè¿›è¡Œèµ‹å€¼. å› ä¸ºéœ€è¦ç¡®å®šè¡¨ä¸­æ˜¯å¦æœ‰åˆ›å»ºæ—¶é—´æˆ–æ›´æ–°æ—¶é—´ä¸”ç¡®å®šæ—¶é—´å­—æ®µåï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨çš„åœ°æ–¹ * çš„ mapper ç»§æ‰¿ {@link BaseMapper}&lt;br&gt; * æ€è·¯ï¼Œä» BaseMapper çš„æ³›å‹ T è·å–å®ä½“ç±»ï¼Œä»å®ä½“ç±»é‡Œé¢è§£æå‡ºåˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å­—æ®µå¯¹åº”çš„æ•°æ®åº“å­—æ®µåï¼Œè¿™é‡Œåˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´æ˜¯é€šè¿‡åç§° * åŒ¹é…çš„ï¼Œå¤§å°å†™ä¸è®ºåŒ…å«åŒ¹é….é’ˆå¯¹æ’å…¥è¡Œä¸ºä¼šå¢åŠ åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´ï¼Œé’ˆå¯¹æ›´æ–°è¡Œä¸ºä¼šæ›´æ–°æ›´æ–°æ—¶é—´.&lt;br&gt; * &lt;lu&gt; * &lt;li&gt;åˆ›å»ºæ—¶é—´ï¼ŒdCjsjã€cjsjã€dtCjsjã€dCjrqã€cjrqã€dtCjrqã€createTimeã€dCreateTimeã€dtCreateTime&lt;/li&gt; * &lt;li&gt;æ›´æ–°æ—¶é—´ï¼ŒdGxsj, gxsj, dtGxsj, dXgsj, xgsj, dtXgsj, dZhxgsjã€zhxgsjã€dtZhxgsjã€updateTimeã€dUpdateTimeã€dtUpdateTime&lt;/li&gt; * &lt;/lu&gt; * * @author liulili * @date 2024/1/25 11:24 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"update"</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutofillCreateOrUpdateTimeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">CJSJ_COLUMN_NAMES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"cjsj"</span><span class="token punctuation">,</span> <span class="token string">"dCjsj"</span><span class="token punctuation">,</span> <span class="token string">"dtCjsj"</span><span class="token punctuation">,</span> <span class="token string">"cjrq"</span><span class="token punctuation">,</span> <span class="token string">"dCjrq"</span><span class="token punctuation">,</span> <span class="token string">"dtCjrq"</span><span class="token punctuation">,</span> <span class="token string">"createTime"</span><span class="token punctuation">,</span> <span class="token string">"dCreateTime"</span><span class="token punctuation">,</span> <span class="token string">"dtCreateTime"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">GXSJ_COLUMN_NAMES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"gxsj"</span><span class="token punctuation">,</span> <span class="token string">"dGxsj"</span><span class="token punctuation">,</span> <span class="token string">"dtGxsj"</span><span class="token punctuation">,</span> <span class="token string">"xgsj"</span><span class="token punctuation">,</span> <span class="token string">"dXgsj"</span><span class="token punctuation">,</span> <span class="token string">"dtXgsj"</span><span class="token punctuation">,</span> <span class="token string">"zhxgsj"</span><span class="token punctuation">,</span> <span class="token string">"dZhxgsj"</span><span class="token punctuation">,</span> <span class="token string">"dtZhxgsj"</span><span class="token punctuation">,</span> <span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token string">"dUpdateTime"</span><span class="token punctuation">,</span> <span class="token string">"dtUpdateTime"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MappedStatement</span> mappedStatement <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedStatement</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">StatementType</span> statement <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">==</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token constant">CALLABLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"ã€è‡ªåŠ¨å¡«å……åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´ã€‘ä¸æ”¯æŒåœ¨å­˜å‚¨è¿‡ç¨‹ç±»å‹ä¸šåŠ¡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">SqlCommandType</span> command <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> id <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span> mapperClazz <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            mapperClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"className[{}]ä¸æ˜¯Classæ— æ³•ç»§ç»­ã€è‡ªåŠ¨å¡«å……åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´ã€‘çš„å·¥ä½œ"</span><span class="token punctuation">,</span> className<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"className[{}]ä¸æ˜¯Classæ— æ³•ç»§ç»­ã€è‡ªåŠ¨å¡«å……åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´ã€‘çš„å·¥ä½œ"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Class</span> entityClazz <span class="token operator">=</span> <span class="token function">findEntityClazz</span><span class="token punctuation">(</span>mapperClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"class[{}]éæ¥å£/æœªç»§æ‰¿BaseMapperæ¥å£"</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">CUTimeDTO</span> cuTimeDTO <span class="token operator">=</span> <span class="token function">findCreateAndUpdateTimeColumn</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getCreateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"class[{}]æ— åŒ¹é…çš„åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å­—æ®µï¼Œ è¯·å‚è€ƒ AutofillCreateOrUpdateTimeInterceptor#CJSJ_COLUMN_NAMES å’Œ AutofillCreateOrUpdateTimeInterceptor#GXSJ_COLUMN_NAMES"</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillInsert</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">UPDATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillUpdate</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillUpdate</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> updateTimeColumn <span class="token operator">=</span> cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>updateTimeColumn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> updateTimeColumn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillUTime</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSource</span> decoderSqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoFillUTimeUpdateSqlSource</span><span class="token punctuation">(</span>sqlSource<span class="token punctuation">,</span> updateTimeColumn<span class="token punctuation">,</span> <span class="token string">"now()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> <span class="token string">"sqlSource"</span><span class="token punctuation">,</span> decoderSqlSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillInsert</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> createColumnName <span class="token operator">=</span> cuTimeDTO<span class="token punctuation">.</span><span class="token function">getCreateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> updateColumnName <span class="token operator">=</span> cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addColumn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>createColumnName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> createColumnName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            addColumn<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>createColumnName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>updateColumnName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> updateColumnName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            addColumn<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>updateColumnName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>addColumn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> columnName <span class="token operator">=</span> addColumn<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> columnValue <span class="token operator">=</span> addColumn<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>column <span class="token operator">-&gt;</span> <span class="token string">"now()"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSource</span> decoderSqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoFillCUTimeInsertSqlSource</span><span class="token punctuation">(</span>sqlSource<span class="token punctuation">,</span> columnName<span class="token punctuation">,</span> columnValue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> <span class="token string">"sqlSource"</span><span class="token punctuation">,</span> decoderSqlSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span><span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getCreateTimePropertyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>createColumnName <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> createColumnName<span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimePropertyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>updateColumnName <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> updateColumnName<span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Collection</span> paramColl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            paramColl<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sparam <span class="token operator">-&gt;</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>sparam<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Map</span> paramMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            entries<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-&gt;</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramArr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>paramArr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span> property <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                property <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"param[{}]å±æ€§ã€{}ã€‘è·å–å±æ€§å€¼å¤±è´¥"</span><span class="token punctuation">,</span> param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span><span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">||</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimePropertyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>updateColumnName <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> updateColumnName<span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Collection</span> paramColl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            paramColl<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sparam <span class="token operator">-&gt;</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span>sparam<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Map</span> paramMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            entries<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-&gt;</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramArr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>paramArr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span> property <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                property <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"param[{}]å±æ€§ã€{}ã€‘è·å–å±æ€§å€¼å¤±è´¥"</span><span class="token punctuation">,</span> param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">autofillUTime</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">CUTimeDTO</span> <span class="token function">findCreateAndUpdateTimeColumn</span><span class="token punctuation">(</span><span class="token class-name">Class</span> entityClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> entityClazz<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> fieldMap <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">,</span> field <span class="token operator">-&gt;</span> field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldKeys <span class="token operator">=</span> fieldMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CUTimeDTO</span> <span class="token class-name">CUTimeDTO</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cjsjFieldNameOptional <span class="token operator">=</span> fieldKeys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>fieldKey <span class="token operator">-&gt;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token constant">CJSJ_COLUMN_NAMES</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>columnName <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>columnName<span class="token punctuation">,</span> fieldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cjsjFieldNameOptional<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>cjsjFieldName <span class="token operator">-&gt;</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setCreateTimePropertyName</span><span class="token punctuation">(</span>cjsjFieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setCreateTimeColumnName</span><span class="token punctuation">(</span><span class="token function">getColumnNameByColumnAnno</span><span class="token punctuation">(</span>cjsjFieldNameOptional<span class="token punctuation">,</span> fieldMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> gxsjFieldNameOptional <span class="token operator">=</span> fieldKeys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>fieldKey <span class="token operator">-&gt;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token constant">GXSJ_COLUMN_NAMES</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>columnName <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>columnName<span class="token punctuation">,</span> fieldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        gxsjFieldNameOptional<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>gxsjFieldName <span class="token operator">-&gt;</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setUpdateTimePropertyName</span><span class="token punctuation">(</span>gxsjFieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token function">getColumnNameByColumnAnno</span><span class="token punctuation">(</span>gxsjFieldNameOptional<span class="token punctuation">,</span> fieldMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getColumnNameByColumnAnno</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldNameOptional<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> fieldMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> columnName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldNameOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> fieldName <span class="token operator">=</span> fieldNameOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Field</span> field <span class="token operator">=</span> fieldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Column</span> column <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Column</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            columnName <span class="token operator">=</span> column<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> columnName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">Class</span> <span class="token function">findEntityClazz</span><span class="token punctuation">(</span><span class="token class-name">Class</span> mapperClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mapperClazz<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> mapperClazz<span class="token punctuation">.</span><span class="token function">getGenericInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>interfaces<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParameterizedType</span><span class="token punctuation">&gt;</span></span> baseMapperTypeOptional <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>interfaces<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>iface <span class="token operator">-&gt;</span> iface <span class="token keyword">instanceof</span> <span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>iface <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span> iface<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>iface <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> iface<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span><span class="token class-name">BaseMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseMapperTypeOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">ParameterizedType</span> baseMapperType <span class="token operator">=</span> baseMapperTypeOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> baseMapperType<span class="token punctuation">.</span><span class="token function">getActualTypeArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®¾è®¡çš„ DTO ç”¨äºç¡®å®šå±æ€§å¯¹åº”çš„åˆ›å»ºæ—¶é—´å­—æ®µå±æ€§å’Œæ›´æ–°æ—¶é—´å­—æ®µå±æ€§ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Getter</span><span class="token annotation punctuation">@Setter</span><span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CUTimeDTO</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> createTimePropertyName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> updateTimePropertyName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> createTimeColumnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> updateTimeColumnName<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒ…è£…å¯¹åº”çš„ SqlSource åœ¨è·å–æœ€åçš„ SQL ï¼ˆ<code>SqlSource#getBoundSql</code>ï¼‰ä¸­æ‹¼æ¥åˆ›å»ºå’Œæ›´æ–°æ—¶é—´è„šæœ¬ã€‚ä¸åœ¨å…·ä½“çš„ SqlSource é‡Œé¢å®Œæˆå­—æ®µæ‹¼æ¥åŠ ä¸Šé¢„å¤„ç†å­—æ®µï¼Œæ˜¯å› ä¸º mybatis æ”¯æŒå¤šç§ SqlSource åŒ…å« <code>StaticSqlSource</code>ã€<code>ProviderSqlSource</code>ã€<code>RawSqlSource</code>ã€<code>DynamicSqlSource</code>ï¼Œä¸”ä»–ä»¬å¯ä»¥ç»„åˆå‡ºç°ï¼Œå¯è§è¿˜æ˜¯æœ‰ä¸€å®šçš„å¤æ‚åº¦çš„ã€‚æ‰€ä»¥æ‰é€‰æ‹©ç”¨åŒ…è£…ç±»å®Œæˆå­—æ®µå¡«å……ã€‚è¿™ç§æ˜¯ä¸å»ºè®®è‡ªåŠ¨å¡«å……é‚£ç§åŒ…å«ä¸åŒå€¼çš„å­—æ®µçš„ï¼Œå› ä¸ºè¿™æ ·ä¼šè®©é¢„å¤„ç† SQL æ²¡æœ‰å‘æŒ¥ä½œç”¨ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoFillUTimeUpdateSqlSource</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSource</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">SqlSource</span> sqlSource<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnValue<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span><span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> newSql <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replaceIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token string">"set "</span><span class="token punctuation">,</span> <span class="token string">"set "</span> <span class="token operator">+</span> columnName <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> columnValue <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> <span class="token string">"sql"</span><span class="token punctuation">,</span> newSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoFillCUTimeInsertSqlSource</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSource</span>  <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">SqlSource</span> sqlSource<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnValue<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span><span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"\\("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> newSql <span class="token operator">=</span> sql<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> index <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            newSql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> columnName <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> sql<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">indexOfIgnoreCase</span><span class="token punctuation">(</span>newSql<span class="token punctuation">,</span> <span class="token string">"values"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index1 <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token string">"values"</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>index1 <span class="token operator">&lt;</span> newSql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> index1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            index1 <span class="token operator">=</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">char</span> next <span class="token operator">=</span> newSql<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token char">' '</span> <span class="token operator">||</span> next <span class="token operator">==</span> <span class="token char">'\\'</span> <span class="token operator">||</span> next <span class="token operator">==</span> <span class="token char">'n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token char">'('</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            index1 <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">indexOfIgnoreCase</span><span class="token punctuation">(</span>newSql<span class="token punctuation">,</span> <span class="token string">"values"</span><span class="token punctuation">,</span> index1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index1 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>newSql<span class="token punctuation">,</span> index<span class="token punctuation">,</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newSql <span class="token operator">=</span> newSql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>replace<span class="token punctuation">,</span> replace <span class="token operator">+</span> columnValue <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> <span class="token string">"sql"</span><span class="token punctuation">,</span> newSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="question-çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®"><a href="#question-çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®" class="headerlink" title=":question: çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®"></a><span class="github-emoji"><span>â“</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2753.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®</h4><p>ä¸ºä»€ä¹ˆä¸è®©é¡¹ç›®ç›´æ¥é›†æˆ mybatis-plus ä¿®æ”¹ pojo å°±èƒ½å¿«é€Ÿè§£å†³é—®é¢˜ï¼Œä¸ç”¨è¿™ä¹ˆå¤æ‚ã€‚å½“ç„¶æˆ‘ç»Ÿä¸€è¿™ä¸ªæ€è·¯ï¼Œä½†è¿™ä¸ªæ€è·¯é€‚åˆäº pojo å°‘ï¼Œä¸”ä½¿ç”¨ <code>@Table</code> ã€<code>@Column</code> ç­‰æ•°æ®åº“å‹çš„æ³¨è§£çš„é¡¹ç›®ã€‚å¦åˆ™ï¼Œåœ¨å¤§é¡¹ç›®ä¸­è¿˜æ˜¯å·¥ä½œé‡åŠé£é™©è¿˜æ˜¯æ¯”è¾ƒé«˜ã€‚ä½†è¿™ä¸å½±å“æˆ‘æ¨èä½¿ç”¨ mybatis-plusã€‚</p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> code </tag>
            
            <tag> mybatis </tag>
            
            <tag> mybatis-plus </tag>
            
            <tag> è‡ªåŠ¨å¡«å…… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis åˆ†å¸ƒå¼é”ä½ ç»­çº¦äº†å—</title>
      <link href="/2024/01/31/redis-fen-bu-shi-suo-ni-xu-yue-liao-ma/"/>
      <url>/2024/01/31/redis-fen-bu-shi-suo-ni-xu-yue-liao-ma/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis-åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ"><a href="#Redis-åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ" class="headerlink" title="Redis åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ"></a>Redis åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ</h2><p>æœåŠ¡åœ¨é›†ç¾¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹é”æ˜¯æ— æ³•æ»¡è¶³æœåŠ¡ä¹‹é—´é€»è¾‘éš”ç¦»ã€‚åˆ†å¸ƒå¼é”æ¦‚å¿µåº”è¿è€Œç”Ÿï¼Œå®ƒéœ€è¦å…·å¤‡äº’æ–¥æ€§ã€é˜²æ­¢æ­»é”ã€é«˜å¯ç”¨æ€§ã€å¯é‡å…¥æ€§ã€å”¯ä¸€æ ‡è¯†çš„ç‰¹ç‚¹ã€‚</p><ul><li><p>äº’æ–¥æ€§ï¼šä»»æ„æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªæœåŠ¡æ‰èƒ½è·å–é”ã€‚</p></li><li><p>é˜²æ­¢æ­»é”ï¼šåˆ†å¸ƒå¼é”åº”è¯¥åœ¨æœåŠ¡é€»è¾‘è¿è¡Œå¼‚å¸¸æˆ–å´©æºƒæ—¶èƒ½å¤Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯ç»™é”è®¾å®šè¶…æ—¶æ—¶é—´é¿å…æ­»é”ã€‚</p></li><li><p>é«˜å¯ç”¨æ€§ï¼šç¡®ä¿é”æä¾›æ–¹èŠ‚ç‚¹æ•…éšœæ—¶ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œç¡®ä¿é”çš„å¯é æ€§ã€‚</p></li><li><p>å¯é‡å…¥æ€§ï¼šå…è®¸åŒä¸€ä¸ªçº¿ç¨‹æˆ–æœåŠ¡åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å¤šæ¬¡è·å–åŒä¸€ä¸ªé”ï¼Œè€Œä¸ä¼šå‡ºç°æ­»é”æˆ–é˜»å¡ã€‚</p></li><li><p>å”¯ä¸€æ ‡è¯†ï¼šåˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å”¯ä¸€çš„æ ‡è¯†ã€‚</p></li></ul><p>åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¤§ä½“æœ‰å‡ ç§ï¼Œä½¿ç”¨åŸºäºå”¯ä¸€ç´¢å¼•çš„æ•°æ®åº“è¡¨ã€zookeeper/etcdã€redisã€‚ä¸ºè¾¾åˆ°åˆ†å¸ƒå¼é”çš„äº’æ–¥æ€§å’Œé˜²æ­¢æ­»é”è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œæ–¹æ¡ˆæ˜¯è®¾å®šè¶…æ—¶æ—¶é—´é…åˆ<strong>å®šæ—¶ç»­æœŸ</strong>ä»¥è¾¾åˆ°ç›®çš„ã€‚å¦‚æœä½ ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œè¯·é—®ä½ é¡¹ç›®ä¸­ Redis åˆ†å¸ƒå¼é”æœ‰<strong>å®šæ—¶ç»­æœŸ</strong>å—ï¼Ÿ</p><p>Jedis ä¸»è¦åŒ…å«æ•°æ®ç»“æ„æ“ä½œå’Œé˜Ÿåˆ— PUB/SUB æ“ä½œã€‚Redisson ç»„ä»¶é™¤æ­¤ä¹‹å¤–è¿˜åŒ…å«åˆ†å¸ƒå¼é”çš„å®ç°ã€‚Redisson å…³äºè·å–é”æœ‰å…­ç§æ–¹å¼ï¼Œ<code>lock()</code> ã€<code>tryLock()</code>ã€<code>lockInterruptibly()</code> ã€<code>tryLock(long waitTime, TimeUnit unit)</code>ã€ <code>lock(long leaseTime, TimeUnit unit)</code> ã€<code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code>ã€‚åŒºåˆ†ç‚¹åœ¨äº æ˜¯å¦ç­‰å¾…è·å–é”ã€ç­‰å¾…è·å–é”æ—¶é•¿ï¼Œæ˜¯å¦æœ‰è¿‡æœŸã€è¿‡æœŸæ—¶é—´ã€‚å¥½åƒæ²¡æœ‰çœ‹åˆ°ç»­æœŸç›¸å…³çš„å†…å®¹ã€‚</p><h4 id="mag-ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ"><a href="#mag-ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ" class="headerlink" title=":mag: ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ"></a><span class="github-emoji"><span>ğŸ”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ</h4><p>å°±åƒè€å¤«è€å¦»ä¸€æ ·ï¼Œ<span class="github-emoji"><span>â¤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çˆ±æ˜¯è—åœ¨ç»†èŠ‚é‡Œï¼Œç»­æœŸè—åœ¨é”è·å–çš„ç»†èŠ‚é‡Œã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸš¦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä»£ç æ˜¯ä»¥ redisson-3.18.0 ç‰ˆæœ¬ä¸ºä¾‹ï¼Œä¼°è®¡æ€»ä½“æ€è·¯å·®ä¸å¤šã€‚</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// RedissonLock</span><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> internalLockLeaseTime<span class="token punctuation">,</span>                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>ttlRemaining <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token comment">// lock acquired</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> ttlRemaining<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆï¼Œæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´æ—¶ï¼Œredisson ä¼šä½¿ç”¨ <code>internalLockLeaseTime</code> ï¼ˆå®ƒæŒ‡ lock å†…ç½®è¿‡æœŸæ—¶é—´ï¼Œlock å¯¹è±¡åˆå§‹åŒ–æ—¶ä»é…ç½®ç±» <code>org.redisson.config.Config#lockWatchdogTimeout</code> ä¸­è·å–ï¼Œé»˜è®¤ 30 sï¼‰ä½œä¸ºè¿‡æœŸæ—¶é—´æ¥ç”³è¯·åˆ†å¸ƒå¼é”ã€‚ç¬¬ä¸€æ¬¡ç”³è¯·é”æˆåŠŸå <code>ttlRemainingFuture.thenApply</code> ï¼Œå¦‚æœè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´æœ‰å€¼ï¼Œåˆ™é‡æ–°è®¾ç½® <code>internalLockLeaseTime</code>ã€‚æ²¡æœ‰è®¾ç½®çš„è¯ï¼Œåˆ™éœ€è¦å®šæ—¶ç»­æœŸï¼Œä¿è¯é”èƒ½è¢«æœ¬çº¿ç¨‹ä¸€ç›´æŒæœ‰ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// RedissonBaseLock</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ExpirationEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpirationEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ExpirationEntry</span> oldEntry <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// å¯é‡å…¥ä½ç½®ï¼Œå› ä¸ºä¸å­˜åœ¨è·å–é”ä¹‹åï¼ŒåŒä¸€çº¿ç¨‹çš„å¹¶å‘é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ LinkedHashMap</span>        oldEntry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        entry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ExpirationEntry</span> ee <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ee <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">Timeout</span> task <span class="token operator">=</span> commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token class-name">ExpirationEntry</span> ent <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">Long</span> threadId <span class="token operator">=</span> ent<span class="token punctuation">.</span><span class="token function">getFirstThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Can't update lock "</span> <span class="token operator">+</span> <span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" expiration"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">// reschedule itself</span>                    <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> internalLockLeaseTime <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ee<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ç®€å•æ¦‚æ‹¬ï¼Œå°±æ˜¯æœªè®¾ç½®è¿‡æœŸæ—¶é—´çš„åˆ†å¸ƒå¼é”ï¼Œæ˜¯ä»¥ 30s è¿‡æœŸæ—¶é—´å…ˆè·å–åˆ†å¸ƒå¼é”ï¼Œç¨‹åºä¸­ä½¿ç”¨æ—¶é—´ç‰‡æ–¹å¼åœ¨æ¯ 10s (30s * 1/3) ç»­æœŸã€‚è®¾ç½®è¿‡æœŸæ—¶é—´çš„åˆ†å¸ƒå¼é”åè€Œä¸èƒ½äº«å—ç»­æœŸã€‚</strong></p><p><span class="github-emoji"><span>ğŸ˜…</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœ¬æ¥å¤§å®¶åœ¨å®æˆ˜è¿‡ç¨‹ä¸­ï¼Œå°±æ˜¯æ€•é”ä¸é‡Šæ”¾ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šè¢«å»ºè®®ä½¿ç”¨ <code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code> ï¼Œç»“æœåªæœ‰è¿™ç§è®¾ç½® leaseTime çš„è·å–é”æ²¡æœ‰ç»­æœŸã€‚å¤šå°‘æœ‰ç‚¹è¢«èƒŒ (feng) åˆº (ci) <span class="github-emoji"><span>ğŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ã€‚æˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®ï¼ˆfengï¼‰é¢˜ï¼ˆciï¼‰ï¼Œå¸Œæœ›åœ¨ leaseTime è®¾ç½®æ—¶ï¼Œä¹Ÿèƒ½äº«å—ç»­æœŸåŠŸæ•ˆã€‚</p><h4 id="balance-scale-è¶…æ—¶ä¸ç»­æœŸå…¼å¾—"><a href="#balance-scale-è¶…æ—¶ä¸ç»­æœŸå…¼å¾—" class="headerlink" title=":balance_scale: è¶…æ—¶ä¸ç»­æœŸå…¼å¾—"></a><span class="github-emoji"><span>âš–</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2696.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¶…æ—¶ä¸ç»­æœŸå…¼å¾—</h4><p>å¥½åœ¨ <code>RedissonBaseLock</code> ä¸­å…³äºç»­æœŸçš„æ–¹æ³• <code>scheduleExpirationRenewal</code> å’Œ <code>cancelExpirationRenewal</code> éƒ½æ˜¯ <code>protected</code> ä¿®é¥°ç¬¦ä¿®é¥°ã€‚å¯ä»¥å»ºç«‹ <code>RedissonBaseLock</code> çš„åŒ…è£…ç±»ï¼Œåœ¨è·å–é”å’Œé‡Šæ”¾é”çš„æ—¶å€™å¯¹ leaseTime è®¾ç½®çš„ç»­æœŸè¡¥è¶³å³å¯ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>redisson</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RFuture</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RLock</span></span><span class="token punctuation">;</span><span class="token comment">/** * åˆ†å¸ƒå¼é”.&lt;br&gt; * ç”¨è£…é¥°è€…æ¨¡å¼ç»™æ‰€æœ‰ lock åŠ ä¸Šæ—¶é—´è¿‡æœŸå‰çš„ç»­æœŸæ“ä½œ.&lt;br&gt; * redis ä½œä¸ºåˆ†å¸ƒå¼é”æ–¹æ¡ˆä¸€å®šä¼šæœ‰å¼Šç«¯ï¼Œæ¯”å¦‚å‡ºç°å“¨å…µæ¨¡å¼çš„ redis é›†ç¾¤ï¼Œå°±å¯èƒ½å› ä¸ºé”ä¿¡æ¯åœ¨ä¸»èŠ‚ç‚¹åŒæ­¥ä»èŠ‚ç‚¹æ—¶å‡ºç°çš„ä¸»èŠ‚ç‚¹ä¸­æ–­ï¼Œå¯¼è‡´ä»èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹ä¹‹å * æ— é”ä¿¡æ¯ï¼Œå¯¼è‡´çš„å…¶ä»–çº¿ç¨‹ç”³è¯·åˆ°é”ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹è·å–åˆ°åŒä¸€æŠŠé”çš„ ganga åœºæ™¯.&lt;br&gt; * è¯·æ³¨æ„åˆç†ä½¿ç”¨é”ï¼Œè·å–é”åä¸€å®šåœ¨ finally ä¸­é‡Šæ”¾é”ï¼Œç¨‹åºè¿è¡Œæ—¶é—´é•¿ä¹‹åä¸€å®šä¼šå‡ºç°å†…å­˜æº¢å‡ºé—®é¢˜. * * @author liulili * @since 20243-01-19 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenewalLock</span> <span class="token keyword">implements</span> <span class="token class-name">RLock</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedissonBaseLock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">RenewalLock</span><span class="token punctuation">(</span><span class="token class-name">RLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token keyword">instanceof</span> <span class="token class-name">RenewalLock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"lock æœ¬å°±æ˜¯ç»­æœŸé”ï¼Œä¸éœ€è¦äºŒæ¬¡è£…é¥°ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token keyword">instanceof</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RedissonBaseLock</span><span class="token punctuation">)</span> lock<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"åˆ†å¸ƒå¼é”ç»­æœŸçš„åŠŸèƒ½è‡³å°‘æ˜¯ RedissonBaseLock çš„å®ä¾‹ï¼Œåˆ° redisson 3.18.0 ç‰ˆæœ¬ï¼ŒRedissonMultiLock æ˜¯ä¸èƒ½è¢« DistributedLock è£…é¥°çš„ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"renewal_"</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"internalLockLeaseTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            field<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"RedissonBaseLock ç±»æ²¡æœ‰ internalLockLeaseTime å±æ€§ï¼Œè¯·æ³¨æ„ç‰ˆæœ¬"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        lock<span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> getLockSuccess <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>getLockSuccess <span class="token operator">&amp;&amp;</span> leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> getLockSuccess<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">forceUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">forceUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByThread</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isHeldByThread</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">remainTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">remainTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// è¿˜æ˜¯é»˜è®¤çš„è¶…æ—¶æ—¶é—´</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">forceUnlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> unlockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">forceUnlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        unlockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> unlockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> unlockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        unlockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> unlockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> unlockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">unlockAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        unlockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> unlockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getHoldCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">getHoldCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">isLockedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isLockedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">remainTimeToLiveAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">remainTimeToLiveAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰ä¸‰ä¸ªæ³¨æ„ç‚¹ï¼šé¦–å…ˆï¼Œè¿™ä¸ªè£…é¥°ç±»éœ€è¦æ”¾åœ¨ <code>org.redisson</code> åªæœ‰è¿™æ ·æ‰èƒ½ä½¿ç”¨ <code>proteced void scheduleExpirationRenewal()</code> å’Œ <code>protected void cancelExpirationRenewal()</code> æ–¹æ³•ã€‚å…¶æ¬¡ï¼Œç»­æœŸä¾æ—§æ˜¯æŒ‰ç…§ <code>internalLockLeaseTime</code> /3 é—´éš”è§¦å‘ï¼Œä½†å› ä¸ºæ˜¯ç”³è¯·é”å®Œç»“ä¹‹åçš„ç»­æœŸï¼Œæ‰€ä»¥æ­¤æ—¶çš„ <code>internalLockLeaseTime</code> ä¸ºç¬¬ä¸€æ¬¡ç”³è¯·é”çš„ <code>leaseTime</code> ã€‚ç¬¬ä¸‰ï¼Œå›  Redisson ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œå¯èƒ½ä¸ä¼šæœ‰ RedissonBaseLock åŸºç±»ï¼Œä½ å¯ä»¥å‡çº§ç‰ˆæœ¬åä½¿ç”¨è£…é¥°ç±»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼é” </tag>
            
            <tag> redis </tag>
            
            <tag> code </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>json å·¥å…·æˆ‘åº”è¯¥æ€ä¹ˆé€‰ï¼Ÿ</title>
      <link href="/2023/05/18/json-gong-ju-wo-ying-gai-zen-me-xuan/"/>
      <url>/2023/05/18/json-gong-ju-wo-ying-gai-zen-me-xuan/</url>
      
        <content type="html"><![CDATA[<p>ç¼–ç¨‹å¤šå¹´ï¼Œå…¶å®é€‚åˆé¡¹ç›®/è‡ªå·±/å›¢é˜Ÿæ‰æ˜¯åˆé€‚çš„ã€‚JSON åœ¨ B/S åº”ç”¨ä¸‹ï¼Œä½œä¸ºè½»é‡çº§çš„æ•°æ®äº¤æ¢æ–¹å¼ã€‚ä¹Ÿåº”è¿è€Œç”Ÿä¸å°‘åºåˆ—åŒ–ååºåˆ—åŒ–çš„ JSON å·¥å…·åŒ…ã€‚<br>æ¯”å¦‚ï¼Œjson-libã€fastjsonã€gsonã€jackson ç­‰ã€‚æˆ‘ç”¨è¿‡çš„ï¼Œä¸»è¦æ˜¯è¿™å‡ ä¸ªå°±è¯´è¯´æˆ‘çš„é€‰æ‹©åœºæ™¯åŠä¾æ®ã€‚</p><h3 id="json-lib"><a href="#json-lib" class="headerlink" title="json-lib"></a>json-lib</h3><p>è¿™æ˜¯æˆ‘<strong>è¢«è¿«</strong>ä½¿ç”¨çš„ JSON å·¥å…·åŒ…ã€‚ä¸æ˜¯ä¸»åŠ¨é€‰æ‹©ï¼Œä¹Ÿæ˜¯å› ä¸ºç¡®å®è§‰å¾—å¾ˆå‘ã€‚<strong>é¦–å…ˆ</strong>ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–è€—æ—¶å¾ˆæ…¢ã€‚<strong>å…¶æ¬¡</strong>ï¼Œ<code>JSONObject.getXXX(key)</code> JSONObject<br>çš„ get ç³»æ–¹æ³•éƒ½å¿…é¡»è¦æ±‚ key å¿…é¡»åœ¨ JSON ä¸²ä¸­ä¸”éç©ºã€‚ä¹Ÿå°±æ˜¯è¢«ä½¿ç”¨çš„ key éƒ½å¿…é¡»æ˜¯éç©ºå€¼ï¼Œæ‰€ä»¥å°±é€¼è¿«è®¾ç½®é»˜è®¤å€¼ã€‚ä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ä¸šåŠ¡è¢«â€é€¼ä¸å¾—å·²â€çš„é»˜è®¤å€¼è¦†ç›–ã€‚<strong>ç¬¬ä¸‰</strong>ï¼Œ<code>JSONObject.put(key,value)</code> æ–¹æ³•ä¼šé’ˆå¯¹ value ç±»å‹ä¸º String ä¸”ç¬¦åˆ JSON æ ¼å¼æ—¶ï¼Œä¼šå°† value ååºåˆ—åŒ–ã€‚è¿™ä¸ªç‰¹æ€§çœ‹ä¼¼å¾ˆå¥½ï¼Œå…¶å®åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œç»™äººè¯¯å¯¼ï¼Œ<br>ä»¥ä¸º value æ˜¯ JSONObject ç»“æœå‘ç°æ˜¯ Stringã€‚Oh my god ï¼ï¼æ€»ç»“ï¼Œå‘æ¯”è¾ƒå¤šï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p><h3 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h3><p>é˜¿é‡Œå·´å·´å‡ºå“ï¼Œä½¿ç”¨æ˜¯å¾ˆç®€å•ï¼ŒåŸºäºç±»å±æ€§ get/set æ¥åºåˆ—åŒ–å’Œéåºåˆ—åŒ–ã€‚åŒ…æ‹¬ä¹Ÿæ”¯æŒå¾ˆå¤šé€‰é¡¹ <code>FastJsonConfig</code> ã€ <code>SerializerFeature</code>ã€‚å¯¹ç ”å‘æ¥è¯´ï¼Œåºåˆ—åŒ–ååºåˆ—åŒ–ä½¿ç”¨<br>èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œæ€§èƒ½ä¹Ÿåå¥½ã€‚ä»¥ä¸ºåº”è¯¥æ˜¯å¾ˆå—æ¬¢è¿ï¼Œä½† github ä¸Š issue å¾ˆå¤šã€‚ä¼ è¯´ä¸­æºç å†™çš„ä¸å¥½ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæ³¨é‡Šã€‚æ‰€ä»¥ï¼Œä¸æ˜¯æœ€å—æ¬¢è¿ï¼Œåœ¨ä¸­å›½å¾ˆæœ‰åœ°ä½ã€‚</p><h3 id="jackson"><a href="#jackson" class="headerlink" title="jackson"></a>jackson</h3><p>è¢« spring-web ç”¨ä½œé»˜è®¤çš„ <code>application/json</code> åºåˆ—åŒ–å’Œååºåˆ—åŒ– JSON é€‰å‹ã€‚ä¾èµ–çš„ jar åŒ…å°‘ï¼Œæä¾›æ‰©å±•é€‰é¡¹/é«˜çº§åŠŸèƒ½å¾ˆå¤šã€‚å¯¹æˆ‘è€Œè¨€ï¼Œç›¸æ¯”è¾ƒ fastjson è€Œè¨€ï¼Œä½¿ç”¨<br>ä¸æ–¹ä¾¿ã€‚å¯¹äº String è½¬ Date æ—¶ï¼Œå¿…é¡»æŒ‡å®š <code>@JsonProperty(format='xxxx')</code> æ ¼å¼åŒ–å­—æ®µã€‚</p><h3 id="gson"><a href="#gson" class="headerlink" title="gson"></a>gson</h3><p>google æ¨å‡º JSON å·¥å…·åŒ…ï¼Œç¬¦åˆ JSON æ ¼å¼å®šä¹‰ï¼Œæ˜¯ä¾æ®å±æ€§è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼ŒåŒ…å« publicã€privateã€protected ä¿®é¥°å­—æ®µã€‚è½¬ Listã€Set é›†åˆç±»ï¼Œç›¸æ¯” fastjson æ”¯æŒ<br>çš„å¾ˆå¥½ã€‚ä½†æ˜¯æ€§èƒ½ç›¸æ¯”è€Œè¨€ä¼šå¼±ä¸€äº›ã€‚</p><h3 id="å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®®-fastjson-gsonã€‚jackson-å°±ç»“åˆ-spring-web-ä½¿ç”¨ã€‚"><a href="#å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®®-fastjson-gsonã€‚jackson-å°±ç»“åˆ-spring-web-ä½¿ç”¨ã€‚" class="headerlink" title="å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®® fastjson/gsonã€‚jackson å°±ç»“åˆ spring-web ä½¿ç”¨ã€‚"></a><strong>å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®® fastjson/gsonã€‚jackson å°±ç»“åˆ spring-web ä½¿ç”¨ã€‚</strong></h3>]]></content>
      
      
      <categories>
          
          <category> é€‰å‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> é€‰å‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-boot-security OAuth2åº”ç”¨å®ç°</title>
      <link href="/2023/04/10/spring-boot-security-oauth2-ying-yong-shi-xian/"/>
      <url>/2023/04/10/spring-boot-security-oauth2-ying-yong-shi-xian/</url>
      
        <content type="html"><![CDATA[<h2 id="mouse-èƒŒæ™¯"><a href="#mouse-èƒŒæ™¯" class="headerlink" title=":mouse: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>é¡¹ç›®ä¸Šä¸€ç›´ä½¿ç”¨ CAS + åº”ç”¨ session + nginx IP hash ç»„åˆæ–¹å¼å®ç°ä¼ªé›†ç¾¤éƒ¨ç½²ã€‚ä½†è¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼Œè¯·æ±‚ä¸å¤Ÿå¹³å‡ï¼Œåº”ç”¨ä½¿ç”¨å¼‚æ­¥å¤„ç†æ–¹å¼ï¼Œè¿˜å¿…é¡»å°†ç»“æœè¿”å›ç»™å‘èµ·çš„åº”ç”¨ï¼Œå¦åˆ™å‰ç«¯æ— æ³•æ‹¿åˆ°ç»“æœã€‚è¿™äº›éƒ½æ˜¯ IP ç»‘å®šå›ºå®šåº”ç”¨å¯¼è‡´çš„ã€‚2023 å¹´ä¸ºæ­¢ï¼Œåœ¨ç½‘ä¸Šæœç´¢åˆ°ä¸»è¦è§£å†³æ–¹å¼æœ‰ä¸¤ä¸ª: 1. session å…±äº«ï¼ˆéœ€è¦ä¾èµ– redisï¼‰2. ç­¾å‘ JWT æˆæƒã€‚ä¸æƒ³å¼•å…¥ redisï¼Œæ‰€ä»¥é€‰æ‹©ç­¾å‘ JWT æˆæƒã€‚æŠ€æœ¯é€‰å‹ä¸Šä½¿ç”¨ <code>spring-scurity</code> + <code>CAS</code> + <code>oauth2</code> ç»„åˆæ–¹å¼ã€‚</p><h2 id="tiger-åº”ç”¨å®ç°"><a href="#tiger-åº”ç”¨å®ç°" class="headerlink" title=":tiger: åº”ç”¨å®ç°"></a><span class="github-emoji"><span>ğŸ¯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åº”ç”¨å®ç°</h2><p>ä½¿ç”¨ <code>spring-security</code> + <code>CAS</code> + <code>Oauth2</code> ç»„åˆæ–¹å¼ï¼Œspring-boot ä¸­æä¾›äº†å¾ˆå¤š starter å¯ä»¥ä½¿ç”¨ã€‚ä»¥ä¸‹ä½¿ç”¨ maven ä»“åº“ç®¡ç†ä¸ºä¾‹</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- spring-security åŸºç¡€ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- CAS ç›¸å…³ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-cas<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- security-jwtç›¸å…³ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-jose<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- JWT ç­¾å‘ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>spring-boot-starter-security</code>ï¼Œæ˜¯ <code>spring-security</code> çš„åŸºç¡€åŒ…ï¼Œä¸»è¦åŒ…å« <code>spring-security-config</code> å’Œ <code>spring-security-web</code></li><li><code>spring-security-cas</code>ï¼Œæ˜¯ <code>spring-security</code> çš„ CAS ç›¸å…³ï¼ŒåŒ…å« CAS validation åŠéªŒè¯é€šè¿‡æˆ–ä¸é€šè¿‡çš„å¤„ç†</li><li><code>spring-security-oauth2-jose</code>ï¼Œæ˜¯ <code>spring-security</code> çš„ token éªŒè¯ç›¸å…³</li><li><code>spring-security-oauth2-resource-server</code>ï¼Œæ˜¯ <code>spring-security</code> çš„ token ç­¾å‘åŠ web token éªŒè¯ã€‚</li></ul><h3 id="elephant-æ€ä¹ˆé›†æˆ"><a href="#elephant-æ€ä¹ˆé›†æˆ" class="headerlink" title=":elephant: æ€ä¹ˆé›†æˆ"></a><span class="github-emoji"><span>ğŸ˜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f418.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ€ä¹ˆé›†æˆ</h3><p>é›†æˆä¹‹å‰ï¼Œå»ºè®®å…ˆçœ‹çœ‹<a href="https://docs.spring.io/spring-security/reference/servlet/architecture.html"> spring-security çš„æ¶æ„</a>ï¼Œ<span class="github-emoji"><span>ğŸ˜¸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f638.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¾ˆå®¹æ˜“ç†è§£ã€‚å½“ç„¶é›†æˆä¸€ä¸ªç»„ä»¶ï¼Œéœ€è¦æœ‰é›†æˆæ€è·¯æˆ–æ­¥éª¤ï¼Œ</p><h4 id="PART1-é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼"><a href="#PART1-é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼" class="headerlink" title="PART1. é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼"></a>PART1. é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼</h4><p>spring-security ç›®å‰æœ‰æ”¯æŒçš„é›†ä¸­æ–¹å¼ï¼Œ</p><ul><li>ä¼ªéªŒè¯ï¼ˆ<code>AbstractPreAuthenticatedProcessingFilter</code>ï¼‰å…¶ä¸­å‡è®¾å§”æ‰˜äººå·²ç»ç”±å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œäº†èº«ä»½éªŒè¯ï¼Œå®ç°ç±»å®Œæˆç®€å•çš„æ ¡éªŒ</li><li>CAS éªŒè¯ï¼ˆ<code>CasAuthenticationFilter</code>ï¼‰</li><li>æœ¬åœ°ç™»å½•éªŒè¯ï¼ˆ<code>UsernamePasswordAuthenticationFilter</code>ï¼‰åº”ç”¨æœ¬åœ°æ•°æ®åº“éªŒè¯ï¼Œéç‹¬ç«‹éªŒè¯æœåŠ¡</li><li>token éªŒè¯ï¼ˆ<code>BearerTokenAuthenticationFilter</code>ï¼‰OAuth2 JWT ç­¾å‘çš„ token åº”ç”¨æœåŠ¡éªŒè¯</li><li>å…¶ä»–éªŒè¯ï¼ˆ<code>AbstractAuthenticationProcessingFilter</code>ï¼‰å®ç°æ­¤ç±»æ¥å®Œæˆå®šåˆ¶éªŒè¯ï¼Œæ¯”å¦‚çº¦å®šå¥½è¯·æ±‚æˆæƒçš„éªŒè¯æ–¹å¼ã€‚</li></ul><p>å½“ç„¶ï¼Œæ­¤å¤„åªæ˜¯é€‰æ‹© Filter å¹¶éçœŸæ­£éªŒè¯çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œspring-security æ”¯æŒçš„ CAS æˆ–  UsernamePassword éªŒè¯æ–¹å¼ä¹Ÿæ˜¯æŠŠä½ çš„éªŒè¯å™¨é»˜è®¤è®¾ç½®äº†ã€‚</p><h4 id="PART2-ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal-credentialsï¼‰"><a href="#PART2-ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal-credentialsï¼‰" class="headerlink" title="PART2. ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal/credentialsï¼‰"></a>PART2. ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal/credentialsï¼‰</h4><p>principalï¼Œè¢«éªŒè¯ä¸»ä½“ã€‚credentialsï¼Œè¢«éªŒè¯è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯†ç ã€‚</p><p>å¦‚æœæ˜¯ä½¿ç”¨ CAS æˆ– UsernamePassword éªŒè¯ï¼Œå¯ä»¥è·³è¿‡è¿™é‡Œï¼Œå› ä¸ºç»„è£…å¾…éªŒè¯å…ƒç´ ï¼Œæœ‰é»˜è®¤å®ç°ã€‚å°±æ‹¿ CAS æ¥æ¯”å¦‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CASAuthenticationFilter</span><span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>                                             <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>  <span class="token comment">//,,,</span>  <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>      username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//,,,</span><span class="token punctuation">}</span><span class="token comment">// UsernamePasswordAuthenticationToken</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//,,,,</span><span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯ä½¿ç”¨ <code>AbstractPreAuthenticatedProcessingFilter</code> æ—¶ï¼Œåˆ™éœ€è¦è¦†ç›–æ–¹æ³• <code>getPreAuthenticatedPrincipal()</code> å’Œ <code>getPreAuthenticatedPrincipal()</code> æ¥ç¡®å®šä¸»ä½“å’Œè¯ä¹¦ã€‚</p><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ˜¯ä½¿ç”¨ <code>BearerTokenAuthenticationFilter</code> æ—¶ï¼Œé»˜è®¤æ˜¯ä»è¯·æ±‚ä¸­è·å– Authorization header å€¼ã€‚æˆ‘åœ¨å®ç°æ—¶ä½¿ç”¨ cookie æ–¹å¼ï¼Œåªéœ€è¦å®ç° <code>BearerTokenResolver</code> æ¥å£ã€‚</p><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ˜¯ä½¿ç”¨ <code>AbstractAuthenticationProcessingFilter</code> æ—¶ï¼Œå°±è‡ªå·±åœ¨ <code>attemptAuthentication()</code> æ–¹æ³•ä¸­å®ç°ã€‚</p><h4 id="PART3-ç»„è£…æˆæƒä»¤ç‰Œ"><a href="#PART3-ç»„è£…æˆæƒä»¤ç‰Œ" class="headerlink" title="PART3. ç»„è£…æˆæƒä»¤ç‰Œ"></a>PART3. ç»„è£…æˆæƒä»¤ç‰Œ</h4><p>å¦‚æœæ˜¯ä½¿ç”¨ CAS æˆ– UsernamePassword éªŒè¯ï¼Œå¯ä»¥è·³è¿‡è¿™é‡Œï¼Œå› ä¸ºç»„è£…ä»¤ç‰Œçš„äº‹æƒ…ï¼ŒFilter é‡Œå·²ç»å®ç°ã€‚å°±æ‹¿ CAS æ¥æ¯”å¦‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CASAuthenticationFilter</span><span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>                                             <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">//...</span><span class="token keyword">boolean</span> serviceTicketRequest <span class="token operator">=</span> <span class="token function">serviceTicketRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> username <span class="token operator">=</span> serviceTicketRequest <span class="token operator">?</span> <span class="token constant">CAS_STATEFUL_IDENTIFIER</span> <span class="token operator">:</span> <span class="token constant">CAS_STATELESS_IDENTIFIER</span><span class="token punctuation">;</span><span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">obtainArtifact</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span><span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>      username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><span class="github-emoji"><span>ğŸ”†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <font color="blue"><strong>åœ¨ä»¤ç‰Œæœªè¢«éªŒè¯ä¹‹å‰ï¼Œä»¤ç‰Œçš„åˆå§‹åŒ–å¿…é¡»æŒ‡å®šä»¤ç‰Œå¹¶æœªå®ŒæˆéªŒè¯ã€‚å³ authenticated å±æ€§ä¸º false ã€‚</strong></font></p><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ˜¯å…¶ä»–éªŒè¯æ–¹å¼ï¼Œåˆ™éœ€è¦è‡ªå·±ç»„è£…æ ¡éªŒä»¤ç‰Œï¼Œç»§æ‰¿ <code>AbstractAuthenticationToken</code> ç±»ã€‚</p><h4 id="PART4-éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…"><a href="#PART4-éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…" class="headerlink" title="PART4. éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…"></a>PART4. éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…</h4><p>å¦‚æœæ˜¯ä½¿ç”¨ CAS éªŒè¯ï¼Œéœ€è¦é€‰æ‹©ä¸€ä¸‹ <code>AbstractCasProtocolUrlBasedTicketValidator</code> éªŒè¯å™¨ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å®ç°æ­¤ abstract ç±»ï¼Œå®Œæˆ ticket éªŒè¯ã€‚éªŒè¯å™¨çš„è°ƒç”¨æ–¹æ˜¯ <code>CasAuthenticationProvider</code>ã€‚ä¸ºä»€ä¹ˆåœ¨æ­¤ä»‹ç» <code>CasAuthenticationProvider</code> ï¼Ÿ<span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å› ä¸ºåŸºæœ¬ä¸Šæ‰€æœ‰çš„éªŒè¯éƒ½ä¸€å®šæ˜¯å®ç° <code>AuthenticationProvider</code> æ¥å£ã€‚<span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç”¨æˆ·æƒé™ä¿¡æ¯çš„ç»„è£…ï¼Œæ˜¯å®ç° <code>AuthenticationUserDetailsService&lt;T extends Authentication&gt;</code> æ¥å£ï¼Œä»ç¼“å­˜æˆ–æ˜¯æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·æˆ–æƒé™ç‚¹ä¿¡æ¯ç»„è£… UserDetailsã€‚</p><p><span class="github-emoji"><span>ğŸ”†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <font color="blue"><strong>éªŒè¯é€šè¿‡åï¼Œå¯ä»¥é€šè¿‡åœ¨ Controller æ–¹æ³•ä¸Šä½¿ç”¨ <code>@AuthenticationPrincipal</code>&nbsp;æ³¨è§£ï¼Œæˆ–è¯·æ±‚çº¿ç¨‹é‡Œ <code>SecurityContextHolder.getContext().getAuthentication()</code>æ¥è·å–ç”¨æˆ·æˆæƒä¿¡æ¯ã€‚<code>@AuthenticationPrincipal</code>&nbsp;æ³¨è§£å¯¹åº” UserDetails å¯¹è±¡ï¼Œ<code>@CurrentSecurityContext</code>&nbsp;æ³¨è§£å¯¹åº” SecurityContext å¯¹è±¡ã€‚</strong></font></p><h4 id="PART5-éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°"><a href="#PART5-éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°" class="headerlink" title="PART5. éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°"></a>PART5. éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°</h4><p>éªŒè¯æˆåŠŸæˆ–å¤±è´¥åçš„å¤„ç†æ–¹å¼ï¼Œä¸€èˆ¬æœ‰å‡ ç§ï¼Œé‡å®šå‘é¦–é¡µæˆ–ç™»å½•é¡µé¢ï¼Œæ³¨å†Œæˆ–æ’¤é”€ JWT tokenï¼Œæ”¾è¡Œåé¢çš„ filter æˆ– Controllerã€‚<span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è€Œ JWT token ç­¾å‘æ³¨é”€çš„åŠŸèƒ½ï¼Œåªéœ€å®ç° <code>AuthenticationSuccessHandler</code> å’Œ <code>AuthenticationFailureHandler</code> ä¸¤ä¸ªæ¥å£ã€‚</p><h4 id="PART6-ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…"><a href="#PART6-ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…" class="headerlink" title="PART6. ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…"></a>PART6. ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…</h4><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é…ç½®ç»„è£…é€šè¿‡ç»§æ‰¿ <code>WebSecurityConfigurerAdapter</code> ç±»ï¼Œè¦†ç›– <code>init(WebSecurity builder)</code> æ–¹æ³•å®Œæˆ Filterã€providerã€handler ç­‰æ³¨å…¥ã€‚æ­¤å¤„ä¸å¤šè¯´ï¼Œçœ‹ä»£ç åº”è¯¥å°±æ‡‚äº†ã€‚</p><p>ä»¥ä¸‹ä»¥ CAS + OAuth2 ç»„åˆæ–¹å¼çš„å®Œæ•´ä»£ç ç‰‡æ®µ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TuscCasTicketValidator</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCasProtocolUrlBasedTicketValidator</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token class-name">TuscCasTicketValidator</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> casServerUrlPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// è®¾å®š CAS server</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>casServerUrlPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getUrlSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// éªŒè¯è·¯å¾„</span>      <span class="token keyword">return</span> <span class="token string">"validate"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token class-name">Assertion</span> <span class="token function">parseResponseFromServer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> response<span class="token punctuation">)</span>      <span class="token keyword">throws</span> <span class="token class-name">TicketValidationException</span> <span class="token punctuation">{</span>        <span class="token comment">// åˆ¤å®šéªŒè¯é€šè¿‡æˆæœåŠç»“æœåé¦ˆ</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// bearer éªŒè¯éœ€è¦</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieBearerTokenResolver</span> <span class="token keyword">implements</span> <span class="token class-name">BearerTokenResolver</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COOKIE_NAME_BEARER</span> <span class="token operator">=</span> <span class="token string">"bearer"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>cookie <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsAnyIgnoreCase</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">COOKIE_NAME_BEARER</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Cookie</span><span class="token operator">::</span><span class="token function">getValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MakeTokenHandler</span> <span class="token keyword">extends</span> <span class="token class-name">FilterAuthSuccessHandler</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>    <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>    <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">//...</span>    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> jwtEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>      <span class="token class-name">JwtEncoderParameters</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>jwsHeader<span class="token punctuation">,</span> jwtClaimsSetBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">String</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>cookieTimeoutSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>cookie<span class="token punctuation">.</span><span class="token function">setHttpOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultAuthFailHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span><span class="token punctuation">,</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>    <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>    <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">InvalidBearerTokenException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/plain;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•å·²è¿‡æœŸæˆ–è¢«æ¨å‡ºï¼Œéœ€è¦é‡æ–°ç™»å½•éªŒè¯ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// è®°ä½ç™»å‡ºæˆ–è®¿é—®å‰çš„åœ°å€</span>    response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•é¡µé¢åœ°å€"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// é‡æ–°ç­¾å‘ token</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtRenewFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>                                  <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>                                  <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>     <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">//...</span>    <span class="token class-name">String</span> bearerToken <span class="token operator">=</span> bearerTokenResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> jwtDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>bearerToken<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Instant</span> expiresAt <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getExpiresAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>expiresAt<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> ticket <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getClaimAsString</span><span class="token punctuation">(</span><span class="token string">"st"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                casTicketValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> serviceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">renewJwt</span><span class="token punctuation">(</span>jwt<span class="token punctuation">,</span> response<span class="token punctuation">,</span> jwtEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TicketValidationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment">//...</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@EnableWebSecurity</span><span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">LoginBaseConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">MakeTokenHandler</span> makeTokenHandler    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">DefaultAuthFailHandler</span> defaultAuthFailHandler<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">WebAuthenticationDetails</span><span class="token punctuation">&gt;</span></span> webAuthenticationDetailsSource<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxxx}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> applicationServerUrl<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxxx}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token class-name">CASServerUrl</span><span class="token punctuation">;</span>    <span class="token comment">// 12h</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${login.jwt.cookieTimeoutSecond:43200}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> cookieTimeoutSecond<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${login.jwt.casDurationSecond:600}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> casDurationSecond<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">BearerTokenAuthenticationFilter</span> bearerTokenFilter <span class="token operator">=</span>           <span class="token keyword">new</span> <span class="token class-name">BearerTokenAuthenticationFilter</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>      bearerTokenFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>        dzdaWebAuthenticationDetailsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BearerTokenResolver</span> bearerTokenResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CookieBearerTokenResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bearerTokenFilter<span class="token punctuation">.</span><span class="token function">setBearerTokenResolver</span><span class="token punctuation">(</span>makeTokenHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        bearerTokenFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>defaultAuthFailHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">AbstractAuthenticationProcessingFilter</span> casAuthenticationFilter          <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>defaultAuthFailHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setFilterProcessesUrl</span><span class="token punctuation">(</span><span class="token string">"/login/cas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>        dzdaWebAuthenticationDetailsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>      casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span>        dzdaCasAuthenticationSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">JwtRenewFilter</span> jwtRenewFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtRenewFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>          <span class="token function">setBearerTokenResolver</span><span class="token punctuation">(</span>bearerTokenResolver<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setCasTicketValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TuscCasTicketValidator</span><span class="token punctuation">(</span>casServerUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setServiceUrl</span><span class="token punctuation">(</span>applicationServerUrl<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setCookieTimeoutSecond</span><span class="token punctuation">(</span>cookieTimeoutSecond<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setCasDurationSecond</span><span class="token punctuation">(</span>casDurationSecond<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setLocalDurationSecond</span><span class="token punctuation">(</span>localDurationSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>        httpSecurity<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>casAuthenticationFilter<span class="token punctuation">,</span>                                  <span class="token class-name">X509AuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>jwtRenewFilter<span class="token punctuation">,</span> <span class="token class-name">BearerTokenAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>bearerTokenFilter<span class="token punctuation">,</span> <span class="token class-name">X509AuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">,</span> <span class="token string">"JESSIONID"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">invalidateHttpSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"logoutroute"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultAuthFailHandler</span><span class="token punctuation">(</span>                  applicationServerUrl<span class="token punctuation">,</span> casServerUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">addSecurityFilterChainBuilder</span><span class="token punctuation">(</span>httpSecurity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">CorsConfigurationSource</span> <span class="token function">corsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">CorsConfiguration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorsConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configuration<span class="token punctuation">.</span><span class="token function">setAllowedOrigins</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configuration<span class="token punctuation">.</span><span class="token function">setAllowedMethods</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configuration<span class="token punctuation">.</span><span class="token function">setAllowedHeaders</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UrlBasedCorsConfigurationSource</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlBasedCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        source<span class="token punctuation">.</span><span class="token function">registerCorsConfiguration</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> source<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">AuthenticationProvider</span> <span class="token function">casAuthenticationProvider</span><span class="token punctuation">(</span><span class="token class-name">LoginServiceImpl</span> loginService<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">CasAuthenticationProvider</span> casAuthenticationProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setAuthenticationUserDetailsService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XXXCasUserDetailsService</span><span class="token punctuation">(</span>loginService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setTicketValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TuscCasTicketValidator</span><span class="token punctuation">(</span>ssoUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ServiceProperties</span> serviceProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serviceProperties<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>applicationServerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setServiceProperties</span><span class="token punctuation">(</span>serviceProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">"casAuthenticationProvider"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> casAuthenticationProvider<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><span class="github-emoji"><span>ğŸ”†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <font color="blue"><strong>éœ€è¦æ˜ç¡® Filter çš„å…ˆåé¡ºåºï¼Œé¡ºåºä¸å¯¹å¯èƒ½ä¼šé€ æˆéªŒè¯ bugï¼Œæ¯”å¦‚ renewFilter åº”è¯¥åœ¨ BearerTokenAuthenticationFilter ä¹‹å‰ã€‚å¦åˆ™ renewFilter å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚</strong></font></p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring-security </tag>
            
            <tag> cas </tag>
            
            <tag> oauth2 </tag>
            
            <tag> pre-security </tag>
            
            <tag> code </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-securityä¸­é‡è§çš„è€—æ—¶å°å‘</title>
      <link href="/2023/04/10/spring-security-zhong-yu-jian-de-hao-shi-xiao-keng/"/>
      <url>/2023/04/10/spring-security-zhong-yu-jian-de-hao-shi-xiao-keng/</url>
      
        <content type="html"><![CDATA[<h2 id="pear-èƒŒæ™¯"><a href="#pear-èƒŒæ™¯" class="headerlink" title=":pear: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f350.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>å®¢æˆ·ç°åœºè¿ç»´åŒäº‹åé¦ˆæŸç³»ç»Ÿè¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åã€å¯†ç åï¼Œæ— æ³•è¿›å…¥ç³»ç»Ÿé¦–é¡µã€‚åœ°å€æ ä¸­åœ°å€å´åœ¨ SSO server å’Œç³»ç»Ÿåœ°å€ä¹‹é—´æ¥å›è·³è½¬ï¼Œç³»ç»Ÿæ—¥å¿—ä¸­ä¹Ÿæ²¡æœ‰ç›¸å…³çš„æ—¥å¿—æä¾›çº¿ç´¢ã€‚å¬åˆ°è¿™é‡Œå°±æ™“å¾—ï¼Œä¸æ˜¯ä¸€ä¸ªè¿ç»´åŒå­¦åœ¨ç™½ç›’çš„æƒ…å†µä¸‹ï¼Œèƒ½è§£å†³çš„é—®é¢˜äº†ã€‚</p><h2 id="orange-é—®é¢˜è·Ÿè¿›"><a href="#orange-é—®é¢˜è·Ÿè¿›" class="headerlink" title=":orange: é—®é¢˜è·Ÿè¿›"></a><span class="github-emoji"><span>ğŸŠ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜è·Ÿè¿›</h2><h3 id="one-æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€"><a href="#one-æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€" class="headerlink" title=":one: æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€"></a><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€</h3><p>è®©è¿ç»´åŒå­¦ F12 æ‰“å¼€ chrome æµè§ˆå™¨å¼€å‘è€…æ¨¡å¼ï¼Œåˆ‡æ¢ Network é¡µç­¾å‹¾é€‰ <code>Preserve log</code>ï¼ˆä¿ç•™è¯·æ±‚æ—¥å¿—ï¼‰ï¼Œå°±èƒ½è®°å½•æµè§ˆå™¨ã€æ¥å›è·³è½¬ã€ç½‘ç»œè¯·æ±‚ã€‚</p><pre class="line-numbers language-none"><code class="language-none">${åº”ç”¨}/login/cas?st=xxxxx${SSO-server}/login?service=encodeURIComponent(${åº”ç”¨}/login/cas)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å°±æ˜¯è¿™ä¸¤ä¸ªåœ°å€ã€æ¥å›è·³è½¬ã€ã€‚ä»è¿™é‡Œèƒ½å¾—åšå‡ºå¦‚ä¸‹æ¨æ–­:</p><ol><li>SSO server æœåŠ¡ä¾æ® cookie ä¸­çš„ TGT éªŒè¯æ˜¯é€šè¿‡çš„ã€‚å¦åˆ™ï¼Œæ­¤å¤„å±•ç¤ºçš„å°±æ˜¯ç™»å½•é¡µé¢ã€‚</li><li>åº”ç”¨ <code>/login/cas</code> è¯·æ±‚ï¼Œé€šè¿‡åå°è°ƒç”¨ SSO server çš„ validate æ¥å£å®Œæˆ stï¼ˆ<code>service ticket</code>ï¼‰éªŒè¯ï¼Œæ˜¾ç„¶è¿™é‡Œæ˜¯ä¸é€šè¿‡çš„ã€‚å¦åˆ™ï¼Œæ­¤å¤„å±•ç¤ºçš„å°±æ˜¯åº”ç”¨é¦–é¡µé¢ã€‚</li></ol><p>æ€»ç»“ï¼Œè¯´æ˜é—®é¢˜å‡ºåœ¨åº”ç”¨ <code>/login/cas</code> è¯·æ±‚è®¤è¯ä¸­ï¼Œè™½ç„¶ä¸æ•¢ç›¸ä¿¡ä½†ã€äº‹å®èƒœäºé›„è¾©ã€ã€‚</p><h3 id="two-åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› "><a href="#two-åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› " class="headerlink" title=":two: åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› "></a><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› </h3><p>ä¸ºä»€ä¹ˆä¸Šé¢è¯´ <code>/login/cas</code> ä¸æ•¢ç›¸ä¿¡æœ‰é—®é¢˜ï¼Œå› ä¸ºåº”ç”¨åç«¯ä½¿ç”¨ <code>spring-security-cas</code> ç»„ä»¶ï¼Œè€Œè¿™ä¸ªç»„ä»¶æ€•æ˜¯æœ‰æˆåƒä¸Šä¸‡çš„é¡¹ç›®ä½¿ç”¨å·²ç»æ˜¯å¾ˆä¼˜ç§€çš„ç»„ä»¶ï¼Œéš¾é“è¢«æˆ‘ç¢°è§å¼€æºçš„ BUG äº†ï¼Ÿ</p><p><code>spring-security-cas</code> ç»„ä»¶ï¼Œæœ‰å‡ ä¸ªé‡è¦ç»„æˆç±»ï¼š</p><ul><li><code>CasAuthenticationFilter</code>ï¼š<code>CAS</code> éªŒè¯è¿‡æ»¤å™¨ï¼Œ<code>/login/cas</code> è¯·æ±‚éªŒè¯å…¥å£ã€‚å…¶ä¸­ï¼Œ <code>attemptAuthentication()</code> å…¶ä¸­åŒ…å«éªŒè¯æ–¹æ³• ï¼ŒéªŒè¯ä¸é€šè¿‡åˆ™æŠ›å‡º <code>AuthenticationException</code>ã€‚<code>successfulAuthentication</code> åˆ™æ˜¯éªŒè¯é€šè¿‡åæ‰§è¡Œé€»è¾‘ï¼Œå¯ä»¥æ˜¯é‡å®šå‘åˆ°é¦–é¡µï¼Œæˆ–æ˜¯ç»§ç»­è®¿é—®åç»­é€»è¾‘ã€‚<code>unsuccessfulAuthentication</code> åˆ™æ˜¯éªŒè¯å¤±è´¥åæ‰§è¡Œé€»è¾‘ï¼Œæ˜¯é‡å®šå‘åˆ° <code>/login</code> ç™»å½•è¯·æ±‚ã€‚</li><li><code>CasAuthenticationProvider</code>ï¼šçœŸæ­£çš„ CAS éªŒè¯å…¥å£ï¼Œä¸»è¦å®Œæˆ CAS éªŒè¯å’Œç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…ã€‚</li><li><code>AbstractCasProtocolUrlBasedTicketValidator</code>ï¼šè¢« <code>CasAuthenticationProvider</code> ç±»è°ƒç”¨ï¼Œå®Œæˆè°ƒç”¨ SSO server validate æ¥å£éªŒè¯<code>serviceTicket</code>ã€‚</li><li><code>AbstractCasAssertionUserDetailsService</code>ï¼šè¢« <code>CasAuthenticationProvider</code> ç±»è°ƒç”¨ï¼Œå®Œæˆç”¨æˆ·åŠæƒé™ä¿¡æ¯çš„è£…è½½ã€‚</li></ul><p>å…³é”®ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ä¼šå¯¼è‡´è¿›å…¥ <code>unsuccessfulAuthentication()</code> é€»è¾‘çš„ï¼Œæ˜¯æŠ›å‡º <code>TicketValidationException</code> å¼‚å¸¸ã€‚é‚£ä¹Ÿå°±æ˜¯ <code>ticketValidator.validate()</code> ã€ <code>authenticationUserDetailsService.loadUserDetails()</code> æˆ– <code>userDetailsChecker.check()</code> é€»è¾‘ç‚¹æŠ›å‡ºå¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CasAuthenticationProvider</span><span class="token keyword">private</span> <span class="token class-name">CasAuthenticationToken</span> <span class="token function">authenticateNow</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name">Assertion</span> assertion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticketValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getServiceUrl</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token function">loadUserByAssertion</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsChecker<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> userDetails<span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authoritiesMapper<span class="token punctuation">.</span><span class="token function">mapAuthorities</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TicketValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>getMessage<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByAssertion</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> <span class="token class-name">CasAssertionAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAssertionAuthenticationToken</span><span class="token punctuation">(</span>assertion<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserDetails</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåï¼Œç°åœºé€šè¿‡ <code>arthas</code> å·¥å…·ä»£ç  <code>watch</code> å‘½ä»¤ï¼Œç›‘å¬ä»£ç æ˜ç¡®å¼‚å¸¸æŠ›å‡ºä½ç½®ã€‚æœ€åï¼Œæ˜¯åœ¨ <code>authenticationUserDetailsService.loadUserDetails()</code> åº”ç”¨è‡ªå·±å®ç°ç±»ä¸ŠæŠ›å‡ºäº†  <code>UsernameNotFoundException</code> å¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserDetails</span><span class="token punctuation">(</span><span class="token class-name">CasAssertionAuthenticationToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token function">getPrincipalAttributes</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} æ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"æ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> loginId <span class="token operator">=</span> <span class="token function">getLoginId</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} æ²¡æœ‰ç™»å½•æ ‡è¯†"</span><span class="token punctuation">,</span> loginId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%sæ²¡æœ‰ç™»å½•æ ‡è¯†"</span><span class="token punctuation">,</span> loginId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> corpId <span class="token operator">=</span> <span class="token function">getCorpId</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UserDO</span> userDO <span class="token operator">=</span> <span class="token function">loadUserDO</span><span class="token punctuation">(</span>loginId<span class="token punctuation">,</span> corpId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorities <span class="token operator">=</span> <span class="token function">getDefaultUserAuthorities</span><span class="token punctuation">(</span>userDO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonUserDetails</span><span class="token punctuation">(</span>userDO<span class="token punctuation">.</span><span class="token function">getLoginId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grantedAuthorities<span class="token punctuation">,</span> userDO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="three-åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ"><a href="#three-åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ" class="headerlink" title=":three: åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ"></a><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ</h3><p>æœ€ç»ˆï¼Œè¿˜æ˜¯è¦å›åˆ°æ–‡é¦–ã€ç ´ã€ä»£ç æœ‰å¼‚å¸¸ï¼Œæ—¥å¿—æ–‡ä»¶å´æ— è®°å½•é—®é¢˜ã€‚å›å¤´ç»†çœ‹ <code>AbstractAuthenticationProcessingFilter.unsuccessfulAuthentication()</code> æ–¹æ³•ï¼Œå¼‚å¸¸æ—¥å¿—æ‰“å°å±…ç„¶æ˜¯  trace çº§åˆ«ï¼Œç°åœºæ—¥å¿—çº§åˆ«é…ç½®çš„ error çº§åˆ«ï¼Œæ•…ä»£ç æœ‰å¼‚å¸¸ï¼Œæ—¥å¿—æ–‡ä»¶å´æ— è®°å½•é—®é¢˜ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Failed to process authentication request"</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Cleared SecurityContextHolder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Handling authentication failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="banana-æœªæåŠçš„åŸºç¡€çŸ¥è¯†"><a href="#banana-æœªæåŠçš„åŸºç¡€çŸ¥è¯†" class="headerlink" title=":banana: æœªæåŠçš„åŸºç¡€çŸ¥è¯†"></a><span class="github-emoji"><span>ğŸŒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœªæåŠçš„åŸºç¡€çŸ¥è¯†</h3><ul><li><a href="https://apereo.github.io/cas/6.6.x/index.html">CAS å®˜ç½‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring-security </tag>
            
            <tag> cas </tag>
            
            <tag> relogin </tag>
            
            <tag> code </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>npm-link VUEX watch æ€ä¹ˆä¸ç”Ÿæ•ˆ</title>
      <link href="/2023/04/02/npm-link-vuex-watch-zen-me-bu-sheng-xiao/"/>
      <url>/2023/04/02/npm-link-vuex-watch-zen-me-bu-sheng-xiao/</url>
      
        <content type="html"><![CDATA[<h2 id="cat-èƒŒæ™¯"><a href="#cat-èƒŒæ™¯" class="headerlink" title=":cat: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ±</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>å‰ç«¯é¡¹ç›® <code>package.json</code> ç›¸å½“äºåç«¯ maven é¡¹ç›® pom.xml æ–‡ä»¶ç®¡ç†é¡¹ç›®ç»„ä»¶ä¾èµ–ã€‚éœ€è¦èµ° <code>npm install --save-dev xxxx</code> å¼•å…¥æ–¹å¼ã€‚<br>å¯¹äºé¡¹ç›®ä¸­å­˜åœ¨å¤šé¡¹ç›®å…±ç”¨çš„å‰ç«¯ç»„ä»¶å¼€å‘ï¼Œä¸å¸Œæœ›æ¯æ¬¡ä¿®æ”¹ä»¥å‘å¸ƒç‰ˆæœ¬å† <code>npm install</code> ä¸‹è½½åŒ…è°ƒè¯•ã€‚<br>å¯ä»¥é€‰ç”¨ <a href="https://docs.npmjs.com/cli/v9/commands/npm-link/">npm-link æ–¹å¼</a> å°†å‰ç«¯ç»„ä»¶ link åˆ°åœºæ™¯ UI ä¸­å®Œæˆå¼€å‘/è”è°ƒ/bug ä¿®æ”¹å·¥ä½œã€‚<br>æœ€è¿‘å‰ç«¯åŒå­¦å‘ç°ï¼Œnpm-link æ–¹å¼å¼•å…¥çš„å‰ç«¯ç»„ä»¶ä¸­å¼•å…¥ VUEXï¼Œä¸”å¯¹ store å±æ€§ watch äº‹ä»¶æ˜¯ä¸ä¼šç”Ÿæ•ˆã€‚<br>ä¸ªäººè§‰å¾—ä¸åº”è¯¥ï¼Œnpm-link å°±ç®€å•çš„å°†å‰ç«¯ç»„ä»¶ link åˆ° UIï¼Œå¯ä»¥è¯´æ˜¯<strong>åŸå°</strong>ä¸åŠ¨ï¼ŒåŒ…æ‹¬ <code>node_modules</code>ï¼ˆæœ€åå‘ç°ä¹Ÿååœ¨æ­¤å¤„ï¼‰ã€‚<br>æœç´¢ google å’Œç™¾åº¦éƒ½æ²¡æœ‰æœ‰æ•ˆçš„å¸–å­ã€‚</p><h2 id="tiger-é—®é¢˜è·Ÿè¿›"><a href="#tiger-é—®é¢˜è·Ÿè¿›" class="headerlink" title=":tiger: é—®é¢˜è·Ÿè¿›"></a><span class="github-emoji"><span>ğŸ¯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜è·Ÿè¿›</h2><h3 id="one-ææ‡‚-VUEX-store-çš„-watch-åŸç†"><a href="#one-ææ‡‚-VUEX-store-çš„-watch-åŸç†" class="headerlink" title=":one: ææ‡‚ VUEX store çš„ watch åŸç†"></a><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ææ‡‚ VUEX store çš„ watch åŸç†</h3><p><strong>store watch çš„åˆå§‹åŒ–</strong></p><p><code>vue</code> åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ <code>initState</code> å…¶ä¸­ï¼Œä¼šé’ˆå¯¹æœ¬ <code>vue</code> çš„ watch å®Œæˆ <code>initWatch</code> åˆå§‹åŒ–ã€‚å…¶ä¸­åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>Vue.prototype.$watch</code> (æ³¨æ„ï¼Œæ­¤å¤„åˆå§‹åŒ–ç”¨åˆ°çš„è¿˜æ˜¯ vue åŸå‹æ–¹æ³• $watch) å…¶ä¸­ä¼šè§¦å‘ä¸€æ¬¡ <code>watch handler</code> æ–¹æ³•ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token string">"callback for immediate watcher \""</span> <span class="token operator">+</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">;</span>      <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">invokeWithErrorHandling</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">[</span>watcher<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ <code>new Watcher</code> å¯¹è±¡ç¬¬ä¸€æ¬¡è·å– <code>watcher.value</code> æ—¶ï¼Œè§¦å‘ <code>watcher</code> å¯¹è±¡çš„ Dep ä¾èµ–ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">Watcher</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Watcher</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>  expOrFn<span class="token punctuation">,</span>  cb<span class="token punctuation">,</span>  options<span class="token punctuation">,</span>  isRenderWatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// éšè—ä¸éœ€è¦å…³æ³¨çš„ä»£ç </span>  <span class="token comment">// parse expression for getter</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop<span class="token punctuation">;</span>    <span class="token comment">// éšè—ä¸éœ€è¦å…³æ³¨çš„ä»£ç </span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy    <span class="token operator">?</span> <span class="token keyword">undefined</span>    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æŒ‡å®š Dep.target ä¸º watcher</span>  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> value<span class="token punctuation">;</span>  <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"getter for watcher \""</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> e    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// é€€å‡º Dep.target çš„æŒ‡å‘  </span>    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// è§¦å‘çœŸå® get æ—¶ï¼Œå®Œæˆäº† watcher çš„ Dep ä¾èµ–</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¿½ç•¥ set</span>    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>                childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// å®Œæˆ Dep.target æ·»åŠ ä¾èµ–ï¼Œæ­¤æ—¶çš„ Dep.target æ˜¯ watther æœ¬èº«ã€‚è€Œ this ä¸º store çš„ dep å¯¹è±¡ã€‚</span><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">depend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// watcher å®Œæˆ addDepæ—¶ï¼Œé™¤äº†ç»™è‡ªèº« depIdå’Œ deps åŠ ä¸Š store depå¯¹è±¡ï¼ŒåŒæ ·æŠŠè‡ªèº«watcherä½œä¸º store dep çš„å­å…³è”</span><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addDep</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Dep.prototype.depend</code> å®Œæˆè°ƒç”¨æ—¶ï¼Œstore watcher å·²ç»å®Œæˆä¸ store çš„ dep å¯¹è±¡çš„ç»‘å®šè¿‡ç¨‹ã€‚ä»¥ä¸Š <code>store watch init</code> çš„é“¾è·¯å¦‚ä¸‹ï¼Œ</p><pre class="line-numbers language-none"><code class="language-none">depend (vue.common.dev.js:726)reactiveGetter (vue.common.dev.js:1038)prototypeAccessors$1.state.get (vuex.esm.js:438)ï¼ˆåŒ¿åï¼‰ (vue.common.dev.js:514)get (vue.common.dev.js:4490)Watcher (vue.common.dev.js:4479)Vue.$watch (vue.common.dev.js:4953)createWatcher (vue.common.dev.js:4913)initWatch (vue.common.dev.js:4895)initState (vue.common.dev.js:4656)Vue._init (vue.common.dev.js:5010)VueComponent (vue.common.dev.js:5157)createComponentInstanceForVnode (vue.common.dev.js:3307)init (vue.common.dev.js:3136)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>store watch çš„è§¦å‘</strong></p><p><code>this.$store.commit('xxx', xxxx)</code> è§¦å‘æ—¶ï¼Œåœ¨æ”¹å€¼çš„åŒäº‹ä¼šè§¦å‘æœ¬ store Dep çš„ notify ï¼ˆé€šçŸ¥ï¼‰ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¿½ç•¥ get</span>    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>        <span class="token comment">/* eslint-disable no-self-compare */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment">/* eslint-enable no-self-compare */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// #7981: for accessor properties without setter</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// è§¦å‘é€šçŸ¥</span>        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">notify</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¿½ç•¥ä¸é‡è¦ä»£ç </span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// watcher update</span>    subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ <code>notify</code> çš„ä¸­éå† Dep çš„ subs å¹¶æ›´æ–°ï¼Œæ­¤å¤„å›æƒ³ watcher åˆå§‹åŒ–æ—¶ <code>watcher#addDep</code> å¯è§ subs æ˜¯åŒ…å« watcher çš„ï¼Œæ‰€ä»¥ store å±æ€§å˜åŒ–ä¹Ÿå°±èƒ½é€šçŸ¥åˆ° watcher äº†ã€‚<code>store watch notify</code> çš„é“¾è·¯å¦‚ä¸‹ï¼Œ</p><pre class="line-numbers language-none"><code class="language-none">handler (list_left.vue:411)invokeWithErrorHandling (vue.common.dev.js:1868)run (vue.common.dev.js:4579)flushSchedulerQueue (vue.common.dev.js:4323)ï¼ˆåŒ¿åï¼‰ (vue.common.dev.js:1994)flushCallbacks (vue.common.dev.js:1920)Promise.thenï¼ˆå¼‚æ­¥ï¼‰timerFunc (vue.common.dev.js:1947)nextTick (vue.common.dev.js:2004)queueWatcher (vue.common.dev.js:4415)update (vue.common.dev.js:4555)notify (vue.common.dev.js:741)reactiveSetter (vue.common.dev.js:1066)proxySetter (vue.common.dev.js:4639)changeAjlb (nav.vue:431)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šï¼Œ<strong>watcher init</strong> å’Œ <strong>watcher è§¦å‘</strong> æ€»ç»“æ¥è¯´å°±æ˜¯è¿™ä¸ªå›¾ã€‚</p><p><img src="/images/2023/npm_link_vuex_watch/link.png"></p><h3 id="two-ä¸ºå•¥-npm-link-ä¸èƒ½è§¦å‘-store-watch"><a href="#two-ä¸ºå•¥-npm-link-ä¸èƒ½è§¦å‘-store-watch" class="headerlink" title=":two: ä¸ºå•¥ npm-link ä¸èƒ½è§¦å‘ store watch"></a><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸ºå•¥ npm-link ä¸èƒ½è§¦å‘ store watch</h3><p>ææ‡‚äº†ï¼Œstore watcher è¿™æ‘Šå­äº‹æƒ…ï¼Œæ’æŸ¥å°±ç›¸å¯¹ç®€å•äº†ã€‚**æŠ“ä½ 1 ä¸ªä½ç½®å³å¯ï¼Œåœ¨ <code>initWatcher</code> çš„æ—¶å€™æ˜¯å¦å®Œæˆäº† <code>Watcher#addDep</code>ã€‚<br>** ç»“æœå‘ç°ï¼Œåœ¨ <code>Watcher.prototype.get</code>æ–¹æ³•ä¸­ <code>pushTarget(this)</code>  Dep æŒ‡å‘ <code>webpack://${web_app}/./node_nodules/vue/dist/vue,common.dev.js</code>ã€‚<br>è€Œåœ¨ <code>Object.defineProperty#get</code> æ–¹æ³•ä¸­ <code>Dep.target</code> ä»£ç  Dep æŒ‡å‘<br><code>webpack://${web_app}/${web_component}/node_modules/vue/dist/vue.common.dev.js</code>ã€‚<br>æ‘†æ˜ Dep å·²ç»ä¸æ˜¯åŸæ¥çš„ Dep äº†ï¼Œå¯¼è‡´ store Dep ä¸ watcher æ²¡åŠ æˆï¼Œå¯¼è‡´ store watcher ä¸è¢«è§¦å‘ã€‚</p><p><strong>æ­¤æ—¶ï¼Œæˆ‘å›æƒ³å¹¸å¥½æ˜¯ä¸ªå¥³ç”Ÿï¼Œä¸ç„¶æˆ‘å°±å»æ¥¼ä¸‹æŠ½æ ¹çƒŸäº†ã€‚è¿™ä¸ªåç«¯ jar åŒ…å†²çªå¯å¤ªåƒäº†ã€‚</strong></p><h3 id="three-å¦‚ä½•è§£å†³é—®é¢˜"><a href="#three-å¦‚ä½•è§£å†³é—®é¢˜" class="headerlink" title=":three: å¦‚ä½•è§£å†³é—®é¢˜"></a><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚ä½•è§£å†³é—®é¢˜</h3><p>åœ¨åœºæ™¯å±‚å°† vue å®šä¹‰æˆ window å…¨å±€å¯¹è±¡ã€‚åœ¨ç»„ä»¶å†…ä½¿ç”¨ <code>window.Vue</code> è£…è½½  vuexã€‚è‡ªæ­¤ï¼Œé—®é¢˜ç»ˆç»“ã€‚ä¿®æ”¹æ–¹å¼ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// åœ¨å‰ç«¯åº”ç”¨å…¥å£æ–‡ä»¶ä¸­</span><span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span><span class="token keyword">import</span> vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>Vue <span class="token operator">=</span> vue<span class="token punctuation">;</span>vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åœ¨è¢«å¼•ç”¨çš„ç»„ä»¶å…¥å£æ–‡ä»¶ä¸­</span><span class="token keyword">import</span> vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rabbit-æ€»ç»“"><a href="#rabbit-æ€»ç»“" class="headerlink" title=":rabbit: æ€»ç»“"></a><span class="github-emoji"><span>ğŸ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f430.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ€»ç»“</h2><ol><li>npm-link å›ºç„¶è§£å†³äº†ä¸ç”¨è€æ”¹ç»„ä»¶ç‰ˆæœ¬å·è°ƒè¯•çš„é—®é¢˜ï¼Œä½†å› ä¸º npm-link çš„ç»„ä»¶ä¼šä½¿ç”¨è‡ªèº«çš„ node_modules å¯¼è‡´ï¼Œéƒ¨åˆ†åŸæœ¬æœŸæœ›ä¸åœºæ™¯ ui å…±äº«çš„å¯¹è±¡å¯èƒ½ä¸å…±äº«ã€‚</li><li>å‰ç«¯ä»£ç æ’æŸ¥ç¡®æ˜¯ä¸å¦‚åç«¯ä»£ç æ’æŸ¥æ–¹ä¾¿ï¼Œå•¥ <code>console.warn</code> éƒ½ä¹ˆå¾—è€—æ—¶é•¿ã€‚</li></ol><h2 id="sheep-é™„ä»¶"><a href="#sheep-é™„ä»¶" class="headerlink" title=":sheep: é™„ä»¶"></a><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é™„ä»¶</h2><ul><li><a href="https://segmentfault.com/a/1190000016208088">Vueæºç è§£è¯»ä¹‹Dep,Observerå’ŒWatcher</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> npm-link </tag>
            
            <tag> code </tag>
            
            <tag> npm </tag>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlab ä¸Šå’Œé¡¹ç›®å¤§ä»“åº“è¯´å†è§</title>
      <link href="/2023/03/27/gitlab-shang-he-xiang-mu-da-cang-ku-shuo-zai-jian/"/>
      <url>/2023/03/27/gitlab-shang-he-xiang-mu-da-cang-ku-shuo-zai-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="cat-èƒŒæ™¯"><a href="#cat-èƒŒæ™¯" class="headerlink" title=":cat: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ±</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p><code>git clone</code> é¡¹ç›®è€—æ—¶å¾ˆé•¿ã€‚åŸå› ï¼Œç½‘é€Ÿæ…¢æˆ–æ˜¯ä»£ç ä»“åº“æ–‡ä»¶å¾ˆå¤§(n+ G)ã€‚æœ¬ç¯‡æ–‡ç« å°±è®²è¿°å¦‚ä½•ç»™ <code>gitlab</code> ä»£ç ä»“åº“å‡è´Ÿã€‚</p><h3 id="dog-åŸºç¡€çŸ¥è¯†"><a href="#dog-åŸºç¡€çŸ¥è¯†" class="headerlink" title=":dog: åŸºç¡€çŸ¥è¯†"></a><span class="github-emoji"><span>ğŸ¶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f436.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŸºç¡€çŸ¥è¯†</h3><p>é¡¹ç›®åœ¨ gitlab ä¸­æ˜¾ç¤ºçš„ä»“åº“å¤§å° = é¡¹ç›®æ–‡ä»¶æ€»å¤§å° + <code>.git</code> ï¼ˆéšè—ï¼‰ç›®å½•ä¸‹æ–‡ä»¶å¤§å°ã€‚è¯·è®¤çœŸå…³æ³¨ä½ é¡¹ç›®ç›®å½•æ–‡ä»¶å¤§å°ï¼ˆwindows å¯ä»¥ç”¨ <a href="https://www.jam-software.com/treesize_free">treesize free</a> / <a href="http://www.uderzo.it/main_products/space_sniffer/download_alt.html">SpaceSniffer</a> å·¥å…·ï¼Œlinux å¯ä»¥ç”¨å‘½ä»¤ <code>du -h â€“max-depth=1 *</code>ï¼Œmac å‘½ä»¤ <code>du -h -d 1 *</code> ï¼‰ï¼Œä¸€èˆ¬ <code>.git</code> ç›®å½•ä¸‹æ–‡ä»¶å¤§å° &gt;= é¡¹ç›®æ–‡ä»¶å¤§å°ã€‚æ„å‘³ç€ï¼Œé¡¹ç›®æ•´ä½“ä¸‹è½½ç©ºé—´å ç”¨ &gt;= 2 * é¡¹ç›®æ–‡ä»¶å¤§å°ã€‚æ‰€ä»¥ï¼Œå¦‚æœé¡¹ç›®ä¸­åŒ…å«æ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œä¾‹å¦‚è§†é¢‘ï¼Œé«˜æ¸…ç…§ç‰‡ç­‰ï¼ŒæŠŠ gitlab å½“åšäº†<strong>å…±äº«å¤‡ä»½å­˜å‚¨ç©ºé—´</strong>æ˜¯é¡¹ç›®æ–‡ä»¶å¤§çš„ç½ªé­ç¥¸æ‰‹ã€‚æ‰€ä»¥ï¼Œé¡¹ç›®åˆæœŸä»£ç ä¸€å®šå’Œéœ€æ±‚æ–‡æ¡£åšå‰¥ç¦»ï¼Œé™¤éä½ çš„é¡¹ç›®è¶³å¤Ÿçš„å°ã€‚</p><h3 id="fish-æ‹¯æ•‘-git-ä»“åº“"><a href="#fish-æ‹¯æ•‘-git-ä»“åº“" class="headerlink" title=":fish: æ‹¯æ•‘ git ä»“åº“"></a><span class="github-emoji"><span>ğŸŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ‹¯æ•‘ git ä»“åº“</h3><p>å¯¹äºéœ€æ±‚æ–‡æ¡£ç±»é¡¹ç›®è€Œè¨€ï¼Œå»ºè®®ç”¨ <code>git lfs</code> åšå¤§æ–‡ä»¶ç®¡ç†ï¼ˆæ­¤å¤„ <code>git lfs</code> ä¸åšè¿‡å¤šä»‹ç»ï¼Œè¯·ç‚¹å‡»<a href="https://git-lfs.github.com/">é“¾æ¥</a>äº†è§£ï¼‰ã€‚è¯·å¤šæƒ³æƒ³åé¢åŠ å…¥çš„éœ€æ±‚äººï¼Œç»™ä»–ä»¬çš„åŠ å…¥å‡å°‘ä¸€äº›ç»Šè„šçŸ³ã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä»…ä½¿ç”¨å‡ æ¬¡ï¼Œè¿‡ä¸€ä¸ªæœˆä¹‹ååŸºæœ¬ä¸ç¿»çš„ä¸œè¥¿ã€æ— éœ€ç‰ˆæœ¬ç®¡ç†ã€å†…å®¹è¶…è¿‡ 100 MB çš„è§†é¢‘ï¼Œè¯·æ…é‡æ”¾å…¥ git ä»“åº“</p></blockquote><h3 id="whale-åˆ†æ-git-å¤§ä»“åº“"><a href="#whale-åˆ†æ-git-å¤§ä»“åº“" class="headerlink" title=":whale: åˆ†æ git å¤§ä»“åº“"></a><span class="github-emoji"><span>ğŸ³</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ†æ git å¤§ä»“åº“</h3><ul><li><p>windows ä¸Šä½¿ç”¨ <code>TreeSize Free</code>  çœ‹çœ‹æ–‡ä»¶å¤§å°å æ¯”åˆ†å¸ƒã€‚å‘ç°ï¼Œé¡¹ç›®æœ¬èº«æ–‡ä»¶å¤§å°å¤§çº¦ 900 MB ï¼Œ<code>.git</code> ç›®å½•åƒæ‰ 2.6 GBã€‚åŸå› ï¼Œå…¶å®ä¸Šé¢åŸºç¡€çŸ¥è¯†ç®—æ˜¯è§£ç­”äº†ä¸€éƒ¨åˆ†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒé™„ä»¶<strong>git åŸç†</strong>æ‰¾ç­”æ¡ˆã€‚</p><p><img src="/images/2023/gitlab_bigcodes/directory_image.png"></p></li><li><p>ä½¿ç”¨ <code>git verify-pack</code>  å‘½ä»¤è¿è¡Œ  <code>git verify-pack -v .git/objects/pack/pack-f0fa1a09cd9ebf8874e4ecafa9e56be7816097de.idx|sort -k 3 -n| tail -10</code> ï¼ŒæŸ¥æ‰¾å‡ºæ–‡ä»¶å¤§å°åœ¨å‰ 10 çš„æ–‡ä»¶ hash æ ‡è¯†ã€‚æ³¨æ„ï¼Œwindows ä¸Šè¯·ä½¿ç”¨ <code>git Bash Here </code> è¿è¡Œã€‚</p><p><img src="/images/2023/gitlab_bigcodes/git_xpack.png"></p></li><li><p>ä½¿ç”¨å‘½ä»¤ <code>git rev-list</code> è¿è¡Œ <code>git rev-list --objects --all|grep  hashId </code> å®šä½å¤§æ–‡ä»¶è·¯å¾„ã€‚æ­¤å¤„ï¼Œå¤„ç†æ–‡ä»¶å¤§å°è¶…è¿‡ 100 MBã€‚</p><p><img src="/images/2023/gitlab_bigcodes/directory_file.png"></p></li><li><p>æŒ‰ç…§è·¯å¾„å’Œ <code>git log</code> æŸ¥æ‰¾æäº¤äººï¼Œç¡®å®šæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸”æ˜¯å¦éœ€è¦å­˜åœ¨ã€‚ç¡®å®šéœ€è¦æ¸…ç†çš„ä¸º <code>xxxx.asf</code> å’Œ <code>xxx.asf</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚å·²ç»åˆ é™¤çš„æ–‡ä»¶ï¼Œå´åœ¨æ—¥å¿—é‡Œèƒ½æœç´¢å‡ºæ¥ï¼ŒåŸå› æ˜¯é˜²æ­¢ä½ æ‰§è¡Œ <code>git revert</code> è¿˜åŸåˆ°åˆ é™¤å‰çš„ commitId ç‰ˆæœ¬ã€‚æ‰€ä»¥ï¼Œæ¸…ç†åŸåˆ™å°±æ˜¯éœ€è¦<strong>æ˜ç¡®</strong>å“ªäº›æ–‡ä»¶è¦åˆ é™¤ï¼Œæ²¡æœ‰æœºä¼šè¿˜åŸçš„è¯ï¼Œå°±åˆ é™¤å§ã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœ‰é‡å‘½å/ç§»åŠ¨ç›®å½•éœ€æ±‚ï¼Œè¯·ä½¿ç”¨ <code>git mv</code>  å‘½ä»¤ï¼Œè€Œè¾¾åˆ°ç›®å½•å˜æ›´åŠå‘½ååŠŸèƒ½ã€‚ä¸è¦ä½¿ç”¨ <code>git mv</code> å’Œ <code>git add</code> çš„æ–¹å¼ï¼Œå®Œæˆæ–‡ä»¶é‡å‘½åæˆ–ç§»åŠ¨ç›®å½•ã€‚è¿™æ ·ä¼šé€ æˆæœ‰åˆ é™¤çš„ç”¨ä¸åˆ°çš„è®°å½•ã€‚</p></blockquote></li></ul><h2 id="dolphin-å¦‚ä½•æ¸…ç†"><a href="#dolphin-å¦‚ä½•æ¸…ç†" class="headerlink" title=":dolphin: å¦‚ä½•æ¸…ç†"></a><span class="github-emoji"><span>ğŸ¬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚ä½•æ¸…ç†</h2><blockquote><p>åœ¨æ¸…ç†ä¹‹å‰ï¼Œå»ºè®®æ‰€æœ‰äººçš„åˆ†æ”¯éƒ½ push åˆ°è¿œç«¯ã€‚å¦åˆ™ï¼Œå…¶ä»–äººçš„æ¯æ¬¡çš„ push éƒ½ä¼šè®©ä½ çš„æ¸…ç†éƒ½éœ€è¦é‡æ–°æ¥ä¸€æ¬¡ã€‚</p></blockquote><p>ç›®å‰ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li><p>git åŸç”Ÿæ”¯æŒçš„ <code>filter-branch</code> åˆ†æ”¯æ–‡ä»¶ï¼Œå‘½ä»¤ <code>git filter-branch --force --tree-filter 'rm -f path/to/big_file.mpg' HEAD</code> ã€‚ï¼ˆä¸æ¨èã€‚å¯¹äºè¶…å¤š commit çš„é¡¹ç›®ï¼Œ<code>filter-branch</code> æ…¢çš„æ€€ç–‘äººç”Ÿï¼Œå°ç¼–å°±æ˜¯ä» <code>git filter-branch</code> æ”¾å¼ƒï¼Œè½¬æŠ• <code>BFG</code>ï¼‰</p></li><li><p><code>BFG</code> å·¥å…·</p><ul><li><p>æ‰§è¡Œå‘½ä»¤ <code>git clone --mirror git-repository-url</code>  clone git ä»“åº“</p></li><li><p>æ‰§è¡Œå‘½ä»¤ <code>java -jar bfg.jar --massive-non-file-objects-sized-up-to 100M --delete-files '{xxx.asf,xxx.asf}' thunisoft-mvd.git</code>ã€‚</p><blockquote><p><code>BFG</code> å¯¹äºéœ€è¦æ¸…ç†çš„ history ä¼šæ›´æ”¹æ¶‰åŠæ–‡ä»¶çš„æäº¤çš„ commit-idã€‚å…·ä½“è€æ–° commit-id çš„å¯¹åº”å…³ç³»æ–‡ä»¶åœ¨ <code>thunisoft-mvd.git.bfg-report\2020-07-17\16-14-13\object-id-map.old-new.txt</code> ä¸­<br>æ­¤æ—¶ï¼Œ<code>.git/objects</code> ä¸‹çš„  <code>pack/xxxxx.pack</code>  æ–‡ä»¶ä¼šè¢«è§£å‹ä¸º  n ä¸ª <code>git objects</code> å¯¹è±¡æ–‡ä»¶</p></blockquote></li></ul><p>  <img src="/images/2023/gitlab_bigcodes/log_for_bfg.png"></p></li><li><p>æ‰§è¡Œå‘½ä»¤ <code>git reflog expire --expire=now --all &amp;&amp; git gc --prune=now --aggressive</code> ï¼Œå°† git object å¯¹è±¡å‹ç¼©ã€‚è€Œåï¼Œæ‰§è¡Œå‘½ä»¤ <code>git push</code> æ¨é€è¿œç«¯ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ¨é€ä¹‹å‰è§£é™¤ä»“åº“çš„ <code>Protected Branches</code> çš„é…ç½®</p></blockquote></li></ul><p>  <img src="/images/2023/gitlab_bigcodes/git_compress.png"></p><ul><li>è¯·é¡¹ç›®ç»„æ‰€æœ‰æˆå‘˜æ”¾å¼ƒåŸæœ¬çš„æœ¬åœ°é¡¹ç›®ä»“åº“ï¼Œé‡æ–° clone git é¡¹ç›®ã€‚å› ä¸ºï¼Œå¦‚æœç”¨åŸæ¥çš„ä»“åº“ä½ ä¼šå‘ç°æœ¬åœ° <code>.git</code> ä¼šæ›´å¤§ï¼Œå› ä¸ºé™¤äº† <code>git gc</code> é‡æ–°ç”Ÿæˆçš„ <code>pack</code> æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜æœ‰æœ¬åœ°æœ¬èº«è€çš„ <code>pack</code> æ–‡ä»¶ã€‚</li></ul><p><strong>æœ€ç»ˆå’Œæ´¾ç”Ÿé¡¹ç›®å¯¹æ¯”ï¼Œé™¤ <code>.git</code> ç›®å½•å¤–å…¶ä»–ç›¸åŒã€‚</strong></p><p><img src="/images/2023/gitlab_bigcodes/gitcode_compare.png"></p><p><strong>ä¸ºä»€ä¹ˆå­˜åœ¨ä¸åˆ° 1 KB çš„æ–‡ä»¶ï¼Ÿå› ä¸ºï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ <code>git lfs</code> åšäº†å¤§æ–‡ä»¶ç®¡ç†ï¼Œä½¿ç”¨ <code>git lfs pull</code> å¯ä»¥ä»è¿œç«¯æ‹‰ä¸‹ 1 KB æ˜ å°„çš„åŸæ–‡ä»¶</strong><br><strong><font color="red">æ¸…ç†å®Œæˆï¼Œ2.4 GB -&gt; 1.1 GB çš„è½¬èº«</font></strong></p><h2 id="lion-ç‰¹åˆ«è¯´æ˜"><a href="#lion-ç‰¹åˆ«è¯´æ˜" class="headerlink" title=":lion: ç‰¹åˆ«è¯´æ˜"></a><span class="github-emoji"><span>ğŸ¦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f981.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç‰¹åˆ«è¯´æ˜</h2><ul><li>é¡¹ç›®ä½¿ç”¨ <code>git lfs</code> ç®¡ç†å¤§æ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>BFG</code> æ¸…ç†å®Œå¯¹é¡¹ç›®æœ¬èº«æ²¡æœ‰ä»»ä½•å½±å“ã€‚ç…§æ ·ï¼Œå¯ä»¥ä½¿ç”¨ <code>git lfs</code> å‘½ä»¤ç®¡ç†æ–‡ä»¶ã€‚</li><li>çœŸå®é¡¹ç›®åœ¨æ¸…ç†å‰ï¼Œè¯·å…ˆæŒ‰ç…§æœ¬æ–‡å…ˆ <code>clone</code> å‡ºä¸€ä»½ï¼Œç†Ÿæ‚‰ä¸€ä¸‹æ¸…ç†æµç¨‹ï¼Œæ›´æœ‰åº•æ°”ã€‚</li></ul><h2 id="horse-é™„å½•"><a href="#horse-é™„å½•" class="headerlink" title=":horse: é™„å½•"></a><span class="github-emoji"><span>ğŸ´</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f434.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é™„å½•</h2><ul><li><a href="http://www.ruanyifeng.com/blog/2018/10/git-internals.html">git åŸç†-é˜®ä¸€å³°</a></li><li><a href="https://zhuanlan.zhihu.com/p/45510461">git åŸç†</a></li><li><a href="https://docs.github.com/cn/github/managing-large-files/removing-files-from-git-large-file-storage#removing-a-single-file">git å¤§æ–‡ä»¶æ¸…ç†-github</a></li><li><a href="http://gitlab.thunisoft.com/help/user/project/repository/reducing_the_repo_size_using_git.md">git å¤§æ–‡ä»¶æ¸…ç†-gitlab</a>ï¼Œç›®å‰ä¸ç”¨ä¸Šä¼  <code>object-id-map.old-new.txt</code> æ–‡ä»¶ï¼Œèµ° â€œå¼€å§‹æ¸…ç†â€ è¿™æ­¥éª¤</li><li><a href="https://rtyley.github.io/bfg-repo-cleaner/">git BFG</a></li><li><a href="https://learngitbranching.js.org/?locale=zh_CN">git ç»ƒä¹ åœº</a></li><li><a href="https://git-scm.com/book/zh/v2">git å­¦ä¹ æ–‡æ¡£</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> gitlab </tag>
            
            <tag> BFG </tag>
            
            <tag> æ‚é¡¹ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
