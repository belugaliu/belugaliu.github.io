<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>æ€ä¹ˆå®ç° mybatis è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´</title>
      <link href="/2024/02/18/zen-me-shi-xian-mybatis-zi-dong-she-zhi-chuang-jian-shi-jian-geng-xin-shi-jian/"/>
      <url>/2024/02/18/zen-me-shi-xian-mybatis-zi-dong-she-zhi-chuang-jian-shi-jian-geng-xin-shi-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="æ€ä¹ˆå®ç°-mybatis-è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´"><a href="#æ€ä¹ˆå®ç°-mybatis-è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´" class="headerlink" title="æ€ä¹ˆå®ç° mybatis è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´"></a>æ€ä¹ˆå®ç° mybatis è‡ªåŠ¨è®¾ç½®åˆ›å»ºæ—¶é—´æ›´æ–°æ—¶é—´</h2><h4 id="mag-ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯"><a href="#mag-ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯" class="headerlink" title=":mag: ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯"></a><span class="github-emoji"><span>ğŸ”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç›¸å¯¹æµè¡Œæ–¹æ¡ˆå¼Šç«¯</h4><p>mybatis æä¾› Interceptor æ¥å£ä»¥æ’ä»¶æ–¹å¼æä¾›æ‰©å±•èƒ½åŠ›ã€‚äº’è”ç½‘ä¸Šå¤§éƒ½æ˜¯å¯¹æ•°æ®è¡¨æ˜ å°„ç±»å¯¹è±¡ä¸­å…³äºæ—¶é—´å±æ€§è®¾ç½®å½“å‰æ—¶é—´çš„è§£å†³æ–¹æ¡ˆã€‚ä½†è¿™ç§æ–¹æ³•æ— æ³•è§£å†³ mapper.xml å†™æ›´æ–° SQL æˆ– @XXXProvider æ‹¼ SQL çš„æ–¹å¼æ’å…¥æˆ–æ›´æ–°æ•°æ®è¡¨ã€‚ä½†æ˜¯ä¾æ‰˜äºæ•°æ®è¡¨æ˜ å°„ç±»æœ¬èº«æ²¡æœ‰é—®é¢˜ï¼Œå› ä¸ºéœ€è¦çŸ¥é“åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å¯¹åº”çš„æ•°æ®åº“å­—æ®µä¿¡æ¯ï¼Œè¿™æ˜¯å…‰æ‹¦æˆªåˆ° SQL è€Œæ— æ³•åˆ¤æ–­æ—¶é—´ç›¸å…³çš„å­—æ®µæ˜¯å¦å­˜åœ¨å¹¶èµ‹å€¼ã€‚</p><h4 id="mortar-board-æ›´å¥½çš„é€‰æ‹©"><a href="#mortar-board-æ›´å¥½çš„é€‰æ‹©" class="headerlink" title=":mortar_board: æ›´å¥½çš„é€‰æ‹©"></a><span class="github-emoji"><span>ğŸ“</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f393.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ›´å¥½çš„é€‰æ‹©</h4><p>å¦‚æœä½ é¡¹ç›®ä¸­ä½¿ç”¨äº† mybatis-plus ç»„ä»¶ï¼Œæ­å–œä½ åšè¿™ä¸ªå†³å®šä½ è¶³å¤Ÿæ˜æ™ºã€‚ mybatis-plus æä¾› MetaObjectHandler æŠ½è±¡ç±»å®ç°å…¬å…±å­—æ®µè‡ªåŠ¨å†™å…¥èƒ½åŠ›ã€‚å…¶å¤§ä½“æ€è·¯æ˜¯é’ˆå¯¹ @XXXProvider æ‹¼ SQL æ—¶å°†å®ä½“ä¸­æ ‡è®°éœ€è¦è‡ªåŠ¨å¡«å……çš„å­—æ®µæ‹¼å…¥ SQL ä¸­ï¼Œé€šè¿‡ metaObjectHandler å¯¹å®ä½“å±æ€§å­—æ®µå¡«å……ç›¸åº”å€¼ï¼Œæœ€åå¸¦æœ‰è‡ªåŠ¨å¡«å……å­—æ®µçš„ PrepareStatement SQL æ’å…¥/æ›´æ–°æ•°æ®è¡¨æ•°æ®ã€‚</p><p>ä½†ï¼Œé¡¹ç›®ä¸Šä½¿ç”¨è‡ªå†™ <code>BaseMapper&lt;E,ID&gt;</code> æ¥å£å’Œ @XXXProvider æ³¨è§£å®ç° BaseMapperSqlSourceBuilder ç±»å®Œæˆ SQL æ‹¼æ¥ã€‚ä½†æœªæä¾›å¯¹å…¬ç”¨å­—æ®µè‡ªåŠ¨å†™å…¥èƒ½åŠ›ã€‚</p><h4 id="mushroom-åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜"><a href="#mushroom-åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜" class="headerlink" title=":mushroom: åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜"></a><span class="github-emoji"><span>ğŸ„</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f344.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨ç°çŠ¶ä¸Šè§£å†³é—®é¢˜</h4><p>Interceptor æ‹¦æˆªçš„ä½ç½®æ˜¯æ‰§è¡Œ SQL ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯ <code>@Signature(type = Executor.class, method="update", args={MappedStatement.class, Object.class})</code> ï¼Œåœ¨ SQL é‡Œæ‹¼æ¥æ—¶é—´çš„å­—æ®µå’Œå­—æ®µå€¼ã€‚å­—æ®µå€¼å¯ä»¥ç›´æ¥è®¾ç½®çš„ <code>now()</code> æ•°æ®åº“å‡½æ•°ï¼Œç¼ºç‚¹æ˜¯å¼ºä¾èµ–æ•°æ®åº“ã€‚è¿™ä¸ªç¼ºç‚¹éœ€è¦é€šè¿‡ driver ä¿¡æ¯æ‰¾ç¡®åˆ‡çš„æ•°æ®åº“ç±»å‹ï¼Œåˆ‡æ¢æ—¶é—´å‡½æ•°ã€‚æ—¶é—´å­—æ®µä¿¡æ¯åˆ™æ˜¯é€šè¿‡ <code>BaseMapper&lt;E,ID&gt;</code> è·å–æ³›å‹ E æŒ‡å‘çš„ Classï¼Œé€šè¿‡å±æ€§ååŒ¹é…ï¼ˆæ²¡åŠæ³•è€ä»£ç åªèƒ½åŒ¹é…å±æ€§åï¼‰æˆ–æ³¨è§£åŒ¹é…æ‰¾åˆ°æ—¶é—´å­—æ®µã€‚SQL é‡Œæ‹¼æ¥æ—¶é—´å­—æ®µæ˜¯é€šè¿‡åŒ…è£… SqlSource é€šè¿‡ <code>SqlSource#getBoundSql</code> æ›¿æ¢æœ€ç»ˆ SQL å’Œå½“å‰æ—¶é—´å‡½æ•°ã€‚</p><ul><li><code>mappedStatement#getId()</code>ï¼Œid çš„å€¼å¯¹åº”ç±»å…¨è·¯å¾„ï¼Œä»è¿™ä¸ªç±»å…¨è·¯å¾„è·å–ç±»ä¿¡æ¯å¹¶ç¡®å®š <code>BaseMapper&lt;E,ID&gt;</code> E æŒ‡å‘çš„æ³›å‹</li></ul><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">/** * è¡¨çš„åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´ä¼šéšç€è¡¨çš„æ›´æ–°æˆ–æ’å…¥è¡Œä¸ºè¿›è¡Œèµ‹å€¼. å› ä¸ºéœ€è¦ç¡®å®šè¡¨ä¸­æ˜¯å¦æœ‰åˆ›å»ºæ—¶é—´æˆ–æ›´æ–°æ—¶é—´ä¸”ç¡®å®šæ—¶é—´å­—æ®µåï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨çš„åœ°æ–¹ * çš„ mapper ç»§æ‰¿ {@link BaseMapper}&lt;br&gt; * æ€è·¯ï¼Œä» BaseMapper çš„æ³›å‹ T è·å–å®ä½“ç±»ï¼Œä»å®ä½“ç±»é‡Œé¢è§£æå‡ºåˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å­—æ®µå¯¹åº”çš„æ•°æ®åº“å­—æ®µåï¼Œè¿™é‡Œåˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´æ˜¯é€šè¿‡åç§° * åŒ¹é…çš„ï¼Œå¤§å°å†™ä¸è®ºåŒ…å«åŒ¹é….é’ˆå¯¹æ’å…¥è¡Œä¸ºä¼šå¢åŠ åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´ï¼Œé’ˆå¯¹æ›´æ–°è¡Œä¸ºä¼šæ›´æ–°æ›´æ–°æ—¶é—´.&lt;br&gt; * &lt;lu&gt; * &lt;li&gt;åˆ›å»ºæ—¶é—´ï¼ŒdCjsjã€cjsjã€dtCjsjã€dCjrqã€cjrqã€dtCjrqã€createTimeã€dCreateTimeã€dtCreateTime&lt;/li&gt; * &lt;li&gt;æ›´æ–°æ—¶é—´ï¼ŒdGxsj, gxsj, dtGxsj, dXgsj, xgsj, dtXgsj, dZhxgsjã€zhxgsjã€dtZhxgsjã€updateTimeã€dUpdateTimeã€dtUpdateTime&lt;/li&gt; * &lt;/lu&gt; * * @author liulili * @date 2024/1/25 11:24 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token annotation punctuation">@Component</span><span class="token annotation punctuation">@Intercepts</span><span class="token punctuation">(</span><span class="token annotation punctuation">@Signature</span><span class="token punctuation">(</span>type <span class="token operator">=</span> <span class="token class-name">Executor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> method<span class="token operator">=</span><span class="token string">"update"</span><span class="token punctuation">,</span> args<span class="token operator">=</span><span class="token punctuation">{</span><span class="token class-name">MappedStatement</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutofillCreateOrUpdateTimeInterceptor</span> <span class="token keyword">implements</span> <span class="token class-name">Interceptor</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">CJSJ_COLUMN_NAMES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"cjsj"</span><span class="token punctuation">,</span> <span class="token string">"dCjsj"</span><span class="token punctuation">,</span> <span class="token string">"dtCjsj"</span><span class="token punctuation">,</span> <span class="token string">"cjrq"</span><span class="token punctuation">,</span> <span class="token string">"dCjrq"</span><span class="token punctuation">,</span> <span class="token string">"dtCjrq"</span><span class="token punctuation">,</span> <span class="token string">"createTime"</span><span class="token punctuation">,</span> <span class="token string">"dCreateTime"</span><span class="token punctuation">,</span> <span class="token string">"dtCreateTime"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token constant">GXSJ_COLUMN_NAMES</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span><span class="token string">"gxsj"</span><span class="token punctuation">,</span> <span class="token string">"dGxsj"</span><span class="token punctuation">,</span> <span class="token string">"dtGxsj"</span><span class="token punctuation">,</span> <span class="token string">"xgsj"</span><span class="token punctuation">,</span> <span class="token string">"dXgsj"</span><span class="token punctuation">,</span> <span class="token string">"dtXgsj"</span><span class="token punctuation">,</span> <span class="token string">"zhxgsj"</span><span class="token punctuation">,</span> <span class="token string">"dZhxgsj"</span><span class="token punctuation">,</span> <span class="token string">"dtZhxgsj"</span><span class="token punctuation">,</span> <span class="token string">"updateTime"</span><span class="token punctuation">,</span> <span class="token string">"dUpdateTime"</span><span class="token punctuation">,</span> <span class="token string">"dtUpdateTime"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">intercept</span><span class="token punctuation">(</span><span class="token class-name">Invocation</span> invocation<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>        <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args <span class="token operator">=</span> invocation<span class="token punctuation">.</span><span class="token function">getArgs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">MappedStatement</span> mappedStatement <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MappedStatement</span><span class="token punctuation">)</span> args<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token class-name">StatementType</span> statement <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getStatementType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>statement <span class="token operator">==</span> <span class="token class-name">StatementType</span><span class="token punctuation">.</span><span class="token constant">CALLABLE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"ã€è‡ªåŠ¨å¡«å……åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´ã€‘ä¸æ”¯æŒåœ¨å­˜å‚¨è¿‡ç¨‹ç±»å‹ä¸šåŠ¡"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">SqlCommandType</span> command <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlCommandType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> id <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> className <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> id<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Class</span> mapperClazz <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            mapperClazz <span class="token operator">=</span> <span class="token class-name">Class</span><span class="token punctuation">.</span><span class="token function">forName</span><span class="token punctuation">(</span>className<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isDebugEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"className[{}]ä¸æ˜¯Classæ— æ³•ç»§ç»­ã€è‡ªåŠ¨å¡«å……åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´ã€‘çš„å·¥ä½œ"</span><span class="token punctuation">,</span> className<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>log<span class="token punctuation">.</span><span class="token function">isInfoEnabled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">"className[{}]ä¸æ˜¯Classæ— æ³•ç»§ç»­ã€è‡ªåŠ¨å¡«å……åˆ›å»ºæˆ–ä¿®æ”¹æ—¶é—´ã€‘çš„å·¥ä½œ"</span><span class="token punctuation">,</span> className<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Class</span> entityClazz <span class="token operator">=</span> <span class="token function">findEntityClazz</span><span class="token punctuation">(</span>mapperClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"class[{}]éæ¥å£/æœªç»§æ‰¿BaseMapperæ¥å£"</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">CUTimeDTO</span> cuTimeDTO <span class="token operator">=</span> <span class="token function">findCreateAndUpdateTimeColumn</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getCreateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"class[{}]æ— åŒ¹é…çš„åˆ›å»ºæ—¶é—´å’Œæ›´æ–°æ—¶é—´å­—æ®µï¼Œ è¯·å‚è€ƒ AutofillCreateOrUpdateTimeInterceptor#CJSJ_COLUMN_NAMES å’Œ AutofillCreateOrUpdateTimeInterceptor#GXSJ_COLUMN_NAMES"</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">INSERT</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillInsert</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>command <span class="token operator">==</span> <span class="token class-name">SqlCommandType</span><span class="token punctuation">.</span><span class="token constant">UPDATE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillUpdate</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> args<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span> entityClazz<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> invocation<span class="token punctuation">.</span><span class="token function">proceed</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillUpdate</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> updateTimeColumn <span class="token operator">=</span> cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>updateTimeColumn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> updateTimeColumn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillUTime</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSource</span> decoderSqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoFillUTimeUpdateSqlSource</span><span class="token punctuation">(</span>sqlSource<span class="token punctuation">,</span> updateTimeColumn<span class="token punctuation">,</span> <span class="token string">"now()"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> <span class="token string">"sqlSource"</span><span class="token punctuation">,</span> decoderSqlSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillInsert</span><span class="token punctuation">(</span><span class="token class-name">MappedStatement</span> mappedStatement<span class="token punctuation">,</span> <span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> createColumnName <span class="token operator">=</span> cuTimeDTO<span class="token punctuation">.</span><span class="token function">getCreateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> updateColumnName <span class="token operator">=</span> cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> addColumn <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>createColumnName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> createColumnName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            addColumn<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>createColumnName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isNotBlank</span><span class="token punctuation">(</span>updateColumnName<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">containsIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> updateColumnName<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            addColumn<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>updateColumnName<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">CollectionUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>addColumn<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> columnName <span class="token operator">=</span> addColumn<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> columnValue <span class="token operator">=</span> addColumn<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>column <span class="token operator">-&gt;</span> <span class="token string">"now()"</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">joining</span><span class="token punctuation">(</span><span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSource</span> sqlSource <span class="token operator">=</span> mappedStatement<span class="token punctuation">.</span><span class="token function">getSqlSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">SqlSource</span> decoderSqlSource <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AutoFillCUTimeInsertSqlSource</span><span class="token punctuation">(</span>sqlSource<span class="token punctuation">,</span> columnName<span class="token punctuation">,</span> columnValue<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>mappedStatement<span class="token punctuation">,</span> <span class="token string">"sqlSource"</span><span class="token punctuation">,</span> decoderSqlSource<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span><span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getCreateTimePropertyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>createColumnName <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> createColumnName<span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimePropertyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                    <span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>updateColumnName <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> updateColumnName<span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Collection</span> paramColl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            paramColl<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sparam <span class="token operator">-&gt;</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>sparam<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Map</span> paramMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            entries<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-&gt;</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramArr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>paramArr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span> property <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                property <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"param[{}]å±æ€§ã€{}ã€‘è·å–å±æ€§å€¼å¤±è´¥"</span><span class="token punctuation">,</span> param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">autofillCUTime</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span><span class="token class-name">Object</span> param<span class="token punctuation">,</span> <span class="token class-name">CUTimeDTO</span> cuTimeDTO<span class="token punctuation">,</span> <span class="token class-name">Class</span> entityClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>param<span class="token punctuation">)</span> <span class="token operator">||</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isPrimitive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEnum</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Optional</span><span class="token punctuation">.</span><span class="token function">ofNullable</span><span class="token punctuation">(</span>cuTimeDTO<span class="token punctuation">.</span><span class="token function">getUpdateTimePropertyName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>updateColumnName <span class="token operator">-&gt;</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> updateColumnName<span class="token punctuation">,</span> <span class="token class-name">Calendar</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Collection</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Collection</span> paramColl <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Collection</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            paramColl<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>sparam <span class="token operator">-&gt;</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span>sparam<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param <span class="token keyword">instanceof</span> <span class="token class-name">Map</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Map</span> paramMap <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map<span class="token punctuation">.</span>Entry</span><span class="token punctuation">&gt;</span></span> entries <span class="token operator">=</span> paramMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            entries<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>entry <span class="token operator">-&gt;</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span>entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> paramArr <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span> param<span class="token punctuation">;</span>            <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>paramArr<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>obj <span class="token operator">-&gt;</span> <span class="token function">autofillUTime</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> param<span class="token punctuation">.</span><span class="token function">getClass</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>field <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token class-name">Object</span> property <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                property <span class="token operator">=</span> <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">getProperty</span><span class="token punctuation">(</span>param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>                log<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">"param[{}]å±æ€§ã€{}ã€‘è·å–å±æ€§å€¼å¤±è´¥"</span><span class="token punctuation">,</span> param<span class="token punctuation">,</span> field<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token function">autofillUTime</span><span class="token punctuation">(</span>property<span class="token punctuation">,</span> cuTimeDTO<span class="token punctuation">,</span> entityClazz<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">CUTimeDTO</span> <span class="token function">findCreateAndUpdateTimeColumn</span><span class="token punctuation">(</span><span class="token class-name">Class</span> entityClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Field</span><span class="token punctuation">[</span><span class="token punctuation">]</span> fields <span class="token operator">=</span> entityClazz<span class="token punctuation">.</span><span class="token function">getDeclaredFields</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> fieldMap <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>fields<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">(</span><span class="token class-name">Collectors</span><span class="token punctuation">.</span><span class="token function">toMap</span><span class="token punctuation">(</span><span class="token class-name">Field</span><span class="token operator">::</span><span class="token function">getName</span><span class="token punctuation">,</span> field <span class="token operator">-&gt;</span> field<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldKeys <span class="token operator">=</span> fieldMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CUTimeDTO</span> <span class="token class-name">CUTimeDTO</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> cjsjFieldNameOptional <span class="token operator">=</span> fieldKeys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>fieldKey <span class="token operator">-&gt;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token constant">CJSJ_COLUMN_NAMES</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>columnName <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>columnName<span class="token punctuation">,</span> fieldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cjsjFieldNameOptional<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>cjsjFieldName <span class="token operator">-&gt;</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setCreateTimePropertyName</span><span class="token punctuation">(</span>cjsjFieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setCreateTimeColumnName</span><span class="token punctuation">(</span><span class="token function">getColumnNameByColumnAnno</span><span class="token punctuation">(</span>cjsjFieldNameOptional<span class="token punctuation">,</span> fieldMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> gxsjFieldNameOptional <span class="token operator">=</span> fieldKeys<span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>fieldKey <span class="token operator">-&gt;</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span><span class="token constant">GXSJ_COLUMN_NAMES</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">anyMatch</span><span class="token punctuation">(</span>columnName <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsIgnoreCase</span><span class="token punctuation">(</span>columnName<span class="token punctuation">,</span> fieldKey<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        gxsjFieldNameOptional<span class="token punctuation">.</span><span class="token function">ifPresent</span><span class="token punctuation">(</span>gxsjFieldName <span class="token operator">-&gt;</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setUpdateTimePropertyName</span><span class="token punctuation">(</span>gxsjFieldName<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">CUTimeDTO</span><span class="token punctuation">.</span><span class="token function">setUpdateTimeColumnName</span><span class="token punctuation">(</span><span class="token function">getColumnNameByColumnAnno</span><span class="token punctuation">(</span>gxsjFieldNameOptional<span class="token punctuation">,</span> fieldMap<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token class-name">CUTimeDTO</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token function">getColumnNameByColumnAnno</span><span class="token punctuation">(</span><span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> fieldNameOptional<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Field</span><span class="token punctuation">&gt;</span></span> fieldMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> columnName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>fieldNameOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> fieldName <span class="token operator">=</span> fieldNameOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Field</span> field <span class="token operator">=</span> fieldMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>fieldName<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token class-name">Column</span> column <span class="token operator">=</span> field<span class="token punctuation">.</span><span class="token function">getAnnotation</span><span class="token punctuation">(</span><span class="token class-name">Column</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            columnName <span class="token operator">=</span> column<span class="token punctuation">.</span><span class="token function">name</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> columnName<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token class-name">Class</span> <span class="token function">findEntityClazz</span><span class="token punctuation">(</span><span class="token class-name">Class</span> mapperClazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>mapperClazz<span class="token punctuation">.</span><span class="token function">isInterface</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Type</span><span class="token punctuation">[</span><span class="token punctuation">]</span> interfaces <span class="token operator">=</span> mapperClazz<span class="token punctuation">.</span><span class="token function">getGenericInterfaces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">isNull</span><span class="token punctuation">(</span>interfaces<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">Optional</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ParameterizedType</span><span class="token punctuation">&gt;</span></span> baseMapperTypeOptional <span class="token operator">=</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>interfaces<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>iface <span class="token operator">-&gt;</span> iface <span class="token keyword">instanceof</span> <span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>iface <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token class-name">ParameterizedType</span><span class="token punctuation">)</span> iface<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>iface <span class="token operator">-&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> iface<span class="token punctuation">.</span><span class="token function">getRawType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span><span class="token class-name">BaseMapper</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>baseMapperTypeOptional<span class="token punctuation">.</span><span class="token function">isPresent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">ParameterizedType</span> baseMapperType <span class="token operator">=</span> baseMapperTypeOptional<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token punctuation">)</span> baseMapperType<span class="token punctuation">.</span><span class="token function">getActualTypeArguments</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Object</span> <span class="token function">plugin</span><span class="token punctuation">(</span><span class="token class-name">Object</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token class-name">Plugin</span><span class="token punctuation">.</span><span class="token function">wrap</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">setProperties</span><span class="token punctuation">(</span><span class="token class-name">Properties</span> properties<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è®¾è®¡çš„ DTO ç”¨äºç¡®å®šå±æ€§å¯¹åº”çš„åˆ›å»ºæ—¶é—´å­—æ®µå±æ€§å’Œæ›´æ–°æ—¶é—´å­—æ®µå±æ€§ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Getter</span><span class="token annotation punctuation">@Setter</span><span class="token annotation punctuation">@Accessors</span><span class="token punctuation">(</span>chain <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token annotation punctuation">@NoArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CUTimeDTO</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> createTimePropertyName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> updateTimePropertyName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> createTimeColumnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> updateTimeColumnName<span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åŒ…è£…å¯¹åº”çš„ SqlSource åœ¨è·å–æœ€åçš„ SQL ï¼ˆ<code>SqlSource#getBoundSql</code>ï¼‰ä¸­æ‹¼æ¥åˆ›å»ºå’Œæ›´æ–°æ—¶é—´è„šæœ¬ã€‚ä¸åœ¨å…·ä½“çš„ SqlSource é‡Œé¢å®Œæˆå­—æ®µæ‹¼æ¥åŠ ä¸Šé¢„å¤„ç†å­—æ®µï¼Œæ˜¯å› ä¸º mybatis æ”¯æŒå¤šç§ SqlSource åŒ…å« <code>StaticSqlSource</code>ã€<code>ProviderSqlSource</code>ã€<code>RawSqlSource</code>ã€<code>DynamicSqlSource</code>ï¼Œä¸”ä»–ä»¬å¯ä»¥ç»„åˆå‡ºç°ï¼Œå¯è§è¿˜æ˜¯æœ‰ä¸€å®šçš„å¤æ‚åº¦çš„ã€‚æ‰€ä»¥æ‰é€‰æ‹©ç”¨åŒ…è£…ç±»å®Œæˆå­—æ®µå¡«å……ã€‚è¿™ç§æ˜¯ä¸å»ºè®®è‡ªåŠ¨å¡«å……é‚£ç§åŒ…å«ä¸åŒå€¼çš„å­—æ®µçš„ï¼Œå› ä¸ºè¿™æ ·ä¼šè®©é¢„å¤„ç† SQL æ²¡æœ‰å‘æŒ¥ä½œç”¨ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoFillUTimeUpdateSqlSource</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSource</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">SqlSource</span> sqlSource<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnValue<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span><span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> newSql <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">replaceIgnoreCase</span><span class="token punctuation">(</span>sql<span class="token punctuation">,</span> <span class="token string">"set "</span><span class="token punctuation">,</span> <span class="token string">"set "</span> <span class="token operator">+</span> columnName <span class="token operator">+</span> <span class="token string">"="</span> <span class="token operator">+</span> columnValue <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> <span class="token string">"sql"</span><span class="token punctuation">,</span> newSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@AllArgsConstructor</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AutoFillCUTimeInsertSqlSource</span> <span class="token keyword">implements</span> <span class="token class-name">SqlSource</span>  <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token class-name">SqlSource</span> sqlSource<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnName<span class="token punctuation">;</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> columnValue<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">BoundSql</span> <span class="token function">getBoundSql</span><span class="token punctuation">(</span><span class="token class-name">Object</span> parameterObject<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">BoundSql</span> boundSql <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>sqlSource<span class="token punctuation">.</span><span class="token function">getBoundSql</span><span class="token punctuation">(</span>parameterObject<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> boundSql<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">replaceBoundSql</span><span class="token punctuation">(</span><span class="token class-name">BoundSql</span> boundSql<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">String</span> sql <span class="token operator">=</span> boundSql<span class="token punctuation">.</span><span class="token function">getSql</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Pattern</span> pattern <span class="token operator">=</span> <span class="token class-name">Pattern</span><span class="token punctuation">.</span><span class="token function">compile</span><span class="token punctuation">(</span><span class="token string">"\\("</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Matcher</span> matcher <span class="token operator">=</span> pattern<span class="token punctuation">.</span><span class="token function">matcher</span><span class="token punctuation">(</span>sql<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">String</span> newSql <span class="token operator">=</span> sql<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>matcher<span class="token punctuation">.</span><span class="token function">find</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">int</span> index <span class="token operator">=</span> matcher<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            newSql <span class="token operator">=</span> sql<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">+</span> columnName <span class="token operator">+</span> <span class="token string">","</span> <span class="token operator">+</span> sql<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">int</span> index <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">indexOfIgnoreCase</span><span class="token punctuation">(</span>newSql<span class="token punctuation">,</span> <span class="token string">"values"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">int</span> index1 <span class="token operator">=</span> index <span class="token operator">+</span> <span class="token string">"values"</span><span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">while</span><span class="token punctuation">(</span>index1 <span class="token operator">&lt;</span> newSql<span class="token punctuation">.</span><span class="token function">length</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> index1 <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            index1 <span class="token operator">=</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">char</span> next <span class="token operator">=</span> newSql<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span>index1<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token char">' '</span> <span class="token operator">||</span> next <span class="token operator">==</span> <span class="token char">'\\'</span> <span class="token operator">||</span> next <span class="token operator">==</span> <span class="token char">'n'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">continue</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>next <span class="token operator">==</span> <span class="token char">'('</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">break</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            index1 <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">indexOfIgnoreCase</span><span class="token punctuation">(</span>newSql<span class="token punctuation">,</span> <span class="token string">"values"</span><span class="token punctuation">,</span> index1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>index1 <span class="token operator">==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> replace <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>newSql<span class="token punctuation">,</span> index<span class="token punctuation">,</span> index1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        newSql <span class="token operator">=</span> newSql<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>replace<span class="token punctuation">,</span> replace <span class="token operator">+</span> columnValue <span class="token operator">+</span> <span class="token string">","</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BeanUtil</span><span class="token punctuation">.</span><span class="token function">setProperty</span><span class="token punctuation">(</span>boundSql<span class="token punctuation">,</span> <span class="token string">"sql"</span><span class="token punctuation">,</span> newSql<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h4 id="question-çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®"><a href="#question-çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®" class="headerlink" title=":question: çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®"></a><span class="github-emoji"><span>â“</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2753.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çŒœæµ‹ä½ ä¼šæœ‰è¿™æ ·çš„ç–‘é—®</h4><p>ä¸ºä»€ä¹ˆä¸è®©é¡¹ç›®ç›´æ¥é›†æˆ mybatis-plus ä¿®æ”¹ pojo å°±èƒ½å¿«é€Ÿè§£å†³é—®é¢˜ï¼Œä¸ç”¨è¿™ä¹ˆå¤æ‚ã€‚å½“ç„¶æˆ‘ç»Ÿä¸€è¿™ä¸ªæ€è·¯ï¼Œä½†è¿™ä¸ªæ€è·¯é€‚åˆäº pojo å°‘ï¼Œä¸”ä½¿ç”¨ <code>@Table</code> ã€<code>@Column</code> ç­‰æ•°æ®åº“å‹çš„æ³¨è§£çš„é¡¹ç›®ã€‚å¦åˆ™ï¼Œåœ¨å¤§é¡¹ç›®ä¸­è¿˜æ˜¯å·¥ä½œé‡åŠé£é™©è¿˜æ˜¯æ¯”è¾ƒé«˜ã€‚ä½†è¿™ä¸å½±å“æˆ‘æ¨èä½¿ç”¨ mybatis-plusã€‚</p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> code </tag>
            
            <tag> mybatis </tag>
            
            <tag> mybatis-plus </tag>
            
            <tag> è‡ªåŠ¨å¡«å…… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Redis åˆ†å¸ƒå¼é”ä½ ç»­çº¦äº†å—</title>
      <link href="/2024/01/31/redis-fen-bu-shi-suo-ni-xu-yue-liao-ma/"/>
      <url>/2024/01/31/redis-fen-bu-shi-suo-ni-xu-yue-liao-ma/</url>
      
        <content type="html"><![CDATA[<h2 id="Redis-åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ"><a href="#Redis-åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ" class="headerlink" title="Redis åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ"></a>Redis åˆ†å¸ƒå¼é”ä½ ç»­æœŸäº†å—ï¼Ÿ</h2><p>æœåŠ¡åœ¨é›†ç¾¤æƒ…å†µä¸‹ï¼Œçº¿ç¨‹é”æ˜¯æ— æ³•æ»¡è¶³æœåŠ¡ä¹‹é—´é€»è¾‘éš”ç¦»ã€‚åˆ†å¸ƒå¼é”æ¦‚å¿µåº”è¿è€Œç”Ÿï¼Œå®ƒéœ€è¦å…·å¤‡äº’æ–¥æ€§ã€é˜²æ­¢æ­»é”ã€é«˜å¯ç”¨æ€§ã€å¯é‡å…¥æ€§ã€å”¯ä¸€æ ‡è¯†çš„ç‰¹ç‚¹ã€‚</p><ul><li><p>äº’æ–¥æ€§ï¼šä»»æ„æ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªæœåŠ¡æ‰èƒ½è·å–é”ã€‚</p></li><li><p>é˜²æ­¢æ­»é”ï¼šåˆ†å¸ƒå¼é”åº”è¯¥åœ¨æœåŠ¡é€»è¾‘è¿è¡Œå¼‚å¸¸æˆ–å´©æºƒæ—¶èƒ½å¤Ÿè‡ªåŠ¨é‡Šæ”¾ã€‚ä¸€èˆ¬çš„åšæ³•æ˜¯ç»™é”è®¾å®šè¶…æ—¶æ—¶é—´é¿å…æ­»é”ã€‚</p></li><li><p>é«˜å¯ç”¨æ€§ï¼šç¡®ä¿é”æä¾›æ–¹èŠ‚ç‚¹æ•…éšœæ—¶ä¹Ÿèƒ½æ­£å¸¸å·¥ä½œï¼Œç¡®ä¿é”çš„å¯é æ€§ã€‚</p></li><li><p>å¯é‡å…¥æ€§ï¼šå…è®¸åŒä¸€ä¸ªçº¿ç¨‹æˆ–æœåŠ¡åœ¨æŒæœ‰é”çš„æƒ…å†µä¸‹å¤šæ¬¡è·å–åŒä¸€ä¸ªé”ï¼Œè€Œä¸ä¼šå‡ºç°æ­»é”æˆ–é˜»å¡ã€‚</p></li><li><p>å”¯ä¸€æ ‡è¯†ï¼šåˆ†å¸ƒå¼é”åº”è¯¥å…·å¤‡å”¯ä¸€çš„æ ‡è¯†ã€‚</p></li></ul><p>åˆ†å¸ƒå¼é”æ–¹æ¡ˆå¤§ä½“æœ‰å‡ ç§ï¼Œä½¿ç”¨åŸºäºå”¯ä¸€ç´¢å¼•çš„æ•°æ®åº“è¡¨ã€zookeeper/etcdã€redisã€‚ä¸ºè¾¾åˆ°åˆ†å¸ƒå¼é”çš„äº’æ–¥æ€§å’Œé˜²æ­¢æ­»é”è¿™ä¸¤ä¸ªç‰¹æ€§ï¼Œæ–¹æ¡ˆæ˜¯è®¾å®šè¶…æ—¶æ—¶é—´é…åˆ<strong>å®šæ—¶ç»­æœŸ</strong>ä»¥è¾¾åˆ°ç›®çš„ã€‚å¦‚æœä½ ç”¨ Redis å®ç°åˆ†å¸ƒå¼é”ï¼Œè¯·é—®ä½ é¡¹ç›®ä¸­ Redis åˆ†å¸ƒå¼é”æœ‰<strong>å®šæ—¶ç»­æœŸ</strong>å—ï¼Ÿ</p><p>Jedis ä¸»è¦åŒ…å«æ•°æ®ç»“æ„æ“ä½œå’Œé˜Ÿåˆ— PUB/SUB æ“ä½œã€‚Redisson ç»„ä»¶é™¤æ­¤ä¹‹å¤–è¿˜åŒ…å«åˆ†å¸ƒå¼é”çš„å®ç°ã€‚Redisson å…³äºè·å–é”æœ‰å…­ç§æ–¹å¼ï¼Œ<code>lock()</code> ã€<code>tryLock()</code>ã€<code>lockInterruptibly()</code> ã€<code>tryLock(long waitTime, TimeUnit unit)</code>ã€ <code>lock(long leaseTime, TimeUnit unit)</code> ã€<code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code>ã€‚åŒºåˆ†ç‚¹åœ¨äº æ˜¯å¦ç­‰å¾…è·å–é”ã€ç­‰å¾…è·å–é”æ—¶é•¿ï¼Œæ˜¯å¦æœ‰è¿‡æœŸã€è¿‡æœŸæ—¶é—´ã€‚å¥½åƒæ²¡æœ‰çœ‹åˆ°ç»­æœŸç›¸å…³çš„å†…å®¹ã€‚</p><h4 id="mag-ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ"><a href="#mag-ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ" class="headerlink" title=":mag: ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ"></a><span class="github-emoji"><span>ğŸ”</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f50d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç»­æœŸè—åœ¨ç»†èŠ‚é‡Œ</h4><p>å°±åƒè€å¤«è€å¦»ä¸€æ ·ï¼Œ<span class="github-emoji"><span>â¤</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2764.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> çˆ±æ˜¯è—åœ¨ç»†èŠ‚é‡Œï¼Œç»­æœŸè—åœ¨é”è·å–çš„ç»†èŠ‚é‡Œã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸš¦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f6a6.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä»£ç æ˜¯ä»¥ redisson-3.18.0 ç‰ˆæœ¬ä¸ºä¾‹ï¼Œä¼°è®¡æ€»ä½“æ€è·¯å·®ä¸å¤šã€‚</p></blockquote><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// RedissonLock</span><span class="token keyword">private</span> <span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryAcquireAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> ttlRemainingFuture<span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        ttlRemainingFuture <span class="token operator">=</span> <span class="token function">tryLockInnerAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> internalLockLeaseTime<span class="token punctuation">,</span>                <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">,</span> threadId<span class="token punctuation">,</span> <span class="token class-name">RedisCommands</span><span class="token punctuation">.</span><span class="token constant">EVAL_LONG</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> f <span class="token operator">=</span> ttlRemainingFuture<span class="token punctuation">.</span><span class="token function">thenApply</span><span class="token punctuation">(</span>ttlRemaining <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>        <span class="token comment">// lock acquired</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>ttlRemaining <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                internalLockLeaseTime <span class="token operator">=</span> unit<span class="token punctuation">.</span><span class="token function">toMillis</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> ttlRemaining<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CompletableFutureWrapper</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>f<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>   <span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>é¦–å…ˆï¼Œæ²¡æœ‰è®¾ç½®è¿‡æœŸæ—¶é—´æ—¶ï¼Œredisson ä¼šä½¿ç”¨ <code>internalLockLeaseTime</code> ï¼ˆå®ƒæŒ‡ lock å†…ç½®è¿‡æœŸæ—¶é—´ï¼Œlock å¯¹è±¡åˆå§‹åŒ–æ—¶ä»é…ç½®ç±» <code>org.redisson.config.Config#lockWatchdogTimeout</code> ä¸­è·å–ï¼Œé»˜è®¤ 30 sï¼‰ä½œä¸ºè¿‡æœŸæ—¶é—´æ¥ç”³è¯·åˆ†å¸ƒå¼é”ã€‚ç¬¬ä¸€æ¬¡ç”³è¯·é”æˆåŠŸå <code>ttlRemainingFuture.thenApply</code> ï¼Œå¦‚æœè‡ªå®šä¹‰è¿‡æœŸæ—¶é—´æœ‰å€¼ï¼Œåˆ™é‡æ–°è®¾ç½® <code>internalLockLeaseTime</code>ã€‚æ²¡æœ‰è®¾ç½®çš„è¯ï¼Œåˆ™éœ€è¦å®šæ—¶ç»­æœŸï¼Œä¿è¯é”èƒ½è¢«æœ¬çº¿ç¨‹ä¸€ç›´æŒæœ‰ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// RedissonBaseLock</span>    <span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ExpirationEntry</span> entry <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExpirationEntry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">ExpirationEntry</span> oldEntry <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">putIfAbsent</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> entry<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>oldEntry <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// å¯é‡å…¥ä½ç½®ï¼Œå› ä¸ºä¸å­˜åœ¨è·å–é”ä¹‹åï¼ŒåŒä¸€çº¿ç¨‹çš„å¹¶å‘é—®é¢˜ï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨ LinkedHashMap</span>        oldEntry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>        entry<span class="token punctuation">.</span><span class="token function">addThreadId</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isInterrupted</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token class-name">ExpirationEntry</span> ee <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>ee <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token class-name">Timeout</span> task <span class="token operator">=</span> commandExecutor<span class="token punctuation">.</span><span class="token function">getConnectionManager</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">newTimeout</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TimerTask</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token annotation punctuation">@Override</span>        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token class-name">Timeout</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>            <span class="token class-name">ExpirationEntry</span> ent <span class="token operator">=</span> <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>ent <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">Long</span> threadId <span class="token operator">=</span> ent<span class="token punctuation">.</span><span class="token function">getFirstThreadId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>threadId <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token class-name">CompletionStage</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> future <span class="token operator">=</span> <span class="token function">renewExpirationAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            future<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"Can't update lock "</span> <span class="token operator">+</span> <span class="token function">getRawName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">" expiration"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token constant">EXPIRATION_RENEWAL_MAP</span><span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token function">getEntryName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                    <span class="token keyword">return</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token comment">// reschedule itself</span>                    <span class="token function">renewExpiration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>                    <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span><span class="token punctuation">,</span> internalLockLeaseTime <span class="token operator">/</span> <span class="token number">3</span><span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    ee<span class="token punctuation">.</span><span class="token function">setTimeout</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>ç®€å•æ¦‚æ‹¬ï¼Œå°±æ˜¯æœªè®¾ç½®è¿‡æœŸæ—¶é—´çš„åˆ†å¸ƒå¼é”ï¼Œæ˜¯ä»¥ 30s è¿‡æœŸæ—¶é—´å…ˆè·å–åˆ†å¸ƒå¼é”ï¼Œç¨‹åºä¸­ä½¿ç”¨æ—¶é—´ç‰‡æ–¹å¼åœ¨æ¯ 10s (30s * 1/3) ç»­æœŸã€‚è®¾ç½®è¿‡æœŸæ—¶é—´çš„åˆ†å¸ƒå¼é”åè€Œä¸èƒ½äº«å—ç»­æœŸã€‚</strong></p><p><span class="github-emoji"><span>ğŸ˜…</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f605.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœ¬æ¥å¤§å®¶åœ¨å®æˆ˜è¿‡ç¨‹ä¸­ï¼Œå°±æ˜¯æ€•é”ä¸é‡Šæ”¾ï¼ŒåŸºæœ¬ä¸Šéƒ½ä¼šè¢«å»ºè®®ä½¿ç”¨ <code>tryLock(long waitTime, long leaseTime, TimeUnit unit)</code> ï¼Œç»“æœåªæœ‰è¿™ç§è®¾ç½® leaseTime çš„è·å–é”æ²¡æœ‰ç»­æœŸã€‚å¤šå°‘æœ‰ç‚¹è¢«èƒŒ (feng) åˆº (ci) <span class="github-emoji"><span>ğŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span>ã€‚æˆ‘ä»¬éœ€è¦è§£å†³è¿™ä¸ªé—®ï¼ˆfengï¼‰é¢˜ï¼ˆciï¼‰ï¼Œå¸Œæœ›åœ¨ leaseTime è®¾ç½®æ—¶ï¼Œä¹Ÿèƒ½äº«å—ç»­æœŸåŠŸæ•ˆã€‚</p><h4 id="balance-scale-è¶…æ—¶ä¸ç»­æœŸå…¼å¾—"><a href="#balance-scale-è¶…æ—¶ä¸ç»­æœŸå…¼å¾—" class="headerlink" title=":balance_scale: è¶…æ—¶ä¸ç»­æœŸå…¼å¾—"></a><span class="github-emoji"><span>âš–</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/2696.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è¶…æ—¶ä¸ç»­æœŸå…¼å¾—</h4><p>å¥½åœ¨ <code>RedissonBaseLock</code> ä¸­å…³äºç»­æœŸçš„æ–¹æ³• <code>scheduleExpirationRenewal</code> å’Œ <code>cancelExpirationRenewal</code> éƒ½æ˜¯ <code>protected</code> ä¿®é¥°ç¬¦ä¿®é¥°ã€‚å¯ä»¥å»ºç«‹ <code>RedissonBaseLock</code> çš„åŒ…è£…ç±»ï¼Œåœ¨è·å–é”å’Œé‡Šæ”¾é”çš„æ—¶å€™å¯¹ leaseTime è®¾ç½®çš„ç»­æœŸè¡¥è¶³å³å¯ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">package</span> <span class="token namespace">org<span class="token punctuation">.</span>redisson</span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>lang<span class="token punctuation">.</span>reflect<span class="token punctuation">.</span></span><span class="token class-name">Field</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Objects</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span></span><span class="token class-name">TimeUnit</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>locks<span class="token punctuation">.</span></span><span class="token class-name">Condition</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">lombok<span class="token punctuation">.</span>extern<span class="token punctuation">.</span>slf4j<span class="token punctuation">.</span></span><span class="token class-name">Slf4j</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RFuture</span></span><span class="token punctuation">;</span><span class="token keyword">import</span> <span class="token import"><span class="token namespace">org<span class="token punctuation">.</span>redisson<span class="token punctuation">.</span>api<span class="token punctuation">.</span></span><span class="token class-name">RLock</span></span><span class="token punctuation">;</span><span class="token comment">/** * åˆ†å¸ƒå¼é”.&lt;br&gt; * ç”¨è£…é¥°è€…æ¨¡å¼ç»™æ‰€æœ‰ lock åŠ ä¸Šæ—¶é—´è¿‡æœŸå‰çš„ç»­æœŸæ“ä½œ.&lt;br&gt; * redis ä½œä¸ºåˆ†å¸ƒå¼é”æ–¹æ¡ˆä¸€å®šä¼šæœ‰å¼Šç«¯ï¼Œæ¯”å¦‚å‡ºç°å“¨å…µæ¨¡å¼çš„ redis é›†ç¾¤ï¼Œå°±å¯èƒ½å› ä¸ºé”ä¿¡æ¯åœ¨ä¸»èŠ‚ç‚¹åŒæ­¥ä»èŠ‚ç‚¹æ—¶å‡ºç°çš„ä¸»èŠ‚ç‚¹ä¸­æ–­ï¼Œå¯¼è‡´ä»èŠ‚ç‚¹æˆä¸ºä¸»èŠ‚ç‚¹ä¹‹å * æ— é”ä¿¡æ¯ï¼Œå¯¼è‡´çš„å…¶ä»–çº¿ç¨‹ç”³è¯·åˆ°é”ï¼Œæ­¤æ—¶å°±ä¼šå‡ºç°ä¸¤ä¸ªçº¿ç¨‹è·å–åˆ°åŒä¸€æŠŠé”çš„ ganga åœºæ™¯.&lt;br&gt; * è¯·æ³¨æ„åˆç†ä½¿ç”¨é”ï¼Œè·å–é”åä¸€å®šåœ¨ finally ä¸­é‡Šæ”¾é”ï¼Œç¨‹åºè¿è¡Œæ—¶é—´é•¿ä¹‹åä¸€å®šä¼šå‡ºç°å†…å­˜æº¢å‡ºé—®é¢˜. * * @author liulili * @since 20243-01-19 */</span><span class="token annotation punctuation">@Slf4j</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RenewalLock</span> <span class="token keyword">implements</span> <span class="token class-name">RLock</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">RedissonBaseLock</span> lock<span class="token punctuation">;</span>    <span class="token keyword">public</span> <span class="token class-name">RenewalLock</span><span class="token punctuation">(</span><span class="token class-name">RLock</span> lock<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token keyword">instanceof</span> <span class="token class-name">RenewalLock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"lock æœ¬å°±æ˜¯ç»­æœŸé”ï¼Œä¸éœ€è¦äºŒæ¬¡è£…é¥°ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>lock <span class="token keyword">instanceof</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span>lock <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">RedissonBaseLock</span><span class="token punctuation">)</span> lock<span class="token punctuation">;</span>            <span class="token keyword">return</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">"åˆ†å¸ƒå¼é”ç»­æœŸçš„åŠŸèƒ½è‡³å°‘æ˜¯ RedissonBaseLock çš„å®ä¾‹ï¼Œåˆ° redisson 3.18.0 ç‰ˆæœ¬ï¼ŒRedissonMultiLock æ˜¯ä¸èƒ½è¢« DistributedLock è£…é¥°çš„ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token string">"renewal_"</span> <span class="token operator">+</span> lock<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token class-name">Field</span> field <span class="token operator">=</span> <span class="token class-name">RedissonBaseLock</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getDeclaredField</span><span class="token punctuation">(</span><span class="token string">"internalLockLeaseTime"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            field<span class="token punctuation">.</span><span class="token function">setAccessible</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            field<span class="token punctuation">.</span><span class="token function">setLong</span><span class="token punctuation">(</span>lock<span class="token punctuation">,</span> leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"RedissonBaseLock ç±»æ²¡æœ‰ internalLockLeaseTime å±æ€§ï¼Œè¯·æ³¨æ„ç‰ˆæœ¬"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        lock<span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token keyword">boolean</span> getLockSuccess <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>getLockSuccess <span class="token operator">&amp;&amp;</span> leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> getLockSuccess<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">forceUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">forceUnlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isLocked</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByThread</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isHeldByThread</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isHeldByCurrentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">getHoldCount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">long</span> <span class="token function">remainTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">remainTimeToLive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// è¿˜æ˜¯é»˜è®¤çš„è¶…æ—¶æ—¶é—´</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        lock<span class="token punctuation">.</span><span class="token function">lockInterruptibly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">boolean</span> <span class="token function">tryLock</span><span class="token punctuation">(</span><span class="token keyword">long</span> time<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> <span class="token function">tryLock</span><span class="token punctuation">(</span>time<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">try</span> <span class="token punctuation">{</span>            lock<span class="token punctuation">.</span><span class="token function">unlock</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">Condition</span> <span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">newCondition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">forceUnlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> unlockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">forceUnlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        unlockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> unlockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> unlockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        unlockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> unlockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">unlockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> unlockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">unlockAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        unlockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancelExpirationRenewal</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> unlockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> <span class="token function">lockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">lockAsync</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">tryLockAsync</span><span class="token punctuation">(</span><span class="token keyword">long</span> waitTime<span class="token punctuation">,</span> <span class="token keyword">long</span> leaseTime<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span> unit<span class="token punctuation">,</span> <span class="token keyword">long</span> threadId<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> lockFuture <span class="token operator">=</span> lock<span class="token punctuation">.</span><span class="token function">tryLockAsync</span><span class="token punctuation">(</span>waitTime<span class="token punctuation">,</span> leaseTime<span class="token punctuation">,</span> unit<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>        lockFuture<span class="token punctuation">.</span><span class="token function">whenComplete</span><span class="token punctuation">(</span><span class="token punctuation">(</span>unlockStatus<span class="token punctuation">,</span> e<span class="token punctuation">)</span> <span class="token operator">-&gt;</span> <span class="token punctuation">{</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">Objects</span><span class="token punctuation">.</span><span class="token function">nonNull</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">return</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>leaseTime <span class="token operator">&gt;</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">scheduleExpirationRenewal</span><span class="token punctuation">(</span>leaseTime<span class="token punctuation">,</span> threadId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> lockFuture<span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">getHoldCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">getHoldCountAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span> <span class="token function">isLockedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">isLockedAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">RFuture</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> <span class="token function">remainTimeToLiveAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">return</span> lock<span class="token punctuation">.</span><span class="token function">remainTimeToLiveAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>æœ‰ä¸‰ä¸ªæ³¨æ„ç‚¹ï¼šé¦–å…ˆï¼Œè¿™ä¸ªè£…é¥°ç±»éœ€è¦æ”¾åœ¨ <code>org.redisson</code> åªæœ‰è¿™æ ·æ‰èƒ½ä½¿ç”¨ <code>proteced void scheduleExpirationRenewal()</code> å’Œ <code>protected void cancelExpirationRenewal()</code> æ–¹æ³•ã€‚å…¶æ¬¡ï¼Œç»­æœŸä¾æ—§æ˜¯æŒ‰ç…§ <code>internalLockLeaseTime</code> /3 é—´éš”è§¦å‘ï¼Œä½†å› ä¸ºæ˜¯ç”³è¯·é”å®Œç»“ä¹‹åçš„ç»­æœŸï¼Œæ‰€ä»¥æ­¤æ—¶çš„ <code>internalLockLeaseTime</code> ä¸ºç¬¬ä¸€æ¬¡ç”³è¯·é”çš„ <code>leaseTime</code> ã€‚ç¬¬ä¸‰ï¼Œå›  Redisson ç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œå¯èƒ½ä¸ä¼šæœ‰ RedissonBaseLock åŸºç±»ï¼Œä½ å¯ä»¥å‡çº§ç‰ˆæœ¬åä½¿ç”¨è£…é¥°ç±»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> åˆ†å¸ƒå¼é” </tag>
            
            <tag> redis </tag>
            
            <tag> code </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>json å·¥å…·æˆ‘åº”è¯¥æ€ä¹ˆé€‰ï¼Ÿ</title>
      <link href="/2023/05/18/json-gong-ju-wo-ying-gai-zen-me-xuan/"/>
      <url>/2023/05/18/json-gong-ju-wo-ying-gai-zen-me-xuan/</url>
      
        <content type="html"><![CDATA[<p>ç¼–ç¨‹å¤šå¹´ï¼Œå…¶å®é€‚åˆé¡¹ç›®/è‡ªå·±/å›¢é˜Ÿæ‰æ˜¯åˆé€‚çš„ã€‚JSON åœ¨ B/S åº”ç”¨ä¸‹ï¼Œä½œä¸ºè½»é‡çº§çš„æ•°æ®äº¤æ¢æ–¹å¼ã€‚ä¹Ÿåº”è¿è€Œç”Ÿä¸å°‘åºåˆ—åŒ–ååºåˆ—åŒ–çš„ JSON å·¥å…·åŒ…ã€‚<br>æ¯”å¦‚ï¼Œjson-libã€fastjsonã€gsonã€jackson ç­‰ã€‚æˆ‘ç”¨è¿‡çš„ï¼Œä¸»è¦æ˜¯è¿™å‡ ä¸ªå°±è¯´è¯´æˆ‘çš„é€‰æ‹©åœºæ™¯åŠä¾æ®ã€‚</p><h3 id="json-lib"><a href="#json-lib" class="headerlink" title="json-lib"></a>json-lib</h3><p>è¿™æ˜¯æˆ‘<strong>è¢«è¿«</strong>ä½¿ç”¨çš„ JSON å·¥å…·åŒ…ã€‚ä¸æ˜¯ä¸»åŠ¨é€‰æ‹©ï¼Œä¹Ÿæ˜¯å› ä¸ºç¡®å®è§‰å¾—å¾ˆå‘ã€‚<strong>é¦–å…ˆ</strong>ï¼Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–è€—æ—¶å¾ˆæ…¢ã€‚<strong>å…¶æ¬¡</strong>ï¼Œ<code>JSONObject.getXXX(key)</code> JSONObject<br>çš„ get ç³»æ–¹æ³•éƒ½å¿…é¡»è¦æ±‚ key å¿…é¡»åœ¨ JSON ä¸²ä¸­ä¸”éç©ºã€‚ä¹Ÿå°±æ˜¯è¢«ä½¿ç”¨çš„ key éƒ½å¿…é¡»æ˜¯éç©ºå€¼ï¼Œæ‰€ä»¥å°±é€¼è¿«è®¾ç½®é»˜è®¤å€¼ã€‚ä½†è¿™æ ·å¯èƒ½ä¼šå¯¼è‡´ä¸šåŠ¡è¢«â€é€¼ä¸å¾—å·²â€çš„é»˜è®¤å€¼è¦†ç›–ã€‚<strong>ç¬¬ä¸‰</strong>ï¼Œ<code>JSONObject.put(key,value)</code> æ–¹æ³•ä¼šé’ˆå¯¹ value ç±»å‹ä¸º String ä¸”ç¬¦åˆ JSON æ ¼å¼æ—¶ï¼Œä¼šå°† value ååºåˆ—åŒ–ã€‚è¿™ä¸ªç‰¹æ€§çœ‹ä¼¼å¾ˆå¥½ï¼Œå…¶å®åœ¨ç‰¹å®šåœºæ™¯ä¸‹ï¼Œç»™äººè¯¯å¯¼ï¼Œ<br>ä»¥ä¸º value æ˜¯ JSONObject ç»“æœå‘ç°æ˜¯ Stringã€‚Oh my god ï¼ï¼æ€»ç»“ï¼Œå‘æ¯”è¾ƒå¤šï¼Œä¸å»ºè®®ä½¿ç”¨ã€‚</p><h3 id="fastjson"><a href="#fastjson" class="headerlink" title="fastjson"></a>fastjson</h3><p>é˜¿é‡Œå·´å·´å‡ºå“ï¼Œä½¿ç”¨æ˜¯å¾ˆç®€å•ï¼ŒåŸºäºç±»å±æ€§ get/set æ¥åºåˆ—åŒ–å’Œéåºåˆ—åŒ–ã€‚åŒ…æ‹¬ä¹Ÿæ”¯æŒå¾ˆå¤šé€‰é¡¹ <code>FastJsonConfig</code> ã€ <code>SerializerFeature</code>ã€‚å¯¹ç ”å‘æ¥è¯´ï¼Œåºåˆ—åŒ–ååºåˆ—åŒ–ä½¿ç”¨<br>èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œæ€§èƒ½ä¹Ÿåå¥½ã€‚ä»¥ä¸ºåº”è¯¥æ˜¯å¾ˆå—æ¬¢è¿ï¼Œä½† github ä¸Š issue å¾ˆå¤šã€‚ä¼ è¯´ä¸­æºç å†™çš„ä¸å¥½ï¼Œä¹Ÿæ²¡ä»€ä¹ˆæ³¨é‡Šã€‚æ‰€ä»¥ï¼Œä¸æ˜¯æœ€å—æ¬¢è¿ï¼Œåœ¨ä¸­å›½å¾ˆæœ‰åœ°ä½ã€‚</p><h3 id="jackson"><a href="#jackson" class="headerlink" title="jackson"></a>jackson</h3><p>è¢« spring-web ç”¨ä½œé»˜è®¤çš„ <code>application/json</code> åºåˆ—åŒ–å’Œååºåˆ—åŒ– JSON é€‰å‹ã€‚ä¾èµ–çš„ jar åŒ…å°‘ï¼Œæä¾›æ‰©å±•é€‰é¡¹/é«˜çº§åŠŸèƒ½å¾ˆå¤šã€‚å¯¹æˆ‘è€Œè¨€ï¼Œç›¸æ¯”è¾ƒ fastjson è€Œè¨€ï¼Œä½¿ç”¨<br>ä¸æ–¹ä¾¿ã€‚å¯¹äº String è½¬ Date æ—¶ï¼Œå¿…é¡»æŒ‡å®š <code>@JsonProperty(format='xxxx')</code> æ ¼å¼åŒ–å­—æ®µã€‚</p><h3 id="gson"><a href="#gson" class="headerlink" title="gson"></a>gson</h3><p>google æ¨å‡º JSON å·¥å…·åŒ…ï¼Œç¬¦åˆ JSON æ ¼å¼å®šä¹‰ï¼Œæ˜¯ä¾æ®å±æ€§è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼ŒåŒ…å« publicã€privateã€protected ä¿®é¥°å­—æ®µã€‚è½¬ Listã€Set é›†åˆç±»ï¼Œç›¸æ¯” fastjson æ”¯æŒ<br>çš„å¾ˆå¥½ã€‚ä½†æ˜¯æ€§èƒ½ç›¸æ¯”è€Œè¨€ä¼šå¼±ä¸€äº›ã€‚</p><h3 id="å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®®-fastjson-gsonã€‚jackson-å°±ç»“åˆ-spring-web-ä½¿ç”¨ã€‚"><a href="#å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®®-fastjson-gsonã€‚jackson-å°±ç»“åˆ-spring-web-ä½¿ç”¨ã€‚" class="headerlink" title="å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®® fastjson/gsonã€‚jackson å°±ç»“åˆ spring-web ä½¿ç”¨ã€‚"></a><strong>å¦‚æœéœ€è¦åŠŸèƒ½å®Œå–„ï¼Œæ˜“ä¸Šæ‰‹å»ºè®® fastjson/gsonã€‚jackson å°±ç»“åˆ spring-web ä½¿ç”¨ã€‚</strong></h3>]]></content>
      
      
      <categories>
          
          <category> é€‰å‹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> é€‰å‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-boot-security OAuth2åº”ç”¨å®ç°</title>
      <link href="/2023/04/11/spring-boot-security-oauth2-ying-yong-shi-xian/"/>
      <url>/2023/04/11/spring-boot-security-oauth2-ying-yong-shi-xian/</url>
      
        <content type="html"><![CDATA[<h2 id="mouse-èƒŒæ™¯"><a href="#mouse-èƒŒæ™¯" class="headerlink" title=":mouse: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ­</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42d.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>é¡¹ç›®ä¸Šä¸€ç›´ä½¿ç”¨ CAS + åº”ç”¨ session + nginx IP hash ç»„åˆæ–¹å¼å®ç°ä¼ªé›†ç¾¤éƒ¨ç½²ã€‚ä½†è¿™ç§æ–¹å¼ä¹Ÿæœ‰ä¸€å®šçš„ç¼ºç‚¹ï¼Œè¯·æ±‚ä¸å¤Ÿå¹³å‡ï¼Œåº”ç”¨ä½¿ç”¨å¼‚æ­¥å¤„ç†æ–¹å¼ï¼Œè¿˜å¿…é¡»å°†ç»“æœè¿”å›ç»™å‘èµ·çš„åº”ç”¨ï¼Œå¦åˆ™å‰ç«¯æ— æ³•æ‹¿åˆ°ç»“æœã€‚è¿™äº›éƒ½æ˜¯ IP ç»‘å®šå›ºå®šåº”ç”¨å¯¼è‡´çš„ã€‚2023 å¹´ä¸ºæ­¢ï¼Œåœ¨ç½‘ä¸Šæœç´¢åˆ°ä¸»è¦è§£å†³æ–¹å¼æœ‰ä¸¤ä¸ª: 1. session å…±äº«ï¼ˆéœ€è¦ä¾èµ– redisï¼‰2. ç­¾å‘ JWT æˆæƒã€‚ä¸æƒ³å¼•å…¥ redisï¼Œæ‰€ä»¥é€‰æ‹©ç­¾å‘ JWT æˆæƒã€‚æŠ€æœ¯é€‰å‹ä¸Šä½¿ç”¨ <code>spring-scurity</code> + <code>CAS</code> + <code>oauth2</code> ç»„åˆæ–¹å¼ã€‚</p><h2 id="tiger-åº”ç”¨å®ç°"><a href="#tiger-åº”ç”¨å®ç°" class="headerlink" title=":tiger: åº”ç”¨å®ç°"></a><span class="github-emoji"><span>ğŸ¯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åº”ç”¨å®ç°</h2><p>ä½¿ç”¨ <code>spring-security</code> + <code>CAS</code> + <code>Oauth2</code> ç»„åˆæ–¹å¼ï¼Œspring-boot ä¸­æä¾›äº†å¾ˆå¤š starter å¯ä»¥ä½¿ç”¨ã€‚ä»¥ä¸‹ä½¿ç”¨ maven ä»“åº“ç®¡ç†ä¸ºä¾‹</p><pre class="line-numbers language-markup" data-language="markup"><code class="language-markup"><span class="token comment">&lt;!-- spring-security åŸºç¡€ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.boot<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-boot-starter-security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- CAS ç›¸å…³ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-cas<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- security-jwtç›¸å…³ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-jose<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token comment">&lt;!-- JWT ç­¾å‘ --&gt;</span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.springframework.security<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>spring-security-oauth2-resource-server<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><ul><li><code>spring-boot-starter-security</code>ï¼Œæ˜¯ <code>spring-security</code> çš„åŸºç¡€åŒ…ï¼Œä¸»è¦åŒ…å« <code>spring-security-config</code> å’Œ <code>spring-security-web</code></li><li><code>spring-security-cas</code>ï¼Œæ˜¯ <code>spring-security</code> çš„ CAS ç›¸å…³ï¼ŒåŒ…å« CAS validation åŠéªŒè¯é€šè¿‡æˆ–ä¸é€šè¿‡çš„å¤„ç†</li><li><code>spring-security-oauth2-jose</code>ï¼Œæ˜¯ <code>spring-security</code> çš„ token éªŒè¯ç›¸å…³</li><li><code>spring-security-oauth2-resource-server</code>ï¼Œæ˜¯ <code>spring-security</code> çš„ token ç­¾å‘åŠ web token éªŒè¯ã€‚</li></ul><h3 id="elephant-æ€ä¹ˆé›†æˆ"><a href="#elephant-æ€ä¹ˆé›†æˆ" class="headerlink" title=":elephant: æ€ä¹ˆé›†æˆ"></a><span class="github-emoji"><span>ğŸ˜</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f418.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ€ä¹ˆé›†æˆ</h3><p>é›†æˆä¹‹å‰ï¼Œå»ºè®®å…ˆçœ‹çœ‹<a href="https://docs.spring.io/spring-security/reference/servlet/architecture.html"> spring-security çš„æ¶æ„</a>ï¼Œ<span class="github-emoji"><span>ğŸ˜¸</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f638.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¾ˆå®¹æ˜“ç†è§£ã€‚å½“ç„¶é›†æˆä¸€ä¸ªç»„ä»¶ï¼Œéœ€è¦æœ‰é›†æˆæ€è·¯æˆ–æ­¥éª¤ï¼Œ</p><h4 id="PART1-é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼"><a href="#PART1-é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼" class="headerlink" title="PART1. é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼"></a>PART1. é€‰å®šç”¨æˆ·æ ¡éªŒæ–¹å¼</h4><p>spring-security ç›®å‰æœ‰æ”¯æŒçš„é›†ä¸­æ–¹å¼ï¼Œ</p><ul><li>ä¼ªéªŒè¯ï¼ˆ<code>AbstractPreAuthenticatedProcessingFilter</code>ï¼‰å…¶ä¸­å‡è®¾å§”æ‰˜äººå·²ç»ç”±å¤–éƒ¨ç³»ç»Ÿè¿›è¡Œäº†èº«ä»½éªŒè¯ï¼Œå®ç°ç±»å®Œæˆç®€å•çš„æ ¡éªŒ</li><li>CAS éªŒè¯ï¼ˆ<code>CasAuthenticationFilter</code>ï¼‰</li><li>æœ¬åœ°ç™»å½•éªŒè¯ï¼ˆ<code>UsernamePasswordAuthenticationFilter</code>ï¼‰åº”ç”¨æœ¬åœ°æ•°æ®åº“éªŒè¯ï¼Œéç‹¬ç«‹éªŒè¯æœåŠ¡</li><li>token éªŒè¯ï¼ˆ<code>BearerTokenAuthenticationFilter</code>ï¼‰OAuth2 JWT ç­¾å‘çš„ token åº”ç”¨æœåŠ¡éªŒè¯</li><li>å…¶ä»–éªŒè¯ï¼ˆ<code>AbstractAuthenticationProcessingFilter</code>ï¼‰å®ç°æ­¤ç±»æ¥å®Œæˆå®šåˆ¶éªŒè¯ï¼Œæ¯”å¦‚çº¦å®šå¥½è¯·æ±‚æˆæƒçš„éªŒè¯æ–¹å¼ã€‚</li></ul><p>å½“ç„¶ï¼Œæ­¤å¤„åªæ˜¯é€‰æ‹© Filter å¹¶éçœŸæ­£éªŒè¯çš„ä½ç½®ã€‚æ‰€ä»¥ï¼Œspring-security æ”¯æŒçš„ CAS æˆ–  UsernamePassword éªŒè¯æ–¹å¼ä¹Ÿæ˜¯æŠŠä½ çš„éªŒè¯å™¨é»˜è®¤è®¾ç½®äº†ã€‚</p><h4 id="PART2-ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal-credentialsï¼‰"><a href="#PART2-ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal-credentialsï¼‰" class="headerlink" title="PART2. ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal/credentialsï¼‰"></a>PART2. ç»„è£…å¾…æ ¡éªŒå…ƒç´ ï¼ˆprincipal/credentialsï¼‰</h4><p>principalï¼Œè¢«éªŒè¯ä¸»ä½“ã€‚credentialsï¼Œè¢«éªŒè¯è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯†ç ã€‚</p><p>å¦‚æœæ˜¯ä½¿ç”¨ CAS æˆ– UsernamePassword éªŒè¯ï¼Œå¯ä»¥è·³è¿‡è¿™é‡Œï¼Œå› ä¸ºç»„è£…å¾…éªŒè¯å…ƒç´ ï¼Œæœ‰é»˜è®¤å®ç°ã€‚å°±æ‹¿ CAS æ¥æ¯”å¦‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CASAuthenticationFilter</span><span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>                                             <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>  <span class="token comment">//,,,</span>  <span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>      username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">//,,,</span><span class="token punctuation">}</span><span class="token comment">// UsernamePasswordAuthenticationToken</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractAuthenticationToken</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">(</span><span class="token class-name">Object</span> principal<span class="token punctuation">,</span> <span class="token class-name">Object</span> credentials<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//,,,,</span><span class="token keyword">this</span><span class="token punctuation">.</span>principal <span class="token operator">=</span> principal<span class="token punctuation">;</span><span class="token keyword">this</span><span class="token punctuation">.</span>credentials <span class="token operator">=</span> credentials<span class="token punctuation">;</span><span class="token function">setAuthenticated</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å¦‚æœæ˜¯ä½¿ç”¨ <code>AbstractPreAuthenticatedProcessingFilter</code> æ—¶ï¼Œåˆ™éœ€è¦è¦†ç›–æ–¹æ³• <code>getPreAuthenticatedPrincipal()</code> å’Œ <code>getPreAuthenticatedPrincipal()</code> æ¥ç¡®å®šä¸»ä½“å’Œè¯ä¹¦ã€‚</p><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ˜¯ä½¿ç”¨ <code>BearerTokenAuthenticationFilter</code> æ—¶ï¼Œé»˜è®¤æ˜¯ä»è¯·æ±‚ä¸­è·å– Authorization header å€¼ã€‚æˆ‘åœ¨å®ç°æ—¶ä½¿ç”¨ cookie æ–¹å¼ï¼Œåªéœ€è¦å®ç° <code>BearerTokenResolver</code> æ¥å£ã€‚</p><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ˜¯ä½¿ç”¨ <code>AbstractAuthenticationProcessingFilter</code> æ—¶ï¼Œå°±è‡ªå·±åœ¨ <code>attemptAuthentication()</code> æ–¹æ³•ä¸­å®ç°ã€‚</p><h4 id="PART3-ç»„è£…æˆæƒä»¤ç‰Œ"><a href="#PART3-ç»„è£…æˆæƒä»¤ç‰Œ" class="headerlink" title="PART3. ç»„è£…æˆæƒä»¤ç‰Œ"></a>PART3. ç»„è£…æˆæƒä»¤ç‰Œ</h4><p>å¦‚æœæ˜¯ä½¿ç”¨ CAS æˆ– UsernamePassword éªŒè¯ï¼Œå¯ä»¥è·³è¿‡è¿™é‡Œï¼Œå› ä¸ºç»„è£…ä»¤ç‰Œçš„äº‹æƒ…ï¼ŒFilter é‡Œå·²ç»å®ç°ã€‚å°±æ‹¿ CAS æ¥æ¯”å¦‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CASAuthenticationFilter</span><span class="token keyword">public</span> <span class="token class-name">Authentication</span> <span class="token function">attemptAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>                                             <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">//...</span><span class="token keyword">boolean</span> serviceTicketRequest <span class="token operator">=</span> <span class="token function">serviceTicketRequest</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">String</span> username <span class="token operator">=</span> serviceTicketRequest <span class="token operator">?</span> <span class="token constant">CAS_STATEFUL_IDENTIFIER</span> <span class="token operator">:</span> <span class="token constant">CAS_STATELESS_IDENTIFIER</span><span class="token punctuation">;</span><span class="token class-name">String</span> password <span class="token operator">=</span> <span class="token function">obtainArtifact</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span><span class="token class-name">UsernamePasswordAuthenticationToken</span> authRequest <span class="token operator">=</span> <span class="token class-name">UsernamePasswordAuthenticationToken</span><span class="token punctuation">.</span><span class="token function">unauthenticated</span><span class="token punctuation">(</span>      username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//...</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><span class="github-emoji"><span>ğŸ”†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <font color="blue"><strong>åœ¨ä»¤ç‰Œæœªè¢«éªŒè¯ä¹‹å‰ï¼Œä»¤ç‰Œçš„åˆå§‹åŒ–å¿…é¡»æŒ‡å®šä»¤ç‰Œå¹¶æœªå®ŒæˆéªŒè¯ã€‚å³ authenticated å±æ€§ä¸º false ã€‚</strong></font></p><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚æœæ˜¯å…¶ä»–éªŒè¯æ–¹å¼ï¼Œåˆ™éœ€è¦è‡ªå·±ç»„è£…æ ¡éªŒä»¤ç‰Œï¼Œç»§æ‰¿ <code>AbstractAuthenticationToken</code> ç±»ã€‚</p><h4 id="PART4-éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…"><a href="#PART4-éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…" class="headerlink" title="PART4. éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…"></a>PART4. éªŒè¯åŠéªŒè¯åç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…</h4><p>å¦‚æœæ˜¯ä½¿ç”¨ CAS éªŒè¯ï¼Œéœ€è¦é€‰æ‹©ä¸€ä¸‹ <code>AbstractCasProtocolUrlBasedTicketValidator</code> éªŒè¯å™¨ã€‚å½“ç„¶ä½ ä¹Ÿå¯ä»¥å®ç°æ­¤ abstract ç±»ï¼Œå®Œæˆ ticket éªŒè¯ã€‚éªŒè¯å™¨çš„è°ƒç”¨æ–¹æ˜¯ <code>CasAuthenticationProvider</code>ã€‚ä¸ºä»€ä¹ˆåœ¨æ­¤ä»‹ç» <code>CasAuthenticationProvider</code> ï¼Ÿ<span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å› ä¸ºåŸºæœ¬ä¸Šæ‰€æœ‰çš„éªŒè¯éƒ½ä¸€å®šæ˜¯å®ç° <code>AuthenticationProvider</code> æ¥å£ã€‚<span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç”¨æˆ·æƒé™ä¿¡æ¯çš„ç»„è£…ï¼Œæ˜¯å®ç° <code>AuthenticationUserDetailsService&lt;T extends Authentication&gt;</code> æ¥å£ï¼Œä»ç¼“å­˜æˆ–æ˜¯æ•°æ®åº“ä¸­æŸ¥è¯¢ç”¨æˆ·æˆ–æƒé™ç‚¹ä¿¡æ¯ç»„è£… UserDetailsã€‚</p><p><span class="github-emoji"><span>ğŸ”†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <font color="blue"><strong>éªŒè¯é€šè¿‡åï¼Œå¯ä»¥é€šè¿‡åœ¨ Controller æ–¹æ³•ä¸Šä½¿ç”¨ <code>@AuthenticationPrincipal</code>&nbsp;æ³¨è§£ï¼Œæˆ–è¯·æ±‚çº¿ç¨‹é‡Œ <code>SecurityContextHolder.getContext().getAuthentication()</code>æ¥è·å–ç”¨æˆ·æˆæƒä¿¡æ¯ã€‚<code>@AuthenticationPrincipal</code>&nbsp;æ³¨è§£å¯¹åº” UserDetails å¯¹è±¡ï¼Œ<code>@CurrentSecurityContext</code>&nbsp;æ³¨è§£å¯¹åº” SecurityContext å¯¹è±¡ã€‚</strong></font></p><h4 id="PART5-éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°"><a href="#PART5-éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°" class="headerlink" title="PART5. éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°"></a>PART5. éªŒè¯æˆåŠŸæˆ–å¤±è´¥çš„å¤„ç†å®ç°</h4><p>éªŒè¯æˆåŠŸæˆ–å¤±è´¥åçš„å¤„ç†æ–¹å¼ï¼Œä¸€èˆ¬æœ‰å‡ ç§ï¼Œé‡å®šå‘é¦–é¡µæˆ–ç™»å½•é¡µé¢ï¼Œæ³¨å†Œæˆ–æ’¤é”€ JWT tokenï¼Œæ”¾è¡Œåé¢çš„ filter æˆ– Controllerã€‚<span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> è€Œ JWT token ç­¾å‘æ³¨é”€çš„åŠŸèƒ½ï¼Œåªéœ€å®ç° <code>AuthenticationSuccessHandler</code> å’Œ <code>AuthenticationFailureHandler</code> ä¸¤ä¸ªæ¥å£ã€‚</p><h4 id="PART6-ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…"><a href="#PART6-ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…" class="headerlink" title="PART6. ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…"></a>PART6. ä»¥ä¸Šå†…å®¹é…ç½®ç»„è£…</h4><p><span class="github-emoji"><span>ğŸƒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f383.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é…ç½®ç»„è£…é€šè¿‡ç»§æ‰¿ <code>WebSecurityConfigurerAdapter</code> ç±»ï¼Œè¦†ç›– <code>init(WebSecurity builder)</code> æ–¹æ³•å®Œæˆ Filterã€providerã€handler ç­‰æ³¨å…¥ã€‚æ­¤å¤„ä¸å¤šè¯´ï¼Œçœ‹ä»£ç åº”è¯¥å°±æ‡‚äº†ã€‚</p><p>ä»¥ä¸‹ä»¥ CAS + OAuth2 ç»„åˆæ–¹å¼çš„å®Œæ•´ä»£ç ç‰‡æ®µ</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">TuscCasTicketValidator</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractCasProtocolUrlBasedTicketValidator</span> <span class="token punctuation">{</span> <span class="token keyword">public</span> <span class="token class-name">TuscCasTicketValidator</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> casServerUrlPrefix<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token comment">// è®¾å®š CAS server</span>        <span class="token keyword">super</span><span class="token punctuation">(</span>casServerUrlPrefix<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token class-name">String</span> <span class="token function">getUrlSuffix</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// éªŒè¯è·¯å¾„</span>      <span class="token keyword">return</span> <span class="token string">"validate"</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">protected</span> <span class="token class-name">Assertion</span> <span class="token function">parseResponseFromServer</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">String</span> response<span class="token punctuation">)</span>      <span class="token keyword">throws</span> <span class="token class-name">TicketValidationException</span> <span class="token punctuation">{</span>        <span class="token comment">// åˆ¤å®šéªŒè¯é€šè¿‡æˆæœåŠç»“æœåé¦ˆ</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// bearer éªŒè¯éœ€è¦</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CookieBearerTokenResolver</span> <span class="token keyword">implements</span> <span class="token class-name">BearerTokenResolver</span> <span class="token punctuation">{</span>    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">String</span> <span class="token constant">COOKIE_NAME_BEARER</span> <span class="token operator">=</span> <span class="token string">"bearer"</span><span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token class-name">String</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> <span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">stream</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getCookies</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span>cookie <span class="token operator">-&gt;</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">equalsAnyIgnoreCase</span><span class="token punctuation">(</span>cookie<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token constant">COOKIE_NAME_BEARER</span><span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token class-name">Cookie</span><span class="token operator">::</span><span class="token function">getValue</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">findFirst</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">orElse</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MakeTokenHandler</span> <span class="token keyword">extends</span> <span class="token class-name">FilterAuthSuccessHandler</span> <span class="token punctuation">{</span>  <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationSuccess</span><span class="token punctuation">(</span>    <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>    <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">//...</span>    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> jwtEncoder<span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span>      <span class="token class-name">JwtEncoderParameters</span><span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>jwsHeader<span class="token punctuation">,</span> jwtClaimsSetBuilder<span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token class-name">String</span> token <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getTokenValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">,</span> token<span class="token punctuation">)</span><span class="token punctuation">;</span>cookie<span class="token punctuation">.</span><span class="token function">setPath</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span>cookieTimeoutSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>cookie<span class="token punctuation">.</span><span class="token function">setHttpOnly</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultAuthFailHandler</span> <span class="token keyword">implements</span> <span class="token class-name">AuthenticationFailureHandler</span><span class="token punctuation">,</span> <span class="token class-name">LogoutSuccessHandler</span> <span class="token punctuation">{</span><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>    <span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>    <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>    <span class="token class-name">AuthenticationException</span> exception<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span>    log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">""</span><span class="token punctuation">,</span> exception<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>exception <span class="token keyword">instanceof</span> <span class="token class-name">InvalidBearerTokenException</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Cookie</span> cookie <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Cookie</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        cookie<span class="token punctuation">.</span><span class="token function">setMaxAge</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">addCookie</span><span class="token punctuation">(</span>cookie<span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token class-name">HttpStatus</span><span class="token punctuation">.</span><span class="token constant">UNAUTHORIZED</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        response<span class="token punctuation">.</span><span class="token function">setContentType</span><span class="token punctuation">(</span><span class="token string">"text/plain;charset=utf-8"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">try</span> <span class="token punctuation">(</span><span class="token class-name">PrintWriter</span> writer <span class="token operator">=</span> response<span class="token punctuation">.</span><span class="token function">getWriter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            writer<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•å·²è¿‡æœŸæˆ–è¢«æ¨å‡ºï¼Œéœ€è¦é‡æ–°ç™»å½•éªŒè¯ï¼"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// è®°ä½ç™»å‡ºæˆ–è®¿é—®å‰çš„åœ°å€</span>    response<span class="token punctuation">.</span><span class="token function">sendRedirect</span><span class="token punctuation">(</span><span class="token string">"ç™»å½•é¡µé¢åœ°å€"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// é‡æ–°ç­¾å‘ token</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">JwtRenewFilter</span> <span class="token keyword">extends</span> <span class="token class-name">OncePerRequestFilter</span> <span class="token punctuation">{</span><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">doFilterInternal</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span>                                  <span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span>                                  <span class="token class-name">FilterChain</span> filterChain<span class="token punctuation">)</span>     <span class="token keyword">throws</span> <span class="token class-name">ServletException</span><span class="token punctuation">,</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>    <span class="token comment">//...</span>    <span class="token class-name">String</span> bearerToken <span class="token operator">=</span> bearerTokenResolver<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>request<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">Jwt</span> jwt <span class="token operator">=</span> jwtDecoder<span class="token punctuation">.</span><span class="token function">decode</span><span class="token punctuation">(</span>bearerToken<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">Instant</span> expiresAt <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getExpiresAt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>expiresAt<span class="token punctuation">.</span><span class="token function">isBefore</span><span class="token punctuation">(</span><span class="token class-name">Instant</span><span class="token punctuation">.</span><span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">plusSeconds</span><span class="token punctuation">(</span><span class="token number">60</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token class-name">String</span> ticket <span class="token operator">=</span> jwt<span class="token punctuation">.</span><span class="token function">getClaimAsString</span><span class="token punctuation">(</span><span class="token string">"st"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">try</span> <span class="token punctuation">{</span>                casTicketValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>ticket<span class="token punctuation">,</span> serviceUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">renewJwt</span><span class="token punctuation">(</span>jwt<span class="token punctuation">,</span> response<span class="token punctuation">,</span> jwtEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TicketValidationException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>              <span class="token comment">//...</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token annotation punctuation">@Configuration</span><span class="token annotation punctuation">@EnableWebSecurity</span><span class="token annotation punctuation">@AutoConfigureAfter</span><span class="token punctuation">(</span><span class="token class-name">LoginBaseConfiguration</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">LoginConfiguration</span> <span class="token keyword">extends</span> <span class="token class-name">WebSecurityConfigurerAdapter</span> <span class="token punctuation">{</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">HttpSecurity</span> httpSecurity<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">AuthenticationManager</span> authenticationManager<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">MakeTokenHandler</span> makeTokenHandler    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">DefaultAuthFailHandler</span> defaultAuthFailHandler<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Resource</span>    <span class="token keyword">private</span> <span class="token class-name">AuthenticationDetailsSource</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">HttpServletRequest</span><span class="token punctuation">,</span> <span class="token class-name">WebAuthenticationDetails</span><span class="token punctuation">&gt;</span></span> webAuthenticationDetailsSource<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxxx}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> applicationServerUrl<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${xxxx}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token class-name">String</span> <span class="token class-name">CASServerUrl</span><span class="token punctuation">;</span>    <span class="token comment">// 12h</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${login.jwt.cookieTimeoutSecond:43200}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> cookieTimeoutSecond<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Value</span><span class="token punctuation">(</span><span class="token string">"${login.jwt.casDurationSecond:600}"</span><span class="token punctuation">)</span>    <span class="token keyword">private</span> <span class="token keyword">int</span> casDurationSecond<span class="token punctuation">;</span>    <span class="token annotation punctuation">@Override</span>    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">init</span><span class="token punctuation">(</span><span class="token class-name">WebSecurity</span> builder<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>        <span class="token class-name">BearerTokenAuthenticationFilter</span> bearerTokenFilter <span class="token operator">=</span>           <span class="token keyword">new</span> <span class="token class-name">BearerTokenAuthenticationFilter</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>      bearerTokenFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>        dzdaWebAuthenticationDetailsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">BearerTokenResolver</span> bearerTokenResolver <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CookieBearerTokenResolver</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        bearerTokenFilter<span class="token punctuation">.</span><span class="token function">setBearerTokenResolver</span><span class="token punctuation">(</span>makeTokenHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        bearerTokenFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>defaultAuthFailHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">AbstractAuthenticationProcessingFilter</span> casAuthenticationFilter          <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationFailureHandler</span><span class="token punctuation">(</span>defaultAuthFailHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setFilterProcessesUrl</span><span class="token punctuation">(</span><span class="token string">"/login/cas"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationDetailsSource</span><span class="token punctuation">(</span>        dzdaWebAuthenticationDetailsSource<span class="token punctuation">)</span><span class="token punctuation">;</span>      casAuthenticationFilter<span class="token punctuation">.</span><span class="token function">setAuthenticationSuccessHandler</span><span class="token punctuation">(</span>        dzdaCasAuthenticationSuccessHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">JwtRenewFilter</span> jwtRenewFilter <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtRenewFilter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>          <span class="token function">setBearerTokenResolver</span><span class="token punctuation">(</span>bearerTokenResolver<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setCasTicketValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TuscCasTicketValidator</span><span class="token punctuation">(</span>casServerUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setServiceUrl</span><span class="token punctuation">(</span>applicationServerUrl<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setCookieTimeoutSecond</span><span class="token punctuation">(</span>cookieTimeoutSecond<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setCasDurationSecond</span><span class="token punctuation">(</span>casDurationSecond<span class="token punctuation">)</span>          <span class="token punctuation">.</span><span class="token function">setLocalDurationSecond</span><span class="token punctuation">(</span>localDurationSecond<span class="token punctuation">)</span><span class="token punctuation">;</span>        httpSecurity<span class="token punctuation">.</span><span class="token function">authenticationManager</span><span class="token punctuation">(</span>authenticationManager<span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>casAuthenticationFilter<span class="token punctuation">,</span>                                  <span class="token class-name">X509AuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>jwtRenewFilter<span class="token punctuation">,</span> <span class="token class-name">BearerTokenAuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">addFilterBefore</span><span class="token punctuation">(</span>bearerTokenFilter<span class="token punctuation">,</span> <span class="token class-name">X509AuthenticationFilter</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">authorizeHttpRequests</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anyRequest</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">authenticated</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">anonymous</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">logout</span><span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">deleteCookies</span><span class="token punctuation">(</span><span class="token string">"bearer"</span><span class="token punctuation">,</span> <span class="token string">"JESSIONID"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">invalidateHttpSession</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">logoutUrl</span><span class="token punctuation">(</span><span class="token string">"logoutroute"</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">logoutSuccessHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultAuthFailHandler</span><span class="token punctuation">(</span>                  applicationServerUrl<span class="token punctuation">,</span> casServerUrl<span class="token punctuation">)</span><span class="token punctuation">)</span>                <span class="token punctuation">.</span><span class="token function">and</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">csrf</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">disable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">cors</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        builder<span class="token punctuation">.</span><span class="token function">addSecurityFilterChainBuilder</span><span class="token punctuation">(</span>httpSecurity<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">CorsConfigurationSource</span> <span class="token function">corsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">CorsConfiguration</span> configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CorsConfiguration</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configuration<span class="token punctuation">.</span><span class="token function">setAllowedOrigins</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configuration<span class="token punctuation">.</span><span class="token function">setAllowedMethods</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        configuration<span class="token punctuation">.</span><span class="token function">setAllowedHeaders</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span><span class="token string">"*"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UrlBasedCorsConfigurationSource</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UrlBasedCorsConfigurationSource</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        source<span class="token punctuation">.</span><span class="token function">registerCorsConfiguration</span><span class="token punctuation">(</span><span class="token string">"/**"</span><span class="token punctuation">,</span> configuration<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> source<span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token annotation punctuation">@Bean</span>    <span class="token keyword">public</span> <span class="token class-name">AuthenticationProvider</span> <span class="token function">casAuthenticationProvider</span><span class="token punctuation">(</span><span class="token class-name">LoginServiceImpl</span> loginService<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">CasAuthenticationProvider</span> casAuthenticationProvider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setAuthenticationUserDetailsService</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">XXXCasUserDetailsService</span><span class="token punctuation">(</span>loginService<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setTicketValidator</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TuscCasTicketValidator</span><span class="token punctuation">(</span>ssoUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">ServiceProperties</span> serviceProperties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ServiceProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        serviceProperties<span class="token punctuation">.</span><span class="token function">setService</span><span class="token punctuation">(</span>applicationServerUrl<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setServiceProperties</span><span class="token punctuation">(</span>serviceProperties<span class="token punctuation">)</span><span class="token punctuation">;</span>        casAuthenticationProvider<span class="token punctuation">.</span><span class="token function">setKey</span><span class="token punctuation">(</span><span class="token string">"casAuthenticationProvider"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> casAuthenticationProvider<span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><span class="github-emoji"><span>ğŸ”†</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f506.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> <font color="blue"><strong>éœ€è¦æ˜ç¡® Filter çš„å…ˆåé¡ºåºï¼Œé¡ºåºä¸å¯¹å¯èƒ½ä¼šé€ æˆéªŒè¯ bugï¼Œæ¯”å¦‚ renewFilter åº”è¯¥åœ¨ BearerTokenAuthenticationFilter ä¹‹å‰ã€‚å¦åˆ™ renewFilter å°±æ²¡æœ‰æ„ä¹‰äº†ã€‚</strong></font></p>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring-security </tag>
            
            <tag> cas </tag>
            
            <tag> oauth2 </tag>
            
            <tag> pre-security </tag>
            
            <tag> code </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>spring-securityä¸­é‡è§çš„è€—æ—¶å°å‘</title>
      <link href="/2023/04/10/spring-security-zhong-yu-jian-de-hao-shi-xiao-keng/"/>
      <url>/2023/04/10/spring-security-zhong-yu-jian-de-hao-shi-xiao-keng/</url>
      
        <content type="html"><![CDATA[<h2 id="pear-èƒŒæ™¯"><a href="#pear-èƒŒæ™¯" class="headerlink" title=":pear: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f350.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>å®¢æˆ·ç°åœºè¿ç»´åŒäº‹åé¦ˆæŸç³»ç»Ÿè¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åã€å¯†ç åï¼Œæ— æ³•è¿›å…¥ç³»ç»Ÿé¦–é¡µã€‚åœ°å€æ ä¸­åœ°å€å´åœ¨ SSO server å’Œç³»ç»Ÿåœ°å€ä¹‹é—´æ¥å›è·³è½¬ï¼Œç³»ç»Ÿæ—¥å¿—ä¸­ä¹Ÿæ²¡æœ‰ç›¸å…³çš„æ—¥å¿—æä¾›çº¿ç´¢ã€‚å¬åˆ°è¿™é‡Œå°±æ™“å¾—ï¼Œä¸æ˜¯ä¸€ä¸ªè¿ç»´åŒå­¦åœ¨ç™½ç›’çš„æƒ…å†µä¸‹ï¼Œèƒ½è§£å†³çš„é—®é¢˜äº†ã€‚</p><h2 id="orange-é—®é¢˜è·Ÿè¿›"><a href="#orange-é—®é¢˜è·Ÿè¿›" class="headerlink" title=":orange: é—®é¢˜è·Ÿè¿›"></a><span class="github-emoji"><span>ğŸŠ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜è·Ÿè¿›</h2><h3 id="one-æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€"><a href="#one-æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€" class="headerlink" title=":one: æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€"></a><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€</h3><p>è®©è¿ç»´åŒå­¦ F12 æ‰“å¼€ chrome æµè§ˆå™¨å¼€å‘è€…æ¨¡å¼ï¼Œåˆ‡æ¢ Network é¡µç­¾å‹¾é€‰ <code>Preserve log</code>ï¼ˆä¿ç•™è¯·æ±‚æ—¥å¿—ï¼‰ï¼Œå°±èƒ½è®°å½•æµè§ˆå™¨ã€æ¥å›è·³è½¬ã€ç½‘ç»œè¯·æ±‚ã€‚</p><pre class="line-numbers language-none"><code class="language-none">${åº”ç”¨}/login/cas?st=xxxxx${SSO-server}/login?service=encodeURIComponent(${åº”ç”¨}/login/cas)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å°±æ˜¯è¿™ä¸¤ä¸ªåœ°å€ã€æ¥å›è·³è½¬ã€ã€‚ä»è¿™é‡Œèƒ½å¾—åšå‡ºå¦‚ä¸‹æ¨æ–­:</p><ol><li>SSO server æœåŠ¡ä¾æ® cookie ä¸­çš„ TGT éªŒè¯æ˜¯é€šè¿‡çš„ã€‚å¦åˆ™ï¼Œæ­¤å¤„å±•ç¤ºçš„å°±æ˜¯ç™»å½•é¡µé¢ã€‚</li><li>åº”ç”¨ <code>/login/cas</code> è¯·æ±‚ï¼Œé€šè¿‡åå°è°ƒç”¨ SSO server çš„ validate æ¥å£å®Œæˆ stï¼ˆ<code>service ticket</code>ï¼‰éªŒè¯ï¼Œæ˜¾ç„¶è¿™é‡Œæ˜¯ä¸é€šè¿‡çš„ã€‚å¦åˆ™ï¼Œæ­¤å¤„å±•ç¤ºçš„å°±æ˜¯åº”ç”¨é¦–é¡µé¢ã€‚</li></ol><p>æ€»ç»“ï¼Œè¯´æ˜é—®é¢˜å‡ºåœ¨åº”ç”¨ <code>/login/cas</code> è¯·æ±‚è®¤è¯ä¸­ï¼Œè™½ç„¶ä¸æ•¢ç›¸ä¿¡ä½†ã€äº‹å®èƒœäºé›„è¾©ã€ã€‚</p><h3 id="two-åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› "><a href="#two-åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› " class="headerlink" title=":two: åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› "></a><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› </h3><p>ä¸ºä»€ä¹ˆä¸Šé¢è¯´ <code>/login/cas</code> ä¸æ•¢ç›¸ä¿¡æœ‰é—®é¢˜ï¼Œå› ä¸ºåº”ç”¨åç«¯ä½¿ç”¨ <code>spring-security-cas</code> ç»„ä»¶ï¼Œè€Œè¿™ä¸ªç»„ä»¶æ€•æ˜¯æœ‰æˆåƒä¸Šä¸‡çš„é¡¹ç›®ä½¿ç”¨å·²ç»æ˜¯å¾ˆä¼˜ç§€çš„ç»„ä»¶ï¼Œéš¾é“è¢«æˆ‘ç¢°è§å¼€æºçš„ BUG äº†ï¼Ÿ</p><p><code>spring-security-cas</code> ç»„ä»¶ï¼Œæœ‰å‡ ä¸ªé‡è¦ç»„æˆç±»ï¼š</p><ul><li><code>CasAuthenticationFilter</code>ï¼š<code>CAS</code> éªŒè¯è¿‡æ»¤å™¨ï¼Œ<code>/login/cas</code> è¯·æ±‚éªŒè¯å…¥å£ã€‚å…¶ä¸­ï¼Œ <code>attemptAuthentication()</code> å…¶ä¸­åŒ…å«éªŒè¯æ–¹æ³• ï¼ŒéªŒè¯ä¸é€šè¿‡åˆ™æŠ›å‡º <code>AuthenticationException</code>ã€‚<code>successfulAuthentication</code> åˆ™æ˜¯éªŒè¯é€šè¿‡åæ‰§è¡Œé€»è¾‘ï¼Œå¯ä»¥æ˜¯é‡å®šå‘åˆ°é¦–é¡µï¼Œæˆ–æ˜¯ç»§ç»­è®¿é—®åç»­é€»è¾‘ã€‚<code>unsuccessfulAuthentication</code> åˆ™æ˜¯éªŒè¯å¤±è´¥åæ‰§è¡Œé€»è¾‘ï¼Œæ˜¯é‡å®šå‘åˆ° <code>/login</code> ç™»å½•è¯·æ±‚ã€‚</li><li><code>CasAuthenticationProvider</code>ï¼šçœŸæ­£çš„ CAS éªŒè¯å…¥å£ï¼Œä¸»è¦å®Œæˆ CAS éªŒè¯å’Œç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…ã€‚</li><li><code>AbstractCasProtocolUrlBasedTicketValidator</code>ï¼šè¢« <code>CasAuthenticationProvider</code> ç±»è°ƒç”¨ï¼Œå®Œæˆè°ƒç”¨ SSO server validate æ¥å£éªŒè¯<code>serviceTicket</code>ã€‚</li><li><code>AbstractCasAssertionUserDetailsService</code>ï¼šè¢« <code>CasAuthenticationProvider</code> ç±»è°ƒç”¨ï¼Œå®Œæˆç”¨æˆ·åŠæƒé™ä¿¡æ¯çš„è£…è½½ã€‚</li></ul><p>å…³é”®ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ä¼šå¯¼è‡´è¿›å…¥ <code>unsuccessfulAuthentication()</code> é€»è¾‘çš„ï¼Œæ˜¯æŠ›å‡º <code>TicketValidationException</code> å¼‚å¸¸ã€‚é‚£ä¹Ÿå°±æ˜¯ <code>ticketValidator.validate()</code> ã€ <code>authenticationUserDetailsService.loadUserDetails()</code> æˆ– <code>userDetailsChecker.check()</code> é€»è¾‘ç‚¹æŠ›å‡ºå¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CasAuthenticationProvider</span><span class="token keyword">private</span> <span class="token class-name">CasAuthenticationToken</span> <span class="token function">authenticateNow</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name">Assertion</span> assertion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticketValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getServiceUrl</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token function">loadUserByAssertion</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsChecker<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> userDetails<span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authoritiesMapper<span class="token punctuation">.</span><span class="token function">mapAuthorities</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TicketValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>getMessage<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByAssertion</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> <span class="token class-name">CasAssertionAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAssertionAuthenticationToken</span><span class="token punctuation">(</span>assertion<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserDetails</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåï¼Œç°åœºé€šè¿‡ <code>arthas</code> å·¥å…·ä»£ç  <code>watch</code> å‘½ä»¤ï¼Œç›‘å¬ä»£ç æ˜ç¡®å¼‚å¸¸æŠ›å‡ºä½ç½®ã€‚æœ€åï¼Œæ˜¯åœ¨ <code>authenticationUserDetailsService.loadUserDetails()</code> åº”ç”¨è‡ªå·±å®ç°ç±»ä¸ŠæŠ›å‡ºäº†  <code>UsernameNotFoundException</code> å¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserDetails</span><span class="token punctuation">(</span><span class="token class-name">CasAssertionAuthenticationToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token function">getPrincipalAttributes</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} æ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"æ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> loginId <span class="token operator">=</span> <span class="token function">getLoginId</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} æ²¡æœ‰ç™»å½•æ ‡è¯†"</span><span class="token punctuation">,</span> loginId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%sæ²¡æœ‰ç™»å½•æ ‡è¯†"</span><span class="token punctuation">,</span> loginId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> corpId <span class="token operator">=</span> <span class="token function">getCorpId</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UserDO</span> userDO <span class="token operator">=</span> <span class="token function">loadUserDO</span><span class="token punctuation">(</span>loginId<span class="token punctuation">,</span> corpId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorities <span class="token operator">=</span> <span class="token function">getDefaultUserAuthorities</span><span class="token punctuation">(</span>userDO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonUserDetails</span><span class="token punctuation">(</span>userDO<span class="token punctuation">.</span><span class="token function">getLoginId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grantedAuthorities<span class="token punctuation">,</span> userDO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="three-åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ"><a href="#three-åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ" class="headerlink" title=":three: åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ"></a><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ</h3><p>æœ€ç»ˆï¼Œè¿˜æ˜¯è¦å›åˆ°æ–‡é¦–ã€ç ´ã€ä»£ç æœ‰å¼‚å¸¸ï¼Œæ—¥å¿—æ–‡ä»¶å´æ— è®°å½•é—®é¢˜ã€‚å›å¤´ç»†çœ‹ <code>AbstractAuthenticationProcessingFilter.unsuccessfulAuthentication()</code> æ–¹æ³•ï¼Œå¼‚å¸¸æ—¥å¿—æ‰“å°å±…ç„¶æ˜¯  trace çº§åˆ«ï¼Œç°åœºæ—¥å¿—çº§åˆ«é…ç½®çš„ error çº§åˆ«ï¼Œæ•…ä»£ç æœ‰å¼‚å¸¸ï¼Œæ—¥å¿—æ–‡ä»¶å´æ— è®°å½•é—®é¢˜ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Failed to process authentication request"</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Cleared SecurityContextHolder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Handling authentication failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="banana-æœªæåŠçš„åŸºç¡€çŸ¥è¯†"><a href="#banana-æœªæåŠçš„åŸºç¡€çŸ¥è¯†" class="headerlink" title=":banana: æœªæåŠçš„åŸºç¡€çŸ¥è¯†"></a><span class="github-emoji"><span>ğŸŒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœªæåŠçš„åŸºç¡€çŸ¥è¯†</h3><ul><li><a href="https://apereo.github.io/cas/6.6.x/index.html">CAS å®˜ç½‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring-security </tag>
            
            <tag> cas </tag>
            
            <tag> relogin </tag>
            
            <tag> code </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>npm-link VUEX watch æ€ä¹ˆä¸ç”Ÿæ•ˆ</title>
      <link href="/2023/04/02/npm-link-vuex-watch-zen-me-bu-sheng-xiao/"/>
      <url>/2023/04/02/npm-link-vuex-watch-zen-me-bu-sheng-xiao/</url>
      
        <content type="html"><![CDATA[<h2 id="cat-èƒŒæ™¯"><a href="#cat-èƒŒæ™¯" class="headerlink" title=":cat: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ±</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>å‰ç«¯é¡¹ç›® <code>package.json</code> ç›¸å½“äºåç«¯ maven é¡¹ç›® pom.xml æ–‡ä»¶ç®¡ç†é¡¹ç›®ç»„ä»¶ä¾èµ–ã€‚éœ€è¦èµ° <code>npm install --save-dev xxxx</code> å¼•å…¥æ–¹å¼ã€‚<br>å¯¹äºé¡¹ç›®ä¸­å­˜åœ¨å¤šé¡¹ç›®å…±ç”¨çš„å‰ç«¯ç»„ä»¶å¼€å‘ï¼Œä¸å¸Œæœ›æ¯æ¬¡ä¿®æ”¹ä»¥å‘å¸ƒç‰ˆæœ¬å† <code>npm install</code> ä¸‹è½½åŒ…è°ƒè¯•ã€‚<br>å¯ä»¥é€‰ç”¨ <a href="https://docs.npmjs.com/cli/v9/commands/npm-link/">npm-link æ–¹å¼</a> å°†å‰ç«¯ç»„ä»¶ link åˆ°åœºæ™¯ UI ä¸­å®Œæˆå¼€å‘/è”è°ƒ/bug ä¿®æ”¹å·¥ä½œã€‚<br>æœ€è¿‘å‰ç«¯åŒå­¦å‘ç°ï¼Œnpm-link æ–¹å¼å¼•å…¥çš„å‰ç«¯ç»„ä»¶ä¸­å¼•å…¥ VUEXï¼Œä¸”å¯¹ store å±æ€§ watch äº‹ä»¶æ˜¯ä¸ä¼šç”Ÿæ•ˆã€‚<br>ä¸ªäººè§‰å¾—ä¸åº”è¯¥ï¼Œnpm-link å°±ç®€å•çš„å°†å‰ç«¯ç»„ä»¶ link åˆ° UIï¼Œå¯ä»¥è¯´æ˜¯<strong>åŸå°</strong>ä¸åŠ¨ï¼ŒåŒ…æ‹¬ <code>node_modules</code>ï¼ˆæœ€åå‘ç°ä¹Ÿååœ¨æ­¤å¤„ï¼‰ã€‚<br>æœç´¢ google å’Œç™¾åº¦éƒ½æ²¡æœ‰æœ‰æ•ˆçš„å¸–å­ã€‚</p><h2 id="tiger-é—®é¢˜è·Ÿè¿›"><a href="#tiger-é—®é¢˜è·Ÿè¿›" class="headerlink" title=":tiger: é—®é¢˜è·Ÿè¿›"></a><span class="github-emoji"><span>ğŸ¯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜è·Ÿè¿›</h2><h3 id="one-ææ‡‚-VUEX-store-çš„-watch-åŸç†"><a href="#one-ææ‡‚-VUEX-store-çš„-watch-åŸç†" class="headerlink" title=":one: ææ‡‚ VUEX store çš„ watch åŸç†"></a><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ææ‡‚ VUEX store çš„ watch åŸç†</h3><p><strong>store watch çš„åˆå§‹åŒ–</strong></p><p><code>vue</code> åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ <code>initState</code> å…¶ä¸­ï¼Œä¼šé’ˆå¯¹æœ¬ <code>vue</code> çš„ watch å®Œæˆ <code>initWatch</code> åˆå§‹åŒ–ã€‚å…¶ä¸­åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>Vue.prototype.$watch</code> (æ³¨æ„ï¼Œæ­¤å¤„åˆå§‹åŒ–ç”¨åˆ°çš„è¿˜æ˜¯ vue åŸå‹æ–¹æ³• $watch) å…¶ä¸­ä¼šè§¦å‘ä¸€æ¬¡ <code>watch handler</code> æ–¹æ³•ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token string">"callback for immediate watcher \""</span> <span class="token operator">+</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">;</span>      <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">invokeWithErrorHandling</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">[</span>watcher<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ <code>new Watcher</code> å¯¹è±¡ç¬¬ä¸€æ¬¡è·å– <code>watcher.value</code> æ—¶ï¼Œè§¦å‘ <code>watcher</code> å¯¹è±¡çš„ Dep ä¾èµ–ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">Watcher</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Watcher</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>  expOrFn<span class="token punctuation">,</span>  cb<span class="token punctuation">,</span>  options<span class="token punctuation">,</span>  isRenderWatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// éšè—ä¸éœ€è¦å…³æ³¨çš„ä»£ç </span>  <span class="token comment">// parse expression for getter</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop<span class="token punctuation">;</span>    <span class="token comment">// éšè—ä¸éœ€è¦å…³æ³¨çš„ä»£ç </span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy    <span class="token operator">?</span> <span class="token keyword">undefined</span>    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æŒ‡å®š Dep.target ä¸º watcher</span>  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> value<span class="token punctuation">;</span>  <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"getter for watcher \""</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> e    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// é€€å‡º Dep.target çš„æŒ‡å‘  </span>    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// è§¦å‘çœŸå® get æ—¶ï¼Œå®Œæˆäº† watcher çš„ Dep ä¾èµ–</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¿½ç•¥ set</span>    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>                childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// å®Œæˆ Dep.target æ·»åŠ ä¾èµ–ï¼Œæ­¤æ—¶çš„ Dep.target æ˜¯ watther æœ¬èº«ã€‚è€Œ this ä¸º store çš„ dep å¯¹è±¡ã€‚</span><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">depend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// watcher å®Œæˆ addDepæ—¶ï¼Œé™¤äº†ç»™è‡ªèº« depIdå’Œ deps åŠ ä¸Š store depå¯¹è±¡ï¼ŒåŒæ ·æŠŠè‡ªèº«watcherä½œä¸º store dep çš„å­å…³è”</span><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addDep</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Dep.prototype.depend</code> å®Œæˆè°ƒç”¨æ—¶ï¼Œstore watcher å·²ç»å®Œæˆä¸ store çš„ dep å¯¹è±¡çš„ç»‘å®šè¿‡ç¨‹ã€‚ä»¥ä¸Š <code>store watch init</code> çš„é“¾è·¯å¦‚ä¸‹ï¼Œ</p><pre class="line-numbers language-none"><code class="language-none">depend (vue.common.dev.js:726)reactiveGetter (vue.common.dev.js:1038)prototypeAccessors$1.state.get (vuex.esm.js:438)ï¼ˆåŒ¿åï¼‰ (vue.common.dev.js:514)get (vue.common.dev.js:4490)Watcher (vue.common.dev.js:4479)Vue.$watch (vue.common.dev.js:4953)createWatcher (vue.common.dev.js:4913)initWatch (vue.common.dev.js:4895)initState (vue.common.dev.js:4656)Vue._init (vue.common.dev.js:5010)VueComponent (vue.common.dev.js:5157)createComponentInstanceForVnode (vue.common.dev.js:3307)init (vue.common.dev.js:3136)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>store watch çš„è§¦å‘</strong></p><p><code>this.$store.commit('xxx', xxxx)</code> è§¦å‘æ—¶ï¼Œåœ¨æ”¹å€¼çš„åŒäº‹ä¼šè§¦å‘æœ¬ store Dep çš„ notify ï¼ˆé€šçŸ¥ï¼‰ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¿½ç•¥ get</span>    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>        <span class="token comment">/* eslint-disable no-self-compare */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment">/* eslint-enable no-self-compare */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// #7981: for accessor properties without setter</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// è§¦å‘é€šçŸ¥</span>        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">notify</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¿½ç•¥ä¸é‡è¦ä»£ç </span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// watcher update</span>    subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ <code>notify</code> çš„ä¸­éå† Dep çš„ subs å¹¶æ›´æ–°ï¼Œæ­¤å¤„å›æƒ³ watcher åˆå§‹åŒ–æ—¶ <code>watcher#addDep</code> å¯è§ subs æ˜¯åŒ…å« watcher çš„ï¼Œæ‰€ä»¥ store å±æ€§å˜åŒ–ä¹Ÿå°±èƒ½é€šçŸ¥åˆ° watcher äº†ã€‚<code>store watch notify</code> çš„é“¾è·¯å¦‚ä¸‹ï¼Œ</p><pre class="line-numbers language-none"><code class="language-none">handler (list_left.vue:411)invokeWithErrorHandling (vue.common.dev.js:1868)run (vue.common.dev.js:4579)flushSchedulerQueue (vue.common.dev.js:4323)ï¼ˆåŒ¿åï¼‰ (vue.common.dev.js:1994)flushCallbacks (vue.common.dev.js:1920)Promise.thenï¼ˆå¼‚æ­¥ï¼‰timerFunc (vue.common.dev.js:1947)nextTick (vue.common.dev.js:2004)queueWatcher (vue.common.dev.js:4415)update (vue.common.dev.js:4555)notify (vue.common.dev.js:741)reactiveSetter (vue.common.dev.js:1066)proxySetter (vue.common.dev.js:4639)changeAjlb (nav.vue:431)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šï¼Œ<strong>watcher init</strong> å’Œ <strong>watcher è§¦å‘</strong> æ€»ç»“æ¥è¯´å°±æ˜¯è¿™ä¸ªå›¾ã€‚</p><p><img src="/images/2023/npm_link_vuex_watch/link.png"></p><h3 id="two-ä¸ºå•¥-npm-link-ä¸èƒ½è§¦å‘-store-watch"><a href="#two-ä¸ºå•¥-npm-link-ä¸èƒ½è§¦å‘-store-watch" class="headerlink" title=":two: ä¸ºå•¥ npm-link ä¸èƒ½è§¦å‘ store watch"></a><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸ºå•¥ npm-link ä¸èƒ½è§¦å‘ store watch</h3><p>ææ‡‚äº†ï¼Œstore watcher è¿™æ‘Šå­äº‹æƒ…ï¼Œæ’æŸ¥å°±ç›¸å¯¹ç®€å•äº†ã€‚**æŠ“ä½ 1 ä¸ªä½ç½®å³å¯ï¼Œåœ¨ <code>initWatcher</code> çš„æ—¶å€™æ˜¯å¦å®Œæˆäº† <code>Watcher#addDep</code>ã€‚<br>** ç»“æœå‘ç°ï¼Œåœ¨ <code>Watcher.prototype.get</code>æ–¹æ³•ä¸­ <code>pushTarget(this)</code>  Dep æŒ‡å‘ <code>webpack://${web_app}/./node_nodules/vue/dist/vue,common.dev.js</code>ã€‚<br>è€Œåœ¨ <code>Object.defineProperty#get</code> æ–¹æ³•ä¸­ <code>Dep.target</code> ä»£ç  Dep æŒ‡å‘<br><code>webpack://${web_app}/${web_component}/node_modules/vue/dist/vue.common.dev.js</code>ã€‚<br>æ‘†æ˜ Dep å·²ç»ä¸æ˜¯åŸæ¥çš„ Dep äº†ï¼Œå¯¼è‡´ store Dep ä¸ watcher æ²¡åŠ æˆï¼Œå¯¼è‡´ store watcher ä¸è¢«è§¦å‘ã€‚</p><p><strong>æ­¤æ—¶ï¼Œæˆ‘å›æƒ³å¹¸å¥½æ˜¯ä¸ªå¥³ç”Ÿï¼Œä¸ç„¶æˆ‘å°±å»æ¥¼ä¸‹æŠ½æ ¹çƒŸäº†ã€‚è¿™ä¸ªåç«¯ jar åŒ…å†²çªå¯å¤ªåƒäº†ã€‚</strong></p><h3 id="three-å¦‚ä½•è§£å†³é—®é¢˜"><a href="#three-å¦‚ä½•è§£å†³é—®é¢˜" class="headerlink" title=":three: å¦‚ä½•è§£å†³é—®é¢˜"></a><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚ä½•è§£å†³é—®é¢˜</h3><p>åœ¨åœºæ™¯å±‚å°† vue å®šä¹‰æˆ window å…¨å±€å¯¹è±¡ã€‚åœ¨ç»„ä»¶å†…ä½¿ç”¨ <code>window.Vue</code> è£…è½½  vuexã€‚è‡ªæ­¤ï¼Œé—®é¢˜ç»ˆç»“ã€‚ä¿®æ”¹æ–¹å¼ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// åœ¨å‰ç«¯åº”ç”¨å…¥å£æ–‡ä»¶ä¸­</span><span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span><span class="token keyword">import</span> vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>Vue <span class="token operator">=</span> vue<span class="token punctuation">;</span>vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åœ¨è¢«å¼•ç”¨çš„ç»„ä»¶å…¥å£æ–‡ä»¶ä¸­</span><span class="token keyword">import</span> vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rabbit-æ€»ç»“"><a href="#rabbit-æ€»ç»“" class="headerlink" title=":rabbit: æ€»ç»“"></a><span class="github-emoji"><span>ğŸ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f430.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ€»ç»“</h2><ol><li>npm-link å›ºç„¶è§£å†³äº†ä¸ç”¨è€æ”¹ç»„ä»¶ç‰ˆæœ¬å·è°ƒè¯•çš„é—®é¢˜ï¼Œä½†å› ä¸º npm-link çš„ç»„ä»¶ä¼šä½¿ç”¨è‡ªèº«çš„ node_modules å¯¼è‡´ï¼Œéƒ¨åˆ†åŸæœ¬æœŸæœ›ä¸åœºæ™¯ ui å…±äº«çš„å¯¹è±¡å¯èƒ½ä¸å…±äº«ã€‚</li><li>å‰ç«¯ä»£ç æ’æŸ¥ç¡®æ˜¯ä¸å¦‚åç«¯ä»£ç æ’æŸ¥æ–¹ä¾¿ï¼Œå•¥ <code>console.warn</code> éƒ½ä¹ˆå¾—è€—æ—¶é•¿ã€‚</li></ol><h2 id="sheep-é™„ä»¶"><a href="#sheep-é™„ä»¶" class="headerlink" title=":sheep: é™„ä»¶"></a><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é™„ä»¶</h2><ul><li><a href="https://segmentfault.com/a/1190000016208088">Vueæºç è§£è¯»ä¹‹Dep,Observerå’ŒWatcher</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> code </category>
          
      </categories>
      
      
        <tags>
            
            <tag> npm-link </tag>
            
            <tag> code </tag>
            
            <tag> npm </tag>
            
            <tag> å‰ç«¯ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlab ä¸Šå’Œé¡¹ç›®å¤§ä»“åº“è¯´å†è§</title>
      <link href="/2023/03/27/gitlab-shang-he-xiang-mu-da-cang-ku-shuo-zai-jian/"/>
      <url>/2023/03/27/gitlab-shang-he-xiang-mu-da-cang-ku-shuo-zai-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="cat-èƒŒæ™¯"><a href="#cat-èƒŒæ™¯" class="headerlink" title=":cat: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ±</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p><code>git clone</code> é¡¹ç›®è€—æ—¶å¾ˆé•¿ã€‚åŸå› ï¼Œç½‘é€Ÿæ…¢æˆ–æ˜¯ä»£ç ä»“åº“æ–‡ä»¶å¾ˆå¤§(n+ G)ã€‚æœ¬ç¯‡æ–‡ç« å°±è®²è¿°å¦‚ä½•ç»™ <code>gitlab</code> ä»£ç ä»“åº“å‡è´Ÿã€‚</p><h3 id="dog-åŸºç¡€çŸ¥è¯†"><a href="#dog-åŸºç¡€çŸ¥è¯†" class="headerlink" title=":dog: åŸºç¡€çŸ¥è¯†"></a><span class="github-emoji"><span>ğŸ¶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f436.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŸºç¡€çŸ¥è¯†</h3><p>é¡¹ç›®åœ¨ gitlab ä¸­æ˜¾ç¤ºçš„ä»“åº“å¤§å° = é¡¹ç›®æ–‡ä»¶æ€»å¤§å° + <code>.git</code> ï¼ˆéšè—ï¼‰ç›®å½•ä¸‹æ–‡ä»¶å¤§å°ã€‚è¯·è®¤çœŸå…³æ³¨ä½ é¡¹ç›®ç›®å½•æ–‡ä»¶å¤§å°ï¼ˆwindows å¯ä»¥ç”¨ <a href="https://www.jam-software.com/treesize_free">treesize free</a> / <a href="http://www.uderzo.it/main_products/space_sniffer/download_alt.html">SpaceSniffer</a> å·¥å…·ï¼Œlinux å¯ä»¥ç”¨å‘½ä»¤ <code>du -h â€“max-depth=1 *</code>ï¼Œmac å‘½ä»¤ <code>du -h -d 1 *</code> ï¼‰ï¼Œä¸€èˆ¬ <code>.git</code> ç›®å½•ä¸‹æ–‡ä»¶å¤§å° &gt;= é¡¹ç›®æ–‡ä»¶å¤§å°ã€‚æ„å‘³ç€ï¼Œé¡¹ç›®æ•´ä½“ä¸‹è½½ç©ºé—´å ç”¨ &gt;= 2 * é¡¹ç›®æ–‡ä»¶å¤§å°ã€‚æ‰€ä»¥ï¼Œå¦‚æœé¡¹ç›®ä¸­åŒ…å«æ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œä¾‹å¦‚è§†é¢‘ï¼Œé«˜æ¸…ç…§ç‰‡ç­‰ï¼ŒæŠŠ gitlab å½“åšäº†<strong>å…±äº«å¤‡ä»½å­˜å‚¨ç©ºé—´</strong>æ˜¯é¡¹ç›®æ–‡ä»¶å¤§çš„ç½ªé­ç¥¸æ‰‹ã€‚æ‰€ä»¥ï¼Œé¡¹ç›®åˆæœŸä»£ç ä¸€å®šå’Œéœ€æ±‚æ–‡æ¡£åšå‰¥ç¦»ï¼Œé™¤éä½ çš„é¡¹ç›®è¶³å¤Ÿçš„å°ã€‚</p><h3 id="fish-æ‹¯æ•‘-git-ä»“åº“"><a href="#fish-æ‹¯æ•‘-git-ä»“åº“" class="headerlink" title=":fish: æ‹¯æ•‘ git ä»“åº“"></a><span class="github-emoji"><span>ğŸŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ‹¯æ•‘ git ä»“åº“</h3><p>å¯¹äºéœ€æ±‚æ–‡æ¡£ç±»é¡¹ç›®è€Œè¨€ï¼Œå»ºè®®ç”¨ <code>git lfs</code> åšå¤§æ–‡ä»¶ç®¡ç†ï¼ˆæ­¤å¤„ <code>git lfs</code> ä¸åšè¿‡å¤šä»‹ç»ï¼Œè¯·ç‚¹å‡»<a href="https://git-lfs.github.com/">é“¾æ¥</a>äº†è§£ï¼‰ã€‚è¯·å¤šæƒ³æƒ³åé¢åŠ å…¥çš„éœ€æ±‚äººï¼Œç»™ä»–ä»¬çš„åŠ å…¥å‡å°‘ä¸€äº›ç»Šè„šçŸ³ã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä»…ä½¿ç”¨å‡ æ¬¡ï¼Œè¿‡ä¸€ä¸ªæœˆä¹‹ååŸºæœ¬ä¸ç¿»çš„ä¸œè¥¿ã€æ— éœ€ç‰ˆæœ¬ç®¡ç†ã€å†…å®¹è¶…è¿‡ 100 MB çš„è§†é¢‘ï¼Œè¯·æ…é‡æ”¾å…¥ git ä»“åº“</p></blockquote><h3 id="whale-åˆ†æ-git-å¤§ä»“åº“"><a href="#whale-åˆ†æ-git-å¤§ä»“åº“" class="headerlink" title=":whale: åˆ†æ git å¤§ä»“åº“"></a><span class="github-emoji"><span>ğŸ³</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ†æ git å¤§ä»“åº“</h3><ul><li><p>windows ä¸Šä½¿ç”¨ <code>TreeSize Free</code>  çœ‹çœ‹æ–‡ä»¶å¤§å°å æ¯”åˆ†å¸ƒã€‚å‘ç°ï¼Œé¡¹ç›®æœ¬èº«æ–‡ä»¶å¤§å°å¤§çº¦ 900 MB ï¼Œ<code>.git</code> ç›®å½•åƒæ‰ 2.6 GBã€‚åŸå› ï¼Œå…¶å®ä¸Šé¢åŸºç¡€çŸ¥è¯†ç®—æ˜¯è§£ç­”äº†ä¸€éƒ¨åˆ†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒé™„ä»¶<strong>git åŸç†</strong>æ‰¾ç­”æ¡ˆã€‚</p><p><img src="/images/2023/gitlab_bigcodes/directory_image.png"></p></li><li><p>ä½¿ç”¨ <code>git verify-pack</code>  å‘½ä»¤è¿è¡Œ  <code>git verify-pack -v .git/objects/pack/pack-f0fa1a09cd9ebf8874e4ecafa9e56be7816097de.idx|sort -k 3 -n| tail -10</code> ï¼ŒæŸ¥æ‰¾å‡ºæ–‡ä»¶å¤§å°åœ¨å‰ 10 çš„æ–‡ä»¶ hash æ ‡è¯†ã€‚æ³¨æ„ï¼Œwindows ä¸Šè¯·ä½¿ç”¨ <code>git Bash Here </code> è¿è¡Œã€‚</p><p><img src="/images/2023/gitlab_bigcodes/git_xpack.png"></p></li><li><p>ä½¿ç”¨å‘½ä»¤ <code>git rev-list</code> è¿è¡Œ <code>git rev-list --objects --all|grep  hashId </code> å®šä½å¤§æ–‡ä»¶è·¯å¾„ã€‚æ­¤å¤„ï¼Œå¤„ç†æ–‡ä»¶å¤§å°è¶…è¿‡ 100 MBã€‚</p><p><img src="/images/2023/gitlab_bigcodes/directory_file.png"></p></li><li><p>æŒ‰ç…§è·¯å¾„å’Œ <code>git log</code> æŸ¥æ‰¾æäº¤äººï¼Œç¡®å®šæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸”æ˜¯å¦éœ€è¦å­˜åœ¨ã€‚ç¡®å®šéœ€è¦æ¸…ç†çš„ä¸º <code>xxxx.asf</code> å’Œ <code>xxx.asf</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚å·²ç»åˆ é™¤çš„æ–‡ä»¶ï¼Œå´åœ¨æ—¥å¿—é‡Œèƒ½æœç´¢å‡ºæ¥ï¼ŒåŸå› æ˜¯é˜²æ­¢ä½ æ‰§è¡Œ <code>git revert</code> è¿˜åŸåˆ°åˆ é™¤å‰çš„ commitId ç‰ˆæœ¬ã€‚æ‰€ä»¥ï¼Œæ¸…ç†åŸåˆ™å°±æ˜¯éœ€è¦<strong>æ˜ç¡®</strong>å“ªäº›æ–‡ä»¶è¦åˆ é™¤ï¼Œæ²¡æœ‰æœºä¼šè¿˜åŸçš„è¯ï¼Œå°±åˆ é™¤å§ã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœ‰é‡å‘½å/ç§»åŠ¨ç›®å½•éœ€æ±‚ï¼Œè¯·ä½¿ç”¨ <code>git mv</code>  å‘½ä»¤ï¼Œè€Œè¾¾åˆ°ç›®å½•å˜æ›´åŠå‘½ååŠŸèƒ½ã€‚ä¸è¦ä½¿ç”¨ <code>git mv</code> å’Œ <code>git add</code> çš„æ–¹å¼ï¼Œå®Œæˆæ–‡ä»¶é‡å‘½åæˆ–ç§»åŠ¨ç›®å½•ã€‚è¿™æ ·ä¼šé€ æˆæœ‰åˆ é™¤çš„ç”¨ä¸åˆ°çš„è®°å½•ã€‚</p></blockquote></li></ul><h2 id="dolphin-å¦‚ä½•æ¸…ç†"><a href="#dolphin-å¦‚ä½•æ¸…ç†" class="headerlink" title=":dolphin: å¦‚ä½•æ¸…ç†"></a><span class="github-emoji"><span>ğŸ¬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚ä½•æ¸…ç†</h2><blockquote><p>åœ¨æ¸…ç†ä¹‹å‰ï¼Œå»ºè®®æ‰€æœ‰äººçš„åˆ†æ”¯éƒ½ push åˆ°è¿œç«¯ã€‚å¦åˆ™ï¼Œå…¶ä»–äººçš„æ¯æ¬¡çš„ push éƒ½ä¼šè®©ä½ çš„æ¸…ç†éƒ½éœ€è¦é‡æ–°æ¥ä¸€æ¬¡ã€‚</p></blockquote><p>ç›®å‰ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li><p>git åŸç”Ÿæ”¯æŒçš„ <code>filter-branch</code> åˆ†æ”¯æ–‡ä»¶ï¼Œå‘½ä»¤ <code>git filter-branch --force --tree-filter 'rm -f path/to/big_file.mpg' HEAD</code> ã€‚ï¼ˆä¸æ¨èã€‚å¯¹äºè¶…å¤š commit çš„é¡¹ç›®ï¼Œ<code>filter-branch</code> æ…¢çš„æ€€ç–‘äººç”Ÿï¼Œå°ç¼–å°±æ˜¯ä» <code>git filter-branch</code> æ”¾å¼ƒï¼Œè½¬æŠ• <code>BFG</code>ï¼‰</p></li><li><p><code>BFG</code> å·¥å…·</p><ul><li><p>æ‰§è¡Œå‘½ä»¤ <code>git clone --mirror git-repository-url</code>  clone git ä»“åº“</p></li><li><p>æ‰§è¡Œå‘½ä»¤ <code>java -jar bfg.jar --massive-non-file-objects-sized-up-to 100M --delete-files '{xxx.asf,xxx.asf}' thunisoft-mvd.git</code>ã€‚</p><blockquote><p><code>BFG</code> å¯¹äºéœ€è¦æ¸…ç†çš„ history ä¼šæ›´æ”¹æ¶‰åŠæ–‡ä»¶çš„æäº¤çš„ commit-idã€‚å…·ä½“è€æ–° commit-id çš„å¯¹åº”å…³ç³»æ–‡ä»¶åœ¨ <code>thunisoft-mvd.git.bfg-report\2020-07-17\16-14-13\object-id-map.old-new.txt</code> ä¸­<br>æ­¤æ—¶ï¼Œ<code>.git/objects</code> ä¸‹çš„  <code>pack/xxxxx.pack</code>  æ–‡ä»¶ä¼šè¢«è§£å‹ä¸º  n ä¸ª <code>git objects</code> å¯¹è±¡æ–‡ä»¶</p></blockquote></li></ul><p>  <img src="/images/2023/gitlab_bigcodes/log_for_bfg.png"></p></li><li><p>æ‰§è¡Œå‘½ä»¤ <code>git reflog expire --expire=now --all &amp;&amp; git gc --prune=now --aggressive</code> ï¼Œå°† git object å¯¹è±¡å‹ç¼©ã€‚è€Œåï¼Œæ‰§è¡Œå‘½ä»¤ <code>git push</code> æ¨é€è¿œç«¯ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ¨é€ä¹‹å‰è§£é™¤ä»“åº“çš„ <code>Protected Branches</code> çš„é…ç½®</p></blockquote></li></ul><p>  <img src="/images/2023/gitlab_bigcodes/git_compress.png"></p><ul><li>è¯·é¡¹ç›®ç»„æ‰€æœ‰æˆå‘˜æ”¾å¼ƒåŸæœ¬çš„æœ¬åœ°é¡¹ç›®ä»“åº“ï¼Œé‡æ–° clone git é¡¹ç›®ã€‚å› ä¸ºï¼Œå¦‚æœç”¨åŸæ¥çš„ä»“åº“ä½ ä¼šå‘ç°æœ¬åœ° <code>.git</code> ä¼šæ›´å¤§ï¼Œå› ä¸ºé™¤äº† <code>git gc</code> é‡æ–°ç”Ÿæˆçš„ <code>pack</code> æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜æœ‰æœ¬åœ°æœ¬èº«è€çš„ <code>pack</code> æ–‡ä»¶ã€‚</li></ul><p><strong>æœ€ç»ˆå’Œæ´¾ç”Ÿé¡¹ç›®å¯¹æ¯”ï¼Œé™¤ <code>.git</code> ç›®å½•å¤–å…¶ä»–ç›¸åŒã€‚</strong></p><p><img src="/images/2023/gitlab_bigcodes/gitcode_compare.png"></p><p><strong>ä¸ºä»€ä¹ˆå­˜åœ¨ä¸åˆ° 1 KB çš„æ–‡ä»¶ï¼Ÿå› ä¸ºï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ <code>git lfs</code> åšäº†å¤§æ–‡ä»¶ç®¡ç†ï¼Œä½¿ç”¨ <code>git lfs pull</code> å¯ä»¥ä»è¿œç«¯æ‹‰ä¸‹ 1 KB æ˜ å°„çš„åŸæ–‡ä»¶</strong><br><strong><font color="red">æ¸…ç†å®Œæˆï¼Œ2.4 GB -&gt; 1.1 GB çš„è½¬èº«</font></strong></p><h2 id="lion-ç‰¹åˆ«è¯´æ˜"><a href="#lion-ç‰¹åˆ«è¯´æ˜" class="headerlink" title=":lion: ç‰¹åˆ«è¯´æ˜"></a><span class="github-emoji"><span>ğŸ¦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f981.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç‰¹åˆ«è¯´æ˜</h2><ul><li>é¡¹ç›®ä½¿ç”¨ <code>git lfs</code> ç®¡ç†å¤§æ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>BFG</code> æ¸…ç†å®Œå¯¹é¡¹ç›®æœ¬èº«æ²¡æœ‰ä»»ä½•å½±å“ã€‚ç…§æ ·ï¼Œå¯ä»¥ä½¿ç”¨ <code>git lfs</code> å‘½ä»¤ç®¡ç†æ–‡ä»¶ã€‚</li><li>çœŸå®é¡¹ç›®åœ¨æ¸…ç†å‰ï¼Œè¯·å…ˆæŒ‰ç…§æœ¬æ–‡å…ˆ <code>clone</code> å‡ºä¸€ä»½ï¼Œç†Ÿæ‚‰ä¸€ä¸‹æ¸…ç†æµç¨‹ï¼Œæ›´æœ‰åº•æ°”ã€‚</li></ul><h2 id="horse-é™„å½•"><a href="#horse-é™„å½•" class="headerlink" title=":horse: é™„å½•"></a><span class="github-emoji"><span>ğŸ´</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f434.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é™„å½•</h2><ul><li><a href="http://www.ruanyifeng.com/blog/2018/10/git-internals.html">git åŸç†-é˜®ä¸€å³°</a></li><li><a href="https://zhuanlan.zhihu.com/p/45510461">git åŸç†</a></li><li><a href="https://docs.github.com/cn/github/managing-large-files/removing-files-from-git-large-file-storage#removing-a-single-file">git å¤§æ–‡ä»¶æ¸…ç†-github</a></li><li><a href="http://gitlab.thunisoft.com/help/user/project/repository/reducing_the_repo_size_using_git.md">git å¤§æ–‡ä»¶æ¸…ç†-gitlab</a>ï¼Œç›®å‰ä¸ç”¨ä¸Šä¼  <code>object-id-map.old-new.txt</code> æ–‡ä»¶ï¼Œèµ° â€œå¼€å§‹æ¸…ç†â€ è¿™æ­¥éª¤</li><li><a href="https://rtyley.github.io/bfg-repo-cleaner/">git BFG</a></li><li><a href="https://learngitbranching.js.org/?locale=zh_CN">git ç»ƒä¹ åœº</a></li><li><a href="https://git-scm.com/book/zh/v2">git å­¦ä¹ æ–‡æ¡£</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> æ‚é¡¹ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> gitlab </tag>
            
            <tag> BFG </tag>
            
            <tag> æ‚é¡¹ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
