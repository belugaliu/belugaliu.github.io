<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>spring-securityä¸­é‡è§çš„è€—æ—¶å°å‘</title>
      <link href="/2023/04/10/spring-security-zhong-yu-jian-de-hao-shi-xiao-keng/"/>
      <url>/2023/04/10/spring-security-zhong-yu-jian-de-hao-shi-xiao-keng/</url>
      
        <content type="html"><![CDATA[<h2 id="pear-èƒŒæ™¯"><a href="#pear-èƒŒæ™¯" class="headerlink" title=":pear: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f350.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>å®¢æˆ·ç°åœºè¿ç»´åŒäº‹åé¦ˆæŸç³»ç»Ÿè¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åã€å¯†ç åï¼Œæ— æ³•è¿›å…¥ç³»ç»Ÿé¦–é¡µã€‚åœ°å€æ ä¸­åœ°å€å´åœ¨ SSO server å’Œç³»ç»Ÿåœ°å€ä¹‹é—´æ¥å›è·³è½¬ï¼Œç³»ç»Ÿæ—¥å¿—ä¸­ä¹Ÿæ²¡æœ‰ç›¸å…³çš„æ—¥å¿—æä¾›çº¿ç´¢ã€‚å¬åˆ°è¿™é‡Œå°±æ™“å¾—ï¼Œä¸æ˜¯ä¸€ä¸ªè¿ç»´åŒå­¦åœ¨ç™½ç›’çš„æƒ…å†µä¸‹ï¼Œèƒ½è§£å†³çš„é—®é¢˜äº†ã€‚</p><h2 id="orange-é—®é¢˜è·Ÿè¿›"><a href="#orange-é—®é¢˜è·Ÿè¿›" class="headerlink" title=":orange: é—®é¢˜è·Ÿè¿›"></a><span class="github-emoji"><span>ğŸŠ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34a.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜è·Ÿè¿›</h2><h3 id="one-æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€"><a href="#one-æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€" class="headerlink" title=":one: æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€"></a><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ˜ç¡®è¿ç»´è¯´ã€æ¥å›è·³è½¬ã€åˆ°åº•æ¶‰åŠé‚£äº›åœ°å€</h3><p>è®©è¿ç»´åŒå­¦ F12 æ‰“å¼€ chrome æµè§ˆå™¨å¼€å‘è€…æ¨¡å¼ï¼Œåˆ‡æ¢ Network é¡µç­¾å‹¾é€‰ <code>Preserve log</code>ï¼ˆä¿ç•™è¯·æ±‚æ—¥å¿—ï¼‰ï¼Œå°±èƒ½è®°å½•æµè§ˆå™¨ã€æ¥å›è·³è½¬ã€ç½‘ç»œè¯·æ±‚ã€‚</p><pre class="line-numbers language-none"><code class="language-none">${åº”ç”¨}/login/cas?st=xxxxx${SSO-server}/login?service=encodeURIComponent(${åº”ç”¨}/login/cas)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre><p>å°±æ˜¯è¿™ä¸¤ä¸ªåœ°å€ã€æ¥å›è·³è½¬ã€ã€‚ä»è¿™é‡Œèƒ½å¾—åšå‡ºå¦‚ä¸‹æ¨æ–­:</p><ol><li>SSO server æœåŠ¡ä¾æ® cookie ä¸­çš„ TGT éªŒè¯æ˜¯é€šè¿‡çš„ã€‚å¦åˆ™ï¼Œæ­¤å¤„å±•ç¤ºçš„å°±æ˜¯ç™»å½•é¡µé¢ã€‚</li><li>åº”ç”¨ <code>/login/cas</code> è¯·æ±‚ï¼Œé€šè¿‡åå°è°ƒç”¨ SSO server çš„ validate æ¥å£å®Œæˆ stï¼ˆ<code>service ticket</code>ï¼‰éªŒè¯ï¼Œæ˜¾ç„¶è¿™é‡Œæ˜¯ä¸é€šè¿‡çš„ã€‚å¦åˆ™ï¼Œæ­¤å¤„å±•ç¤ºçš„å°±æ˜¯åº”ç”¨é¦–é¡µé¢ã€‚</li></ol><p>æ€»ç»“ï¼Œè¯´æ˜é—®é¢˜å‡ºåœ¨åº”ç”¨ <code>/login/cas</code> è¯·æ±‚è®¤è¯ä¸­ï¼Œè™½ç„¶ä¸æ•¢ç›¸ä¿¡ä½†ã€äº‹å®èƒœäºé›„è¾©ã€ã€‚</p><h3 id="two-åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› "><a href="#two-åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› " class="headerlink" title=":two: åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› "></a><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åœ¨åº”ç”¨åç«¯æ‰¾æ‰¾åŸå› </h3><p>ä¸ºä»€ä¹ˆä¸Šé¢è¯´ <code>/login/cas</code> ä¸æ•¢ç›¸ä¿¡æœ‰é—®é¢˜ï¼Œå› ä¸ºåº”ç”¨åç«¯ä½¿ç”¨ <code>spring-security-cas</code> ç»„ä»¶ï¼Œè€Œè¿™ä¸ªç»„ä»¶æ€•æ˜¯æœ‰æˆåƒä¸Šä¸‡çš„é¡¹ç›®ä½¿ç”¨å·²ç»æ˜¯å¾ˆä¼˜ç§€çš„ç»„ä»¶ï¼Œéš¾é“è¢«æˆ‘ç¢°è§å¼€æºçš„ BUG äº†ï¼Ÿ</p><p><code>spring-security-cas</code> ç»„ä»¶ï¼Œæœ‰å‡ ä¸ªé‡è¦ç»„æˆç±»ï¼š</p><ul><li><code>CasAuthenticationFilter</code>ï¼š<code>CAS</code> éªŒè¯è¿‡æ»¤å™¨ï¼Œ<code>/login/cas</code> è¯·æ±‚éªŒè¯å…¥å£ã€‚å…¶ä¸­ï¼Œ <code>attemptAuthentication()</code> å…¶ä¸­åŒ…å«éªŒè¯æ–¹æ³• ï¼ŒéªŒè¯ä¸é€šè¿‡åˆ™æŠ›å‡º <code>AuthenticationException</code>ã€‚<code>successfulAuthentication</code> åˆ™æ˜¯éªŒè¯é€šè¿‡åæ‰§è¡Œé€»è¾‘ï¼Œå¯ä»¥æ˜¯é‡å®šå‘åˆ°é¦–é¡µï¼Œæˆ–æ˜¯ç»§ç»­è®¿é—®åç»­é€»è¾‘ã€‚<code>unsuccessfulAuthentication</code> åˆ™æ˜¯éªŒè¯å¤±è´¥åæ‰§è¡Œé€»è¾‘ï¼Œæ˜¯é‡å®šå‘åˆ° <code>/login</code> ç™»å½•è¯·æ±‚ã€‚</li><li><code>CasAuthenticationProvider</code>ï¼šçœŸæ­£çš„ CAS éªŒè¯å…¥å£ï¼Œä¸»è¦å®Œæˆ CAS éªŒè¯å’Œç”¨æˆ·æƒé™ä¿¡æ¯ç»„è£…ã€‚</li><li><code>AbstractCasProtocolUrlBasedTicketValidator</code>ï¼šè¢« <code>CasAuthenticationProvider</code> ç±»è°ƒç”¨ï¼Œå®Œæˆè°ƒç”¨ SSO server validate æ¥å£éªŒè¯<code>serviceTicket</code>ã€‚</li><li><code>AbstractCasAssertionUserDetailsService</code>ï¼šè¢« <code>CasAuthenticationProvider</code> ç±»è°ƒç”¨ï¼Œå®Œæˆç”¨æˆ·åŠæƒé™ä¿¡æ¯çš„è£…è½½ã€‚</li></ul><p>å…³é”®ä»£ç å¦‚ä¸‹ï¼Œå…¶ä¸­ä¼šå¯¼è‡´è¿›å…¥ <code>unsuccessfulAuthentication()</code> é€»è¾‘çš„ï¼Œæ˜¯æŠ›å‡º <code>TicketValidationException</code> å¼‚å¸¸ã€‚é‚£ä¹Ÿå°±æ˜¯ <code>ticketValidator.validate()</code> ã€ <code>authenticationUserDetailsService.loadUserDetails()</code> æˆ– <code>userDetailsChecker.check()</code> é€»è¾‘ç‚¹æŠ›å‡ºå¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token comment">// CasAuthenticationProvider</span><span class="token keyword">private</span> <span class="token class-name">CasAuthenticationToken</span> <span class="token function">authenticateNow</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Authentication</span> authentication<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">AuthenticationException</span> <span class="token punctuation">{</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    <span class="token class-name">Assertion</span> assertion <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>ticketValidator<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token function">getServiceUrl</span><span class="token punctuation">(</span>authentication<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token class-name">UserDetails</span> userDetails <span class="token operator">=</span> <span class="token function">loadUserByAssertion</span><span class="token punctuation">(</span>assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>userDetailsChecker<span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CasAuthenticationToken</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>key<span class="token punctuation">,</span> userDetails<span class="token punctuation">,</span> authentication<span class="token punctuation">.</span><span class="token function">getCredentials</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authoritiesMapper<span class="token punctuation">.</span><span class="token function">mapAuthorities</span><span class="token punctuation">(</span>userDetails<span class="token punctuation">.</span><span class="token function">getAuthorities</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDetails<span class="token punctuation">,</span> assertion<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TicketValidationException</span> ex<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">BadCredentialsException</span><span class="token punctuation">(</span>ex<span class="token punctuation">.</span>getMessage<span class="token punctuation">,</span> ex<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token keyword">protected</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserByAssertion</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Assertion</span> assertion<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">final</span> <span class="token class-name">CasAssertionAuthenticationToken</span> token <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CasAssertionAuthenticationToken</span><span class="token punctuation">(</span>assertion<span class="token punctuation">,</span> <span class="token string">""</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>authenticationUserDetailsService<span class="token punctuation">.</span><span class="token function">loadUserDetails</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>è€Œåï¼Œç°åœºé€šè¿‡ <code>arthas</code> å·¥å…·ä»£ç  <code>watch</code> å‘½ä»¤ï¼Œç›‘å¬ä»£ç æ˜ç¡®å¼‚å¸¸æŠ›å‡ºä½ç½®ã€‚æœ€åï¼Œæ˜¯åœ¨ <code>authenticationUserDetailsService.loadUserDetails()</code> åº”ç”¨è‡ªå·±å®ç°ç±»ä¸ŠæŠ›å‡ºäº†  <code>UsernameNotFoundException</code> å¼‚å¸¸ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">public</span> <span class="token class-name">UserDetails</span> <span class="token function">loadUserDetails</span><span class="token punctuation">(</span><span class="token class-name">CasAssertionAuthenticationToken</span> token<span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">&gt;</span></span> attributes <span class="token operator">=</span> <span class="token function">getPrincipalAttributes</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">MapUtils</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} æ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®"</span><span class="token punctuation">,</span> token<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span>token<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"æ²¡æœ‰é¢å¤–çš„å…ƒæ•°æ®"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> loginId <span class="token operator">=</span> <span class="token function">getLoginId</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">isBlank</span><span class="token punctuation">(</span>loginId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            log<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">"{} æ²¡æœ‰ç™»å½•æ ‡è¯†"</span><span class="token punctuation">,</span> loginId<span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">UsernameNotFoundException</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">.</span><span class="token function">format</span><span class="token punctuation">(</span><span class="token string">"%sæ²¡æœ‰ç™»å½•æ ‡è¯†"</span><span class="token punctuation">,</span> loginId<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token class-name">String</span> corpId <span class="token operator">=</span> <span class="token function">getCorpId</span><span class="token punctuation">(</span>attributes<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">UserDO</span> userDO <span class="token operator">=</span> <span class="token function">loadUserDO</span><span class="token punctuation">(</span>loginId<span class="token punctuation">,</span> corpId<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">GrantedAuthority</span><span class="token punctuation">&gt;</span></span> grantedAuthorities <span class="token operator">=</span> <span class="token function">getDefaultUserAuthorities</span><span class="token punctuation">(</span>userDO<span class="token punctuation">.</span><span class="token function">getId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">CommonUserDetails</span><span class="token punctuation">(</span>userDO<span class="token punctuation">.</span><span class="token function">getLoginId</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> userDO<span class="token punctuation">.</span><span class="token function">getPassword</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> grantedAuthorities<span class="token punctuation">,</span> userDO<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="three-åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ"><a href="#three-åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ" class="headerlink" title=":three: åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ"></a><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ°åº•æ˜¯ä¸ºä»€ä¹ˆæœ‰å¼‚å¸¸æ²¡æœ‰æ—¥å¿—è¾“å‡ºå‘¢ï¼Ÿ</h3><p>æœ€ç»ˆï¼Œè¿˜æ˜¯è¦å›åˆ°æ–‡é¦–ã€ç ´ã€ä»£ç æœ‰å¼‚å¸¸ï¼Œæ—¥å¿—æ–‡ä»¶å´æ— è®°å½•é—®é¢˜ã€‚å›å¤´ç»†çœ‹ <code>AbstractAuthenticationProcessingFilter.unsuccessfulAuthentication()</code> æ–¹æ³•ï¼Œå¼‚å¸¸æ—¥å¿—æ‰“å°å±…ç„¶æ˜¯  trace çº§åˆ«ï¼Œç°åœºæ—¥å¿—çº§åˆ«é…ç½®çš„ error çº§åˆ«ï¼Œæ•…ä»£ç æœ‰å¼‚å¸¸ï¼Œæ—¥å¿—æ–‡ä»¶å´æ— è®°å½•é—®é¢˜ã€‚</p><pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token keyword">protected</span> <span class="token keyword">void</span> <span class="token function">unsuccessfulAuthentication</span><span class="token punctuation">(</span><span class="token class-name">HttpServletRequest</span> request<span class="token punctuation">,</span><span class="token class-name">HttpServletResponse</span> response<span class="token punctuation">,</span> <span class="token class-name">AuthenticationException</span> failed<span class="token punctuation">)</span><span class="token keyword">throws</span> <span class="token class-name">IOException</span><span class="token punctuation">,</span> <span class="token class-name">ServletException</span> <span class="token punctuation">{</span><span class="token class-name">SecurityContextHolder</span><span class="token punctuation">.</span><span class="token function">clearContext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Failed to process authentication request"</span><span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Cleared SecurityContextHolder"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>logger<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">"Handling authentication failure"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>rememberMeServices<span class="token punctuation">.</span><span class="token function">loginFail</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">)</span><span class="token punctuation">;</span>failureHandler<span class="token punctuation">.</span><span class="token function">onAuthenticationFailure</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> response<span class="token punctuation">,</span> failed<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h3 id="banana-æœªæåŠçš„åŸºç¡€çŸ¥è¯†"><a href="#banana-æœªæåŠçš„åŸºç¡€çŸ¥è¯†" class="headerlink" title=":banana: æœªæåŠçš„åŸºç¡€çŸ¥è¯†"></a><span class="github-emoji"><span>ğŸŒ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f34c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœªæåŠçš„åŸºç¡€çŸ¥è¯†</h3><ul><li><a href="https://apereo.github.io/cas/6.6.x/index.html">CAS å®˜ç½‘</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> spring </category>
          
      </categories>
      
      
        <tags>
            
            <tag> spring-security </tag>
            
            <tag> cas </tag>
            
            <tag> relogin </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>npm-link VUEX watch æ€ä¹ˆä¸ç”Ÿæ•ˆ</title>
      <link href="/2023/04/02/npm-link-vuex-watch-zen-me-bu-sheng-xiao/"/>
      <url>/2023/04/02/npm-link-vuex-watch-zen-me-bu-sheng-xiao/</url>
      
        <content type="html"><![CDATA[<h2 id="cat-èƒŒæ™¯"><a href="#cat-èƒŒæ™¯" class="headerlink" title=":cat: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ±</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p>å‰ç«¯é¡¹ç›® <code>package.json</code> ç›¸å½“äºåç«¯ maven é¡¹ç›® pom.xml æ–‡ä»¶ç®¡ç†é¡¹ç›®ç»„ä»¶ä¾èµ–ã€‚éœ€è¦èµ° <code>npm install --save-dev xxxx</code> å¼•å…¥æ–¹å¼ã€‚<br>å¯¹äºé¡¹ç›®ä¸­å­˜åœ¨å¤šé¡¹ç›®å…±ç”¨çš„å‰ç«¯ç»„ä»¶å¼€å‘ï¼Œä¸å¸Œæœ›æ¯æ¬¡ä¿®æ”¹ä»¥å‘å¸ƒç‰ˆæœ¬å† <code>npm install</code> ä¸‹è½½åŒ…è°ƒè¯•ã€‚<br>å¯ä»¥é€‰ç”¨ <a href="https://docs.npmjs.com/cli/v9/commands/npm-link/">npm-link æ–¹å¼</a> å°†å‰ç«¯ç»„ä»¶ link åˆ°åœºæ™¯ UI ä¸­å®Œæˆå¼€å‘/è”è°ƒ/bug ä¿®æ”¹å·¥ä½œã€‚<br>æœ€è¿‘å‰ç«¯åŒå­¦å‘ç°ï¼Œnpm-link æ–¹å¼å¼•å…¥çš„å‰ç«¯ç»„ä»¶ä¸­å¼•å…¥ VUEXï¼Œä¸”å¯¹ store å±æ€§ watch äº‹ä»¶æ˜¯ä¸ä¼šç”Ÿæ•ˆã€‚<br>ä¸ªäººè§‰å¾—ä¸åº”è¯¥ï¼Œnpm-link å°±ç®€å•çš„å°†å‰ç«¯ç»„ä»¶ link åˆ° UIï¼Œå¯ä»¥è¯´æ˜¯<strong>åŸå°</strong>ä¸åŠ¨ï¼ŒåŒ…æ‹¬ <code>node_modules</code>ï¼ˆæœ€åå‘ç°ä¹Ÿååœ¨æ­¤å¤„ï¼‰ã€‚<br>æœç´¢ google å’Œç™¾åº¦éƒ½æ²¡æœ‰æœ‰æ•ˆçš„å¸–å­ã€‚</p><h2 id="tiger-é—®é¢˜è·Ÿè¿›"><a href="#tiger-é—®é¢˜è·Ÿè¿›" class="headerlink" title=":tiger: é—®é¢˜è·Ÿè¿›"></a><span class="github-emoji"><span>ğŸ¯</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é—®é¢˜è·Ÿè¿›</h2><h3 id="one-ææ‡‚-VUEX-store-çš„-watch-åŸç†"><a href="#one-ææ‡‚-VUEX-store-çš„-watch-åŸç†" class="headerlink" title=":one: ææ‡‚ VUEX store çš„ watch åŸç†"></a><span class="github-emoji"><span>1âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0031-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ææ‡‚ VUEX store çš„ watch åŸç†</h3><p><strong>store watch çš„åˆå§‹åŒ–</strong></p><p><code>vue</code> åˆå§‹åŒ–æ—¶ï¼Œä¼šè°ƒç”¨ <code>initState</code> å…¶ä¸­ï¼Œä¼šé’ˆå¯¹æœ¬ <code>vue</code> çš„ watch å®Œæˆ <code>initWatch</code> åˆå§‹åŒ–ã€‚å…¶ä¸­åˆå§‹åŒ–è¿‡ç¨‹ä¸­ä¼šè°ƒç”¨ <code>Vue.prototype.$watch</code> (æ³¨æ„ï¼Œæ­¤å¤„åˆå§‹åŒ–ç”¨åˆ°çš„è¿˜æ˜¯ vue åŸå‹æ–¹æ³• $watch) å…¶ä¸­ä¼šè§¦å‘ä¸€æ¬¡ <code>watch handler</code> æ–¹æ³•ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token class-name">Vue</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">$watch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isPlainObject</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">return</span> <span class="token function">createWatcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span>    <span class="token punctuation">}</span>    options <span class="token operator">=</span> options <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>    options<span class="token punctuation">.</span>user <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>    <span class="token keyword">var</span> watcher <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Watcher</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> expOrFn<span class="token punctuation">,</span> cb<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">var</span> info <span class="token operator">=</span> <span class="token string">"callback for immediate watcher \""</span> <span class="token operator">+</span> <span class="token punctuation">(</span>watcher<span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">;</span>      <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">invokeWithErrorHandling</span><span class="token punctuation">(</span>cb<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">[</span>watcher<span class="token punctuation">.</span>value<span class="token punctuation">]</span><span class="token punctuation">,</span> vm<span class="token punctuation">,</span> info<span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token keyword">return</span> <span class="token keyword">function</span> <span class="token function">unwatchFn</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      watcher<span class="token punctuation">.</span><span class="token function">teardown</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>åœ¨ <code>new Watcher</code> å¯¹è±¡ç¬¬ä¸€æ¬¡è·å– <code>watcher.value</code> æ—¶ï¼Œè§¦å‘ <code>watcher</code> å¯¹è±¡çš„ Dep ä¾èµ–ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token keyword">var</span> <span class="token function-variable function">Watcher</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">Watcher</span> <span class="token punctuation">(</span><span class="token parameter">vm<span class="token punctuation">,</span>  expOrFn<span class="token punctuation">,</span>  cb<span class="token punctuation">,</span>  options<span class="token punctuation">,</span>  isRenderWatcher</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>vm <span class="token operator">=</span> vm<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>isRenderWatcher<span class="token punctuation">)</span> <span class="token punctuation">{</span>    vm<span class="token punctuation">.</span>_watcher <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  vm<span class="token punctuation">.</span>_watchers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// éšè—ä¸éœ€è¦å…³æ³¨çš„ä»£ç </span>  <span class="token comment">// parse expression for getter</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> expOrFn <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> expOrFn<span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> <span class="token function">parsePath</span><span class="token punctuation">(</span>expOrFn<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>getter<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token keyword">this</span><span class="token punctuation">.</span>getter <span class="token operator">=</span> noop<span class="token punctuation">;</span>    <span class="token comment">// éšè—ä¸éœ€è¦å…³æ³¨çš„ä»£ç </span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span>  <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lazy    <span class="token operator">?</span> <span class="token keyword">undefined</span>    <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">get</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">get</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token comment">// æŒ‡å®š Dep.target ä¸º watcher</span>  <span class="token function">pushTarget</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">var</span> value<span class="token punctuation">;</span>  <span class="token keyword">var</span> vm <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>vm<span class="token punctuation">;</span>  <span class="token keyword">try</span> <span class="token punctuation">{</span>    value <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> vm<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>user<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">handleError</span><span class="token punctuation">(</span>e<span class="token punctuation">,</span> vm<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token string">"getter for watcher \""</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>expression<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">"\""</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>      <span class="token keyword">throw</span> e    <span class="token punctuation">}</span>  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>deep<span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token function">traverse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>    <span class="token comment">// é€€å‡º Dep.target çš„æŒ‡å‘  </span>    <span class="token function">popTarget</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cleanupDeps</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span>  <span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// è§¦å‘çœŸå® get æ—¶ï¼Œå®Œæˆäº† watcher çš„ Dep ä¾èµ–</span>Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¿½ç•¥ set</span>    <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveGetter</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>            dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>childOb<span class="token punctuation">)</span> <span class="token punctuation">{</span>                childOb<span class="token punctuation">.</span>dep<span class="token punctuation">.</span><span class="token function">depend</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>                    <span class="token function">dependArray</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token punctuation">}</span>            <span class="token punctuation">}</span>        <span class="token punctuation">}</span>        <span class="token keyword">return</span> value<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token comment">// å®Œæˆ Dep.target æ·»åŠ ä¾èµ–ï¼Œæ­¤æ—¶çš„ Dep.target æ˜¯ watther æœ¬èº«ã€‚è€Œ this ä¸º store çš„ dep å¯¹è±¡ã€‚</span><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">depend</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">depend</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span>Dep<span class="token punctuation">.</span>target<span class="token punctuation">)</span> <span class="token punctuation">{</span>    Dep<span class="token punctuation">.</span>target<span class="token punctuation">.</span><span class="token function">addDep</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span class="token comment">// watcher å®Œæˆ addDepæ—¶ï¼Œé™¤äº†ç»™è‡ªèº« depIdå’Œ deps åŠ ä¸Š store depå¯¹è±¡ï¼ŒåŒæ ·æŠŠè‡ªèº«watcherä½œä¸º store dep çš„å­å…³è”</span><span class="token class-name">Watcher</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">addDep</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">addDep</span> <span class="token punctuation">(</span><span class="token parameter">dep</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> id <span class="token operator">=</span> dep<span class="token punctuation">.</span>id<span class="token punctuation">;</span>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDepIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">this</span><span class="token punctuation">.</span>newDeps<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>depIds<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      dep<span class="token punctuation">.</span><span class="token function">addSub</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><code>Dep.prototype.depend</code> å®Œæˆè°ƒç”¨æ—¶ï¼Œstore watcher å·²ç»å®Œæˆä¸ store çš„ dep å¯¹è±¡çš„ç»‘å®šè¿‡ç¨‹ã€‚ä»¥ä¸Š <code>store watch init</code> çš„é“¾è·¯å¦‚ä¸‹ï¼Œ</p><pre class="line-numbers language-none"><code class="language-none">depend (vue.common.dev.js:726)reactiveGetter (vue.common.dev.js:1038)prototypeAccessors$1.state.get (vuex.esm.js:438)ï¼ˆåŒ¿åï¼‰ (vue.common.dev.js:514)get (vue.common.dev.js:4490)Watcher (vue.common.dev.js:4479)Vue.$watch (vue.common.dev.js:4953)createWatcher (vue.common.dev.js:4913)initWatch (vue.common.dev.js:4895)initState (vue.common.dev.js:4656)Vue._init (vue.common.dev.js:5010)VueComponent (vue.common.dev.js:5157)createComponentInstanceForVnode (vue.common.dev.js:3307)init (vue.common.dev.js:3136)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p><strong>store watch çš„è§¦å‘</strong></p><p><code>this.$store.commit('xxx', xxxx)</code> è§¦å‘æ—¶ï¼Œåœ¨æ”¹å€¼çš„åŒäº‹ä¼šè§¦å‘æœ¬ store Dep çš„ notify ï¼ˆé€šçŸ¥ï¼‰ã€‚</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript">Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> key<span class="token punctuation">,</span> <span class="token punctuation">{</span>    <span class="token literal-property property">enumerable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token literal-property property">configurable</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>    <span class="token comment">// å¿½ç•¥ get</span>    <span class="token function-variable function">set</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">reactiveSetter</span> <span class="token punctuation">(</span><span class="token parameter">newVal</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>        <span class="token keyword">var</span> value <span class="token operator">=</span> getter <span class="token operator">?</span> <span class="token function">getter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token operator">:</span> val<span class="token punctuation">;</span>        <span class="token comment">/* eslint-disable no-self-compare */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>newVal <span class="token operator">===</span> value <span class="token operator">||</span> <span class="token punctuation">(</span>newVal <span class="token operator">!==</span> newVal <span class="token operator">&amp;&amp;</span> value <span class="token operator">!==</span> value<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token keyword">return</span>        <span class="token punctuation">}</span>        <span class="token comment">/* eslint-enable no-self-compare */</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>customSetter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">customSetter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span>        <span class="token comment">// #7981: for accessor properties without setter</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>getter <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> <span class="token punctuation">}</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>setter<span class="token punctuation">)</span> <span class="token punctuation">{</span>            <span class="token function">setter</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>            val <span class="token operator">=</span> newVal<span class="token punctuation">;</span>        <span class="token punctuation">}</span>        childOb <span class="token operator">=</span> <span class="token operator">!</span>shallow <span class="token operator">&amp;&amp;</span> <span class="token function">observe</span><span class="token punctuation">(</span>newVal<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token comment">// è§¦å‘é€šçŸ¥</span>        dep<span class="token punctuation">.</span><span class="token function">notify</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token class-name">Dep</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">notify</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">notify</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token keyword">var</span> subs <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>subs<span class="token punctuation">.</span><span class="token function">slice</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// å¿½ç•¥ä¸é‡è¦ä»£ç </span>  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span> l <span class="token operator">=</span> subs<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i <span class="token operator">&lt;</span> l<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>    <span class="token comment">// watcher update</span>    subs<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">update</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>å…¶ä¸­ <code>notify</code> çš„ä¸­éå† Dep çš„ subs å¹¶æ›´æ–°ï¼Œæ­¤å¤„å›æƒ³ watcher åˆå§‹åŒ–æ—¶ <code>watcher#addDep</code> å¯è§ subs æ˜¯åŒ…å« watcher çš„ï¼Œæ‰€ä»¥ store å±æ€§å˜åŒ–ä¹Ÿå°±èƒ½é€šçŸ¥åˆ° watcher äº†ã€‚<code>store watch notify</code> çš„é“¾è·¯å¦‚ä¸‹ï¼Œ</p><pre class="line-numbers language-none"><code class="language-none">handler (list_left.vue:411)invokeWithErrorHandling (vue.common.dev.js:1868)run (vue.common.dev.js:4579)flushSchedulerQueue (vue.common.dev.js:4323)ï¼ˆåŒ¿åï¼‰ (vue.common.dev.js:1994)flushCallbacks (vue.common.dev.js:1920)Promise.thenï¼ˆå¼‚æ­¥ï¼‰timerFunc (vue.common.dev.js:1947)nextTick (vue.common.dev.js:2004)queueWatcher (vue.common.dev.js:4415)update (vue.common.dev.js:4555)notify (vue.common.dev.js:741)reactiveSetter (vue.common.dev.js:1066)proxySetter (vue.common.dev.js:4639)changeAjlb (nav.vue:431)<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><p>ä»¥ä¸Šï¼Œ<strong>watcher init</strong> å’Œ <strong>watcher è§¦å‘</strong> æ€»ç»“æ¥è¯´å°±æ˜¯è¿™ä¸ªå›¾ã€‚</p><p><img src="/images/2023/npm_link_vuex_watch/link.png"></p><h3 id="two-ä¸ºå•¥-npm-link-ä¸èƒ½è§¦å‘-store-watch"><a href="#two-ä¸ºå•¥-npm-link-ä¸èƒ½è§¦å‘-store-watch" class="headerlink" title=":two: ä¸ºå•¥ npm-link ä¸èƒ½è§¦å‘ store watch"></a><span class="github-emoji"><span>2âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0032-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä¸ºå•¥ npm-link ä¸èƒ½è§¦å‘ store watch</h3><p>ææ‡‚äº†ï¼Œstore watcher è¿™æ‘Šå­äº‹æƒ…ï¼Œæ’æŸ¥å°±ç›¸å¯¹ç®€å•äº†ã€‚**æŠ“ä½ 1 ä¸ªä½ç½®å³å¯ï¼Œåœ¨ <code>initWatcher</code> çš„æ—¶å€™æ˜¯å¦å®Œæˆäº† <code>Watcher#addDep</code>ã€‚<br>** ç»“æœå‘ç°ï¼Œåœ¨ <code>Watcher.prototype.get</code>æ–¹æ³•ä¸­ <code>pushTarget(this)</code>  Dep æŒ‡å‘ <code>webpack://${web_app}/./node_nodules/vue/dist/vue,common.dev.js</code>ã€‚<br>è€Œåœ¨ <code>Object.defineProperty#get</code> æ–¹æ³•ä¸­ <code>Dep.target</code> ä»£ç  Dep æŒ‡å‘<br><code>webpack://${web_app}/${web_component}/node_modules/vue/dist/vue.common.dev.js</code>ã€‚<br>æ‘†æ˜ Dep å·²ç»ä¸æ˜¯åŸæ¥çš„ Dep äº†ï¼Œå¯¼è‡´ store Dep ä¸ watcher æ²¡åŠ æˆï¼Œå¯¼è‡´ store watcher ä¸è¢«è§¦å‘ã€‚</p><p><strong>æ­¤æ—¶ï¼Œæˆ‘å›æƒ³å¹¸å¥½æ˜¯ä¸ªå¥³ç”Ÿï¼Œä¸ç„¶æˆ‘å°±å»æ¥¼ä¸‹æŠ½æ ¹çƒŸäº†ã€‚è¿™ä¸ªåç«¯ jar åŒ…å†²çªå¯å¤ªåƒäº†ã€‚</strong></p><h3 id="three-å¦‚ä½•è§£å†³é—®é¢˜"><a href="#three-å¦‚ä½•è§£å†³é—®é¢˜" class="headerlink" title=":three: å¦‚ä½•è§£å†³é—®é¢˜"></a><span class="github-emoji"><span>3âƒ£</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/0033-20e3.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚ä½•è§£å†³é—®é¢˜</h3><p>åœ¨åœºæ™¯å±‚å°† vue å®šä¹‰æˆ window å…¨å±€å¯¹è±¡ã€‚åœ¨ç»„ä»¶å†…ä½¿ç”¨ <code>window.Vue</code> è£…è½½  vuexã€‚è‡ªæ­¤ï¼Œé—®é¢˜ç»ˆç»“ã€‚ä¿®æ”¹æ–¹å¼ï¼š</p><pre class="line-numbers language-javascript" data-language="javascript"><code class="language-javascript"><span class="token comment">// åœ¨å‰ç«¯åº”ç”¨å…¥å£æ–‡ä»¶ä¸­</span><span class="token keyword">import</span> vue <span class="token keyword">from</span> <span class="token string">'vue'</span><span class="token punctuation">;</span><span class="token keyword">import</span> vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span>window<span class="token punctuation">.</span>Vue <span class="token operator">=</span> vue<span class="token punctuation">;</span>vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// åœ¨è¢«å¼•ç”¨çš„ç»„ä»¶å…¥å£æ–‡ä»¶ä¸­</span><span class="token keyword">import</span> vuex <span class="token keyword">from</span> <span class="token string">'vuex'</span><span class="token punctuation">;</span><span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>Vue<span class="token punctuation">)</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span>Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>    window<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>vuex<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre><h2 id="rabbit-æ€»ç»“"><a href="#rabbit-æ€»ç»“" class="headerlink" title=":rabbit: æ€»ç»“"></a><span class="github-emoji"><span>ğŸ°</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f430.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ€»ç»“</h2><ol><li>npm-link å›ºç„¶è§£å†³äº†ä¸ç”¨è€æ”¹ç»„ä»¶ç‰ˆæœ¬å·è°ƒè¯•çš„é—®é¢˜ï¼Œä½†å› ä¸º npm-link çš„ç»„ä»¶ä¼šä½¿ç”¨è‡ªèº«çš„ node_modules å¯¼è‡´ï¼Œéƒ¨åˆ†åŸæœ¬æœŸæœ›ä¸åœºæ™¯ ui å…±äº«çš„å¯¹è±¡å¯èƒ½ä¸å…±äº«ã€‚</li><li>å‰ç«¯ä»£ç æ’æŸ¥ç¡®æ˜¯ä¸å¦‚åç«¯ä»£ç æ’æŸ¥æ–¹ä¾¿ï¼Œå•¥ <code>console.warn</code> éƒ½ä¹ˆå¾—è€—æ—¶é•¿ã€‚</li></ol><h2 id="sheep-é™„ä»¶"><a href="#sheep-é™„ä»¶" class="headerlink" title=":sheep: é™„ä»¶"></a><span class="github-emoji"><span>ğŸ‘</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f411.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é™„ä»¶</h2><ul><li><a href="https://segmentfault.com/a/1190000016208088">Vueæºç è§£è¯»ä¹‹Dep,Observerå’ŒWatcher</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> npm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> npm-link </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitlab ä¸Šå’Œé¡¹ç›®å¤§ä»“åº“è¯´å†è§</title>
      <link href="/2023/03/27/gitlab-shang-he-xiang-mu-da-cang-ku-shuo-zai-jian/"/>
      <url>/2023/03/27/gitlab-shang-he-xiang-mu-da-cang-ku-shuo-zai-jian/</url>
      
        <content type="html"><![CDATA[<h2 id="cat-èƒŒæ™¯"><a href="#cat-èƒŒæ™¯" class="headerlink" title=":cat: èƒŒæ™¯"></a><span class="github-emoji"><span>ğŸ±</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f431.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> èƒŒæ™¯</h2><p><code>git clone</code> é¡¹ç›®è€—æ—¶å¾ˆé•¿ã€‚åŸå› ï¼Œç½‘é€Ÿæ…¢æˆ–æ˜¯ä»£ç ä»“åº“æ–‡ä»¶å¾ˆå¤§(n+ G)ã€‚æœ¬ç¯‡æ–‡ç« å°±è®²è¿°å¦‚ä½•ç»™ <code>gitlab</code> ä»£ç ä»“åº“å‡è´Ÿã€‚</p><h3 id="dog-åŸºç¡€çŸ¥è¯†"><a href="#dog-åŸºç¡€çŸ¥è¯†" class="headerlink" title=":dog: åŸºç¡€çŸ¥è¯†"></a><span class="github-emoji"><span>ğŸ¶</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f436.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åŸºç¡€çŸ¥è¯†</h3><p>é¡¹ç›®åœ¨ gitlab ä¸­æ˜¾ç¤ºçš„ä»“åº“å¤§å° = é¡¹ç›®æ–‡ä»¶æ€»å¤§å° + <code>.git</code> ï¼ˆéšè—ï¼‰ç›®å½•ä¸‹æ–‡ä»¶å¤§å°ã€‚è¯·è®¤çœŸå…³æ³¨ä½ é¡¹ç›®ç›®å½•æ–‡ä»¶å¤§å°ï¼ˆwindows å¯ä»¥ç”¨ <a href="https://www.jam-software.com/treesize_free">treesize free</a> / <a href="http://www.uderzo.it/main_products/space_sniffer/download_alt.html">SpaceSniffer</a> å·¥å…·ï¼Œlinux å¯ä»¥ç”¨å‘½ä»¤ <code>du -h â€“max-depth=1 *</code>ï¼Œmac å‘½ä»¤ <code>du -h -d 1 *</code> ï¼‰ï¼Œä¸€èˆ¬ <code>.git</code> ç›®å½•ä¸‹æ–‡ä»¶å¤§å° &gt;= é¡¹ç›®æ–‡ä»¶å¤§å°ã€‚æ„å‘³ç€ï¼Œé¡¹ç›®æ•´ä½“ä¸‹è½½ç©ºé—´å ç”¨ &gt;= 2 * é¡¹ç›®æ–‡ä»¶å¤§å°ã€‚æ‰€ä»¥ï¼Œå¦‚æœé¡¹ç›®ä¸­åŒ…å«æ¯”è¾ƒå¤§çš„æ–‡ä»¶ï¼Œä¾‹å¦‚è§†é¢‘ï¼Œé«˜æ¸…ç…§ç‰‡ç­‰ï¼ŒæŠŠ gitlab å½“åšäº†<strong>å…±äº«å¤‡ä»½å­˜å‚¨ç©ºé—´</strong>æ˜¯é¡¹ç›®æ–‡ä»¶å¤§çš„ç½ªé­ç¥¸æ‰‹ã€‚æ‰€ä»¥ï¼Œé¡¹ç›®åˆæœŸä»£ç ä¸€å®šå’Œéœ€æ±‚æ–‡æ¡£åšå‰¥ç¦»ï¼Œé™¤éä½ çš„é¡¹ç›®è¶³å¤Ÿçš„å°ã€‚</p><h3 id="fish-æ‹¯æ•‘-git-ä»“åº“"><a href="#fish-æ‹¯æ•‘-git-ä»“åº“" class="headerlink" title=":fish: æ‹¯æ•‘ git ä»“åº“"></a><span class="github-emoji"><span>ğŸŸ</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f41f.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æ‹¯æ•‘ git ä»“åº“</h3><p>å¯¹äºéœ€æ±‚æ–‡æ¡£ç±»é¡¹ç›®è€Œè¨€ï¼Œå»ºè®®ç”¨ <code>git lfs</code> åšå¤§æ–‡ä»¶ç®¡ç†ï¼ˆæ­¤å¤„ <code>git lfs</code> ä¸åšè¿‡å¤šä»‹ç»ï¼Œè¯·ç‚¹å‡»<a href="https://git-lfs.github.com/">é“¾æ¥</a>äº†è§£ï¼‰ã€‚è¯·å¤šæƒ³æƒ³åé¢åŠ å…¥çš„éœ€æ±‚äººï¼Œç»™ä»–ä»¬çš„åŠ å…¥å‡å°‘ä¸€äº›ç»Šè„šçŸ³ã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ä»…ä½¿ç”¨å‡ æ¬¡ï¼Œè¿‡ä¸€ä¸ªæœˆä¹‹ååŸºæœ¬ä¸ç¿»çš„ä¸œè¥¿ã€æ— éœ€ç‰ˆæœ¬ç®¡ç†ã€å†…å®¹è¶…è¿‡ 100 MB çš„è§†é¢‘ï¼Œè¯·æ…é‡æ”¾å…¥ git ä»“åº“</p></blockquote><h3 id="whale-åˆ†æ-git-å¤§ä»“åº“"><a href="#whale-åˆ†æ-git-å¤§ä»“åº“" class="headerlink" title=":whale: åˆ†æ git å¤§ä»“åº“"></a><span class="github-emoji"><span>ğŸ³</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f433.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> åˆ†æ git å¤§ä»“åº“</h3><ul><li><p>windows ä¸Šä½¿ç”¨ <code>TreeSize Free</code>  çœ‹çœ‹æ–‡ä»¶å¤§å°å æ¯”åˆ†å¸ƒã€‚å‘ç°ï¼Œé¡¹ç›®æœ¬èº«æ–‡ä»¶å¤§å°å¤§çº¦ 900 MB ï¼Œ<code>.git</code> ç›®å½•åƒæ‰ 2.6 GBã€‚åŸå› ï¼Œå…¶å®ä¸Šé¢åŸºç¡€çŸ¥è¯†ç®—æ˜¯è§£ç­”äº†ä¸€éƒ¨åˆ†ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥å‚è€ƒé™„ä»¶<strong>git åŸç†</strong>æ‰¾ç­”æ¡ˆã€‚</p><p><img src="/images/2023/gitlab_bigcodes/directory_image.png"></p></li><li><p>ä½¿ç”¨ <code>git verify-pack</code>  å‘½ä»¤è¿è¡Œ  <code>git verify-pack -v .git/objects/pack/pack-f0fa1a09cd9ebf8874e4ecafa9e56be7816097de.idx|sort -k 3 -n| tail -10</code> ï¼ŒæŸ¥æ‰¾å‡ºæ–‡ä»¶å¤§å°åœ¨å‰ 10 çš„æ–‡ä»¶ hash æ ‡è¯†ã€‚æ³¨æ„ï¼Œwindows ä¸Šè¯·ä½¿ç”¨ <code>git Bash Here </code> è¿è¡Œã€‚</p><p><img src="/images/2023/gitlab_bigcodes/git_xpack.png"></p></li><li><p>ä½¿ç”¨å‘½ä»¤ <code>git rev-list</code> è¿è¡Œ <code>git rev-list --objects --all|grep  hashId </code> å®šä½å¤§æ–‡ä»¶è·¯å¾„ã€‚æ­¤å¤„ï¼Œå¤„ç†æ–‡ä»¶å¤§å°è¶…è¿‡ 100 MBã€‚</p><p><img src="/images/2023/gitlab_bigcodes/directory_file.png"></p></li><li><p>æŒ‰ç…§è·¯å¾„å’Œ <code>git log</code> æŸ¥æ‰¾æäº¤äººï¼Œç¡®å®šæ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸”æ˜¯å¦éœ€è¦å­˜åœ¨ã€‚ç¡®å®šéœ€è¦æ¸…ç†çš„ä¸º <code>xxxx.asf</code> å’Œ <code>xxx.asf</code> ä¸¤ä¸ªæ–‡ä»¶ã€‚å·²ç»åˆ é™¤çš„æ–‡ä»¶ï¼Œå´åœ¨æ—¥å¿—é‡Œèƒ½æœç´¢å‡ºæ¥ï¼ŒåŸå› æ˜¯é˜²æ­¢ä½ æ‰§è¡Œ <code>git revert</code> è¿˜åŸåˆ°åˆ é™¤å‰çš„ commitId ç‰ˆæœ¬ã€‚æ‰€ä»¥ï¼Œæ¸…ç†åŸåˆ™å°±æ˜¯éœ€è¦<strong>æ˜ç¡®</strong>å“ªäº›æ–‡ä»¶è¦åˆ é™¤ï¼Œæ²¡æœ‰æœºä¼šè¿˜åŸçš„è¯ï¼Œå°±åˆ é™¤å§ã€‚</p><blockquote><p><span class="github-emoji"><span>ğŸ’¡</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f4a1.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> æœ‰é‡å‘½å/ç§»åŠ¨ç›®å½•éœ€æ±‚ï¼Œè¯·ä½¿ç”¨ <code>git mv</code>  å‘½ä»¤ï¼Œè€Œè¾¾åˆ°ç›®å½•å˜æ›´åŠå‘½ååŠŸèƒ½ã€‚ä¸è¦ä½¿ç”¨ <code>git mv</code> å’Œ <code>git add</code> çš„æ–¹å¼ï¼Œå®Œæˆæ–‡ä»¶é‡å‘½åæˆ–ç§»åŠ¨ç›®å½•ã€‚è¿™æ ·ä¼šé€ æˆæœ‰åˆ é™¤çš„ç”¨ä¸åˆ°çš„è®°å½•ã€‚</p></blockquote></li></ul><h2 id="dolphin-å¦‚ä½•æ¸…ç†"><a href="#dolphin-å¦‚ä½•æ¸…ç†" class="headerlink" title=":dolphin: å¦‚ä½•æ¸…ç†"></a><span class="github-emoji"><span>ğŸ¬</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f42c.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> å¦‚ä½•æ¸…ç†</h2><blockquote><p>åœ¨æ¸…ç†ä¹‹å‰ï¼Œå»ºè®®æ‰€æœ‰äººçš„åˆ†æ”¯éƒ½ push åˆ°è¿œç«¯ã€‚å¦åˆ™ï¼Œå…¶ä»–äººçš„æ¯æ¬¡çš„ push éƒ½ä¼šè®©ä½ çš„æ¸…ç†éƒ½éœ€è¦é‡æ–°æ¥ä¸€æ¬¡ã€‚</p></blockquote><p>ç›®å‰ï¼Œä¸»è¦æœ‰ä¸¤ç§æ–¹æ³•ï¼š</p><ul><li><p>git åŸç”Ÿæ”¯æŒçš„ <code>filter-branch</code> åˆ†æ”¯æ–‡ä»¶ï¼Œå‘½ä»¤ <code>git filter-branch --force --tree-filter 'rm -f path/to/big_file.mpg' HEAD</code> ã€‚ï¼ˆä¸æ¨èã€‚å¯¹äºè¶…å¤š commit çš„é¡¹ç›®ï¼Œ<code>filter-branch</code> æ…¢çš„æ€€ç–‘äººç”Ÿï¼Œå°ç¼–å°±æ˜¯ä» <code>git filter-branch</code> æ”¾å¼ƒï¼Œè½¬æŠ• <code>BFG</code>ï¼‰</p></li><li><p><code>BFG</code> å·¥å…·</p><ul><li><p>æ‰§è¡Œå‘½ä»¤ <code>git clone --mirror git-repository-url</code>  clone git ä»“åº“</p></li><li><p>æ‰§è¡Œå‘½ä»¤ <code>java -jar bfg.jar --massive-non-file-objects-sized-up-to 100M --delete-files '{xxx.asf,xxx.asf}' thunisoft-mvd.git</code>ã€‚</p><blockquote><p><code>BFG</code> å¯¹äºéœ€è¦æ¸…ç†çš„ history ä¼šæ›´æ”¹æ¶‰åŠæ–‡ä»¶çš„æäº¤çš„ commit-idã€‚å…·ä½“è€æ–° commit-id çš„å¯¹åº”å…³ç³»æ–‡ä»¶åœ¨ <code>thunisoft-mvd.git.bfg-report\2020-07-17\16-14-13\object-id-map.old-new.txt</code> ä¸­<br>æ­¤æ—¶ï¼Œ<code>.git/objects</code> ä¸‹çš„  <code>pack/xxxxx.pack</code>  æ–‡ä»¶ä¼šè¢«è§£å‹ä¸º  n ä¸ª <code>git objects</code> å¯¹è±¡æ–‡ä»¶</p></blockquote></li></ul><p>  <img src="/images/2023/gitlab_bigcodes/log_for_bfg.png"></p></li><li><p>æ‰§è¡Œå‘½ä»¤ <code>git reflog expire --expire=now --all &amp;&amp; git gc --prune=now --aggressive</code> ï¼Œå°† git object å¯¹è±¡å‹ç¼©ã€‚è€Œåï¼Œæ‰§è¡Œå‘½ä»¤ <code>git push</code> æ¨é€è¿œç«¯ã€‚</p><blockquote><p>æ³¨æ„ï¼šæ¨é€ä¹‹å‰è§£é™¤ä»“åº“çš„ <code>Protected Branches</code> çš„é…ç½®</p></blockquote></li></ul><p>  <img src="/images/2023/gitlab_bigcodes/git_compress.png"></p><ul><li>è¯·é¡¹ç›®ç»„æ‰€æœ‰æˆå‘˜æ”¾å¼ƒåŸæœ¬çš„æœ¬åœ°é¡¹ç›®ä»“åº“ï¼Œé‡æ–° clone git é¡¹ç›®ã€‚å› ä¸ºï¼Œå¦‚æœç”¨åŸæ¥çš„ä»“åº“ä½ ä¼šå‘ç°æœ¬åœ° <code>.git</code> ä¼šæ›´å¤§ï¼Œå› ä¸ºé™¤äº† <code>git gc</code> é‡æ–°ç”Ÿæˆçš„ <code>pack</code> æ–‡ä»¶ä¹‹å¤–ï¼Œè¿˜æœ‰æœ¬åœ°æœ¬èº«è€çš„ <code>pack</code> æ–‡ä»¶ã€‚</li></ul><p><strong>æœ€ç»ˆå’Œæ´¾ç”Ÿé¡¹ç›®å¯¹æ¯”ï¼Œé™¤ <code>.git</code> ç›®å½•å¤–å…¶ä»–ç›¸åŒã€‚</strong></p><p><img src="/images/2023/gitlab_bigcodes/gitcode_compare.png"></p><p><strong>ä¸ºä»€ä¹ˆå­˜åœ¨ä¸åˆ° 1 KB çš„æ–‡ä»¶ï¼Ÿå› ä¸ºï¼Œæœ¬é¡¹ç›®ä½¿ç”¨ <code>git lfs</code> åšäº†å¤§æ–‡ä»¶ç®¡ç†ï¼Œä½¿ç”¨ <code>git lfs pull</code> å¯ä»¥ä»è¿œç«¯æ‹‰ä¸‹ 1 KB æ˜ å°„çš„åŸæ–‡ä»¶</strong><br><strong><font color="red">æ¸…ç†å®Œæˆï¼Œ2.4 GB -&gt; 1.1 GB çš„è½¬èº«</font></strong></p><h2 id="lion-ç‰¹åˆ«è¯´æ˜"><a href="#lion-ç‰¹åˆ«è¯´æ˜" class="headerlink" title=":lion: ç‰¹åˆ«è¯´æ˜"></a><span class="github-emoji"><span>ğŸ¦</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f981.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> ç‰¹åˆ«è¯´æ˜</h2><ul><li>é¡¹ç›®ä½¿ç”¨ <code>git lfs</code> ç®¡ç†å¤§æ–‡ä»¶ä¹‹åï¼Œä½¿ç”¨ <code>BFG</code> æ¸…ç†å®Œå¯¹é¡¹ç›®æœ¬èº«æ²¡æœ‰ä»»ä½•å½±å“ã€‚ç…§æ ·ï¼Œå¯ä»¥ä½¿ç”¨ <code>git lfs</code> å‘½ä»¤ç®¡ç†æ–‡ä»¶ã€‚</li><li>çœŸå®é¡¹ç›®åœ¨æ¸…ç†å‰ï¼Œè¯·å…ˆæŒ‰ç…§æœ¬æ–‡å…ˆ <code>clone</code> å‡ºä¸€ä»½ï¼Œç†Ÿæ‚‰ä¸€ä¸‹æ¸…ç†æµç¨‹ï¼Œæ›´æœ‰åº•æ°”ã€‚</li></ul><h2 id="horse-é™„å½•"><a href="#horse-é™„å½•" class="headerlink" title=":horse: é™„å½•"></a><span class="github-emoji"><span>ğŸ´</span><img src="https://github.githubassets.com/images/icons/emoji/unicode/1f434.png?v8" aria-hidden="true" onerror="this.parent.classList.add('github-emoji-fallback')"></span> é™„å½•</h2><ul><li><a href="http://www.ruanyifeng.com/blog/2018/10/git-internals.html">git åŸç†-é˜®ä¸€å³°</a></li><li><a href="https://zhuanlan.zhihu.com/p/45510461">git åŸç†</a></li><li><a href="https://docs.github.com/cn/github/managing-large-files/removing-files-from-git-large-file-storage#removing-a-single-file">git å¤§æ–‡ä»¶æ¸…ç†-github</a></li><li><a href="http://gitlab.thunisoft.com/help/user/project/repository/reducing_the_repo_size_using_git.md">git å¤§æ–‡ä»¶æ¸…ç†-gitlab</a>ï¼Œç›®å‰ä¸ç”¨ä¸Šä¼  <code>object-id-map.old-new.txt</code> æ–‡ä»¶ï¼Œèµ° â€œå¼€å§‹æ¸…ç†â€ è¿™æ­¥éª¤</li><li><a href="https://rtyley.github.io/bfg-repo-cleaner/">git BFG</a></li><li><a href="https://learngitbranching.js.org/?locale=zh_CN">git ç»ƒä¹ åœº</a></li><li><a href="https://git-scm.com/book/zh/v2">git å­¦ä¹ æ–‡æ¡£</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> tools </category>
          
      </categories>
      
      
        <tags>
            
            <tag> tools </tag>
            
            <tag> gitlab </tag>
            
            <tag> BFG </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
